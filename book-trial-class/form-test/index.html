<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unischooly ‚Äì Booking Form (Backend Test)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-main: #050818;
      --bg-card: #0b1020;
      --bg-card-soft: #12172b;
      --accent-1: #ff6ad5;
      --accent-2: #4be1ff;
      --accent-3: #8b5cff;
      --accent-4: #ffac35;
      --text-main: #e5f0ff;
      --text-soft: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --danger: #f97373;
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text-main);
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 32px 16px;
    }

    .shell {
      width: 100%;
      max-width: 1120px;
      background: radial-gradient(circle at top left, #1f2937 0, #020617 55%);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.8),
        0 0 0 1px rgba(56, 189, 248, 0.08);
      padding: 28px 32px 32px;
    }

    .shell-header {
      margin-bottom: 12px;
    }

    .shell-title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.01em;
      margin: 0 0 4px;
      background: linear-gradient(90deg, #e5e7eb, #a5b4fc, #22d3ee);
      -webkit-background-clip: text;
      color: transparent;
    }

    .shell-subtitle {
      margin: 0;
      font-size: 13px;
      color: var(--text-soft);
    }

    .step-indicator {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 18px 0 20px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .step-indicator span strong {
      color: #e5e7eb;
    }

    .step-bars {
      display: flex;
      gap: 8px;
      width: 160px;
    }

    .step-bar {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
    }

    .step-bar.active {
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
    }

    .step-bar.completed {
      background: linear-gradient(90deg, #22c55e, #a7f3d0);
    }

    .banner {
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 12px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .banner.show {
      display: flex;
    }

    .banner-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.7);
      color: #fecaca;
    }

    .banner-success {
      background: rgba(22, 163, 74, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.8);
      color: #bbf7d0;
    }

    .banner-icon {
      font-size: 16px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 16px;
    }

    .field-group {
      margin-bottom: 16px;
    }

    .field-label-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
    }

    .field-label {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .field-hint {
      font-size: 11px;
      color: var(--text-soft);
    }

    .input,
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background-color 0.15s;
    }

    .input::placeholder {
      color: #4b5563;
    }

    .input:focus,
    select:focus {
      border-color: var(--accent-2);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.4),
        0 0 30px rgba(56, 189, 248, 0.3);
    }

    .pill-toggle {
      display: inline-flex;
      padding: 4px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      border: 1px solid rgba(148, 163, 184, 0.4);
      gap: 4px;
    }

    .pill-toggle button {
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-soft);
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .pill-toggle button span {
      font-size: 13px;
    }

    .pill-toggle button.active {
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: #f9fafb;
      box-shadow:
        0 0 0 1px rgba(96, 165, 250, 0.6),
        0 8px 25px rgba(15, 23, 42, 0.9);
    }

    .pill-toggle button.inactive {
      color: #9ca3af;
    }

    .btn-main {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 14px 18px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      color: #0b1020;
      background-image: linear-gradient(90deg, #ff6ad5, #8b5cff, #4be1ff);
      background-size: 200% 100%;
      box-shadow:
        0 10px 40px rgba(59, 130, 246, 0.5),
        0 0 0 1px rgba(191, 219, 254, 0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.1s ease, box-shadow 0.15s ease, background-position 0.2s;
    }

    .btn-main:hover {
      background-position: 100% 0;
      transform: translateY(-1px);
      box-shadow:
        0 14px 45px rgba(59, 130, 246, 0.65),
        0 0 0 1px rgba(191, 219, 254, 0.35);
    }

    .btn-main:active {
      transform: translateY(0);
      box-shadow:
        0 8px 30px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(148, 163, 184, 0.75);
    }

    .btn-main:disabled {
      opacity: 0.65;
      cursor: wait;
      box-shadow: none;
    }

    .btn-secondary {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-soft);
      background: transparent;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }

    .btn-secondary span {
      font-size: 14px;
    }

    .btn-secondary:hover {
      color: #e5e7eb;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .section-subtitle {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 12px;
    }

    .date-row,
    .time-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .date-pill {
      min-width: 100px;
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      cursor: pointer;
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      transition: all 0.15s ease;
    }

    .date-pill strong {
      font-size: 13px;
      color: #e5e7eb;
    }

    .date-pill.selected {
      border-color: var(--accent-2);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.4),
        0 10px 40px rgba(15, 23, 42, 0.95);
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
    }

    .time-pill {
      flex: 1 0 150px;
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      cursor: pointer;
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: all 0.15s ease;
    }

    .time-pill-main {
      font-size: 13px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .time-pill-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .time-pill.selected {
      border-color: var(--accent-2);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.4),
        0 10px 40px rgba(15, 23, 42, 0.95);
    }

    .star-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(250, 204, 21, 0.12);
      color: #facc15;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      border: 1px solid rgba(250, 204, 21, 0.8);
    }

    .pill-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .pill-option {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-subtle);
      font-size: 12px;
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      color: var(--text-soft);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .pill-option.selected {
      border-color: var(--accent-2);
      color: #f9fafb;
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.4),
        0 8px 28px rgba(15, 23, 42, 0.95);
    }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-soft);
      text-align: center;
    }

    @media (max-width: 768px) {
      body {
        padding: 16px 8px;
      }

      .shell {
        padding: 20px 16px 20px;
        border-radius: 20px;
      }

      .grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="shell-header">
      <h1 class="shell-title">Unischooly ‚Äì Booking Form (Backend Test)</h1>
      <p class="shell-subtitle">
        Simple 3-step form to test Supabase integration. No fancy design ‚Äì only logic.
      </p>
    </header>

    <div class="step-indicator">
      <span>Step <strong id="step-label">1</strong> of 3 ‚Äì <span id="step-title">Details</span></span>
      <div class="step-bars">
        <div class="step-bar active"></div>
        <div class="step-bar" id="step-bar-2"></div>
        <div class="step-bar" id="step-bar-3"></div>
      </div>
    </div>

    <div id="error-banner" class="banner banner-error">
      <div class="banner-icon">‚ö†Ô∏è</div>
      <div id="error-text">Something went wrong.</div>
    </div>

    <div id="success-banner" class="banner banner-success">
      <div class="banner-icon">‚úÖ</div>
      <div id="success-text">Saved successfully.</div>
    </div>

    <!-- STEP 1 -->
    <section id="step-1">
      <div class="field-group">
        <div class="section-title">Step 1 ‚Äì Basic details</div>
        <div class="section-subtitle">
          Backend test: region fixed to <strong>MEA</strong>, language fixed to <strong>English</strong>.
          We also capture IP, city, country, device type & browser.
        </div>
      </div>

      <div class="grid">
        <div class="field-group" style="grid-column: span 4;">
          <div class="field-label-row">
            <label class="field-label">Phone Country Code</label>
          </div>
          <input id="phone-country-code" class="input" type="text" placeholder="+971" value="+971" />
        </div>

        <div class="field-group" style="grid-column: span 8;">
          <div class="field-label-row">
            <label class="field-label">WhatsApp Number</label>
            <span class="field-hint">We'll send class link &amp; updates here</span>
          </div>
          <input
            id="phone-number"
            class="input"
            type="tel"
            placeholder="10‚Äì12 digit number"
          />
          <div class="field-hint" style="margin-top: 4px;">
            Please share the number that you use for WhatsApp.
          </div>
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Child's Name</label>
          </div>
          <input id="child-name" class="input" type="text" placeholder="E.g. Aarav, Emma" />
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Select Child's Grade</label>
          </div>
          <select id="child-grade">
            <option value="">Select grade</option>
            <option>Grade 1</option>
            <option>Grade 2</option>
            <option>Grade 3</option>
            <option>Grade 4</option>
            <option>Grade 5</option>
            <option>Grade 6</option>
            <option>Grade 7</option>
            <option>Grade 8</option>
            <option>Grade 9</option>
            <option>Grade 10</option>
            <option>Grade 11</option>
            <option>Grade 12</option>
          </select>
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Parent / Guardian Name</label>
          </div>
          <input id="parent-name" class="input" type="text" placeholder="Full name" />
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Parent's Email</label>
          </div>
          <input id="parent-email" class="input" type="email" placeholder="We'll send confirmation here" />
        </div>

        <div class="field-group" style="grid-column: span 12;">
          <div class="field-label-row">
            <label class="field-label">Do you have a Laptop / Desktop?</label>
          </div>
          <div class="pill-toggle">
            <button type="button" id="laptop-yes" class="active">
              <span>üíª</span> Yes
            </button>
            <button type="button" id="laptop-no" class="inactive">
              <span>üì±</span> No (Tablet / Mobile only)
            </button>
          </div>
        </div>
      </div>

      <button id="btn-step-1" class="btn-main" style="margin-top: 8px;">
        <span>üöÄ</span>
        <span>Save &amp; Continue to Date &amp; Time</span>
      </button>

      <div class="footer-note">
        Note: We will share the class link & certificate on Email & WhatsApp.
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step-2" style="display:none;">
      <button class="btn-secondary" id="btn-back-to-1">
        <span>‚Üê</span>
        <span>Back to details</span>
      </button>

      <div class="field-group">
        <div class="section-title">Select Date &amp; Time</div>
        <div class="section-subtitle">
          Choose a slot that works in your local time. Your class will be for 1 hour. Showing today + next 5 days.
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Select Date</label>
          <span class="field-hint" id="date-range-label"></span>
        </div>
        <div class="date-row" id="date-row"></div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Select Start Time</label>
          <span class="field-hint">
            Class slots are limited. Times are shown in your local time.
          </span>
        </div>
        <div class="time-row" id="time-row"></div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Select Language</label>
        </div>
        <select id="language-select">
          <option value="english">English</option>
          <option value="arabic">Arabic</option>
          <option value="bahasa">Bahasa</option>
          <option value="vietnamese">Vietnamese</option>
          <option value="filipino">Filipino</option>
          <option value="thai">Thai</option>
        </select>
      </div>

      <button id="btn-step-2" class="btn-main" style="margin-top: 8px;">
        <span>‚ú®</span>
        <span>Confirm Class Time</span>
      </button>

      <div class="footer-note">
        Note: Free class will be conducted by reputed teachers. By continuing you agree to be contacted by Unischooly via WhatsApp / Phone / Email.
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="step-3" style="display:none;">
      <button class="btn-secondary" id="btn-back-to-2">
        <span>‚Üê</span>
        <span>Back to date &amp; time</span>
      </button>

      <div class="field-group">
        <div class="section-title">Help us personalise your experience</div>
        <div class="section-subtitle">
          A few quick questions so we can plan the trial class for your child.
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Who are you?</label>
        </div>
        <div class="pill-options" id="who-options">
          <button type="button" class="pill-option" data-value="Parent">Parent</button>
          <button type="button" class="pill-option" data-value="Student">Student</button>
          <button type="button" class="pill-option" data-value="Guardian">Guardian</button>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Why are you booking this trial class?</label>
        </div>
        <div class="pill-options" id="why-options">
          <button type="button" class="pill-option" data-value="Want to buy course">Want to buy course</button>
          <button type="button" class="pill-option" data-value="To Compare Platform">To Compare Platform</button>
          <button type="button" class="pill-option" data-value="To strengthen Concept">To strengthen Concept</button>
          <button type="button" class="pill-option" data-value="Just for free demo">Just for free demo</button>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">When are you planning to purchase?</label>
        </div>
        <div class="pill-options" id="when-options">
          <button type="button" class="pill-option" data-value="After the Demo">After the Demo</button>
          <button type="button" class="pill-option" data-value="This Week">This Week</button>
          <button type="button" class="pill-option" data-value="This Month">This Month</button>
          <button type="button" class="pill-option" data-value="Just Exploring">Just Exploring</button>
        </div>
      </div>

      <button id="btn-step-3" class="btn-main" style="margin-top: 8px;">
        <span>‚úÖ</span>
        <span>Submit</span>
      </button>

      <div class="footer-note" id="final-message" style="display:none; margin-top: 12px;">
        Your trial class is booked. You can now close this test page.
      </div>
    </section>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // For this backend test we fix region to MEA, course=1, timezone=Asia/Dubai
    const TEST_REGION = {
      regionKey: "MEA",
      courseId: 1,
      timeZone: "Asia/Dubai",
    };

    // ---- state ----
    let currentStep = 1;
    let leadId = null;
    let regionKey = TEST_REGION.regionKey;
    let regionTimeZone = TEST_REGION.timeZone;
    let courseId = TEST_REGION.courseId;

    let slotsByDate = {};
    let selectedDateKey = null;
    let selectedSlot = null;
    let selectedLanguage = "english";

    let hasLaptopValue = "Yes";
    let whoValue = null;
    let whyValue = null;
    let whenValue = null;

    // ---- DOM helpers ----
    const $ = (id) => document.getElementById(id);

    const step1El = $("step-1");
    const step2El = $("step-2");
    const step3El = $("step-3");
    const stepLabelEl = $("step-label");
    const stepTitleEl = $("step-title");
    const stepBars = document.querySelectorAll(".step-bar");

    const errorBanner = $("error-banner");
    const errorText = $("error-text");
    const successBanner = $("success-banner");
    const successText = $("success-text");

    const dateRowEl = $("date-row");
    const timeRowEl = $("time-row");
    const dateRangeLabelEl = $("date-range-label");
    const languageSelectEl = $("language-select");

    const btnStep1 = $("btn-step-1");
    const btnBackTo1 = $("btn-back-to-1");
    const btnStep2 = $("btn-step-2");
    const btnBackTo2 = $("btn-back-to-2");
    const btnStep3 = $("btn-step-3");

    const laptopYesBtn = $("laptop-yes");
    const laptopNoBtn = $("laptop-no");

    const finalMessageEl = $("final-message");

    // ---- small helpers ----
    function showError(msg) {
      if (!errorBanner) return;
      errorText.textContent = msg;
      errorBanner.classList.add("show");
      if (successBanner) successBanner.classList.remove("show");
    }

    function showSuccess(msg) {
      if (!successBanner) return;
      successText.textContent = msg;
      successBanner.classList.add("show");
      if (errorBanner) errorBanner.classList.remove("show");
    }

    function clearBanners() {
      if (errorBanner) errorBanner.classList.remove("show");
      if (successBanner) successBanner.classList.remove("show");
    }

    function fmtDateISO(d) {
      return d.toISOString().slice(0, 10);
    }

    function formatDateRangeLabel(minDate, maxDate) {
      const opt = { day: "2-digit", month: "short", year: "numeric" };
      return `${minDate.toLocaleDateString("en-GB", opt)} ‚Äì ${maxDate.toLocaleDateString(
        "en-GB",
        opt
      )}`;
    }

    function formatTimeLabel(date) {
      return date.toLocaleTimeString("en-US", {
        hour12: true,
        hour: "numeric",
        minute: "2-digit",
      });
    }

    function showStep(step) {
      currentStep = step;
      if (step1El) step1El.style.display = step === 1 ? "block" : "none";
      if (step2El) step2El.style.display = step === 2 ? "block" : "none";
      if (step3El) step3El.style.display = step === 3 ? "block" : "none";

      if (stepLabelEl) stepLabelEl.textContent = String(step);
      if (stepTitleEl) {
        stepTitleEl.textContent =
          step === 1 ? "Details" : step === 2 ? "Date & Time" : "Intent";
      }

      stepBars.forEach((bar, idx) => {
        bar.classList.remove("active", "completed");
        if (idx < step - 1) bar.classList.add("completed");
        else if (idx === step - 1) bar.classList.add("active");
      });

      clearBanners();
      window.scrollTo(0, 0);
    }

    function getInternetSpeedMbps() {
      const conn =
        navigator.connection ||
        navigator.mozConnection ||
        navigator.webkitConnection ||
        null;
      if (!conn || typeof conn.downlink !== "number") return null;
      return Math.round(conn.downlink * 10) / 10;
    }

    // ---- STEP 1 ----
    async function handleStep1() {
      clearBanners();

      const phoneCode = $("phone-country-code").value.trim();
      const phoneNumber = $("phone-number").value.trim().replace(/\\D/g, "");
      const childName = $("child-name").value.trim();
      const childGrade = $("child-grade").value.trim();
      const parentName = $("parent-name").value.trim();
      const parentEmail = $("parent-email").value.trim();

      if (
        !phoneCode ||
        !phoneNumber ||
        !childName ||
        !childGrade ||
        !parentName ||
        !parentEmail
      ) {
        showError("Please fill all required fields.");
        return;
      }

      btnStep1.disabled = true;
      btnStep1.textContent = "Saving...";

      let ipInfo = {};
      try {
        const res = await fetch("https://ipapi.co/json");
        ipInfo = await res.json();
      } catch (e) {
        ipInfo = {};
      }

      const internetSpeed = getInternetSpeedMbps();

      const payload = {
        child_name: childName,
        child_grade: childGrade,
        parent_name: parentName,
        parent_email: parentEmail,
        phone_country_code: phoneCode,
        phone_number: phoneNumber,
        has_laptop: hasLaptopValue,
        internet_speed_mbps: internetSpeed,
        region_key: regionKey,
        timezone: regionTimeZone,
        course_id: courseId,
        lang: "english",
        page_completed: 1,
        full_url: window.location.href,
        landing_page_path: window.location.pathname,
        ip_address: ipInfo.ip || null,
        city: ipInfo.city || null,
        country: ipInfo.country_name || null,
      };

      try {
        const { data, error } = await supabase
          .from("demo_leads")
          .upsert(payload, {
            onConflict: "phone_country_code,phone_number",
            ignoreDuplicates: false,
          })
          .select("id, region_key, timezone, course_id")
          .single();

        if (error) throw error;
        leadId = data.id;
        regionKey = data.region_key || regionKey;
        regionTimeZone = data.timezone || regionTimeZone;
        courseId = data.course_id || courseId;

        showSuccess("Details saved. Loading available slots...");
        await loadSlots();
        showStep(2);
      } catch (err) {
        console.error(err);
        showError("Failed to save details. Please try again.");
      } finally {
        btnStep1.disabled = false;
        btnStep1.innerHTML = "<span>üöÄ</span><span>Save &amp; Continue to Date &amp; Time</span>";
      }
    }

    // ---- STEP 2: slots ----
    async function loadSlots() {
      if (!leadId) return;

      dateRowEl.innerHTML = "";
      timeRowEl.innerHTML = "";
      slotsByDate = {};
      selectedDateKey = null;
      selectedSlot = null;

      const now = new Date();
      const today = new Date();
      const end = new Date();
      end.setDate(end.getDate() + 5);

      const todayKey = fmtDateISO(today);
      const endKey = fmtDateISO(end);

      try {
        const { data, error } = await supabase
          .from("demo_slots_live")
          .select(
            "slot_id, slot_date, slot_datetime_local, is_star_teacher, region_key, course_id"
          )
          .eq("region_key", regionKey)
          .eq("course_id", courseId)
          .gte("slot_date", todayKey)
          .lte("slot_date", endKey)
          .order("slot_datetime_local", { ascending: true });

        if (error) throw error;

        const minTime = new Date(now.getTime() + 60 * 60 * 1000); // +1hr

        const validSlots = (data || []).filter((s) => {
          const dt = new Date(s.slot_datetime_local);
          return dt >= minTime;
        });

        if (!validSlots.length) {
          dateRowEl.innerHTML = "<p>No slots available.</p>";
          return;
        }

        let minDate = null;
        let maxDate = null;

        validSlots.forEach((row) => {
          const dateKey = row.slot_date; // already YYYY-MM-DD

          if (!slotsByDate[dateKey]) slotsByDate[dateKey] = [];
          slotsByDate[dateKey].push(row);

          const d = new Date(dateKey + "T00:00:00");
          if (!minDate || d < minDate) minDate = d;
          if (!maxDate || d > maxDate) maxDate = d;
        });

        if (minDate && maxDate && dateRangeLabelEl) {
          dateRangeLabelEl.textContent = formatDateRangeLabel(minDate, maxDate);
        }

        renderDatePills(todayKey);
      } catch (err) {
        console.error(err);
        showError("Failed to load slots.");
      }
    }

    function renderDatePills(todayKey) {
      dateRowEl.innerHTML = "";
      const keys = Object.keys(slotsByDate).sort();
      if (!keys.length) {
        dateRowEl.innerHTML = "<p>No slots available.</p>";
        return;
      }

      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowKey = fmtDateISO(tomorrow);

      keys.forEach((key) => {
        const d = new Date(key + "T00:00:00");
        let top;
        if (key === todayKey) top = "Today";
        else if (key === tomorrowKey) top = "Tomorrow";
        else top = d.toLocaleDateString("en-US", { weekday: "short" });

        const bottom = d.toLocaleDateString("en-GB", {
          day: "2-digit",
          month: "short",
        });

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "date-pill";
        if (!selectedDateKey) selectedDateKey = key;
        if (selectedDateKey === key) btn.classList.add("selected");
        btn.innerHTML = `<strong>${top}</strong><span>${bottom}</span>`;
        btn.addEventListener("click", () => {
          selectedDateKey = key;
          renderDatePills(todayKey);
          renderTimePills();
        });
        dateRowEl.appendChild(btn);
      });

      renderTimePills();
    }

    function renderTimePills() {
      timeRowEl.innerHTML = "";
      selectedSlot = null;
      const list = slotsByDate[selectedDateKey] || [];
      if (!list.length) {
        timeRowEl.innerHTML = "<p>No slots for this day.</p>";
        return;
      }

      list.forEach((row) => {
        const dt = new Date(row.slot_datetime_local);
        const label = formatTimeLabel(dt);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "time-pill";
        btn.innerHTML = `
          <div class="time-pill-main">${label}</div>
          <div class="time-pill-sub">Live 1:1 class ¬∑ 60 mins</div>
          ${
            row.is_star_teacher
              ? '<div class="star-badge">‚≠ê Star teacher</div>'
              : ""
          }
        `;
        btn.addEventListener("click", () => {
          selectedSlot = { ...row, timeLabel: label };
          Array.from(timeRowEl.children).forEach((c) =>
            c.classList.remove("selected")
          );
          btn.classList.add("selected");
        });
        timeRowEl.appendChild(btn);
      });
    }

    async function handleStep2() {
      clearBanners();
      if (!leadId || !selectedSlot) {
        showError("Please pick a date and time.");
        return;
      }
      btnStep2.disabled = true;
      btnStep2.textContent = "Saving...";

      const lang = (languageSelectEl.value || "english").toLowerCase();

      try {
        const { error } = await supabase
          .from("demo_leads")
          .update({
            preferred_date: selectedSlot.slot_date,
            preferred_time_slot: selectedSlot.timeLabel,
            slot_id: selectedSlot.slot_id,
            star_teacher_selected: !!selectedSlot.is_star_teacher,
            lang: lang,
            page_completed: 2,
          })
          .eq("id", leadId);

        if (error) throw error;
        selectedLanguage = lang;
        showSuccess("Slot saved.");
        showStep(3);
      } catch (err) {
        console.error(err);
        showError("Failed to save selected slot.");
      } finally {
        btnStep2.disabled = false;
        btnStep2.innerHTML = "<span>‚ú®</span><span>Confirm Class Time</span>";
      }
    }

    // ---- STEP 3 ----
    function setupPillGroup(containerId, setter) {
      const container = $(containerId);
      if (!container) return;
      container.querySelectorAll(".pill-option").forEach((btn) => {
        btn.addEventListener("click", () => {
          container.querySelectorAll(".pill-option").forEach((b) =>
            b.classList.remove("selected")
          );
          btn.classList.add("selected");
          setter(btn.dataset.value);
        });
      });
    }

    async function handleStep3() {
      clearBanners();
      if (!leadId) return;
      if (!whoValue || !whyValue || !whenValue) {
        showError("Please answer all questions.");
        return;
      }

      btnStep3.disabled = true;
      btnStep3.textContent = "Saving...";

      try {
        const { error } = await supabase
          .from("demo_leads")
          .update({
            who_are_you: whoValue,
            booking_reason: whyValue,
            purchase_timeline: whenValue,
            page_completed: 3,
          })
          .eq("id", leadId);

        if (error) throw error;
        showSuccess("All details saved. Trial class booked.");
        if (finalMessageEl) finalMessageEl.style.display = "block";
      } catch (err) {
        console.error(err);
        showError("Failed to save final answers.");
      } finally {
        btnStep3.disabled = false;
        btnStep3.innerHTML = "<span>‚úÖ</span><span>Submit</span>";
      }
    }

    // ---- init ----
    document.addEventListener("DOMContentLoaded", () => {
      showStep(1);

      // laptop toggle
      if (laptopYesBtn && laptopNoBtn) {
        laptopYesBtn.addEventListener("click", () => {
          hasLaptopValue = "Yes";
          laptopYesBtn.classList.add("active");
          laptopYesBtn.classList.remove("inactive");
          laptopNoBtn.classList.remove("active");
          laptopNoBtn.classList.add("inactive");
        });
        laptopNoBtn.addEventListener("click", () => {
          hasLaptopValue = "No";
          laptopNoBtn.classList.add("active");
          laptopNoBtn.classList.remove("inactive");
          laptopYesBtn.classList.remove("active");
          laptopYesBtn.classList.add("inactive");
        });
      }

      if (btnStep1) btnStep1.addEventListener("click", handleStep1);
      if (btnBackTo1) btnBackTo1.addEventListener("click", () => showStep(1));
      if (btnStep2) btnStep2.addEventListener("click", handleStep2);
      if (btnBackTo2) btnBackTo2.addEventListener("click", () => showStep(2));
      if (btnStep3) btnStep3.addEventListener("click", handleStep3);

      if (languageSelectEl) {
        languageSelectEl.addEventListener("change", (e) => {
          selectedLanguage = e.target.value.toLowerCase();
        });
      }

      setupPillGroup("who-options", (v) => (whoValue = v));
      setupPillGroup("why-options", (v) => (whyValue = v));
      setupPillGroup("when-options", (v) => (whenValue = v));
    });
  </script>
</body>
</html>
