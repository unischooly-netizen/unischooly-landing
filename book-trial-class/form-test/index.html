<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Unischooly — Booking (Form Test)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#050818;--muted:#9ca3af}
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--bg);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .wrap{
      width:100%;
      max-width:760px;
      border-radius:16px;
      padding:22px;
      background:linear-gradient(180deg,#0f1724 0%, #07102a 100%);
      box-shadow:0 20px 50px rgba(2,6,23,0.7);
      border:1px solid rgba(148,163,184,0.06);
    }
    h1{font-size:20px;margin:0 0 8px}
    p.lead{color:var(--muted);margin:0 0 16px;font-size:13px}
    h2{margin:0 0 8px;font-size:18px}
    .step{display:none}
    .step.active{display:block}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    .row{display:flex;gap:12px}
    .col{flex:1}
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      background:rgba(15,23,42,0.6);
      border:1px solid rgba(148,163,184,0.06);
      color:#e5e7eb;
      font-size:14px;
      outline:none;
    }
    .radio-group{display:flex;gap:8px;margin:8px 0 16px}
    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.06);
      cursor:pointer;
      background:transparent;
      color:#e5e7eb;
    }
    .pill.selected{
      background:linear-gradient(90deg,#ec4899,#6366f1,#22d3ee);
      color:#07102a;
      font-weight:600;
    }
    button.primary{
      width:100%;
      padding:12px 16px;
      border-radius:999px;
      border:none;
      background:linear-gradient(90deg,#ec4899,#6366f1,#22d3ee);
      color:#07102a;
      font-weight:700;
      cursor:pointer;
    }
    .muted{color:var(--muted);font-size:13px}
    .status{min-height:18px;margin-bottom:10px;font-size:13px}
    .status.ok{color:#6ee7b7}
    .status.err{color:#fca5a5}
    .date-row,.time-row{display:flex;gap:8px;flex-wrap:wrap}
    .time-pill{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid rgba(148,163,184,0.06);
      background:transparent;
      cursor:pointer;
    }
    .time-pill.star{
      box-shadow:0 6px 18px rgba(99,102,241,0.12);
      border:1px solid rgba(99,102,241,0.25);
    }
    .summary{
      background:rgba(255,255,255,0.02);
      padding:12px;
      border-radius:8px;
      margin-top:12px;
    }
    .small{font-size:12px;color:var(--muted)}
    pre.debug{
      background:#07102a;
      padding:12px;
      border-radius:8px;
      color:#9ca3af;
      overflow:auto;
      max-height:200px;
    }
  </style>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.5.6/build/css/intlTelInput.css"/>
</head>
<body>
  <div class="wrap" role="main">
    <h1>Unischooly — Book Trial (Test)</h1>
    <p class="lead">This page is a single-file 3-step booking flow for testing with Supabase. It follows your schema exactly.</p>

    <div id="status" class="status"></div>

    <!-- STEP 1 -->
    <div id="step1" class="step active" aria-hidden="false">
      <h2>Step 1 — Contact & Child</h2>
      <div class="muted" style="margin-bottom:12px">Fill details — this will upsert into <code>demo_leads</code> with page_completed = 1</div>

      <div style="margin-bottom:10px">
        <label>Country</label>
        <select id="country_select" aria-label="Country"></select>
      </div>

      <div style="margin-bottom:10px">
        <label>WhatsApp number</label>
        <input id="phone_input" type="tel" placeholder="Enter mobile number" />
        <div class="small">Phone is saved as <code>phone_country_code</code> and <code>phone_number</code> (digits only).</div>
      </div>

      <div class="row" style="margin-bottom:10px">
        <div class="col">
          <label>Child's name</label>
          <input id="child_name" type="text" placeholder="Child's name" />
        </div>
        <div class="col">
          <label>Child's grade</label>
          <select id="child_grade">
            <option value="">Select grade</option>
            <option value="Grade 1">Grade 1</option>
            <option value="Grade 2">Grade 2</option>
            <option value="Grade 3">Grade 3</option>
            <option value="Grade 4">Grade 4</option>
            <option value="Grade 5">Grade 5</option>
            <option value="Grade 6">Grade 6</option>
            <option value="Grade 7">Grade 7</option>
            <option value="Grade 8">Grade 8</option>
            <option value="Grade 9">Grade 9</option>
            <option value="Grade 10">Grade 10</option>
            <option value="Grade 11">Grade 11</option>
            <option value="Grade 12">Grade 12</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-bottom:10px">
        <div class="col">
          <label>Parent / Guardian name</label>
          <input id="parent_name" type="text" placeholder="Parent full name" />
        </div>
        <div class="col">
          <label>Parent email</label>
          <input id="parent_email" type="email" placeholder="example@email.com" />
        </div>
      </div>

      <div style="margin-bottom:10px">
        <label>Do you have a Laptop / Desktop?</label>
        <div class="radio-group" id="laptop_grp">
          <button class="pill selected" data-val="Yes">Yes</button>
          <button class="pill" data-val="No">No (Tablet/Mobile)</button>
        </div>
      </div>

      <div style="display:flex;gap:8px">
        <button id="step1_next" class="primary">Continue to Step 2 →</button>
        <button id="debug_btn" style="background:transparent;border:1px solid rgba(148,163,184,0.08);color:var(--muted);padding:8px 12px;border-radius:8px">Show debug</button>
      </div>
    </div>

    <!-- STEP 2 -->
    <div id="step2" class="step" aria-hidden="true">
      <h2>Step 2 — Select Date & Time</h2>
      <div class="muted" style="margin-bottom:12px">Shows Today + next 5 days for selected region & course. Default language: English</div>

      <div id="slots_area" style="margin-bottom:12px">
        <div id="slots_loading" class="small">Loading available slots…</div>
        <div id="no_slots" class="small" style="display:none">No slots available for the next 5 days.</div>

        <div id="dates_pills" class="date-row" style="margin:8px 0"></div>
        <div id="times_pills" class="time-row" style="margin:8px 0"></div>
      </div>

      <div style="margin-bottom:8px">
        <label>Language</label>
        <div id="lang_grp" class="radio-group"></div>
      </div>

      <div style="display:flex;gap:8px">
        <button id="step2_prev" style="background:transparent;border:1px solid rgba(148,163,184,0.08);color:var(--muted);padding:8px 12px;border-radius:8px">← Back</button>
        <button id="step2_next" class="primary" disabled>Confirm time & Continue →</button>
      </div>

      <div id="selected_summary" class="summary small" style="display:none"></div>
    </div>

    <!-- STEP 3 -->
    <div id="step3" class="step" aria-hidden="true">
      <h2>Step 3 — Motivation & Intent</h2>
      <div class="muted" style="margin-bottom:12px">This will update the same demo_leads row and set page_completed = 3</div>

      <div style="margin-bottom:10px">
        <label>Who are you?</label>
        <div id="who_grp" class="radio-group"></div>
      </div>

      <div style="margin-bottom:10px">
        <label>Why are you booking this trial class?</label>
        <div id="why_grp" class="radio-group"></div>
      </div>

      <div style="margin-bottom:10px">
        <label>When are you planning to purchase?</label>
        <div id="when_grp" class="radio-group"></div>
      </div>

      <div style="display:flex;gap:8px">
        <button id="step3_prev" style="background:transparent;border:1px solid rgba(148,163,184,0.08);color:var(--muted);padding:8px 12px;border-radius:8px">← Back</button>
        <button id="step3_submit" class="primary">Submit & Finish</button>
      </div>
    </div>

    <!-- FINAL -->
    <div id="final_msg" class="step" aria-hidden="true" style="text-align:center">
      <h2>All done — Thank you!</h2>
      <p class="muted">You’ll receive confirmation on WhatsApp & Email. Check the <code>demo_leads</code> table to verify the saved data.</p>
    </div>

    <pre id="debug" class="debug" style="display:none"></pre>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.5.6/build/js/intlTelInput.min.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const COUNTRY_OPTIONS = [
      { code: "IN", name: "India", dial: "+91", regionKey: "ASIA", timezone: "Asia/Kolkata" },
      { code: "AE", name: "United Arab Emirates", dial: "+971", regionKey: "MEA", timezone: "Asia/Dubai" },
      { code: "SA", name: "Saudi Arabia", dial: "+966", regionKey: "MEA", timezone: "Asia/Riyadh" },
      { code: "OM", name: "Oman", dial: "+968", regionKey: "MEA", timezone: "Asia/Muscat" },
      { code: "QA", name: "Qatar", dial: "+974", regionKey: "MEA", timezone: "Asia/Qatar" },
      { code: "KW", name: "Kuwait", dial: "+965", regionKey: "MEA", timezone: "Asia/Kuwait" },
      { code: "BH", name: "Bahrain", dial: "+973", regionKey: "MEA", timezone: "Asia/Bahrain" },
      { code: "US", name: "United States", dial: "+1", regionKey: "USA", timezone: "America/New_York" },
      { code: "CA", name: "Canada", dial: "+1", regionKey: "USA", timezone: "America/Toronto" },
      { code: "GB", name: "United Kingdom", dial: "+44", regionKey: "EUROPE", timezone: "Europe/London" },
      { code: "FR", name: "France", dial: "+33", regionKey: "EUROPE", timezone: "Europe/Paris" },
      { code: "DE", name: "Germany", dial: "+49", regionKey: "EUROPE", timezone: "Europe/Berlin" },
      { code: "SG", name: "Singapore", dial: "+65", regionKey: "SEA", timezone: "Asia/Singapore" },
      { code: "MY", name: "Malaysia", dial: "+60", regionKey: "SEA", timezone: "Asia/Kuala_Lumpur" },
      { code: "ID", name: "Indonesia", dial: "+62", regionKey: "SEA", timezone: "Asia/Jakarta" },
      { code: "PH", name: "Philippines", dial: "+63", regionKey: "SEA", timezone: "Asia/Manila" },
      { code: "VN", name: "Vietnam", dial: "+84", regionKey: "SEA", timezone: "Asia/Ho_Chi_Minh" },
      { code: "TH", name: "Thailand", dial: "+66", regionKey: "SEA", timezone: "Asia/Bangkok" },
      { code: "AU", name: "Australia", dial: "+61", regionKey: "ANZ", timezone: "Australia/Sydney" },
      { code: "NZ", name: "New Zealand", dial: "+64", regionKey: "ANZ", timezone: "Pacific/Auckland" },
      { code: "JP", name: "Japan", dial: "+81", regionKey: "ASIA", timezone: "Asia/Tokyo" },
      { code: "KR", name: "South Korea", dial: "+82", regionKey: "ASIA", timezone: "Asia/Seoul" },
      { code: "CN", name: "China", dial: "+86", regionKey: "ASIA", timezone: "Asia/Shanghai" }
    ];
    const DEFAULT_COUNTRY = "IN";
    const LANGS = ["english","arabic","bahasa","vietnamese","filipino","thai"];

    const $ = (id)=>document.getElementById(id);
    const statusEl = $("status");
    const debugEl = $("debug");

    let leadId = null;
    let leadRow = null;
    let selectedRegion = null;
    let selectedTimezone = null;
    let selectedSlotObj = null;

    const urlParams = new URLSearchParams(location.search);
    let selectedCourseId = parseInt(urlParams.get("courseId") || "1", 10);
    let selectedLang = (urlParams.get("lang") || "english").toLowerCase();

    function setStatus(msg, ok=true){
      statusEl.textContent = msg;
      statusEl.className = "status " + (ok ? "ok" : "err");
    }
    function showDebug(obj){
      debugEl.style.display = debugEl.style.display === "none" ? "block" : "none";
      debugEl.textContent = JSON.stringify(obj,null,2);
    }

    function showStepById(id){
      document.querySelectorAll(".step").forEach(s=>{
        s.classList.remove("active");
        s.setAttribute("aria-hidden","true");
      });
      const el = $(id);
      if(el){
        el.classList.add("active");
        el.setAttribute("aria-hidden","false");
      }
      window.scrollTo(0,0);
    }

    function showStep(n){ showStepById("step"+n); }

    function initCountrySelect(){
      const sel = $("country_select");
      sel.innerHTML = "";
      COUNTRY_OPTIONS.forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c.code;
        opt.textContent = `${c.name} (${c.dial})`;
        sel.appendChild(opt);
      });
      sel.value = DEFAULT_COUNTRY;
      sel.addEventListener("change", onCountryChange);
      onCountryChange();
    }

    function onCountryChange(){
      const code = $("country_select").value;
      const obj = COUNTRY_OPTIONS.find(c=>c.code===code) || COUNTRY_OPTIONS[0];
      selectedRegion = obj.regionKey;
      selectedTimezone = obj.timezone;
      if(window.iti){ try{ window.iti.setCountry(code.toLowerCase()); }catch(e){} }
    }

    function initLaptopPills(){
      document.querySelectorAll("#laptop_grp .pill").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          document.querySelectorAll("#laptop_grp .pill").forEach(b=>b.classList.remove("selected"));
          btn.classList.add("selected");
        });
      });
    }

    function initLangPills(){
      const lg = $("lang_grp");
      LANGS.forEach(lang=>{
        const b = document.createElement("button");
        b.className = "pill " + (lang===selectedLang ? "selected" : "");
        b.textContent = lang.charAt(0).toUpperCase()+lang.slice(1);
        b.dataset.val = lang;
        b.addEventListener("click", ()=>{
          document.querySelectorAll("#lang_grp .pill").forEach(x=>x.classList.remove("selected"));
          b.classList.add("selected");
          selectedLang = lang;
        });
        lg.appendChild(b);
      });
    }

    function initStep3Pills(){
      const whoOpts = ["Parent","Student","Guardian"];
      const whyOpts = ["Want to buy course","To Compare Platform","To strengthen Concept","Just for free demo"];
      const whenOpts = ["After the Demo","This Week","This Month","Just Exploring"];

      whoOpts.forEach(o=>{
        const b = document.createElement("button");
        b.className = "pill";
        b.textContent = o;
        b.dataset.val = o;
        b.addEventListener("click", ()=>{
          document.querySelectorAll("#who_grp .pill").forEach(x=>x.classList.remove("selected"));
          b.classList.add("selected");
        });
        $("who_grp").appendChild(b);
      });
      whyOpts.forEach(o=>{
        const b = document.createElement("button");
        b.className = "pill";
        b.textContent = o;
        b.dataset.val = o;
        b.addEventListener("click", ()=>{
          document.querySelectorAll("#why_grp .pill").forEach(x=>x.classList.remove("selected"));
          b.classList.add("selected");
        });
        $("why_grp").appendChild(b);
      });
      whenOpts.forEach(o=>{
        const b = document.createElement("button");
        b.className = "pill";
        b.textContent = o;
        b.dataset.val = o;
        b.addEventListener("click", ()=>{
          document.querySelectorAll("#when_grp .pill").forEach(x=>x.classList.remove("selected"));
          b.classList.add("selected");
        });
        $("when_grp").appendChild(b);
      });
    }

    function format12(date){
      const d = new Date(date);
      let h = d.getHours();
      const m = String(d.getMinutes()).padStart(2,"0");
      const ampm = h >= 12 ? "PM" : "AM";
      h = ((h+11)%12)+1;
      return `${String(h).padStart(2,"0")}:${m} ${ampm}`;
    }
    function dateKey(date){ return new Date(date).toISOString().slice(0,10); }
    function prettyDateTop(dateStr){
      const d = new Date(dateStr+"T00:00:00");
      const today = new Date();
      if(dateKey(d) === dateKey(today)) return "Today";
      const t2 = new Date(); t2.setDate(t2.getDate()+1);
      if(dateKey(d) === dateKey(t2)) return "Tomorrow";
      return d.toLocaleDateString("en-US",{weekday:"short"});
    }
    function prettyDateBottom(dateStr){
      const d = new Date(dateStr+"T00:00:00");
      return `${String(d.getDate()).padStart(2,"0")} ${d.toLocaleDateString("en-US",{month:"short"})}`;
    }

    async function step1Save(){
      setStatus("Saving lead…");

      const phoneInput = $("phone_input");
      const phoneRaw = phoneInput.value || "";
      const countryData = window.iti ? window.iti.getSelectedCountryData() : null;
      const defaultDial = COUNTRY_OPTIONS.find(c=>c.code===DEFAULT_COUNTRY).dial.replace("+","");
      const phone_country_code = "+" + (countryData?.dialCode || defaultDial);
      const phone_number = phoneRaw.replace(/\D/g,"");

      const child_name = $("child_name").value.trim();
      const child_grade = $("child_grade").value;
      const parent_name = $("parent_name").value.trim();
      const parent_email = $("parent_email").value.trim();
      const has_laptop = document.querySelector("#laptop_grp .pill.selected")?.dataset.val || "Yes";

      const countryCode = $("country_select").value;
      const countryObj = COUNTRY_OPTIONS.find(c=>c.code===countryCode) || COUNTRY_OPTIONS[0];

      if(!phone_number || !child_name || !child_grade || !parent_name || !parent_email){
        setStatus("Please fill all required fields.", false);
        return;
      }

      let ipinfo = {};
      try{
        const r = await fetch("https://ipapi.co/json");
        ipinfo = await r.json();
      }catch(e){ ipinfo = {}; }

      const payload = {
        child_name,
        child_grade,
        parent_name,
        parent_email,
        phone_country_code,
        phone_number,
        has_laptop,
        course_id: selectedCourseId,
        lang: selectedLang,
        page_completed: 1,
        region_key: countryObj.regionKey,
        country: ipinfo.country_name || countryObj.name,
        timezone: countryObj.timezone,
        ip_address: ipinfo.ip || null,
        city: ipinfo.city || null
      };

      try{
        const { data, error } = await supabase
          .from("demo_leads")
          .upsert(payload, { onConflict: "phone_country_code,phone_number" })
          .select("id, phone_country_code, phone_number, region_key, country, timezone")
          .single();
        if(error) throw error;
        leadId = data.id;
        leadRow = data;
        setStatus("Lead saved — loading slots…", true);
        await loadSlots();
        showStep(2);
      }catch(err){
        console.error("step1 err:", err);
        setStatus("Failed to save lead: " + (err.message || JSON.stringify(err)), false);
      }
    }

    async function loadSlots(){
      $("slots_loading").style.display="block";
      $("no_slots").style.display="none";
      $("dates_pills").innerHTML="";
      $("times_pills").innerHTML="";
      $("selected_summary").style.display="none";
      selectedSlotObj=null;
      $("step2_next").disabled=true;

      const today = new Date();
      const end = new Date(); end.setDate(end.getDate()+5);
      const todayKey = today.toISOString().slice(0,10);
      const endKey = end.toISOString().slice(0,10);

      try{
        const { data, error } = await supabase
          .from("demo_slots_live")
          .select("slot_id, slot_date, slot_datetime_local, is_star_teacher, region_key, course_id")
          .eq("region_key", selectedRegion)
          .eq("course_id", selectedCourseId)
          .gte("slot_date", todayKey)
          .lte("slot_date", endKey)
          .order("slot_datetime_local",{ascending:true});
        if(error) throw error;

        const nowEpoch = Date.now();
        const minEpoch = nowEpoch + 60*60*1000; // +1 hour
        const slots = (data || []).filter(s => new Date(s.slot_datetime_local).getTime() >= minEpoch);

        if(!slots.length){
          $("slots_loading").style.display="none";
          $("no_slots").style.display="block";
          return;
        }

        const grouped = {};
        slots.forEach(s=>{
          if(!grouped[s.slot_date]) grouped[s.slot_date]=[];
          grouped[s.slot_date].push(s);
        });

        const dates = Object.keys(grouped).sort();
        const datesP = $("dates_pills");
        dates.forEach(ds=>{
          const btn = document.createElement("button");
          btn.className="pill";
          btn.innerHTML = `<div style="text-align:left">${prettyDateTop(ds)}<div style="font-size:12px;color:var(--muted)">${prettyDateBottom(ds)}</div></div>`;
          btn.dataset.date=ds;
          btn.addEventListener("click", ()=>{
            document.querySelectorAll("#dates_pills .pill").forEach(p=>p.classList.remove("selected"));
            btn.classList.add("selected");
            renderTimesForDate(ds, grouped[ds]);
          });
          datesP.appendChild(btn);
        });

        // auto-select the first date
        datesP.querySelector(".pill").click();
        $("slots_loading").style.display="none";
      }catch(err){
        console.error("loadSlots err:", err);
        setStatus("Failed to load slots: " + (err.message || JSON.stringify(err)), false);
        $("slots_loading").style.display="none";
      }
    }

    function renderTimesForDate(dateStr, slotsArr){
      const timesP = $("times_pills");
      timesP.innerHTML="";
      slotsArr.forEach(s=>{
        const timeLabel = format12(s.slot_datetime_local);
        const btn = document.createElement("button");
        btn.className="time-pill";
        if(s.is_star_teacher) btn.classList.add("star");
        btn.textContent = (s.is_star_teacher ? "★ " : "") + timeLabel;
        btn.addEventListener("click", ()=>{
          document.querySelectorAll(".time-pill").forEach(p=>p.classList.remove("selected"));
          btn.classList.add("selected");
          selectedSlotObj = s;
          $("step2_next").disabled = false;
          $("selected_summary").style.display="block";
          $("selected_summary").textContent =
            `Selected: ${prettyDateTop(dateStr)} ${prettyDateBottom(dateStr)} • ${timeLabel}` +
            (s.is_star_teacher ? " • Star teacher" : "");
        });
        timesP.appendChild(btn);
      });
    }

    async function step2Confirm(){
      if(!leadId || !selectedSlotObj){
        setStatus("Please select a date/time", false);
        return;
      }
      setStatus("Saving selection…");
      const timeLabel = format12(selectedSlotObj.slot_datetime_local);
      try{
        const { error } = await supabase
          .from("demo_leads")
          .update({
            preferred_date: selectedSlotObj.slot_date,
            preferred_time_slot: timeLabel,
            slot_id: selectedSlotObj.slot_id,
            star_teacher_selected: selectedSlotObj.is_star_teacher,
            lang: selectedLang.toLowerCase(),
            page_completed: 2
          })
          .eq("id", leadId);
        if(error) throw error;
        setStatus("Slot saved. Proceed to Step 3.", true);
        showStep(3);
      }catch(err){
        console.error("step2 err:", err);
        setStatus("Failed to save slot: " + (err.message || JSON.stringify(err)), false);
      }
    }

    async function step3Submit(){
      const who = document.querySelector("#who_grp .pill.selected")?.dataset.val || null;
      const why = document.querySelector("#why_grp .pill.selected")?.dataset.val || null;
      const when = document.querySelector("#when_grp .pill.selected")?.dataset.val || null;
      if(!who || !why || !when){
        setStatus("Please pick all options.", false);
        return;
      }
      setStatus("Submitting final details…");
      try{
        const { error } = await supabase
          .from("demo_leads")
          .update({
            who_are_you: who,
            booking_reason: why,
            purchase_timeline: when,
            page_completed: 3
          })
          .eq("id", leadId);
        if(error) throw error;
        setStatus("All done — saved.", true);
        showStepById("final_msg");
      }catch(err){
        console.error("final err:", err);
        setStatus("Failed to finalize: " + (err.message || JSON.stringify(err)), false);
      }
    }

    // --- init once DOM & scripts are ready ---
    window.addEventListener("load", () => {
      // init phone input safely
      const phoneInput = $("phone_input");
      if(window.intlTelInput){
        window.iti = window.intlTelInput(phoneInput, {
          initialCountry: DEFAULT_COUNTRY.toLowerCase(),
          utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.5.6/build/js/utils.js",
          separateDialCode: true,
          geoIpLookup: (cb) => {
            fetch("https://ipapi.co/json")
              .then(r=>r.json())
              .then(d=>{
                if(d && d.country){
                  cb(d.country);
                  try{
                    $("country_select").value = d.country;
                    onCountryChange();
                  }catch(e){}
                } else cb(DEFAULT_COUNTRY);
              })
              .catch(()=>cb(DEFAULT_COUNTRY));
          }
        });
      } else {
        console.warn("intlTelInput not loaded; phone input will be basic.");
      }

      initCountrySelect();
      initLaptopPills();
      initLangPills();
      initStep3Pills();

      $("step1_next").addEventListener("click", step1Save);
      $("step2_prev").addEventListener("click", ()=>showStep(1));
      $("step2_next").addEventListener("click", step2Confirm);
      $("step3_prev").addEventListener("click", ()=>showStep(2));
      $("step3_submit").addEventListener("click", step3Submit);
      $("debug_btn").addEventListener("click", ()=>showDebug({leadId,leadRow,selectedRegion,selectedTimezone,selectedCourseId:selectedCourseId,selectedSlotObj}));
    });
  </script>
</body>
</html>
