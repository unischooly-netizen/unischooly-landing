<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unischooly | Book Trial Class</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <!-- intl-tel-input -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/18.5.6/css/intlTelInput.css" integrity="sha512-I7+0zvJ7u2vXrHddAq4p1iZ3wG8V8X9V1iG2pT0rvSxG0zXZN+F3dBL+XlGvGmFhZl5dV0t1Ik5+pUvNbK/Cw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/18.5.6/js/intlTelInput.min.js" integrity="sha512-lvT5iAG2wE5t5LqvCwVdYlXWZLxQ7sS2QWwZktc6yJhU3QqZ4H0lS5lZlZ8FQFJdI7tCwRbkqVKgf/mBlC9cw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top left, #1b2744 0, #050816 55%, #02030a 100%);
      color: #f9fafb;
    }
    *, *::before, *::after { box-sizing: border-box; }

    .page {
      min-height: 100vh;
      padding: 24px 24px 40px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      background: url("https://res.cloudinary.com/dpapyknn4/image/upload/v1765120532/kid-coding-infographic-icon-neon-boy-programming-on-laptop-in-computer-language-children-learning-kids-coding-school-teach-to-create-computer-and-mobile-phone-apps-vector_kswxdi.jpg") center/cover no-repeat fixed;
    }
    .page::before {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(80,0,150,0.55), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(0,120,255,0.5), transparent 55%),
                  rgba(3,7,18,0.86);
      pointer-events: none;
      z-index: -1;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 22px;
      letter-spacing: 0.02em;
    }
    .logo-mark {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #ff63d8, #7c3aed 50%, #22d3ee 110%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }
    .logo-text {
      background: linear-gradient(90deg, #ff63d8, #7c3aed, #22d3ee);
      -webkit-background-clip: text;
      color: transparent;
    }

    .nav {
      display: flex;
      align-items: center;
      gap: 28px;
      font-size: 14px;
      color: #e5e7eb;
    }
    .nav a {
      color: inherit;
      text-decoration: none;
      opacity: 0.78;
    }
    .nav a:hover { opacity: 1; }
    .nav-cta {
      padding: 10px 22px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: linear-gradient(120deg, #ff63d8, #7c3aed, #22d3ee);
      color: #0b1120;
      font-weight: 600;
      box-shadow: 0 8px 30px rgba(56, 189, 248, 0.35);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.95fr);
      gap: 32px;
      align-items: flex-start;
    }
    @media (max-width: 960px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
      .page { padding: 16px 16px 32px; }
      header { margin-bottom: 20px; }
    }

    .hero-eyebrow {
      font-size: 14px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #a5b4fc;
      margin-bottom: 12px;
    }
    .hero-title {
      font-size: clamp(32px, 4vw, 44px);
      line-height: 1.1;
      font-weight: 800;
      margin: 0 0 10px;
      color: #e5e7eb;
    }
    .hero-title span.accent {
      background: linear-gradient(120deg, #ff63d8, #7c3aed, #22d3ee);
      -webkit-background-clip: text;
      color: transparent;
      text-shadow: 0 0 16px rgba(129, 140, 248, 0.75);
    }
    .hero-subtitle {
      font-size: 16px;
      color: #cbd5f5;
      margin-bottom: 28px;
      max-width: 520px;
    }
    .hero-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }
    .hero-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.9), rgba(15,23,42,0.55));
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow: 0 10px 30px rgba(15,23,42,0.9);
      font-size: 14px;
      color: #e5e7eb;
    }

    /* Card */
    .card {
      background: radial-gradient(circle at top left, rgba(15,23,42, 0.98), rgba(15,23,42, 0.96));
      border-radius: 28px;
      padding: 22px 24px 24px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow: 0 24px 80px rgba(15,23,42, 0.95);
      color: #f9fafb;
    }
    @media (max-width: 960px) {
      .card { padding: 20px 18px; }
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 20px;
      background: linear-gradient(120deg, #ff63d8, #7c3aed, #22d3ee);
      -webkit-background-clip: text;
      color: transparent;
    }
    .step-caption {
      font-size: 13px;
      color: #d1d5db;
      margin-bottom: 20px;
    }

    .step-progress {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 22px;
    }
    .step-progress div {
      height: 4px;
      border-radius: 999px;
      background: radial-gradient(circle at center, rgba(30,64,175,0.95), rgba(15,23,42,1));
      opacity: 0.45;
    }
    .step-progress div.active-1 { background: linear-gradient(90deg,#ff63d8,#7c3aed,#22d3ee); opacity: 1; }
    .step-progress.step-2 div:nth-child(-n+2),
    .step-progress.step-3 div { opacity: 1; background: linear-gradient(90deg,#ff63d8,#7c3aed,#22d3ee); }

    .field-label-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: #e5e7eb;
      margin-bottom: 6px;
    }
    .field-label-row span.helper {
      color: #9ca3af;
      font-size: 12px;
    }

    .input,
    .select,
    .textarea {
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(55,65,81,0.9);
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(15,23,42,0.95));
      padding: 11px 13px;
      color: #f9fafb;
      font-size: 14px;
      outline: none;
      box-shadow: 0 0 0 1px rgba(15,23,42,1);
    }
    .input::placeholder { color: #6b7280; }
    .select { padding-right: 32px; }
    .input:focus,
    .select:focus,
    .textarea:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #0ea5e9;
    }
    .field-group {
      margin-bottom: 14px;
    }

    .inline-cols {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 640px) {
      .inline-cols { grid-template-columns: 1fr; }
    }

    .phone-wrap {
      display: grid;
      grid-template-columns: 0.9fr 1.1fr;
      gap: 10px;
    }
    @media (max-width: 640px) {
      .phone-wrap { grid-template-columns: minmax(0,1fr); }
    }
    .phone-country-label {
      font-size: 11px;
      color: #9ca3af;
      margin-top: -2px;
      margin-bottom: 4px;
    }

    .radio-row {
      display: flex;
      gap: 16px;
      font-size: 14px;
      align-items: center;
    }
    .radio-row label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .slot-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 640px) {
      .slot-grid { grid-template-columns: minmax(0,1fr); }
    }
    .slot-btn {
      position: relative;
      padding: 10px 12px 9px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.75);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.96), rgba(15,23,42,0.94));
      color: #f9fafb;
      font-size: 13px;
      text-align: left;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 3px;
      transition: all 0.16s ease-out;
    }
    .slot-btn .time-text {
      font-weight: 500;
      color: #f9fafb;
    }
    .slot-btn .meta-text {
      font-size: 11px;
      color: #9ca3af;
    }
    .slot-btn .star-tag {
      position: absolute;
      left: 10px;
      bottom: 8px;
      font-size: 11px;
      color: #facc15;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .slot-btn.disabled {
      opacity: 0.35;
      cursor: not-allowed;
    }
    .slot-btn.selected {
      border-color: rgba(251,191,36,0.95);
      box-shadow: 0 0 0 1px rgba(251,191,36,0.9), 0 12px 32px rgba(148,163,184,0.35);
      background: linear-gradient(120deg, rgba(56,189,248,0.15), rgba(129,140,248,0.3));
    }

    .date-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0 6px;
    }
    .date-pill {
      padding: 9px 12px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(15,23,42,0.93));
      font-size: 12px;
      color: #e5e7eb;
      cursor: pointer;
      min-width: 112px;
      text-align: center;
    }
    .date-pill strong { display:block; font-size: 13px; color:#f9fafb; }
    .date-pill span.small { font-size:11px; color:#9ca3af; }
    .date-pill.selected {
      background: linear-gradient(120deg, #ff63d8, #7c3aed, #22d3ee);
      color: #0b1120;
      border-color: transparent;
      box-shadow: 0 10px 28px rgba(56,189,248,0.4);
    }
    .date-pill.selected strong,
    .date-pill.selected span.small { color:#0b1120; }

    .consent-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-top: 12px;
      font-size: 12px;
      color: #e5e7eb;
    }
    .consent-row input[type="checkbox"] {
      margin-top: 3px;
      width: 16px;
      height: 16px;
      accent-color: #22c55e;
    }

    .help-text {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
    }

    .btn-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 18px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      padding: 11px 20px;
      font-size: 14px;
      border: 1px solid transparent;
      cursor: pointer;
    }
    .btn-primary {
      flex: 1;
      background: linear-gradient(120deg, #ff63d8, #7c3aed, #22d3ee);
      color: #0b1120;
      font-weight: 600;
      box-shadow: 0 14px 40px rgba(56,189,248,0.45);
    }
    .btn-secondary {
      background: transparent;
      border-color: rgba(148,163,184,0.7);
      color: #e5e7eb;
      min-width: 110px;
    }
    .btn[disabled] {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
    }

    .status-message {
      margin-top: 10px;
      font-size: 12px;
      color: #bbf7d0;
    }
    .status-error { color: #fecaca; }

    .chips-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }
    .chip-option {
      padding: 8px 13px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 13px;
      cursor: pointer;
      color: #e5e7eb;
      background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(15,23,42,0.92));
    }
    .chip-option.selected {
      background: linear-gradient(120deg, #ff63d8, #7c3aed, #22d3ee);
      color: #0b1120;
      border-color: transparent;
    }

    .footer-note {
      margin-top: 8px;
      font-size: 11px;
      color: #a5b4fc;
    }

    .hidden { display: none; }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="logo">
      <div class="logo-mark">U</div>
      <div class="logo-text">Unischooly</div>
    </div>
    <nav class="nav">
      <a href="#programs">Programs</a>
      <a href="#experts">Meet our Experts</a>
      <a href="#curriculum">Curriculum</a>
      <a href="#faqs">FAQs</a>
      <button class="nav-cta" type="button" onclick="scrollToForm()">Book Trial Class</button>
    </nav>
  </header>

  <main class="layout">
    <section>
      <div class="hero-eyebrow">For curious kids in 30+ countries</div>
      <h1 class="hero-title">
        Book a <span class="accent">Free Live Coding<br/>Class</span> for your child.
      </h1>
      <p class="hero-subtitle">
        A personalised 60-minute class to introduce your child to coding, logic skills & futuristic learning.
      </p>
      <div class="hero-badges">
        <div class="hero-pill">‚è± 60-min Live Class</div>
        <div class="hero-pill">üèÖ Top 1% Certified Teachers</div>
        <div class="hero-pill">üåç Kids in 30+ Countries</div>
        <div class="hero-pill">üöÄ Hands-On Projects</div>
      </div>
    </section>

    <section id="booking-card">
      <div class="card">
        <h2>Book Now &amp; Get Certified</h2>
        <p class="step-caption" id="step-caption">
          Step 1 of 3 ¬∑ Share your child &amp; parent details to unlock a personalised trial class.
        </p>
        <div class="step-progress step-1" id="step-progress">
          <div class="active-1"></div><div></div><div></div>
        </div>

        <!-- STEP 1 -->
        <form id="step1-form">
          <div class="field-group">
            <div class="field-label-row">
              <span>Parent WhatsApp Number</span>
              <span class="helper">We‚Äôll send class details on WhatsApp.</span>
            </div>
            <div class="phone-wrap">
              <div>
                <div class="phone-country-label">Country code</div>
                <input id="phone-input" type="tel" class="input" />
              </div>
              <div>
                <div class="phone-country-label">Mobile number</div>
                <input id="plain-phone-input" class="input" placeholder="Enter mobile number" />
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <span>Child Name</span>
            </div>
            <input id="child-name" class="input" placeholder="Enter child's name" />
          </div>

          <div class="field-group">
            <div class="field-label-row"><span>Child Grade</span></div>
            <select id="child-grade" class="select">
              <option value="">Select Grade</option>
              <option>Grade 1</option><option>Grade 2</option><option>Grade 3</option>
              <option>Grade 4</option><option>Grade 5</option><option>Grade 6</option>
              <option>Grade 7</option><option>Grade 8</option><option>Grade 9</option>
              <option>Grade 10</option><option>Grade 11</option><option>Grade 12</option>
            </select>
          </div>

          <div class="field-group inline-cols">
            <div>
              <div class="field-label-row"><span>Parent Name</span></div>
              <input id="parent-name" class="input" placeholder="Enter parent name" />
            </div>
            <div>
              <div class="field-label-row"><span>Parent Email</span></div>
              <input id="parent-email" class="input" placeholder="Enter email" />
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <span>Do you have a Laptop or Desktop?</span>
            </div>
            <div class="radio-row">
              <label><input type="radio" name="has-laptop" value="Yes" checked /> Yes</label>
              <label><input type="radio" name="has-laptop" value="No" /> No</label>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn-secondary btn" type="button" onclick="goBackFromStep1()" disabled>Back</button>
            <button class="btn-primary btn" type="submit" id="step1-next-btn">Book a Free Trial Class ‚ú®</button>
          </div>
          <div class="status-message" id="status-msg-step1"></div>
        </form>

        <!-- STEP 2 -->
        <div id="step2" class="hidden">
          <div class="field-group">
            <div class="field-label-row">
              <span>Select Date</span>
              <span class="helper">You can choose a date within the next few days.</span>
            </div>
            <div id="date-tabs" class="date-tabs"></div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <span>Available Time Slots</span>
            </div>
            <div id="slots-container">
              <p class="help-text" id="slots-help-text">Pick a date to see available slots.</p>
              <div class="slot-grid" id="slot-grid"></div>
            </div>
            <p class="help-text">Times are shown in your local time zone.</p>
          </div>

          <div class="consent-row">
            <input id="consent-checkbox" type="checkbox" checked />
            <label for="consent-checkbox">
              I agree to be contacted by Unischooly via WhatsApp / Phone / Email for this booking.
            </label>
          </div>

          <div class="btn-row">
            <button class="btn-secondary btn" type="button" onclick="goToStep(1)">‚Üê Back</button>
            <button class="btn-primary btn" type="button" id="step2-next-btn" disabled>Confirm Slot ‚ú®</button>
          </div>
          <div class="status-message" id="status-msg-step2"></div>
        </div>

        <!-- STEP 3 -->
        <div id="step3" class="hidden">
          <div class="field-group">
            <div class="field-label-row"><span>Who are you?</span></div>
            <div class="chips-group" id="who-you-chips">
              <button type="button" class="chip-option" data-value="Parent">Parent</button>
              <button type="button" class="chip-option" data-value="Student">Student</button>
              <button type="button" class="chip-option" data-value="Relative / Guardian">Relative / Guardian</button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row"><span>Why did you book this demo?</span></div>
            <div class="chips-group" id="reason-chips">
              <button type="button" class="chip-option" data-value="To explore coding skills for my child">To explore coding skills for my child</button>
              <button type="button" class="chip-option" data-value="To compare with other platforms">To compare with other platforms</button>
              <button type="button" class="chip-option" data-value="To strengthen school concepts">To strengthen school concepts</button>
              <button type="button" class="chip-option" data-value="Just exploring / not sure yet">Just exploring / not sure yet</button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row"><span>When are you planning to purchase?</span></div>
            <div class="chips-group" id="purchase-chips">
              <button type="button" class="chip-option" data-value="Immediately after trial if it goes well">Immediately after trial if it goes well</button>
              <button type="button" class="chip-option" data-value="Within 1 week">Within 1 week</button>
              <button type="button" class="chip-option" data-value="Within 1‚Äì4 weeks">Within 1‚Äì4 weeks</button>
              <button type="button" class="chip-option" data-value="More than 1 month / not sure">More than 1 month / not sure</button>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn-secondary btn" type="button" onclick="goToStep(2)">‚Üê Back</button>
            <button class="btn-primary btn" type="button" id="step3-submit-btn" disabled>Confirm Booking ‚ú®</button>
          </div>
          <div class="status-message" id="status-msg-step3"></div>
          <p class="footer-note" id="footer-note"></p>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const urlParams = new URLSearchParams(window.location.search);
  const courseId = parseInt(urlParams.get("courseId") || "1", 10);
  const urlRegion = (urlParams.get("region") || "").toUpperCase() || null;
  const lang = urlParams.get("lang") || "english";

  let currentStep = 1;
  let iti;
  let leadRow = null;
  let selectedDateKey = null;
  let allSlotsForDate = [];
  let selectedSlotId = null;
  let selectedSlotLabel = "";
  let selectedRegionKey = null;

  function scrollToForm() {
    document.getElementById("booking-card").scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function initPhoneInput() {
    const input = document.getElementById("phone-input");
    iti = window.intlTelInput(input, {
      initialCountry: "auto",
      utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/18.5.6/js/utils.js",
      geoIpLookup: function(success) {
        fetch("https://ipapi.co/json/")
          .then(res => res.json())
          .then(data => success(data.country_code || "IN"))
          .catch(() => success("IN"));
      },
      separateDialCode: true
    });
  }

  function goBackFromStep1() {
    // no-op, kept for layout symmetry
  }

  function goToStep(step) {
    currentStep = step;
    document.getElementById("step1-form").classList.toggle("hidden", step !== 1);
    document.getElementById("step2").classList.toggle("hidden", step !== 2);
    document.getElementById("step3").classList.toggle("hidden", step !== 3);

    const stepCaption = document.getElementById("step-caption");
    const sp = document.getElementById("step-progress");
    sp.classList.remove("step-1","step-2","step-3");
    sp.classList.add("step-"+step);

    if (step === 1) {
      stepCaption.textContent = "Step 1 of 3 ¬∑ Share your child & parent details to unlock a personalised trial class.";
    } else if (step === 2) {
      stepCaption.textContent = "Step 2 of 3 ¬∑ Pick a convenient date & time for your child's trial class.";
    } else {
      stepCaption.textContent = "Step 3 of 3 ¬∑ Answer 3 quick questions to help us personalise the trial.";
    }
  }

  function formatDateLabel(date, index, todayLocal) {
    const sameDay = date.toDateString() === todayLocal.toDateString();
    const tomorrow = new Date(todayLocal.getTime() + 86400000);
    const isTomorrow = date.toDateString() === tomorrow.toDateString();

    let primary = "";
    if (sameDay) primary = "Today";
    else if (isTomorrow) primary = "Tomorrow";
    else primary = date.toLocaleDateString(undefined, { weekday: "short" });

    const day = date.toLocaleDateString(undefined, { day: "2-digit" });
    const month = date.toLocaleDateString(undefined, { month: "short" });

    return { primary, secondary: day + " " + month };
  }

  function formatTimeRangeLocal(startISO, endISO) {
    const start = new Date(startISO);
    const end = new Date(endISO);
    const opts = { hour: "2-digit", minute: "2-digit", hour12: true };
    const s = start.toLocaleTimeString(undefined, opts).toLowerCase().replace(" ", "");
    const e = end.toLocaleTimeString(undefined, opts).toLowerCase().replace(" ", "");
    return s + " - " + e;
  }

  function buildDateTabs(slots) {
    const dateTabs = document.getElementById("date-tabs");
    dateTabs.innerHTML = "";
    selectedDateKey = null;

    if (!slots.length) {
      document.getElementById("slots-help-text").textContent =
        "No slots available for the next few days. Our team will contact you on WhatsApp.";
      document.getElementById("slot-grid").innerHTML = "";
      return;
    }

    const grouped = {};
    slots.forEach(slot => {
      const d = new Date(slot.slot_start_ist);
      const ymd = d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();
      if (!grouped[ymd]) grouped[ymd] = [];
      grouped[ymd].push(slot);
    });

    const keys = Object.keys(grouped).sort((a,b) => new Date(a) - new Date(b));
    const todayLocal = new Date();

    keys.slice(0, 6).forEach((key, idx) => {
      const d = new Date(key);
      const { primary, secondary } = formatDateLabel(d, idx, todayLocal);

      const pill = document.createElement("button");
      pill.type = "button";
      pill.className = "date-pill";
      pill.dataset.key = key;
      pill.innerHTML = "<span class='small'>"+primary+"</span><strong>"+secondary+"</strong><span class='small'>"+(grouped[key].length)+" slots</span>";

      pill.addEventListener("click", () => {
        selectedDateKey = key;
        allSlotsForDate = grouped[key];
        Array.from(document.getElementsByClassName("date-pill")).forEach(p => p.classList.remove("selected"));
        pill.classList.add("selected");
        buildSlotsForSelectedDate();
      });

      if (idx === 0) {
        selectedDateKey = key;
        allSlotsForDate = grouped[key];
        pill.classList.add("selected");
      }

      dateTabs.appendChild(pill);
    });

    if (selectedDateKey) {
      buildSlotsForSelectedDate();
    }
  }

  function buildSlotsForSelectedDate() {
    const container = document.getElementById("slot-grid");
    const help = document.getElementById("slots-help-text");
    container.innerHTML = "";
    selectedSlotId = null;
    selectedSlotLabel = "";
    document.getElementById("step2-next-btn").disabled = true;

    if (!allSlotsForDate.length) {
      help.textContent = "No slots available for this date.";
      return;
    }
    help.textContent = "Class slots are limited. Please choose carefully.";

    const now = new Date();

    allSlotsForDate
      .sort((a,b) => new Date(a.slot_start_ist) - new Date(b.slot_start_ist))
      .forEach(slot => {
        const start = new Date(slot.slot_start_ist);
        const end = new Date(slot.slot_end_ist);

        const isToday = start.toDateString() === now.toDateString();
        let isTooSoon = false;
        if (isToday) {
          const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
          if (start < oneHourLater) isTooSoon = true;
        }
        const isFull = slot.capacity_booked >= slot.capacity_total;
        const disabled = isFull || isTooSoon || !slot.is_active;

        const label = formatTimeRangeLocal(slot.slot_start_ist, slot.slot_end_ist);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "slot-btn" + (disabled ? " disabled" : "");
        btn.dataset.id = slot.id;
        btn.innerHTML = "<span class='time-text'>"+label+"</span>";

        if (slot.is_star_teacher) {
          const tag = document.createElement("span");
          tag.className = "star-tag";
          tag.innerHTML = "‚≠ê Star Teacher";
          btn.appendChild(tag);
        }

        if (!disabled) {
          btn.addEventListener("click", () => {
            selectedSlotId = slot.id;
            selectedSlotLabel = label;
            Array.from(document.getElementsByClassName("slot-btn")).forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            document.getElementById("step2-next-btn").disabled = !document.getElementById("consent-checkbox").checked;
          });
        }

        container.appendChild(btn);
      });
  }

  async function fetchSlots(regionKeyEffective) {
    const { data, error } = await supabaseClient
      .from("demo_slots")
      .select("*")
      .eq("course_id", courseId)
      .eq("region_key", regionKeyEffective)
      .eq("is_active", true)
      .order("slot_start_ist", { ascending: true });

    if (error) {
      console.error("Error fetching slots", error);
      document.getElementById("slots-help-text").textContent = "Unable to load slots. Please try again.";
      return;
    }

    const now = new Date();
    const maxDaysAhead = 6;
    const latest = new Date(now.getTime() + maxDaysAhead * 24 * 60 * 60 * 1000);

    const filtered = (data || []).filter(slot => {
      const start = new Date(slot.slot_start_ist);
      return start >= now && start <= latest && slot.capacity_booked < slot.capacity_total;
    });

    buildDateTabs(filtered);
  }

  async function handleStep1Submit(evt) {
    evt.preventDefault();
    const statusEl = document.getElementById("status-msg-step1");
    statusEl.textContent = "";

    const childName = document.getElementById("child-name").value.trim();
    const childGrade = document.getElementById("child-grade").value;
    const parentName = document.getElementById("parent-name").value.trim();
    const parentEmail = document.getElementById("parent-email").value.trim();
    const phoneLocal = document.getElementById("plain-phone-input").value.trim();
    const hasLaptop = document.querySelector("input[name='has-laptop']:checked")?.value || null;

    if (!childName || !childGrade || !parentName || !parentEmail || !phoneLocal) {
      statusEl.textContent = "Please fill all required fields.";
      statusEl.classList.add("status-error");
      return;
    }

    const number = iti.getNumber();
    const countryData = iti.getSelectedCountryData();
    const phoneCountryCode = "+" + (countryData.dialCode || "");
    const regionKey = (urlRegion || countryData.region || "INDIA").toUpperCase();
    selectedRegionKey = regionKey;

    const leadPayload = {
      child_name: childName,
      child_grade: childGrade,
      parent_name: parentName,
      parent_email: parentEmail,
      phone_country_code: phoneCountryCode,
      phone_number: phoneLocal,
      is_whatsapp: true,
      has_laptop: hasLaptop,
      course_id: courseId,
      lang: lang,
      region_key: regionKey,
      full_url: window.location.href,
      landing_page_path: window.location.pathname,
      page_completed: 1
    };

    document.getElementById("step1-next-btn").disabled = true;

    const { data, error } = await supabaseClient
      .from("demo_leads")
      .upsert(leadPayload, { onConflict: "phone_country_code,phone_number", ignoreDuplicates: false })
      .select("*")
      .limit(1)
      .maybeSingle();

    document.getElementById("step1-next-btn").disabled = false;

    if (error) {
      console.error(error);
      statusEl.textContent = "Something went wrong while saving details. Please try again.";
      statusEl.classList.add("status-error");
      return;
    }

    leadRow = data;
    statusEl.textContent = "Step 1 saved! Now choose a date and time for your trial class.";
    statusEl.classList.remove("status-error");

    await fetchSlots(regionKey);
    goToStep(2);
  }

  function initChipGroup(containerId, onChange) {
    const el = document.getElementById(containerId);
    el.addEventListener("click", (e) => {
      const btn = e.target.closest(".chip-option");
      if (!btn) return;
      Array.from(el.getElementsByClassName("chip-option")).forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      onChange(btn.dataset.value);
    });
  }

  async function handleStep2Next() {
    const statusEl = document.getElementById("status-msg-step2");
    statusEl.textContent = "";

    if (!selectedSlotId) {
      statusEl.textContent = "Please select a time slot.";
      statusEl.classList.add("status-error");
      return;
    }
    if (!leadRow) {
      statusEl.textContent = "Lead not found. Please go back and fill Step 1 again.";
      statusEl.classList.add("status-error");
      return;
    }

    document.getElementById("step2-next-btn").disabled = true;

    const chosenSlot = allSlotsForDate.find(s => s.id === selectedSlotId);
    let preferredDate = null;
    let preferredTime = selectedSlotLabel;
    if (chosenSlot) {
      const d = new Date(chosenSlot.slot_start_ist);
      preferredDate = d.toISOString().slice(0,10);
    }

    const { data, error } = await supabaseClient
      .from("demo_leads")
      .update({
        preferred_date: preferredDate,
        preferred_time_slot: preferredTime,
        slot_id: selectedSlotId,
        page_completed: 2
      })
      .eq("id", leadRow.id)
      .select("*")
      .maybeSingle();

    document.getElementById("step2-next-btn").disabled = false;

    if (error) {
      console.error(error);
      statusEl.textContent = "Could not save your slot. Please try again.";
      statusEl.classList.add("status-error");
      return;
    }

    leadRow = data;
    statusEl.textContent = "Slot locked! Now answer 3 quick questions to finish.";
    statusEl.classList.remove("status-error");
    goToStep(3);
  }

  let whoValue = null, reasonValue = null, purchaseValue = null;

  async function handleStep3Submit() {
    const statusEl = document.getElementById("status-msg-step3");
    statusEl.textContent = "";

    if (!whoValue || !reasonValue || !purchaseValue) {
      statusEl.textContent = "Please answer all 3 questions.";
      statusEl.classList.add("status-error");
      return;
    }

    if (!leadRow) {
      statusEl.textContent = "Lead not found. Please restart the form.";
      statusEl.classList.add("status-error");
      return;
    }

    document.getElementById("step3-submit-btn").disabled = true;

    const { data, error } = await supabaseClient
      .from("demo_leads")
      .update({
        who_are_you: whoValue,
        booking_reason: reasonValue,
        purchase_timeline: purchaseValue,
        page_completed: 3
      })
      .eq("id", leadRow.id)
      .select("*")
      .maybeSingle();

    document.getElementById("step3-submit-btn").disabled = false;

    if (error) {
      console.error(error);
      statusEl.textContent = "Could not save your answers. Please try again.";
      statusEl.classList.add("status-error");
      return;
    }

    leadRow = data;
    statusEl.textContent = "Your trial class request has been submitted successfully!";
    statusEl.classList.remove("status-error");
    document.getElementById("footer-note").textContent =
      "You‚Äôll receive your class details and joining link on WhatsApp & email shortly.";
  }

  document.addEventListener("DOMContentLoaded", () => {
    initPhoneInput();
    document.getElementById("step1-form").addEventListener("submit", handleStep1Submit);
    document.getElementById("step2-next-btn").addEventListener("click", handleStep2Next);
    document.getElementById("consent-checkbox").addEventListener("change", (e) => {
      if (!selectedSlotId) return;
      document.getElementById("step2-next-btn").disabled = !e.target.checked;
    });

    initChipGroup("who-you-chips", (val) => { whoValue = val; document.getElementById("step3-submit-btn").disabled = !(whoValue && reasonValue && purchaseValue); });
    initChipGroup("reason-chips", (val) => { reasonValue = val; document.getElementById("step3-submit-btn").disabled = !(whoValue && reasonValue && purchaseValue); });
    initChipGroup("purchase-chips", (val) => { purchaseValue = val; document.getElementById("step3-submit-btn").disabled = !(whoValue && reasonValue && purchaseValue); });
  });
</script>
</body>
</html>
