<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unischooly | Demo Dashboard</title>
  <link rel="icon" type="image/svg+xml" href="https://res.cloudinary.com/dpapyknn4/image/upload/v1766210020/favicon_lgxj0r.svg">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#050816;
      --card:#0b0f24;
      --card2:#0f1633;
      --border:rgba(255,255,255,.10);
      --text:#f8f5ff;
      --sub:#a8acd0;
      --muted:#7b7fa9;
      --shadow:0 18px 40px rgba(0,0,0,.55);

      /* Brand gradient (logo vibes) */
      --g1:#9b5bff;
      --g2:#ff7b5f;
      --grad:linear-gradient(135deg,var(--g1),var(--g2));
      --radius:18px;
      --pill:999px;
      --t: .18s ease-out;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:radial-gradient(circle at top, #211a44 0, #050816 55%, #020010 100%);
    }

    .page{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:14px 12px 24px;
    }

    /* Section 1 - Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:22px;
      background:rgba(7,10,28,.72);
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .brand img{
      height:30px;
      width:auto;
      display:block;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,.55));
    }

    /* Animated Tick & Gradient for "Locked In" */
    .locked{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 16px;
      border-radius:var(--pill);
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color:white;
      font-weight:800;
      letter-spacing:.2px;
      font-size:13px;
      white-space:nowrap;
    }
    .locked-icon {
        width: 20px; height: 20px;
        border-radius: 50%;
        background: var(--grad);
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 10px rgba(155, 91, 255, 0.4);
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(155, 91, 255, 0.7); }
        70% { box-shadow: 0 0 0 8px rgba(155, 91, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(155, 91, 255, 0); }
    }

    /* Section 2 - Two column */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (min-width: 980px){
      .grid{grid-template-columns: 1fr 1fr;
      gap:14px;}
    }

    .card{
      background:radial-gradient(circle at 0 0, rgba(155,91,255,.18), transparent 55%), rgba(11,15,36,.92);
      border:1px solid var(--border);
      border-radius:26px;
      box-shadow:var(--shadow);
      position:relative;
      /* removed overflow:hidden to allow calendar popup to show */
    }
    .card-inner{padding:16px 14px;}
    @media (min-width: 720px){
      .card-inner{padding:18px 18px;}
    }

    /* Ticket look */
    .ticket{
      position:relative;
      background:
        radial-gradient(circle at 0 0, rgba(255,123,95,.18), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(155,91,255,.18), transparent 55%),
        rgba(12,16,40,.94);
      border:1px solid rgba(255,255,255,.14);
      border-radius:20px;
      overflow:hidden;
      transition: transform var(--t), box-shadow var(--t), border-color var(--t);
    }
    .ticket:hover{
      transform: translateY(-2px);
      border-color: rgba(155,91,255,.55);
      box-shadow:0 22px 48px rgba(0,0,0,.6);
    }

    .ticket::before, .ticket::after{
      content:"";
      position:absolute;
      top:50%;
      width:34px; height:34px;
      border-radius:50%;
      background: rgba(5,8,22,1);
      border:1px solid rgba(255,255,255,.12);
      transform: translateY(-50%);
      z-index:2;
    }
    .ticket::before{left:-17px}
    .ticket::after{right:-17px}

    .ticket-head{
      display:flex;
      align-items:flex-start; justify-content:space-between; gap:10px;
      padding:14px 14px 10px;
      border-bottom:1px dashed rgba(255,255,255,.18);
    }
    .ticket-title{
      font-weight:900;
      letter-spacing:.4px;
      font-size:13px;
      text-transform:uppercase;
      opacity:.98;
    }
    .ticket-sub{
      font-size:12px;
      color:var(--sub);
      margin-top:2px;
    }

    .stamp{
      position:absolute;
      right:12px; top:12px;
      transform: rotate(10deg);
      background: rgba(0,0,0,.25);
      border:2px solid rgba(255,255,255,.22);
      border-radius:14px;
      padding:10px 10px 8px;
      color:white;
      box-shadow:0 18px 30px rgba(0,0,0,.45);
      z-index:3;
      backdrop-filter: blur(6px);
    }
    .stamp .big{
      font-weight:1000;
      font-size:12px;
      letter-spacing:.6px;
      text-transform:uppercase;
      background:var(--grad);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .stamp .small{
      font-size:10px;
      color:rgba(255,255,255,.88);
      margin-top:2px;
      text-align:center;
    }

    .ticket-body{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding:12px 14px 14px;
    }
    @media (min-width: 520px){
      .ticket-body{grid-template-columns:1fr 1fr}
    }
    .ticket-col h4{
      margin:0 0 6px;
      font-size:12px;
      letter-spacing:.4px;
      color:rgba(255,255,255,.92);
      text-transform:uppercase;
    }
    .kv{
      display:grid;
      grid-template-columns: 86px 1fr;
      gap:8px 10px;
      font-size:13px;
      align-items:center;
    }
    .k{color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.3px}
    
    /* FIX: Email Overflow Ellipsis */
    .v{
        font-weight:800; color:var(--text); 
        min-width:0; 
        overflow:hidden; 
        text-overflow:ellipsis;
        white-space:nowrap;
        display: block;
    }
    /* Gradient text helper (used for names & missed state) */
        .gradText{
        background: var(--grad);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    .powered{
      text-align:center;
      font-size:10px;
      color:rgba(255,255,255,.70);
      padding:8px 10px 10px;
      border-top:1px dashed rgba(255,255,255,.14);
    }

    /* Schedule card */
    .schedule-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .schedule-title{
      display:flex; flex-direction:column; gap:2px;
    }
    .schedule-title .tag{
      display:inline-flex; align-items:center; gap:7px;
      font-weight:900;
      letter-spacing:.2px;
      font-size:12px;
      color:white;
    }
    .schedule-title .tag span{
      display:inline-flex; width:22px; height:22px; border-radius:8px;
      align-items:center; justify-content:center;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
    }
    .schedule-title .sub{
      color:var(--sub);
      font-size:12px;
    }

    .btn{
      border:0;
      border-radius: var(--pill);
      padding:10px 14px;
      font-weight:900;
      color:white;
      background: var(--grad);
      cursor:pointer;
      box-shadow:0 16px 28px rgba(155,91,255,.22);
      transition: transform var(--t), box-shadow var(--t), opacity var(--t);
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); box-shadow:0 22px 34px rgba(155,91,255,.28);}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none;
      box-shadow:none;}
    .btn-ghost{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      color:rgba(255,255,255,.92);
      box-shadow:none;
    }
    .btn-ghost:hover{background:rgba(255,255,255,.12); transform: translateY(-1px);}

    .schedule-box{
      display:grid;
      grid-template-columns: 104px 1fr;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,28,.72);
      /* FIX: Changed from hidden to visible so menu works */
      overflow:visible; 
    }

    .cal{
      width:104px; height:104px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.25), transparent 55%), rgba(10,13,42,.95);
      display:flex; flex-direction:column;
      overflow:hidden;
    }
    .cal .m{
      padding:8px 10px;
      background: rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.10);
      font-size:12px;
      font-weight:900;
      letter-spacing:.8px;
      text-transform:uppercase;
      text-align:center;
    }
    .cal .d{
      flex:1;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:2px;
    }
    .cal .daynum{
      font-size:34px;
      font-weight:1000;
      line-height:1;
    }
    .cal .dow{
      font-size:12px;
      color:rgba(255,255,255,.78);
      font-weight:800;
      letter-spacing:.4px;
      text-transform:uppercase;
    }

    .sched-info .line1{
      font-weight:1000;
      font-size:16px;
      margin-bottom:4px;
    }
    .sched-info .line2{
      color:var(--sub);
      font-size:13px;
      line-height:1.25;
    }
    .sched-actions{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
    }

    /* calendar dropdown */
    .dropdown{position:relative}
    .menu{
      position:absolute;
      left:0; top:44px; /* Changed from right:0 to left:0 for better wrapping */
      width:260px;
      background: rgba(11,15,36,.98);
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      box-shadow:0 22px 50px rgba(0,0,0,.6);
      padding:8px;
      display:none;
      z-index:100;
    }
    .menu.open{display:block}
    .menu a, .menu button{
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      border:0;
      background: transparent;
      color: rgba(255,255,255,.92);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
    }
    .menu a:hover, .menu button:hover{background: rgba(255,255,255,.08);}

    /* fun facts */
    .facts{
      margin-top:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,28,.72);
      padding:12px;
      overflow:hidden;
      min-height: 100px; /* FIX: Prevents empty looking box */
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .facts-head{
      display:flex; align-items:center;
      justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .facts-head .t{
      font-weight:1000;
      font-size:14px;
    }
    .facts-nav{display:flex; gap:8px;}
    .iconbtn{
      width:36px; height:36px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:white;
      font-weight:900;
      cursor:pointer;
      transition: transform var(--t), background var(--t);
    }
    .iconbtn:hover{transform: translateY(-1px);
      background: rgba(255,255,255,.10);}
    .factbox{
      min-height:62px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      flex-grow: 1; /* Ensures it fills space */
    }
    .factemoji{font-size:20px}
    .facttext{font-size:14px; color:rgba(255,255,255,.92); font-weight:800;
      line-height:1.25;}

    /* Right side welcome/timer */
    .welcome{
      padding:16px 14px;
    }
    .welcome h2{
      margin:0 0 6px;
      font-size:22px;
      letter-spacing:.2px;
    }
    .welcome p{
      margin:0 0 10px;
      color:var(--sub);
      font-size:14px;
      line-height:1.35;
    }
    .timer{
      display:flex; flex-direction:column; gap:10px;
      margin-top:10px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,28,.72);
    }
    .timer-row{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .timer-label{font-weight:1000; font-size:14px;}
    .count{
      font-variant-numeric: tabular-nums;
      font-size:22px;
      font-weight:1000;
      letter-spacing:.6px;
    }
    .joinwrap{
      display:flex;
      justify-content:center;
      margin-top:6px;
    }
    .disclaimer{
      margin-top:10px;
      font-size:11px;
      color:rgba(255,255,255,.70);
      line-height:1.35;
    }
    .linklike{
      color:white;
      text-decoration:underline;
      cursor:pointer;
      font-weight:900;
    }

    /* Reschedule */
    .res-btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius: var(--pill);
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:white;
      font-weight:900;
      cursor:pointer;
      transition: transform var(--t), background var(--t);
      white-space:nowrap;
    }
    .res-btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.10);}

    .drawer{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index:80;
    }
    .drawer.open{display:block}
    .panel{
      position:absolute;
      top:0;
      right:0;
      width:min(520px, 100%);
      height:100%;
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.20), transparent 55%), rgba(11,15,36,.98);
      border-left:1px solid rgba(255,255,255,.12);
      box-shadow:-22px 0 60px rgba(0,0,0,.65);
      padding:14px 14px 18px;
      overflow:auto;
    }
    .panel h3{margin:8px 0 4px; font-size:18px;}
    .panel .sub{margin:0 0 10px;
      color:var(--sub); font-size:13px;}
    .panel-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .xbtn{
      width:40px; height:40px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:white;
      cursor:pointer;
      font-size:18px;
      font-weight:900;
    }

    .select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(7,10,28,.72);
      color:white;
      padding:10px 12px;
      outline:none;
      font-weight:800;
      font-size:13px;
    }

    .pills{display:flex; flex-wrap:wrap; gap:10px;
      margin-top:8px;}
    .pill{
      padding:9px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:rgba(255,255,255,.86);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      transition: transform var(--t), background var(--t), border-color var(--t);
      min-width:120px;
    }
    .pill:hover{transform: translateY(-1px);
      background: rgba(255,255,255,.10);}
    .pill.active{
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.34), transparent 60%), rgba(10,13,42,.95);
      border-color: rgba(155,91,255,.55);
      color:white;
    }

    .slotgrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (min-width:420px){
      .slotgrid{grid-template-columns: repeat(3, minmax(0,1fr));}
    }
    
    /* FIX: Slot Colors for visibility */
    .slot{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      padding:10px 10px;
      cursor:pointer;
      font-weight:1000;
      text-align:center;
      transition: transform var(--t), background var(--t), border-color var(--t);
      font-size:13px;
      position:relative;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      color: #e9ecff; /* Force readable color */
    }
    .slot:hover{transform: translateY(-1px); background: rgba(255,255,255,.10);}
    .slot.active{
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.34), transparent 60%), rgba(10,13,42,.95);
      border-color: rgba(155,91,255,.55);
      color:white;
    }
    .star{
      position:absolute; top:6px; right:6px;
      font-size:10px;
      padding:2px 6px;
      border-radius:var(--pill);
      border:1px solid rgba(255,222,140,.8);
      background: rgba(79,54,7,.45);
      color:#ffeec4;
      font-weight:1000;
    }

    /* Modal - Terms */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      background: rgba(0,0,0,.60);
      z-index:90;
      padding:18px 12px;
    }
    .modal.open{display:flex; align-items:center;
      justify-content:center;}
    .modal-card{
      width:min(760px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.20), transparent 55%), rgba(11,15,36,.98);
      box-shadow:0 22px 60px rgba(0,0,0,.75);
      padding:16px 16px 14px;
    }
    .modal-top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .modal-top h3{margin:0; font-size:18px;}
    .modal-top p{margin:4px 0 0; color:var(--sub);
      font-size:13px;}
    .modal-card ul{
      margin:10px 0 0;
      padding-left:18px;
      color:rgba(255,255,255,.88);
      font-size:13px;
      line-height:1.5;
    }

    /* Loading / errors */
    .state{
      margin-top:12px;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,28,.72);
      color:rgba(255,255,255,.86);
      font-weight:800;
      font-size:13px;
    }
    .hide{display:none !important;}

    /* MOBILE OPTIMIZATIONS */
    @media (max-width: 768px) {
        .brand img { height: 24px; } /* Smaller Logo */
        
        .topbar {
            flex-direction: row; /* Keep row but ensure space */
        }
        
        /* Ensure calendar menu fits on screen */
        .menu {
            width: 220px;
            left: -50px; 
        }
        
        /* Stack ticket columns on very small screens */
        .ticket-body { grid-template-columns: 1fr; }
    }
  
    /* Gradient name in welcome header */
    .grad-name{
      background: var(--grad);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 1000;
    }

    /* Email: ellipsis + copy */
    #vEmail{
      cursor: pointer;
      user-select: all;
    }

    /* Fun facts fillers */
    .didyou{
      font-size:11px;
      font-weight:1000;
      letter-spacing:.3px;
      text-transform:uppercase;
      color:rgba(255,255,255,.72);
      margin: 0 0 8px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .didyou:before{
      content:"ğŸ’¡";
      display:inline-block;
    }
    .facts-divider{
      height:2px;
      width:100%;
      border-radius:2px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
      margin-top:10px;
    }
    .facts-divider > span{
      display:block;
      height:100%;
      width:35%;
      background: var(--grad);
      border-radius:2px;
      animation: factsSweep 6s ease-in-out infinite;
    }
    @keyframes factsSweep{
      0%{ transform: translateX(-10%); opacity:.55;}
      50%{ transform: translateX(200%); opacity:1;}
      100%{ transform: translateX(-10%); opacity:.55;}
    }
    .dots{
      display:flex;
      gap:6px;
      align-items:center;
      justify-content:center;
      margin-top:10px;
    }
    .dot{
      width:7px;
      height:7px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      opacity:.55;
      transition: opacity var(--t), transform var(--t), background var(--t);
    }
    .dot.active{
      opacity:1;
      transform: scale(1.2);
      background: rgba(255,255,255,.30);
      border-color: rgba(255,255,255,.35);
    }

    /* Fun Fact Progress Bar (driven by JS) */
    .fact-bar{
      height:100%;
      width:0%;
      background: var(--grad);
      transition: width 5.2s linear;
      animation:none !important;
    }

    /* Star badge: inline (no overlap) */
    .slot{gap:8px;}
    .star{
      position:static;
      top:auto; right:auto;
      margin-left:6px;
      font-size:10px;
      padding:2px 7px;
      border-radius:var(--pill);
      border:1px solid rgba(255,222,140,.8);
      background: rgba(79,54,7,.45);
      color:#ffeec4;
      font-weight:1000;
      line-height:1.2;
      white-space:nowrap;
    }
    /* ======================
   DEMO DASHBOARD FOOTER
====================== */

.demo-footer{
  margin-top:40px;
  border-top:1px solid rgba(255,255,255,.12);
  padding-top:28px;
}

/* Mission section */
.demo-footer .footer-mission{
  max-width:1200px;
  margin:0 auto;
  padding:0 12px;
}

.demo-footer .footer-mission-logo{
  width:180px;
  margin-bottom:12px;
}

.demo-footer .footer-mission-logo img{
  width:100%;
  height:auto;
}

.demo-footer .footer-mission-text{
  font-size:14px;
  line-height:1.6;
  color:rgba(255,255,255,.88);
}

.demo-footer .footer-offices{
  margin-top:18px;
  display:flex;
  flex-wrap:wrap;
  gap:16px;
  font-size:14px;
  color:white;
}

.demo-footer .footer-office-item{
  display:flex;
  align-items:center;
  gap:8px;
}

/* ---------- BOTTOM BAR ---------- */

.demo-footer-bottom{
  margin-top:26px;
  padding:12px 0;
  background:#21333D;
}

.demo--bottom-inner{
  max-width:1200px;
  margin:0 auto;
  padding:0 12px;
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:center;
  gap:12px;
  font-size:13px;
  color:white;
}

/* LEFT */
.demo--left a{
  color:white;
  font-weight:600;
  text-decoration:none;
}

.demo--left a:hover{
  text-decoration:underline;
}

/* CENTER */
.demo--center{
  text-align:center;
  font-weight:500;
}

/* RIGHT */
.demo--right{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:10px;
  white-space:nowrap;
}

.demo--right span{
  font-weight:500;
}

/* âœ… FIXED SOCIAL ICON SIZE */
.demo--social{
  display:flex;
  gap:8px;
}

.demo--social a{
  width:24px;
  height:24px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.demo--social img{
  width:100%;
  height:100%;
  object-fit:contain;
  transition:opacity .2s ease;
}

.demo--social a:hover img{
  opacity:.8;
}

/* ---------- RESPONSIVE ---------- */
@media (max-width:768px){
  .demo--bottom-inner{
    grid-template-columns:1fr;
    text-align:left;
  }

  .demo--right{
    justify-content:flex-start;
  }
}

  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <div class="brand">
        <img src="https://res.cloudinary.com/dpapyknn4/image/upload/v1763143023/Unischooly_Horizontal_logo_qbu1l7.svg" alt="Unischooly" />
      </div>
      <div class="locked">
        <div class="locked-icon">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        </div>
        Your trial class is locked in!
      </div>
    </div>

    <div id="stateError" class="state hide">Booking not found. Please check the link.</div>

    <div id="section2" class="grid">
      <div class="card">
        <div class="card-inner">
          <div class="ticket" id="ticketCard">
            <div class="stamp" aria-label="Value waived stamp">
              <div class="big">VALUE<br/>WAIVED</div>
              <div class="small">$30</div>
            </div>
            <div class="ticket-head">
              <div>
                <div class="ticket-title">ğŸ« OFFICIAL FREE TRIAL PASS</div>
                <div class="ticket-sub">Valid for 1 session â€¢ Powered by Unischooly</div>
              </div>
            </div>
            <div class="ticket-body">
              <div class="ticket-col">
                <h4>Admit One Student</h4>
                <div class="kv">
                   <div class="k">Name</div><div class="v" id="vChild">â€”</div>
                  <div class="k">Grade</div><div class="v" id="vGrade">â€”</div>
                  <div class="k">Course</div><div class="v" id="vCourse">â€”</div>
                </div>
              </div>
              <div class="ticket-col">
                 <h4>Parent Confirmation</h4>
                <div class="kv">
                  <div class="k">Sent to</div><div class="v" id="vParent">â€”</div>
                  <div class="k">Cell</div><div class="v" id="vPhone">â€”</div>
                  <div class="k">Email</div><div class="v" id="vEmail" title="Hover to see email">â€”</div>
                </div>
              </div>
            </div>
            <div class="powered">Powered by Unischooly</div>
          </div>

          <div style="height:12px"></div>
          <div class="schedule-head">
             <div class="schedule-title">
              <div class="tag"><span>ğŸš€</span> Ready for Blast Off!!!</div>
              <div class="sub">Class Schedule</div>
            </div>
            <button class="res-btn" id="btnReschedule">ğŸ—“ï¸ Reschedule</button>
          </div>

          <div class="schedule-box">
            <div class="cal" aria-label="Calendar">
              <div class="m" id="calMonth">â€”</div>
              <div class="d">
                <div class="daynum" id="calDay">â€”</div>
                <div class="dow" id="calDow">â€”</div>
              </div>
            </div>
 
            <div class="sched-info">
              <div class="line1" id="schedTime">â€”</div>
              <div class="line2" id="schedMeta">â€”</div>

              <div class="sched-actions">
                <div class="dropdown">
                  <button class="btn" id="btnCalendar">ğŸ“… Initiate Calendar Sync</button>
                  <div class="menu" id="calMenu">
                    <a id="calGoogle" target="_blank" rel="noreferrer">Google Calendar <span>â†—</span></a>
                    <a id="calApple" target="_blank" rel="noreferrer">Apple Calendar (ICS) <span>â¬‡</span></a>
                    <a id="calOutlook" target="_blank" rel="noreferrer">Outlook.com <span>â†—</span></a>
                    <a id="calYahoo" target="_blank" rel="noreferrer">Yahoo Calendar <span>â†—</span></a>
                    <button id="calDownload">Download .ics <span>â¬‡</span></button>
                  </div>
                </div>
                <button class="btn btn-ghost" id="btnCopy">ğŸ”— Copy class time</button>
             </div>
            </div>
          </div>

          <div class="facts">
            <div class="facts-head">
              <div class="t">âœ¨ Fun Facts</div>
              <div class="facts-nav">
                <button class="iconbtn" id="factPrev">â€¹</button>
                <button class="iconbtn" id="factNext">â€º</button>
              </div>
            </div>
            <div class="didyou">Did you know?</div>
            <div class="factbox" aria-live="polite">
              <div class="factemoji" id="factEmoji">ğŸ’¡</div>
              <div class="facttext" id="factText">â€”</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="welcome">
          <h2 id="welcomeTitle">Welcome!</h2>
         
          <p id="welcomeSub">Your trial class details are loading.</p>

          <div class="timer">
            <div class="timer-row">
              <div class="timer-label" id="timerLabel">Join class in</div>
              <div class="count" id="countdown">--:--:--</div>
            </div>

            <div class="joinwrap">
              <button class="btn" id="btnJoin" disabled>ğŸ¥ Join Class</button>
            </div>

            <div class="disclaimer">
              By clicking join class, you are confirming that you have read, understood and agree to
              <span class="linklike" id="openTerms">Terms & Conditions</span>.
            </div>
          </div>

          <div class="facts" style="margin-top:12px">
            <div class="facts-head">
              <div class="t">Sharpen Your Brain ğŸ§ </div>
              <div class="facts-nav">
                <button class="iconbtn" id="pPrev">â€¹</button>
                <button class="iconbtn" id="pNext">â€º</button>
              </div>
            </div>

            <div class="factbox" style="align-items:flex-start">
              <div class="factemoji">ğŸ§©</div>
              <div style="flex:1">
                <div class="facttext" id="pQuestion" style="margin-bottom:8px">â€”</div>
                 <div class="pills" id="pChoices" style="margin-top:0"></div>
                <div style="margin-top:8px; font-size:11px; color:rgba(255,255,255,.72); font-weight:800" id="pStatus">â€”</div>
              </div>
            </div>
          </div>

          <div class="facts" style="margin-top:12px">
            <div class="facts-head">
              <div class="t">Mini Games ğŸ®</div>
              <div style="font-size:11px; color:rgba(255,255,255,.72); font-weight:800">Quick brain boosters</div>
            </div>
            <div class="factbox" style="flex-direction:column; align-items:stretch; gap:10px">
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn btn-ghost" id="tabSprint">Quick Sprint</button>
                <button class="btn btn-ghost" id="tabMemory">Memory Match</button>
              </div>

              <div id="gameSprint" class="hide">
                 <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
                  <div style="font-weight:1000">Quick Math Sprint (60s)</div>
                  <div style="font-variant-numeric:tabular-nums; font-weight:1000" id="sprintTime">60</div>
                </div>
                <div style="margin-top:8px; font-size:14px; font-weight:1000" id="sprintQ">â€”</div>
                <div class="pills" style="margin-top:10px" id="sprintChoices"></div>
                <div style="margin-top:8px; font-size:11px; color:rgba(255,255,255,.72); font-weight:800" id="sprintStatus">Tap an answer to start.</div>
              </div>

              <div id="gameMemory" class="hide">
                <div style="font-weight:1000; margin-bottom:6px">Memory Match (Emoji)</div>
                <div style="display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:8px" id="memGrid"></div>
                <div style="margin-top:8px; font-size:11px; color:rgba(255,255,255,.72); font-weight:800" id="memStatus">Find all pairs.</div>
              </div>

              <div style="font-size:11px; color:rgba(255,255,255,.70); font-weight:800">Tip: Solving puzzles helps warm up your brain before class!</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div id="termsModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-top">
        <div>
          <h3>Terms & Conditions</h3>
           <p>Please keep these video conferencing etiquette tips in mind so you know what NOT to do during your demo/trial class:</p>
        </div>
        <button class="xbtn" id="closeTerms">âœ•</button>
      </div>

      <ul>
        <li>By taking this demo/trial session, you consent to Unischooly/Company recording this session.</li>
        <li>This demo/trial session or class will be recorded for the whole duration for training, constant process improvement, and audit purposes.</li>
        <li>Unischooly/Company adheres to zero tolerance towards sexual, non-sexual, verbal and visual abuse. Inappropriate hand gestures, threats, or any other indecent behaviour captured or reported during the session shall also be considered a violation of the Companyâ€™s internal policies.</li>
        <li>While taking the demo/trial session, kindly avoid clothing with controversial messages, including but not limited to racial and/or religious slurs or any type of sexual or non-sexual abuse.</li>
      </ul>
    </div>
  </div>

  <div id="resDrawer" class="drawer" aria-hidden="true">
    <div class="panel">
      <div class="panel-top">
        <div>
          <h3>Reschedule your class</h3>
          <div class="sub">Timezone is prefilled. You can change it.</div>
        </div>
        <button class="xbtn" id="closeRes">âœ•</button>
      </div>

      <div style="margin-top:10px">
        <div style="font-weight:1000; font-size:13px; margin-bottom:8px">Timezone</div>
        <select id="tzSelect" class="select"></select>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:1000; font-size:13px; margin-bottom:8px">Select Date</div>
        <div class="pills" id="resDates"></div>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:1000; font-size:13px; margin-bottom:8px">Select Start Time</div>
        <div class="sub">Slots shown in your selected timezone.</div>
        <div class="slotgrid" id="resSlots"></div>
        <div id="resEmpty" class="state hide" style="margin-top:10px">No slots available for this date.</div>
      </div>

      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
        <button class="btn btn-ghost" id="cancelRes">Cancel</button>
        <button class="btn" id="confirmRes" disabled>Confirm Reschedule</button>
      </div>

      <div style="margin-top:10px; font-size:11px; color:rgba(255,255,255,.70); font-weight:800">
        Your class timing will update instantly once confirmed.
      </div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG: Supabase
    // =========================
    const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    
    // =========================
    // Time formatting helpers (DB + display)
    // =========================
    function fmtParts(d, tz, opts){
      const parts = new Intl.DateTimeFormat("en-US", { timeZone: tz, ...opts }).formatToParts(d);
      const obj = {};
      for (const p of parts) { if (p.type !== "literal") obj[p.type] = p.value; }
      return obj;
    }
    function fmtDateSQL(d, tz){
      const p = fmtParts(d, tz, { year:"numeric", month:"2-digit", day:"2-digit" });
      return `${p.year}-${p.month}-${p.day}`;
    }
    function fmtDateTimeSQL(d, tz){
      const p = fmtParts(d, tz, { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:false });
      return `${p.year}-${p.month}-${p.day} ${p.hour}:${p.minute}:${p.second}`;
    }
    function fmtLabel(d, tz){
      const p = fmtParts(d, tz, { hour:"numeric", minute:"2-digit", hour12:true });
      return `${p.hour}:${p.minute} ${p.dayPeriod}`;
    }

    // =========================
    // Timezone-safe helpers (used by Reschedule)
    // =========================
    function parseTime12To24(time12){
      const m = String(time12||"").trim().match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/i);
      if(!m) return null;
      let hh = parseInt(m[1],10);
      const mm = parseInt(m[2]||"00",10);
      const ap = m[3].toUpperCase();
      if(ap==="AM"){ if(hh===12) hh=0; }
      if(ap==="PM"){ if(hh!==12) hh+=12; }
      return {hh, mm};
    }
    function zonedTimeToUtc(dateStr, time12, tz){
      // Convert a wall-clock time in `tz` to an absolute UTC Date (handles DST via Intl offset)
      const t = parseTime12To24(time12);
      if(!t) return null;
      const [y,m,d] = dateStr.split("-").map(n=>parseInt(n,10));
      const utcGuess = new Date(Date.UTC(y, (m||1)-1, d||1, t.hh, t.mm, 0));
      const p = fmtParts(utcGuess, tz, {year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:false});
      const asIfUtc = new Date(Date.UTC(parseInt(p.year,10), parseInt(p.month,10)-1, parseInt(p.day,10), parseInt(p.hour,10), parseInt(p.minute,10), parseInt(p.second,10)));
      const diff = asIfUtc.getTime() - utcGuess.getTime();
      return new Date(utcGuess.getTime() - diff);
    }
    function addDaysInTZ(baseDateStr, days, tz){
      // Move by calendar days in tz using a noon anchor to avoid DST edge cases
      const anchorUtc = zonedTimeToUtc(baseDateStr, "12:00 PM", tz);
      const moved = new Date(anchorUtc.getTime() + days * 86400000);
      return fmtDateSQL(moved, tz);
    }


// =========================
    // URL params
    // =========================
    const url = new URL(window.location.href);
    const leadId =
  url.searchParams.get("leadId") ||
  url.searchParams.get("leadRaw");

// FIX (GLOBAL): Single source of truth for fetching the lead
// If leadId is numeric => use lead_id (BIGINT). Otherwise assume UUID => use id.
const leadFilter = (() => {
  if (!leadId) return null;
  const asNum = Number(leadId);
  if (Number.isFinite(asNum) && String(asNum) === String(parseInt(leadId, 10))) {
    return { col: "lead_id", val: asNum };
  }
  return { col: "id", val: String(leadId) };
})();
if (!leadId) {
  document.getElementById("stateError")?.classList.remove("hide");
  throw new Error("Missing leadId in URL");
} // this is BIGINT lead_id
    const courseId = parseInt(url.searchParams.get("courseId") || "1", 10);

    // =========================
    // Course mapping + facts + puzzles
    // =========================
    const COURSE = {
      1:{name:"Coding", emoji:"ğŸ’»"},
      2:{name:"Python", emoji:"ğŸ"},
      3:{name:"Website Development", emoji:"ğŸŒ"},
      4:{name:"Generative AI", emoji:"âœ¨"},
      5:{name:"Roblox", emoji:"ğŸ§±"},
      6:{name:"Chess", emoji:"â™Ÿï¸"},
      7:{name:"Mathematics", emoji:"â—"},
    };
    const FACT_BANK = {
      1:[
        ["ğŸ’¡","The first computer bug was an actual moth found in 1947!"],
        ["ğŸ§ ","Coding is like giving step-by-step instructions to a super-fast helper."],
        ["ğŸ§©","Algorithms are just smart recipes for solving problems."],
        ["ğŸ®","Many games run at 60 frames per secondâ€”your code helps make that smooth!"],
        ["ğŸ”","Loops save time by repeating actions so you donâ€™t write the same code again."],
        ["ğŸ§±","Scratch blocks teach logic the same way real code does."],
        ["ğŸŒ","The Internet works because of protocolsâ€”rules computers agree on."],
        ["ğŸ”","Encryption turns messages into secret code to keep them safe."],
        ["ğŸ›°ï¸","GPS relies on satellites + math + code to find your location."],
        ["âš¡","Computers love patternsâ€”good coders learn to spot patterns too!"],
      ],
      2:[
        ["ğŸ","Python is named after Monty Pythonâ€”not the snake!"],
        ["ğŸ“¦","Python has packages so you can add superpowers quickly."],
        ["ğŸ§ ","Indentation in Python mattersâ€”it shows what belongs together."],
        ["ğŸ”¢","Python is great for math, data, and AI projects."],
        ["ğŸ§©","Lists in Python hold many items, like a backpack of values."],
        ["ğŸ§ª","You can test code in small pieces to find bugs faster."],
        ["ğŸ¤–","Many AI tools use Python behind the scenes."],
        ["âš™ï¸","Functions are mini-machines: input â†’ work â†’ output."],
        ["ğŸ§¯","Errors are normalâ€”debugging is a coderâ€™s superpower."],
        ["ğŸŒŸ","Readable code is powerful code."],
      ],
      3:[
        ["ğŸŒ","Web pages are built with HTML (structure), CSS (style), and JS (logic)."],
        ["ğŸ¨","CSS can animate shapes without images!"],
        ["ğŸ“±","Responsive design makes sites look great on phones and desktops."],
        ["ğŸ§­","Links connect pages like roads connect cities."],
        ["âš¡","Browsers run JavaScript to make sites interactive."],
        ["ğŸ”¤","A URL is an address to a page on the Internet."],
        ["ğŸ§±","Components help reuse the same UI blocks."],
        ["ğŸ–¼ï¸","Images should be optimized so pages load faster."],
        ["ğŸ”","HTTPS keeps website data secure."],
        ["ğŸ§ ","Good UX is about clarity and confidence."],
      ],
      4:[
        ["âœ¨","Generative AI can create text, images, and music from prompts."],
        ["ğŸ§ ","Models learn patterns from lots of examples."],
        ["ğŸ§©","Prompts work best when theyâ€™re specific and clear."],
        ["ğŸ§ª","AI outputs should be checkedâ€”humans stay in control."],
        ["ğŸ“š","AI can help summarize, brainstorm, and explain concepts."],
        ["ğŸ¨","AI art tools turn words into pictures."],
        ["ğŸ§ ","Training data shapes what AI knows."],
        ["âš–ï¸","Using AI responsibly is importantâ€”be kind and respectful."],
        ["ğŸ”","Iteration is key: prompt â†’ result â†’ improve prompt."],
        ["ğŸŒŸ","AI is a toolâ€”your ideas are the magic."],
      ],
      5:[
        ["ğŸ§±","Roblox games are built with Lua scripting."],
        ["ğŸ®","Game loops update the world many times per second."],
        ["ğŸ§ ","Design + code = fun gameplay."],
        ["ğŸ—ºï¸","Levels are like puzzles you build for others."],
        ["ğŸ”","Events trigger actionsâ€”like when a player touches a part."],
        ["ğŸ¨","Lighting and colors change the mood of a game."],
        ["ğŸ§©","Physics rules make jumping and falling feel real."],
        ["ğŸ”Š","Sound effects make games feel alive."],
        ["ğŸ§ª","Testing helps you catch glitches before players do."],
        ["ğŸ†","Small improvements add up to big fun."],
      ],
      6:[
        ["â™Ÿï¸","In chess, controlling the center gives you more options."],
        ["ğŸ§ ","Tactics are short puzzles; strategy is the long plan."],
        ["ğŸ¯","Forks attack two pieces at once."],
        ["ğŸ›¡ï¸","Develop pieces early to activate your army."],
        ["ğŸ°","Castling helps keep your king safe."],
        ["ğŸ“Œ","Pins stop a piece from moving."],
        ["ğŸ”","Checkmate means the king cannot escape."],
        ["ğŸ§©","Good players look for threats AND defenses."],
        ["â±ï¸","Time management matters in fast games."],
        ["ğŸŒŸ","Every game teaches something new."],
      ],
      7:[
        ["â—","Math is a language for patterns."],
        ["ğŸ§ ","Fractions are just parts of a whole."],
        ["ğŸ“ˆ","Graphs show relationships visually."],
        ["ğŸ”¢","Prime numbers have only two factors: 1 and themselves."],
        ["ğŸ§©","Geometry is like drawing with rules."],
        ["âš¡","Mental math is a skillâ€”practice makes it fast."],
        ["ğŸ§ ","Estimation helps you check if answers make sense."],
        ["ğŸ”","Multiplication is repeated addition."],
        ["ğŸ“","Angles tell you how much you turn."],
        ["ğŸŒŸ","Math helps in games, coding, and real life."],
      ],
    };
    const PUZZLES = {
      1:[
        {q:"What comes next? 2, 4, 8, 16, ?", choices:["18","24","32","34"], a:2},
        {q:"If a loop runs 5 times, and prints 'Hi' each time, how many 'Hi'?", choices:["1","5","10","0"], a:1},
        {q:"Which is a 'condition'?", choices:["Run fast","If it rains","Blue is nice","Hello!"], a:1},
        {q:"Pick the best order to solve a task:", choices:["Plan â†’ Code â†’ Test","Code â†’ Hope","Skip plan","Only test"], a:0},
        {q:"Binary uses only:", choices:["0 and 1","1 and 2","2 and 3","A and B"], a:0},
        {q:"A bug is:", choices:["A feature","A mistake in code","A keyboard","A mouse"], a:1},
        {q:"Which repeats actions?", choices:["Loop","Variable","Comment","Pixel"], a:0},
        {q:"Algorithm is like:", choices:["A recipe","A color","A shoe","A cloud"], a:0},
        {q:"What stores a value?", choices:["Variable","Monitor","Speaker","Cable"], a:0},
        {q:"Debugging means:", choices:["Adding bugs","Fixing issues","Deleting files","Shouting"], a:1},
      ],
      2:[
        {q:"Python is great for:", choices:["Only painting","Data & AI","Only music","Only chess"], a:1},
        {q:"In Python, indentation shows:", choices:["Color","Block of code","Volume","Speed"], a:1},
        {q:"A list is:", choices:["One value","Many values together","A keyboard","A website"], a:1},
        {q:"Function is like:", choices:["A mini-machine","A sandwich","A bus stop","A cloud"], a:0},
        {q:"Which is a number?", choices:["'7'","7","Seven","None"], a:1},
        {q:"Bug fixing is called:", choices:["Debugging","Painting","Sleeping","Singing"], a:0},
        {q:"Print() does:", choices:["Shows output","Deletes code","Plays music","Makes tea"], a:0},
        {q:"If x=3, x+2 = ?", choices:["3","4","5","6"], a:2},
        {q:"A loop repeats until:", choices:["It wants","Condition ends","Keyboard breaks","Sun sets"], a:1},
        {q:"Best coder habit:", choices:["Never test","Write readable code","Hide errors","Skip learning"], a:1},
      ],
      3:[
        {q:"HTML is for:", choices:["Style","Structure","Music","Painting"], a:1},
        {q:"CSS is for:", choices:["Style","Math","Storage","Network"], a:0},
        {q:"JS is for:", choices:["Interactivity","Only images","Only fonts","Only paper"], a:0},
        {q:"Responsive means:", choices:["Fast","Fits all screens","Only desktop","Only mobile"], a:1},
        {q:"A link connects:", choices:["Shoes","Pages","Clouds","Books"], a:1},
        {q:"URL is:", choices:["A page address","A game score","A color","A bug"], a:0},
        {q:"Button click is handled by:", choices:["JavaScript","Paper","Wind","Paint"], a:0},
        {q:"Best for speed:", choices:["Huge images","Optimized images","No images ever","Random"], a:1},
        {q:"HTTPS means:", choices:["Secure site","Slow site","Fun site","Old site"], a:0},
        {q:"UX is about:", choices:["Confusing users","User experience","Only colors","Only text"], a:1},
      ],
      4: [
        {q:"Generative AI can:", choices:["Only sleep","Create content","Only run","Only paint walls"], a:1},
        {q:"Good prompts are:", choices:["Vague","Specific","Empty","Angry"], a:1},
        {q:"AI outputs should be:", choices:["Always trusted","Checked by humans","Ignored","Printed"], a:1},
        {q:"AI learns from:", choices:["Patterns in data","Rain","Shoes","Cars"], a:0},
        {q:"Iteration means:", choices:["Try once","Improve repeatedly","Stop","Delete"], a:1},
        {q:"AI is a:", choices:["Tool","Wizard","Monster","Book"], a:0},
        {q:"Responsible AI is:", choices:["Kind & safe","Mean","Secret","Lazy"], a:0},
        {q:"Models are:", choices:["Pattern learners","Sandwiches","Shoes","Buses"], a:0},
        {q:"Clear prompts help:", choices:["Confuse AI","Get better results","Break code","Slow down"], a:1},
        {q:"Human role is:", choices:["None","In control","Only watch","Only sleep"], a:1},
      ],
      5: [
        {q:"Roblox scripting uses:", choices:["Lua","Python","HTML","Cement"], a:0},
        {q:"Game loop does:", choices:["Updates world","Stops time","Cooks","Draws"], a:0},
        {q:"Events trigger:", choices:["Actions","Rain","Sand","Paper"], a:0},
        {q:"Testing helps:", choices:["Catch glitches","Add bugs","Make noise","Hide work"], a:0},
        {q:"Lighting changes:", choices:["Mood","Math","Keyboard","Cable"], a:0},
        {q:"Physics makes:", choices:["Movement real","Only colors","Only text","Only sound"], a:0},
        {q:"Levels are:", choices:["Puzzles you build","Shoes","Bikes","Clouds"], a:0},
        {q:"Sound effects:", choices:["Add life","Remove fun","Break code","Delete"], a:0},
        {q:"Design + code =", choices:["Fun gameplay","Nothing","Confusion","Sleep"], a:0},
        {q:"Small improvements:", choices:["Add up big","Never matter","Break all","Stop"], a:0},
      ],
      6: [
        {q:"Control the center gives:", choices:["More options","Less moves","No moves","Only pawns"], a:0},
        {q:"Fork attacks:", choices:["Two pieces","Zero pieces","Only king","Only pawn"], a:0},
        {q:"Castling keeps:", choices:["King safer","Queen faster","Pawns taller","Time slower"], a:0},
        {q:"Pin means:", choices:["Piece can't move","Piece flies","Board breaks","Win instantly"], a:0},
        {q:"Checkmate is:", choices:["King trapped","King happy","Queen gone","Draw"], a:0},
        {q:"Strategy is:", choices:["Long plan","Short trick","Random","No plan"], a:0},
        {q:"Tactics are:", choices:["Short puzzles","Long speeches","Books","Songs"], a:0},
        {q:"Develop pieces:", choices:["Early","Never","Only end","Only start"], a:0},
        {q:"Time matters in:", choices:["Fast games","Only slow","Never","Only puzzles"], a:0},
        {q:"Every game teaches:", choices:["Something","Nothing","Only loss","Only win"], a:0},
      ],
      7: [
        {q:"Prime numbers have:", choices:["2 factors","3 factors","0 factors","10 factors"], a:0},
        {q:"Multiplication is:", choices:["Repeated addition","Repeated division","Drawing","Singing"], a:0},
        {q:"Estimation helps:", choices:["Check answers","Confuse","Hide","Lose"], a:0},
        {q:"Angles measure:", choices:["Turn","Speed","Weight","Sound"], a:0},
        {q:"Graphs show:", choices:["Relationships","Only colors","Only sounds","Only bugs"], a:0},
        {q:"Fractions are:", choices:["Parts of whole","Only big numbers","Only primes","Only shapes"], a:0},
        {q:"Geometry is:", choices:["Drawing with rules","Cooking","Flying","Typing"], a:0},
        {q:"Math is:", choices:["Pattern language","Random","Only hard","Only easy"], a:0},
        {q:"Mental math is:", choices:["Practice skill","Magic","Luck","Sleep"], a:0},
        {q:"Math helps in:", choices:["Life & coding","Only school","Only games","Nowhere"], a:0},
      ]
    };
    // =========================
    // Helpers: timezone formatting
    // =========================
    function safeTZ(tz){
      try { Intl.DateTimeFormat("en-US",{timeZone:tz}).format(new Date());
      return tz; } catch { return "Asia/Kolkata"; }
    }
    function fmtLocal(dt, tz){
      const parts = new Intl.DateTimeFormat("en-US", {
        timeZone: tz,
        weekday: "short",
        month: "short",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      }).formatToParts(dt);
      const map = Object.fromEntries(parts.map(p=>[p.type,p.value]));
      return {weekday: map.weekday, month: map.month, day: map.day, time: `${map.hour}:${map.minute} ${map.dayPeriod}`};
    }
    function dateKeyInTZ(dt, tz){
      const p = new Intl.DateTimeFormat("en-CA", {timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit"}).format(dt);
      return p; // YYYY-MM-DD
    }

    // =========================
    // Booking load
    // =========================
    let BOOKING = null;
    let bookingTZ = "Asia/Kolkata";
    let bookingRegion = null;
    let bookingCourseName = (COURSE[courseId]||COURSE[1]).name;
    async function loadBooking(){
      if(!leadFilter){ return null; }
      const { data, error } = await sb
      .from("demo_leads")
      .select("*")
      .eq(leadFilter.col, leadFilter.val)   // âœ… BIGINT MATCH
      .single();
      if(error || !data){ console.error(error); return null; }
      return data;
    }

    // =========================
    // Derive class datetime for countdown + calendar
    // preferred_date is date (no timezone), preferred_time_slot is local string (e.g., "10:00 AM")
    // We'll compute a Date by combining preferred_date with local time in booking.timezone
    // =========================
    function buildMeetLink(){
      // Uses Zoom link saved in demo_leads.zoom_join_url
      // Returns null if not yet available.
      const url = (BOOKING && BOOKING.zoom_join_url) ? String(BOOKING.zoom_join_url).trim() : "";
      if(!url) return null;
      // Basic safety: only allow http/https
      if(!/^https?:\/\//i.test(url)) return null;
      return url;
    }

    // =========================
    // Render Section 2
    // =========================
    function setText(id, value){
      const el = document.getElementById(id);
      if(el) el.textContent = value ?? "â€”";
    }

    
  // ===== Missed/Normal UI helpers (dashboard) =====
  function escHtml(s){
    return (s ?? "").toString()
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }

  function setMissedUI(courseName){
    const titleEl = document.getElementById("welcomeTitle");
    const subEl   = document.getElementById("welcomeSub");
    const discEl  = document.querySelector(".disclaimer");
    const lockEl  = document.querySelector(".locked");

    if(titleEl){
      titleEl.innerHTML =
        `You <span class="gradText">missed</span> your <span class="gradText">${escHtml(courseName)}</span> Trial Class â˜¹ï¸`;
    }
    if(subEl){
      subEl.textContent = "We understand â€” things come up sometimes. Letâ€™s help you get back on track ğŸš€";
    }
    if(discEl){
      discEl.textContent = "Donâ€™t worry! You still have one final opportunity to reschedule and enjoy this class.";
    }
    // Top-right pill (reuse locked styling)
    if(lockEl){
      lockEl.classList.add("missed");
      lockEl.innerHTML = `<div class="tick">âœ•</div><span>Class time is over</span>`;
    }
  }

  function setNormalUI(firstName, courseName){
    const titleEl = document.getElementById("welcomeTitle");
    const subEl   = document.getElementById("welcomeSub");
    const discEl  = document.querySelector(".disclaimer");
    const lockEl  = document.querySelector(".locked");

    if(titleEl){
      titleEl.innerHTML =
        `Welcome to <span class="gradText">${escHtml(firstName)}â€™s</span> ${escHtml(courseName)} Trial Class`;
    }
    if(subEl){
      subEl.textContent =
        "Youâ€™re all set. Explore fun puzzles & mini-games while you wait â€” and sync the class to your calendar.";
    }
    if(discEl){
      discEl.innerHTML =
        `By clicking join class, you are confirming that you have read, understood and agree to <span class="linklike" id="openTerms">Terms & Conditions</span>.`;
      const t = document.getElementById("openTerms");
      if(t) t.onclick = ()=> document.getElementById("termsModal").classList.add("open");
    }
    if(lockEl){
      lockEl.classList.remove("missed");
      lockEl.innerHTML = `<div class="tick">âœ“</div><span>Your trial class is locked in!</span>`;
    }
  }
function renderBooking(b){
      BOOKING = b;
  const btnJoin = document.getElementById("btnJoin");

if (btnJoin && b.zoom_join_url) {
  btnJoin.disabled = false;

  btnJoin.onclick = () => {
    console.log("Joining Zoom:", b.zoom_join_url);
    window.open(b.zoom_join_url, "_blank", "noopener,noreferrer");
  };
}
      bookingTZ = safeTZ(b.timezone || "Asia/Kolkata");
      bookingRegion = b.region_key || null;
      bookingCourseName = (COURSE[b.course_id]||COURSE[courseId]||COURSE[1]).name;
      // Ticket fields
      setText("vChild", b.child_name);
      setText("vGrade", b.child_grade);
      setText("vParent", b.parent_name);
      setText("vEmail", b.parent_email);
      // Email: tooltip + click-to-copy
      const emailEl = document.getElementById("vEmail");
      if(emailEl){
        emailEl.title = b.parent_email || "";
        emailEl.onclick = async () => {
          const email = b.parent_email || "";
          if(!email) return;
          try{ await navigator.clipboard.writeText(email); toast("Copied email"); }
          catch{ toast("Copy failed"); }
        };
      }
      setText("vPhone", `${b.phone_country_code || ""} ${b.phone_number || ""}`.trim());
      setText("vCourse", bookingCourseName);

      // Schedule
      const classDT = b.scheduled_at_utc ? new Date(b.scheduled_at_utc) : null;
if(classDT && !isNaN(classDT.getTime())){
        const s = fmtLocal(classDT, bookingTZ);
        setText("calMonth", s.month);
        setText("calDay", s.day);
        setText("calDow", s.weekday);
        setText("schedTime", `${s.time}`);
        setText("schedMeta", `${b.scheduled_local_date || ""} â€¢ ${bookingTZ}`.trim());

        // calendar links
        setupCalendarLinks(classDT, bookingTZ, bookingCourseName, b.child_name);
        // copy
        document.getElementById("btnCopy").onclick = async () => {
          const txt = `Unischooly Trial Class for ${b.child_name} â€” ${s.weekday}, ${s.month} ${s.day} at ${s.time} (${bookingTZ})`;
          try{ await navigator.clipboard.writeText(txt); toast("Copied!"); } catch { toast("Copy failed"); }
        };
        // countdown
        startCountdown(classDT, bookingTZ);
      } else {
        setText("schedTime", "Schedule not set");
        setText("schedMeta", "Please reschedule or contact support.");
        document.getElementById("btnJoin").disabled = true;
        document.getElementById("countdown").textContent = "--:--:--";
      }

      // Welcome
      // Welcome (first-name only + gradient)
      const rawChild = (b.child_name || "").trim();
      const firstName = rawChild ? rawChild.split(/\s+/)[0] : "Student";
      const welcomeEl = document.getElementById("welcomeTitle");
      if (welcomeEl){
        welcomeEl.innerHTML =
          `Welcome to <span class="grad-name">${firstName.replace(/</g,"&lt;").replace(/>/g,"&gt;")}â€™s</span> ${bookingCourseName} Trial Class`;
      }
      setNormalUI(firstName, bookingCourseName);
// facts
      initFacts(b.course_id || courseId);
      // puzzles & games
      initPuzzle(b.course_id || courseId);
      initMiniGames();
      // reschedule prefill
      initRescheduleUI();
      // join button logic (Zoom)
      // NOTE: we compute the link at click-time so if DB updates and page re-renders, it stays correct.
      document.getElementById("btnJoin").onclick = () => {
        const meetLink = buildMeetLink();
        if(meetLink){
          // Redirect to Zoom in the same tab
          window.location.href = meetLink;
        } else {
          toast("Meet link will appear 5 mins before class.");
        }
      };

    }

    // =========================
    // Toast (tiny)
    // =========================
    let toastTimer=null;
    function toast(msg){
      let el = document.getElementById("toast");
      if(!el){
        el=document.createElement("div");
        el.id="toast";
        el.style.position="fixed";
        el.style.left="50%";
        el.style.bottom="16px";
        el.style.transform="translateX(-50%)";
        el.style.padding="10px 12px";
        el.style.borderRadius="14px";
        el.style.background="rgba(11,15,36,.95)";
        el.style.border="1px solid rgba(255,255,255,.14)";
        el.style.color="white";
        el.style.fontWeight="900";
        el.style.fontSize="13px";
        el.style.boxShadow="0 18px 40px rgba(0,0,0,.6)";
        el.style.zIndex="120";
        document.body.appendChild(el);
      }
      el.textContent=msg;
      el.style.display="block";
      clearTimeout(toastTimer);
      toastTimer=setTimeout(()=>{el.style.display="none"}, 2200);
    }

    // =========================
    // Calendar integration
    // =========================
    function pad2(n){return String(n).padStart(2,"0");}
    function toIcsDateUTC(d){
      // YYYYMMDDTHHMMSSZ
      return `${d.getUTCFullYear()}${pad2(d.getUTCMonth()+1)}${pad2(d.getUTCDate())}T${pad2(d.getUTCHours())}${pad2(d.getUTCMinutes())}00Z`;
    }
    function escapeICS(s){ return String(s||"").replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;");}

    function makeICS({title, desc, startUTC, endUTC}){
      return [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//Unischooly//Demo//EN",
        "CALSCALE:GREGORIAN",
        "METHOD:PUBLISH",
        "BEGIN:VEVENT",
        `UID:${Date.now()}@unischooly.com`,
        `DTSTAMP:${toIcsDateUTC(new Date())}`,
        `DTSTART:${toIcsDateUTC(startUTC)}`,
        `DTEND:${toIcsDateUTC(endUTC)}`,
        `SUMMARY:${escapeICS(title)}`,
        `DESCRIPTION:${escapeICS(desc)}`,
        "END:VEVENT",
        "END:VCALENDAR"
      ].join("\r\n");
    }

    function setupCalendarLinks(classDT, tz, course, child){
      const start = classDT; // already actual instant
      const end = new Date(start.getTime() + 60*60*1000);
      const title = `Unischooly Trial Class - ${course}`;
      const desc = `Trial class for ${child}. Timezone: ${tz}.`;
      // Google Calendar uses dates in UTC in URL parameters
      const gBase = "https://calendar.google.com/calendar/render?action=TEMPLATE";
      const gDates = `${toIcsDateUTC(start)}/${toIcsDateUTC(end)}`;
      const gUrl = `${gBase}&text=${encodeURIComponent(title)}&details=${encodeURIComponent(desc)}&dates=${encodeURIComponent(gDates)}`;

      // Outlook.com
      const oBase = "https://outlook.live.com/calendar/0/deeplink/compose";
      const oUrl = `${oBase}?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(desc)}&startdt=${encodeURIComponent(start.toISOString())}&enddt=${encodeURIComponent(end.toISOString())}`;

      // Yahoo
      const yBase = "https://calendar.yahoo.com/";
      const dur = "0100";
      const yUrl = `${yBase}?v=60&title=${encodeURIComponent(title)}&st=${encodeURIComponent(toIcsDateUTC(start))}&dur=${dur}&desc=${encodeURIComponent(desc)}`;

      // ICS download (Apple uses .ics)
      const ics = makeICS({title, desc, startUTC:start, endUTC:end});
      const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
      const icsUrl = URL.createObjectURL(blob);

      document.getElementById("calGoogle").href = gUrl;
      document.getElementById("calOutlook").href = oUrl;
      document.getElementById("calYahoo").href = yUrl;
      document.getElementById("calApple").href = icsUrl;

      document.getElementById("calDownload").onclick = () => {
        const a = document.createElement("a");
        a.href = icsUrl;
        a.download = "unischooly-trial.ics";
        a.click();
      };
    }

    // Calendar dropdown
    const calBtn = document.getElementById("btnCalendar");
    const calMenu = document.getElementById("calMenu");
    calBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      calMenu.classList.toggle("open");
      // subtle pulse animation by reflowing box-shadow
      calBtn.animate([{transform:"translateY(0)"},{transform:"translateY(-2px)"},{transform:"translateY(0)"}], {duration:700});
    });
    document.addEventListener("click", ()=> calMenu.classList.remove("open"));

    // =========================
    // Fun Facts auto-rotate
    // =========================
    let factIdx=0, factList=[];
    let factTimer=null;
    function renderFactDots(){
      const dotsWrap=document.getElementById('factDots');
      if(!dotsWrap) return;
      dotsWrap.innerHTML='';
      for(let i=0;i<factList.length;i++){
        const d=document.createElement('span');
        d.className='dot'+(i===factIdx?' active':'');
        dotsWrap.appendChild(d);
      }
    }
    function resetFactBar(){
      const bar=document.getElementById('factBar');
      if(!bar) return;
      // restart progress animation
      bar.style.transition = 'none';
      bar.style.width = '0%';
      void bar.offsetWidth;
      bar.style.transition = 'width 5.2s linear';
      bar.style.width = '100%';
    }


    function initFacts(cid){
      factList = (FACT_BANK[cid]||FACT_BANK[1]).slice();
      factIdx = 0;
      showFact(0);
      renderFactDots();
      resetFactBar();
      clearInterval(factTimer);
      factTimer = setInterval(()=> nextFact(1), 5200);

      document.getElementById("factPrev").onclick = ()=> nextFact(-1, true);
      document.getElementById("factNext").onclick = ()=> nextFact(1, true);
    }
    function showFact(i){
      const item = factList[(i+factList.length)%factList.length];
      document.getElementById("factEmoji").textContent = item[0];
      document.getElementById("factText").textContent = item[1];
      renderFactDots();
      resetFactBar();
    }
    function nextFact(delta, manual=false){
      factIdx = (factIdx + delta + factList.length) % factList.length;
      showFact(factIdx);
      if(manual){
        clearInterval(factTimer);
        factTimer = setInterval(()=> nextFact(1), 5200);
      }
    }

    // =========================
    // Puzzles
    // =========================
    let pList=[], pIdx=0, pScore=0, pAnswered=0;
    function initPuzzle(cid){
      pList = (PUZZLES[cid]||PUZZLES[1]).slice();
      pIdx = 0; pScore = 0; pAnswered = 0;
      renderPuzzle();
      document.getElementById("pPrev").onclick = ()=> { pIdx = (pIdx - 1 + pList.length)%pList.length; renderPuzzle(true); };
      document.getElementById("pNext").onclick = ()=> { pIdx = (pIdx + 1)%pList.length; renderPuzzle(true); };
    }
    function renderPuzzle(resetMsg=false){
      const p = pList[pIdx];
      document.getElementById("pQuestion").textContent = p.q;
      const choices = document.getElementById("pChoices");
      choices.innerHTML = "";
      p.choices.forEach((c, idx)=>{
        const b=document.createElement("button");
        b.className="pill";
        b.textContent=c;
        b.onclick=()=>{
          pAnswered++;
          if(idx===p.a){ pScore++; document.getElementById("pStatus").textContent=`âœ… Correct! Score: ${pScore}/${pAnswered}`; }
          else { document.getElementById("pStatus").textContent=`âŒ Oops! Correct: ${p.choices[p.a]} â€¢ Score: ${pScore}/${pAnswered}`; }
          // auto next
          setTimeout(()=>{ pIdx = (pIdx + 1)%pList.length; renderPuzzle(); }, 700);
        };
        choices.appendChild(b);
      });
      if(resetMsg){ document.getElementById("pStatus").textContent=`Score: ${pScore}/${pAnswered}`; }
      if(pAnswered===0){ document.getElementById("pStatus").textContent="Pick an answer to start.";}
    }

    // =========================
    // Mini games (super light)
    // =========================
    function initMiniGames(){
      const tabSprint = document.getElementById("tabSprint");
      const tabMemory = document.getElementById("tabMemory");
      const gameSprint = document.getElementById("gameSprint");
      const gameMemory = document.getElementById("gameMemory");

      let active = null;
      function show(which){
        gameSprint.classList.add("hide");
        gameMemory.classList.add("hide");
        if(which==="sprint"){ gameSprint.classList.remove("hide"); }
        if(which==="memory"){ gameMemory.classList.remove("hide"); }
        active = which;
      }
      tabSprint.onclick = ()=> { show("sprint"); startSprint(); };
      tabMemory.onclick = ()=> { show("memory"); startMemory(); };
      // default
      show("sprint");
      startSprint();
    }

    // Quick Sprint
    let sprintTimer=null, sprintLeft=60, sprintScore=0, sprintRunning=false;
    function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
    function newSprintQ(){
      const a=randInt(2,12), b=randInt(2,12);
      const op = Math.random()<0.5 ? "+" : "Ã—";
      const ans = op==="+" ? (a+b) : (a*b);
      const wrong1 = ans + randInt(-3,3) || ans+1;
      const wrong2 = ans + randInt(-6,6) || ans+2;
      const opts = [ans, wrong1, wrong2].sort(()=>Math.random()-0.5);
      return {text:`${a} ${op} ${b} = ?`, ans, opts};
    }
    let sprintQ=null;
    function setSprintChoicesEnabled(enabled){
      const box=document.getElementById('sprintChoices');
      if(!box) return;
      box.querySelectorAll('button').forEach(b=>{b.disabled=!enabled; b.style.opacity = enabled? '1' : '0.55'; b.style.cursor = enabled? 'pointer' : 'not-allowed';});
    }

    function startSprint(){
      clearInterval(sprintTimer);
      sprintLeft=60; sprintScore=0; sprintRunning=false;
      document.getElementById("sprintTime").textContent = sprintLeft;
      document.getElementById("sprintStatus").textContent = "Tap an answer to start.";
      setSprintChoicesEnabled(true);
      nextSprint();
    }
    function nextSprint(){
      sprintQ = newSprintQ();
      document.getElementById("sprintQ").textContent = sprintQ.text;
      const box = document.getElementById("sprintChoices");
      box.innerHTML="";
      sprintQ.opts.forEach(v=>{
        const b=document.createElement("button");
        b.className="pill";
        b.textContent=String(v);
        b.onclick=()=>{
          if(!sprintRunning){
            sprintRunning=true;
            sprintTimer=setInterval(()=>{
              sprintLeft = Math.max(0, sprintLeft - 1);
              document.getElementById("sprintTime").textContent = sprintLeft;
              if(sprintLeft<=0){
                clearInterval(sprintTimer);
                sprintRunning=false;
                setSprintChoicesEnabled(false);
                document.getElementById("sprintStatus").textContent = `â±ï¸ Time! Score: ${sprintScore} â€¢ Tap â€œQuick Sprintâ€ to play again.`;
              }
            },1000);
          }
          if(sprintLeft<=0){ return; }
          if(v===sprintQ.ans){ sprintScore++; document.getElementById("sprintStatus").textContent = `âœ… Correct! Score: ${sprintScore}`; }
          else { document.getElementById("sprintStatus").textContent = `âŒ Try again! Score: ${sprintScore}`; }
          setTimeout(nextSprint, 350);
        };
        box.appendChild(b);
      });
    }

    // Memory Match
    let memFirst=null, memLock=false, memMatches=0;
    function startMemory(){
      const emojis=["ğŸ€","ğŸš€","â­","ğŸ¯","ğŸ§ ","ğŸ","ğŸŒˆ","ğŸ®"];
      const deck = emojis.concat(emojis).sort(()=>Math.random()-0.5);
      memFirst=null; memLock=false; memMatches=0;
      const grid=document.getElementById("memGrid");
      grid.innerHTML="";
      deck.forEach((emo, idx)=>{
        const btn=document.createElement("button");
        btn.className="slot";
        btn.style.height="54px";
        btn.dataset.emo=emo;
        btn.dataset.open="0";
        btn.textContent="â“";
        btn.onclick=()=>{
          if(memLock) return;
          if(btn.dataset.open==="1") return;
          btn.textContent=emo;
          btn.dataset.open="1";
          if(!memFirst){ memFirst=btn; return; }
          if(memFirst.dataset.emo===btn.dataset.emo){
            memMatches++;
            memFirst=null;
            document.getElementById("memStatus").textContent = `âœ… Matched ${memMatches}/8 pairs`;
            if(memMatches===8){ document.getElementById("memStatus").textContent = "ğŸ† All pairs found!"; }
          } else {
            memLock=true;
            setTimeout(()=>{
              btn.textContent="â“"; btn.dataset.open="0";
              memFirst.textContent="â“"; memFirst.dataset.open="0";
              memFirst=null;
              memLock=false;
            }, 650);
          }
        };
        grid.appendChild(btn);
      });
      document.getElementById("memStatus").textContent="Find all pairs.";
    }

    // =========================
    // Countdown + join enable (T-5min)
    // Hide countdown if ended
    // =========================
    let cdTimer=null;
    function startCountdown(classDT, tz){
      clearInterval(cdTimer);

      const joinBtn = document.getElementById("btnJoin");
      const cd      = document.getElementById("countdown");
      const label   = document.getElementById("timerLabel");

      // preserve original join behavior (set in renderBooking)
      const originalJoinText = joinBtn ? joinBtn.textContent : "";
      const originalJoinOnclick = joinBtn ? joinBtn.onclick : null;

      let missedApplied = false;

      function tick(){
        const now = new Date();
        const diff = classDT.getTime() - now.getTime();

        // Class is over if more than +60 min past start
        if(now.getTime() > classDT.getTime() + 60*60*1000){
          clearInterval(cdTimer);

          if(label) label.textContent = "Class status";
          if(cd) cd.textContent = "Class time is over";

          // Switch to missed UI once (and keep games/facts visible)
          if(!missedApplied){
            missedApplied = true;
            setMissedUI(bookingCourseName);
          }

          // Replace Join with reschedule CTA
          if(joinBtn){
            joinBtn.disabled = false;
            joinBtn.textContent = "â° Pick a New Time Slot";
            joinBtn.onclick = ()=> openRes();
          }
          return;
        }

        // restore normal locked pill if not missed (safety)
        if(missedApplied){
          missedApplied = false;
          // restore welcome copy to normal in case user rescheduled
          setNormalUI((BOOKING?.child_name || "").trim().split(/\s+/)[0] || "Student", bookingCourseName);
          if(joinBtn){
            joinBtn.textContent = originalJoinText || "ğŸ¥ Join Class";
            joinBtn.onclick = originalJoinOnclick;
          }
        }

        // Class is live (started, but not over)
        if(diff <= 0){
          if(label) label.textContent = "Class is live";
          if(cd) cd.textContent = "Now";
          if(joinBtn){
            joinBtn.disabled = false;
            // keep original click (meeting link)
            joinBtn.textContent = originalJoinText || "ğŸ¥ Join Class";
            joinBtn.onclick = originalJoinOnclick;
          }
          return;
        }

        const totalSec = Math.floor(diff/1000);
        const hh = Math.floor(totalSec/3600);
        const mm = Math.floor((totalSec%3600)/60);
        const ss = totalSec%60;

        if(cd){
          cd.textContent = `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
        }

        // enable join at T-5 minutes
        if(joinBtn){
          joinBtn.textContent = originalJoinText || "ğŸ¥ Join Class";
          joinBtn.onclick = originalJoinOnclick;
          joinBtn.disabled = diff > 5*60*1000;
        }
      }

      tick();
      cdTimer = setInterval(tick, 1000);
    }

    // =========================
    // Terms modal
    // =========================
    const termsModal = document.getElementById("termsModal");
    document.getElementById("openTerms").onclick = ()=> termsModal.classList.add("open");
    document.getElementById("closeTerms").onclick = ()=> termsModal.classList.remove("open");
    termsModal.addEventListener("click", (e)=>{ if(e.target===termsModal) termsModal.classList.remove("open"); });
    // =========================
    // Reschedule logic (Brightchamps-style drawer)
    // Updates: preferred_date, preferred_time_slot, timezone (optional)
    // and slot_id (optional) based on chosen slot
    // =========================
    const resDrawer = document.getElementById("resDrawer");
    document.getElementById("btnReschedule").onclick = ()=> openRes();
    document.getElementById("closeRes").onclick = ()=> closeRes();
    document.getElementById("cancelRes").onclick = ()=> closeRes();
    resDrawer.addEventListener("click", (e)=>{ if(e.target===resDrawer) closeRes(); });
    function openRes(){
      if(!BOOKING) return;
      resDrawer.classList.add("open");
      resDrawer.setAttribute("aria-hidden","false");
      // default selection
      buildResDates();
      fetchResSlots();
    }
    function closeRes(){
      resDrawer.classList.remove("open");
      resDrawer.setAttribute("aria-hidden","true");
      // reset active slot
      selectedResSlot = null;
      document.getElementById("confirmRes").disabled = true;
    }

    // timezone dropdown (like page 1 style, but simplified list)
    const TZ_OPTIONS = [
      {label:"India (IST) â€” Asia/Kolkata", tz:"Asia/Kolkata"},
      {label:"UAE (GST) â€” Asia/Dubai", tz:"Asia/Dubai"},
      {label:"Saudi Arabia â€” Asia/Riyadh", tz:"Asia/Riyadh"},
      {label:"Singapore â€” Asia/Singapore", tz:"Asia/Singapore"},
      {label:"Indonesia (Jakarta) â€” Asia/Jakarta", tz:"Asia/Jakarta"},
      {label:"Philippines â€” Asia/Manila", tz:"Asia/Manila"},
      {label:"Vietnam â€” Asia/Ho_Chi_Minh", tz:"Asia/Ho_Chi_Minh"},
      {label:"Thailand â€” Asia/Bangkok", tz:"Asia/Bangkok"},
      {label:"UK â€” Europe/London", tz:"Europe/London"},
      {label:"Germany â€” Europe/Berlin", tz:"Europe/Berlin"},
      {label:"USA (Eastern) â€” America/New_York", tz:"America/New_York"},
      {label:"USA (Central) â€” America/Chicago", tz:"America/Chicago"},
      {label:"USA (Pacific) â€” America/Los_Angeles", tz:"America/Los_Angeles"},
      {label:"Australia â€” Australia/Sydney", tz:"Australia/Sydney"},
      {label:"New Zealand â€” Pacific/Auckland", tz:"Pacific/Auckland"},
    ];
    let resTZ = "Asia/Kolkata";
    let resDate = null; // YYYY-MM-DD (in IST date for DB fetch)
    let selectedResSlot = null;
    // {slot_id, display, localDate}

    function initRescheduleUI(){
      const sel = document.getElementById("tzSelect");
      sel.innerHTML="";
      TZ_OPTIONS.forEach(o=>{
        const op=document.createElement("option");
        op.value=o.tz;
        op.textContent=o.label;
        sel.appendChild(op);
      });
      resTZ = bookingTZ;
      // pick nearest option or set custom at top if not in list
      if(!TZ_OPTIONS.some(o=>o.tz===resTZ)){
        const op=document.createElement("option");
        op.value=resTZ;
        op.textContent=`Your timezone â€” ${resTZ}`;
        sel.insertBefore(op, sel.firstChild);
      }
      sel.value = resTZ;
      sel.onchange = ()=>{
        resTZ = safeTZ(sel.value);
        buildResDates();
        fetchResSlots();
      };
    }

    function buildResDates(){
      const wrap=document.getElementById("resDates");
      wrap.innerHTML="";

      // Next 7 days INCLUDING today, based on SELECTED timezone (resTZ)
      const todayKey = fmtDateSQL(new Date(), resTZ); // correct local date for resTZ
      const dates=[];
      for(let i=0;i<7;i++){
        dates.push(addDaysInTZ(todayKey, i, resTZ)); // local date keys in resTZ
      }

      resDate = dates[0];

      dates.forEach((key, idx)=>{
        // render label in selected timezone using a safe noon anchor
        const noonUtc = zonedTimeToUtc(key, "12:00 PM", resTZ);
        const shown = new Intl.DateTimeFormat("en-US",{timeZone:resTZ, weekday:"short", month:"short", day:"numeric"}).format(noonUtc);

        const pill=document.createElement("button");
        pill.className="pill"+(idx===0?" active":"");
        pill.textContent = (idx===0?"Today â€¢ ":"")+shown;
        pill.onclick=()=>{
          [...wrap.querySelectorAll(".pill")].forEach(p=>p.classList.remove("active"));
          pill.classList.add("active");
          resDate = key; // local date in resTZ
          fetchResSlots();
        };
        wrap.appendChild(pill);
      });
    }

    async function fetchResSlots(){
      const grid=document.getElementById("resSlots");
      const empty=document.getElementById("resEmpty");
      grid.innerHTML="";
      empty.classList.add("hide");
      selectedResSlot = null;
      document.getElementById("confirmRes").disabled = true;

      if(!BOOKING || !bookingRegion) {
        empty.classList.remove("hide");
        empty.textContent="Missing region. Please contact support.";
        return;
      }
      if(!resDate) buildResDates();

      // IMPORTANT:
      // UI uses resDate as LOCAL date in resTZ.
      // DB slots are stored by IST day key (slot_date). To avoid timezone date-jumps,
      // we query a small IST window (prev/today/next) and then FILTER by local date in resTZ.
      const noonUtc = zonedTimeToUtc(resDate, "12:00 PM", resTZ);
      const istToday = fmtDateSQL(noonUtc, "Asia/Kolkata");
      const istPrev  = fmtDateSQL(new Date(noonUtc.getTime() - 86400000), "Asia/Kolkata");
      const istNext  = fmtDateSQL(new Date(noonUtc.getTime() + 86400000), "Asia/Kolkata");
      const istKeys = Array.from(new Set([istPrev, istToday, istNext]));

      const { data, error } = await sb
        .from("demo_slots_live_view")
        .select("*")
        .eq("region_key", bookingRegion)
        .eq("course_id", BOOKING.course_id || courseId)
        .in("slot_date", istKeys);

      if(error){ console.error(error); empty.classList.remove("hide"); empty.textContent="Failed to load slots."; return; }
      if(!data || data.length===0){ empty.classList.remove("hide"); return; }

      const slots=[];
      data.forEach(r=>{
        const utc = new Date(r.slot_start_utc);

        // filter strictly to the selected LOCAL date
        const localDate = fmtDateSQL(utc, resTZ);
        if(localDate !== resDate) return;

        // SEA hide < 7AM in local time
        const p24 = fmtParts(utc, resTZ, {hour:"2-digit", minute:"2-digit", hour12:false});
        const hh24 = parseInt(p24.hour,10);
        const mm24 = parseInt(p24.minute,10);
        if(bookingRegion === "SEA" && hh24 < 7) return;

        const p12 = fmtParts(utc, resTZ, {hour:"numeric", minute:"2-digit", hour12:true});
        const display = `${p12.hour}:${p12.minute} ${p12.dayPeriod}`;

        slots.push({
          slot_id: r.slot_id,
          isStar: r.is_star_teacher,
          display,
          minutes: (hh24*60 + mm24),
          utcInstant: utc
        });
      });

      // If this is "today" in the selected timezone, hide slots earlier than now + 60 minutes (timezone-safe)
      try {
        const todayKey = fmtDateSQL(new Date(), resTZ);
        if (resDate === todayKey) {
          const nowP = fmtParts(new Date(), resTZ, {hour:"2-digit", minute:"2-digit", hour12:false});
          const nowMin = (parseInt(nowP.hour,10)*60) + parseInt(nowP.minute,10);
          const minAllowed = nowMin + 60; // +60 minutes buffer
          for (let i = slots.length - 1; i >= 0; i--) {
            if (slots[i].minutes < minAllowed) slots.splice(i, 1);
          }
        }
      } catch (e) { console.warn("Reschedule slot filter failed", e); }

      // Sort strictly from 12:00 AM -> 11:59 PM
      slots.sort((a,b)=>a.minutes - b.minutes);

      if(slots.length===0){ empty.classList.remove("hide"); return; }

      slots.forEach(s=>{
        const btn=document.createElement("button");
        btn.className="slot";
        btn.innerHTML=`<div class="t">${s.display}</div>`;
        if(s.isStar){
          const tag=document.createElement("div");
          tag.className="star";
          tag.textContent="â­ Star";
          btn.appendChild(tag);
        }
        btn.onclick=()=>{
          [...grid.querySelectorAll(".slot")].forEach(x=>x.classList.remove("active"));
          btn.classList.add("active");
          selectedResSlot = s;
          document.getElementById("confirmRes").disabled = false;
        };
        grid.appendChild(btn);
      });
    }

    document.getElementById("confirmRes").onclick = async ()=>{
      if(!BOOKING || !selectedResSlot) return;
      // We store preferred_date as DB date (IST date) and preferred_time_slot as display string
      // Additionally store timezone if user changed it.
      const upd = (function(){
        const d = selectedResSlot.utcInstant; // UTC instant as Date
        return {
          // user-facing
          preferred_date: resDate,
          preferred_time_slot: selectedResSlot.display,

          // slot linkage
          slot_live_id: selectedResSlot.slot_id,
          slot_id: selectedResSlot.slot_id,

          // schedule (source of truth for Zoom automation)
          scheduled_at_utc: d.toISOString(),
          scheduled_at_ist: fmtDateTimeSQL(d, "Asia/Kolkata"),
          scheduled_local_date: fmtDateSQL(d, resTZ),
          scheduled_local_label: fmtLabel(d, resTZ),
          lead_timezone: resTZ,
          timezone: resTZ,

          // IMPORTANT: reset Zoom so CRON recreates meeting
          zoom_status: "not_created",
          zoom_account_id: null,
          zoom_meeting_id: null,
          zoom_join_url: null,
          zoom_start_url: null,
          meeting_created_at: null,

          booking_status: "rescheduled",
          updated_at: new Date().toISOString()
        };
      })();

      const { error } = await sb
        .from("demo_leads")
        .update(upd)
        .eq(leadFilter.col, leadFilter.val);

      if(error){
        console.error(error);
        toast("Reschedule failed. Try again.");
        return;
      }

      toast("âœ… Rescheduled!");
      closeRes();

      // reload booking fresh
      document.getElementById("stateLoading").classList.remove("hide"); // kept for visual feedback on refresh
      const fresh = await loadBooking();
      document.getElementById("stateLoading").classList.add("hide");
      if(fresh) renderBooking(fresh);
    };

    // =========================
    // Boot
    // =========================
    (async function init(){
      const loading=document.getElementById("stateLoading");
      const err=document.getElementById("stateError");
      const section2=document.getElementById("section2");

      if(!leadFilter){
        // loading.classList.add("hide"); // REMOVED to keep UI visible
        err.classList.remove("hide");
        err.textContent = "Missing booking reference. Please check the link or contact support.";
        return;
      }

      const b = await loadBooking();
      // loading.classList.add("hide"); // REMOVED - element no longer exists in same form

      if(!b){
        err.classList.remove("hide");
        return;
      }

      err.classList.add("hide");
      // section2.classList.remove("hide"); // REMOVED - UI is visible by default
      renderBooking(b);
    })();
  
// Init dashboard
(async function initDashboard() {
  try {
    const booking = await loadBooking();
    if (!booking) {
      document.getElementById("stateError")?.classList.remove("hide");
      return;
    }
    renderBooking(booking);
  } catch (e) {
    console.error("Dashboard init failed", e);
    document.getElementById("stateError")?.classList.remove("hide");
  }
})();
</script>
  <!-- DEMO DASHBOARD FOOTER -->
<footer class="demo-footer">

  <div class="footer-mission">
    <div class="footer-mission-logo">
      <img src="https://res.cloudinary.com/dpapyknn4/image/upload/v1763143023/Unischooly_Horizontal_logo_qbu1l7.svg" alt="Unischooly">
    </div>

    <p class="footer-mission-text">
      Unischooly is on a mission to make world-class education accessible to every child, everywhere.
      Through live online classes in coding, mathematics, AI, chess and more, we help students build
      creativity, logical thinking and problem-solving skills that prepare them for the future.
      Our expert instructors and structured, project-based curriculum turn curious learners into
      confident creators, innovators and leaders of tomorrow.
    </p>

    <div class="footer-offices">
      <strong>Our offices are located in:</strong>
      <div class="footer-office-item">ğŸ‡¸ğŸ‡¬ Singapore</div>
      <div class="footer-office-item">ğŸ‡ºğŸ‡¸ USA</div>
      <div class="footer-office-item">ğŸ‡®ğŸ‡³ India</div>
    </div>
  </div>

  <!-- BOTTOM BAR -->
  <div class="demo-footer-bottom">
    <div class="demo--bottom-inner">

      <!-- LEFT -->
      <div class="demo--left">
        Email us at <a href="mailto:support@unischooly.com">support@unischooly.com</a>
      </div>

      <!-- CENTER -->
      <div class="demo--center">
        Â© UNISCHOOLY 2025. All Rights Reserved
      </div>

      <!-- RIGHT -->
      <div class="demo--right">
        <span>Follow us on:</span>
        <div class="demo--social">
          <a href="https://www.facebook.com/" target="_blank">
            <img src="https://res.cloudinary.com/dpapyknn4/image/upload/v1764348909/Facebook-icon-design-on-transparent-background-PNG_i4jaan.png" alt="Facebook">
          </a>
          <a href="https://www.youtube.com/" target="_blank">
            <img src="https://res.cloudinary.com/dpapyknn4/image/upload/v1764348908/Untitled_design_12_twsuqq.png" alt="YouTube">
          </a>
          <a href="https://www.linkedin.com/" target="_blank">
            <img src="https://res.cloudinary.com/dpapyknn4/image/upload/v1764348908/Untitled_design_13_bjetb3.png" alt="LinkedIn">
          </a>
          <a href="https://www.instagram.com/" target="_blank">
            <img src="https://res.cloudinary.com/dpapyknn4/image/upload/v1764348908/Untitled_design_14_wx3isf.png" alt="Instagram">
          </a>
          <a href="https://wa.me/919270975247" target="_blank">
            <img src="https://res.cloudinary.com/dpapyknn4/image/upload/v1764348908/Untitled_design_15_f1stq2.png" alt="WhatsApp">
          </a>
        </div>
      </div>

    </div>
  </div>

</>
</body>
</html>
