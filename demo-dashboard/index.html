<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unischooly | Demo Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#050816;
      --card:#0b0f24;
      --card2:#0f1633;
      --border:rgba(255,255,255,.10);
      --text:#f8f5ff;
      --sub:#a8acd0;
      --muted:#7b7fa9;
      --shadow:0 18px 40px rgba(0,0,0,.55);

      /* Brand gradient */
      --g1:#9b5bff;
      --g2:#ff7b5f;
      --grad:linear-gradient(135deg,var(--g1),var(--g2));
      --radius:18px;
      --pill:999px;
      --t: .18s ease-out;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:radial-gradient(circle at top, #211a44 0, #050816 55%, #020010 100%);
    }

    .page{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:14px 12px 24px;
    }

    /* Section 1 - Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:22px;
      background:rgba(7,10,28,.72);
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .brand img{
      height:30px;
      width:auto;
      display:block;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,.55));
    }

    /* Animated Tick */
    .locked{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 16px;
      border-radius:var(--pill);
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color:white;
      font-weight:800;
      letter-spacing:.2px;
      font-size:13px;
      white-space:nowrap;
    }
    .locked-icon {
        width: 20px; height: 20px;
        border-radius: 50%;
        background: var(--grad);
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 10px rgba(155, 91, 255, 0.4);
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(155, 91, 255, 0.7); }
        70% { box-shadow: 0 0 0 8px rgba(155, 91, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(155, 91, 255, 0); }
    }

    /* Section 2 - Grid */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (min-width: 980px){
      .grid{grid-template-columns: 1fr 1fr; gap:14px;}
    }

    .card{
      background:radial-gradient(circle at 0 0, rgba(155,91,255,.18), transparent 55%), rgba(11,15,36,.92);
      border:1px solid var(--border);
      border-radius:26px;
      box-shadow:var(--shadow);
      position:relative;
    }
    .card-inner{padding:16px 14px;}
    @media (min-width: 720px){
      .card-inner{padding:18px 18px;}
    }

    /* Ticket */
    .ticket{
      position:relative;
      background:
        radial-gradient(circle at 0 0, rgba(255,123,95,.18), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(155,91,255,.18), transparent 55%),
        rgba(12,16,40,.94);
      border:1px solid rgba(255,255,255,.14);
      border-radius:20px;
      overflow:hidden;
      transition: transform var(--t), box-shadow var(--t), border-color var(--t);
    }
    .ticket:hover{
      transform: translateY(-2px);
      border-color: rgba(155,91,255,.55);
      box-shadow:0 22px 48px rgba(0,0,0,.6);
    }
    .ticket::before, .ticket::after{
      content:""; position:absolute; top:50%; width:34px; height:34px;
      border-radius:50%; background: rgba(5,8,22,1); border:1px solid rgba(255,255,255,.12);
      transform: translateY(-50%); z-index:2;
    }
    .ticket::before{left:-17px}
    .ticket::after{right:-17px}

    .ticket-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding:14px 14px 10px; border-bottom:1px dashed rgba(255,255,255,.18);
    }
    .ticket-title{
      font-weight:900; letter-spacing:.4px; font-size:13px; text-transform:uppercase; opacity:.98;
    }
    .ticket-sub{ font-size:12px; color:var(--sub); margin-top:2px; }

    .stamp{
      position:absolute; right:12px; top:12px; transform: rotate(10deg);
      background: rgba(0,0,0,.25); border:2px solid rgba(255,255,255,.22);
      border-radius:14px; padding:10px 10px 8px; color:white;
      box-shadow:0 18px 30px rgba(0,0,0,.45); z-index:3; backdrop-filter: blur(6px);
    }
    .stamp .big{
      font-weight:1000; font-size:12px; letter-spacing:.6px; text-transform:uppercase;
      background:var(--grad); -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .stamp .small{ font-size:10px; color:rgba(255,255,255,.88); margin-top:2px; text-align:center; }

    .ticket-body{ display:grid; grid-template-columns: 1fr; gap:12px; padding:12px 14px 14px; }
    @media (min-width: 520px){ .ticket-body{grid-template-columns:1fr 1fr} }
    
    .ticket-col h4{
      margin:0 0 6px; font-size:12px; letter-spacing:.4px;
      color:rgba(255,255,255,.92); text-transform:uppercase;
    }
    .kv{
      display:grid; grid-template-columns: 86px 1fr; gap:8px 10px;
      font-size:13px; align-items:center;
    }
    .k{color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.3px}
    
    /* FIX 1: Email Visibility & Cursor */
    .v{
        font-weight:800; color:var(--text); min-width:0;
        /* changed from overflow:hidden/ellipsis to break-all so full email shows on desktop */
        word-break: break-all;
        display: block;
        line-height: 1.3;
    }
    #vEmail { cursor: pointer; transition: color 0.2s; }
    #vEmail:hover { color: var(--sub); }

    .powered{
      text-align:center; font-size:10px; color:rgba(255,255,255,.70);
      padding:8px 10px 10px; border-top:1px dashed rgba(255,255,255,.14);
    }

    /* Schedule */
    .schedule-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .schedule-title{ display:flex; flex-direction:column; gap:2px; }
    .schedule-title .tag{ display:inline-flex; align-items:center; gap:7px; font-weight:900; font-size:12px; color:white; }
    .schedule-title .tag span{
      display:inline-flex; width:22px; height:22px; border-radius:8px;
      align-items:center; justify-content:center;
      background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.14);
    }
    .schedule-title .sub{ color:var(--sub); font-size:12px; }

    .btn{
      border:0; border-radius: var(--pill); padding:10px 14px;
      font-weight:900; color:white; background: var(--grad); cursor:pointer;
      box-shadow:0 16px 28px rgba(155,91,255,.22);
      transition: transform var(--t), box-shadow var(--t), opacity var(--t);
      display:inline-flex; align-items:center; gap:8px; white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); box-shadow:0 22px 34px rgba(155,91,255,.28);}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none; box-shadow:none;}
    .btn-ghost{
      background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.16);
      color:rgba(255,255,255,.92); box-shadow:none;
    }
    .btn-ghost:hover{background:rgba(255,255,255,.12); transform: translateY(-1px);}

    .schedule-box{
      display:grid; grid-template-columns: 104px 1fr; gap:12px; align-items:center;
      padding:12px; border-radius:18px; border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,28,.72); overflow:visible;
    }
    .cal{
      width:104px; height:104px; border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.25), transparent 55%), rgba(10,13,42,.95);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .cal .m{
      padding:8px 10px; background: rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.10); font-size:12px; font-weight:900;
      letter-spacing:.8px; text-transform:uppercase; text-align:center;
    }
    .cal .d{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; }
    .cal .daynum{ font-size:34px; font-weight:1000; line-height:1; }
    .cal .dow{ font-size:12px; color:rgba(255,255,255,.78); font-weight:800; letter-spacing:.4px; text-transform:uppercase; }

    .sched-info .line1{ font-weight:1000; font-size:16px; margin-bottom:4px; }
    .sched-info .line2{ color:var(--sub); font-size:13px; line-height:1.25; }
    .sched-actions{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }

    /* Dropdown */
    .dropdown{position:relative}
    .menu{
      position:absolute; left:0; top:44px; width:260px;
      background: rgba(11,15,36,.98); border:1px solid rgba(255,255,255,.14);
      border-radius:16px; box-shadow:0 22px 50px rgba(0,0,0,.6);
      padding:8px; display:none; z-index:100;
    }
    .menu.open{display:block}
    .menu a, .menu button{
      width:100%; display:flex; justify-content:space-between; align-items:center;
      gap:10px; padding:10px 10px; border-radius:12px; border:0;
      background: transparent; color: rgba(255,255,255,.92);
      text-decoration:none; font-weight:800; font-size:13px; cursor:pointer;
    }
    .menu a:hover, .menu button:hover{background: rgba(255,255,255,.08);}

    /* FIX 2: Fun Facts - Remove Dead Space & Bad Loader */
    .facts{
      margin-top:12px; border-radius:18px; border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,28,.72); padding:12px;
      min-height: auto; /* Allow shrinking */
      display: flex; flex-direction: column; gap: 10px; /* Reduced gap */
    }
    .facts-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .facts-head .t{ font-weight:1000; font-size:14px; display: flex; align-items: center; gap: 8px; }
    
    /* New Spinner Ring next to title instead of bar */
    .timer-ring {
      width: 14px; height: 14px;
      border: 2px solid rgba(255,255,255,0.1);
      border-top-color: #9b5bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .facts-nav{display:flex; gap:8px;}
    .iconbtn{
      width:36px; height:36px; border-radius:12px; border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06); color:white; font-weight:900;
      cursor:pointer; transition: transform var(--t), background var(--t);
    }
    .iconbtn:hover{transform: translateY(-1px); background: rgba(255,255,255,.10);}
    
    .factbox{
      min-height:62px; display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px; border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
    }
    .factemoji{font-size:20px}
    .facttext{font-size:14px; color:rgba(255,255,255,.92); font-weight:800; line-height:1.25;}

    /* Welcome / Timer */
    .welcome{ padding:16px 14px; }
    .welcome h2{ margin:0 0 6px; font-size:22px; letter-spacing:.2px; }
    .welcome p{ margin:0 0 10px; color:var(--sub); font-size:14px; line-height:1.35; }
    
    /* FIX 5: Gradient Text Class */
    .grad-text {
      background: var(--grad);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .timer{
      display:flex; flex-direction:column; gap:10px; margin-top:10px;
      padding:12px; border-radius:18px; border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,28,.72);
    }
    .timer-row{ display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .timer-label{font-weight:1000; font-size:14px;}
    .count{ font-variant-numeric: tabular-nums; font-size:22px; font-weight:1000; letter-spacing:.6px; }
    .joinwrap{ display:flex; justify-content:center; margin-top:6px; }
    .disclaimer{ margin-top:10px; font-size:11px; color:rgba(255,255,255,.70); line-height:1.35; }
    .linklike{ color:white; text-decoration:underline; cursor:pointer; font-weight:900; }

    /* Reschedule Drawer */
    .res-btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 12px;
      border-radius: var(--pill); border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06); color:white; font-weight:900;
      cursor:pointer; transition: transform var(--t), background var(--t); white-space:nowrap;
    }
    .res-btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.10);}

    .drawer{ position:fixed; inset:0; background: rgba(0,0,0,.55); display:none; z-index:80; }
    .drawer.open{display:block}
    .panel{
      position:absolute; top:0; right:0; width:min(520px, 100%); height:100%;
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.20), transparent 55%), rgba(11,15,36,.98);
      border-left:1px solid rgba(255,255,255,.12); box-shadow:-22px 0 60px rgba(0,0,0,.65);
      padding:14px 14px 18px; overflow:auto;
    }
    .panel h3{margin:8px 0 4px; font-size:18px;}
    .panel .sub{margin:0 0 10px; color:var(--sub); font-size:13px;}
    .panel-top{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .xbtn{
      width:40px; height:40px; border-radius:14px; border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06); color:white; cursor:pointer; font-size:18px; font-weight:900;
    }

    .select{
      width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.16);
      background: rgba(7,10,28,.72); color:white; padding:10px 12px; outline:none; font-weight:800; font-size:13px;
    }

    .pills{display:flex; flex-wrap:wrap; gap:10px; margin-top:8px;}
    .pill{
      padding:9px 12px; border-radius:16px; border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06); color:rgba(255,255,255,.86); cursor:pointer;
      font-weight:900; font-size:13px; transition: transform var(--t), background var(--t), border-color var(--t);
      min-width:120px;
    }
    .pill:hover{transform: translateY(-1px); background: rgba(255,255,255,.10);}
    .pill.active{
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.34), transparent 60%), rgba(10,13,42,.95);
      border-color: rgba(155,91,255,.55); color:white;
    }

    .slotgrid{ margin-top:10px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
    @media (min-width:420px){ .slotgrid{grid-template-columns: repeat(3, minmax(0,1fr));} }
    
    /* FIX 3: Slot Padding for Star Badge */
    .slot{
      border-radius:14px; border:1px solid rgba(255,255,255,.16); background: rgba(255,255,255,.06);
      padding:10px 10px; cursor:pointer; font-weight:1000; text-align:center;
      transition: transform var(--t), background var(--t), border-color var(--t);
      font-size:13px; position:relative; min-height:44px;
      display:flex; align-items:center; justify-content:center; color: #e9ecff;
      padding-right: 50px; /* Space for Star */
    }
    .slot:hover{transform: translateY(-1px); background: rgba(255,255,255,.10);}
    .slot.active{
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.34), transparent 60%), rgba(10,13,42,.95);
      border-color: rgba(155,91,255,.55); color:white;
    }
    .star{
      position:absolute; top:6px; right:6px; font-size:10px; padding:2px 6px;
      border-radius:var(--pill); border:1px solid rgba(255,222,140,.8);
      background: rgba(79,54,7,.45); color:#ffeec4; font-weight:1000;
    }

    .modal{ position:fixed; inset:0; display:none; background: rgba(0,0,0,.60); z-index:90; padding:18px 12px; }
    .modal.open{display:flex; align-items:center; justify-content:center;}
    .modal-card{
      width:min(760px, 100%); border-radius:22px; border:1px solid rgba(255,255,255,.14);
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.20), transparent 55%), rgba(11,15,36,.98);
      box-shadow:0 22px 60px rgba(0,0,0,.75); padding:16px 16px 14px;
    }
    .modal-top{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .modal-top h3{margin:0; font-size:18px;}
    .modal-top p{margin:4px 0 0; color:var(--sub); font-size:13px;}
    .modal-card ul{ margin:10px 0 0; padding-left:18px; color:rgba(255,255,255,.88); font-size:13px; line-height:1.5; }

    .state{
      margin-top:12px; padding:12px 14px; border-radius:18px; border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,28,.72); color:rgba(255,255,255,.86); font-weight:800; font-size:13px;
    }
    .hide{display:none !important;}

    @media (max-width: 768px) {
        .brand img { height: 24px; } 
        .topbar { flex-direction: row; }
        .menu { width: 220px; left: -50px; }
        .ticket-body { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <div class="brand">
        <img src="https://res.cloudinary.com/dpapyknn4/image/upload/v1763143023/Unischooly_Horizontal_logo_qbu1l7.svg" alt="Unischooly" />
      </div>
      <div class="locked">
        <div class="locked-icon">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        </div>
        Your trial class is locked in!
      </div>
    </div>

    <div id="stateError" class="state hide">Booking not found. Please check the link.</div>
    <div id="stateLoading" class="state hide">Loading...</div>

    <div id="section2" class="grid">
      <div class="card">
        <div class="card-inner">
          <div class="ticket" id="ticketCard">
            <div class="stamp" aria-label="Value waived stamp">
              <div class="big">VALUE<br/>WAIVED</div>
              <div class="small">$30</div>
            </div>
            <div class="ticket-head">
              <div>
                <div class="ticket-title">üé´ OFFICIAL FREE TRIAL PASS</div>
                <div class="ticket-sub">Valid for 1 session ‚Ä¢ Powered by Unischooly</div>
              </div>
            </div>
            <div class="ticket-body">
              <div class="ticket-col">
                <h4>Admit One Student</h4>
                <div class="kv">
                   <div class="k">Name</div><div class="v" id="vChild">‚Äî</div>
                  <div class="k">Grade</div><div class="v" id="vGrade">‚Äî</div>
                  <div class="k">Course</div><div class="v" id="vCourse">‚Äî</div>
                </div>
              </div>
              <div class="ticket-col">
                 <h4>Parent Confirmation</h4>
                <div class="kv">
                  <div class="k">Sent to</div><div class="v" id="vParent">‚Äî</div>
                  <div class="k">Cell</div><div class="v" id="vPhone">‚Äî</div>
                  <div class="k">Email</div><div class="v" id="vEmail" title="Click to copy">‚Äî</div>
                </div>
              </div>
            </div>
            <div class="powered">Powered by Unischooly</div>
          </div>

          <div style="height:12px"></div>
          <div class="schedule-head">
             <div class="schedule-title">
              <div class="tag"><span>üöÄ</span> Ready for Blast Off!!!</div>
              <div class="sub">Class Schedule</div>
            </div>
            <button class="res-btn" id="btnReschedule">üóìÔ∏è Reschedule</button>
          </div>

          <div class="schedule-box">
            <div class="cal" aria-label="Calendar">
              <div class="m" id="calMonth">‚Äî</div>
              <div class="d">
                <div class="daynum" id="calDay">‚Äî</div>
                <div class="dow" id="calDow">‚Äî</div>
              </div>
            </div>
            <div class="sched-info">
              <div class="line1" id="schedTime">‚Äî</div>
              <div class="line2" id="schedMeta">‚Äî</div>
              <div class="sched-actions">
                <div class="dropdown">
                  <button class="btn" id="btnCalendar">üìÖ Initiate Calendar Sync</button>
                  <div class="menu" id="calMenu">
                    <a id="calGoogle" target="_blank" rel="noreferrer">Google Calendar <span>‚Üó</span></a>
                    <a id="calApple" target="_blank" rel="noreferrer">Apple Calendar (ICS) <span>‚¨á</span></a>
                    <a id="calOutlook" target="_blank" rel="noreferrer">Outlook.com <span>‚Üó</span></a>
                    <a id="calYahoo" target="_blank" rel="noreferrer">Yahoo Calendar <span>‚Üó</span></a>
                    <button id="calDownload">Download .ics <span>‚¨á</span></button>
                  </div>
                </div>
                <button class="btn btn-ghost" id="btnCopy">üîó Copy class time</button>
             </div>
            </div>
          </div>

          <div class="facts">
            <div class="facts-head">
              <div class="t">
                  ‚ú® Fun Facts
                  <div class="timer-ring"></div>
              </div>
              <div class="facts-nav">
                <button class="iconbtn" id="factPrev">‚Äπ</button>
                <button class="iconbtn" id="factNext">‚Ä∫</button>
              </div>
            </div>
            <div class="factbox" aria-live="polite">
              <div class="factemoji" id="factEmoji">üí°</div>
              <div class="facttext" id="factText">‚Äî</div>
            </div>
            </div>
        </div>
      </div>

      <div class="card">
        <div class="welcome">
          <h2 id="welcomeTitle">Welcome!</h2>
          <p id="welcomeSub">Your trial class details are loading.</p>

          <div class="timer">
            <div class="timer-row">
              <div class="timer-label" id="timerLabel">Join class in</div>
              <div class="count" id="countdown">--:--:--</div>
            </div>
            <div class="joinwrap">
              <button class="btn" id="btnJoin" disabled>üé• Join Class</button>
            </div>
            <div class="disclaimer">
              By clicking join class, you are confirming that you have read, understood and agree to
              <span class="linklike" id="openTerms">Terms & Conditions</span>.
            </div>
          </div>

          <div class="facts" style="margin-top:12px">
            <div class="facts-head">
              <div class="t">Sharpen Your Brain üß†</div>
              <div class="facts-nav">
                <button class="iconbtn" id="pPrev">‚Äπ</button>
                <button class="iconbtn" id="pNext">‚Ä∫</button>
              </div>
            </div>
            <div class="factbox" style="align-items:flex-start">
              <div class="factemoji">üß©</div>
              <div style="flex:1">
                <div class="facttext" id="pQuestion" style="margin-bottom:8px">‚Äî</div>
                  <div class="pills" id="pChoices" style="margin-top:0"></div>
                <div style="margin-top:8px; font-size:11px; color:rgba(255,255,255,.72); font-weight:800" id="pStatus">‚Äî</div>
              </div>
            </div>
          </div>

          <div class="facts" style="margin-top:12px">
            <div class="facts-head">
                <div class="t">Mini Games üéÆ</div>
              <div style="font-size:11px; color:rgba(255,255,255,.72); font-weight:800">Quick brain boosters</div>
            </div>
            <div class="factbox" style="flex-direction:column; align-items:stretch; gap:10px">
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn btn-ghost" id="tabSprint">Quick Sprint</button>
                <button class="btn btn-ghost" id="tabMemory">Memory Match</button>
              </div>

              <div id="gameSprint" class="hide">
                 <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
                  <div style="font-weight:1000">Quick Math Sprint (60s)</div>
                  <div style="font-variant-numeric:tabular-nums; font-weight:1000" id="sprintTime">60</div>
                </div>
                <div style="margin-top:8px; font-size:14px; font-weight:1000" id="sprintQ">‚Äî</div>
                <div class="pills" style="margin-top:10px" id="sprintChoices"></div>
                <div style="margin-top:8px; font-size:11px; color:rgba(255,255,255,.72); font-weight:800" id="sprintStatus">Tap an answer to start.</div>
              </div>

              <div id="gameMemory" class="hide">
                <div style="font-weight:1000; margin-bottom:6px">Memory Match (Emoji)</div>
                <div style="display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:8px" id="memGrid"></div>
                <div style="margin-top:8px; font-size:11px; color:rgba(255,255,255,.72); font-weight:800" id="memStatus">Find all pairs.</div>
              </div>

              <div style="font-size:11px; color:rgba(255,255,255,.70); font-weight:800">Tip: Solving puzzles helps warm up your brain before class!</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="termsModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-top">
        <div>
          <h3>Terms & Conditions</h3>
          <p>Please keep these video conferencing etiquette tips in mind:</p>
        </div>
        <button class="xbtn" id="closeTerms">‚úï</button>
      </div>
      <ul>
        <li>By taking this demo/trial session, you consent to recording.</li>
        <li>Sessions are recorded for training and quality assurance.</li>
        <li>Zero tolerance policy for inappropriate behavior.</li>
        <li>Please avoid clothing with offensive messages.</li>
      </ul>
    </div>
  </div>

  <div id="resDrawer" class="drawer" aria-hidden="true">
    <div class="panel">
      <div class="panel-top">
        <div>
          <h3>Reschedule your class</h3>
          <div class="sub">Timezone is prefilled. You can change it.</div>
        </div>
        <button class="xbtn" id="closeRes">‚úï</button>
      </div>

      <div style="margin-top:10px">
        <div style="font-weight:1000; font-size:13px; margin-bottom:8px">Timezone</div>
        <select id="tzSelect" class="select"></select>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:1000; font-size:13px; margin-bottom:8px">Select Date</div>
        <div class="pills" id="resDates"></div>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:1000; font-size:13px; margin-bottom:8px">Select Start Time</div>
        <div class="sub">Slots shown in your selected timezone.</div>
        <div class="slotgrid" id="resSlots"></div>
        <div id="resEmpty" class="state hide" style="margin-top:10px">No slots available for this date.</div>
      </div>

      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
        <button class="btn btn-ghost" id="cancelRes">Cancel</button>
        <button class="btn" id="confirmRes" disabled>Confirm Reschedule</button>
      </div>
      <div style="margin-top:10px; font-size:11px; color:rgba(255,255,255,.70); font-weight:800">
        Your class timing will update instantly once confirmed.
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const url = new URL(window.location.href);
    const iduuid = url.searchParams.get("iduuid");
    const courseId = parseInt(url.searchParams.get("courseId") || "1", 10);

    const COURSE = {
      1:{name:"Coding", emoji:"üíª"}, 2:{name:"Python", emoji:"üêç"}, 3:{name:"Website Development", emoji:"üåê"},
      4:{name:"Generative AI", emoji:"‚ú®"}, 5:{name:"Roblox", emoji:"üß±"}, 6:{name:"Chess", emoji:"‚ôüÔ∏è"}, 7:{name:"Mathematics", emoji:"‚ûó"},
    };
    const FACT_BANK = {
      1:[["üí°","The first computer bug was an actual moth found in 1947!"], ["üß†","Coding is instructions for a helper."], ["üß©","Algorithms are smart recipes."], ["üéÆ","Code makes games smooth."], ["‚ö°","Computers love patterns."]],
      2:[["üêç","Python is named after Monty Python!"], ["üì¶","Packages add superpowers."], ["üß†","Indentation matters."], ["üî¢","Great for AI."], ["üß©","Lists are like backpacks."]],
      3:[["üåê","HTML is structure, CSS is style."], ["üé®","CSS animates without images."], ["üì±","Responsive fits all screens."], ["üß≠","Links connect the web."], ["‚ö°","JS makes sites interactive."]],
      4:[["‚ú®","Gen AI creates text & images."], ["üß†","Models learn from patterns."], ["üß©","Be specific with prompts."], ["üß™","Humans stay in control."], ["üåü","AI is a tool, you are the magic."]],
      5:[["üß±","Roblox uses Lua."], ["üéÆ","Game loops update the world."], ["üß†","Design + Code = Fun."], ["üó∫Ô∏è","Levels are puzzles."], ["üîÅ","Events trigger actions."]],
      6:[["‚ôüÔ∏è","Control the center!"], ["üß†","Tactics are short puzzles."], ["üéØ","Forks attack two pieces."], ["üõ°Ô∏è","Develop pieces early."], ["üè∞","Castling keeps the King safe."]],
      7:[["‚ûó","Math is a pattern language."], ["üß†","Fractions are parts."], ["üìà","Graphs show relationships."], ["üî¢","Primes have 2 factors."], ["üß©","Geometry is drawing with rules."]]
    };
    const PUZZLES = {
      1:[{q:"What comes next? 2, 4, 8, 16, ?", choices:["32","18"], a:0}, {q:"A bug is:", choices:["A mistake","A feature"], a:0}],
      2:[{q:"Python is great for:", choices:["AI & Data","Painting"], a:0}, {q:"x=3, x+2=?", choices:["5","6"], a:0}],
      3:[{q:"HTML is:", choices:["Structure","Style"], a:0}, {q:"CSS is:", choices:["Style","Logic"], a:0}],
      4:[{q:"AI learns from:", choices:["Patterns","Magic"], a:0}, {q:"Prompts should be:", choices:["Specific","Vague"], a:0}],
      5:[{q:"Roblox uses:", choices:["Lua","Java"], a:0}, {q:"Levels are:", choices:["Puzzles","Shoes"], a:0}],
      6:[{q:"Castling helps:", choices:["King","Pawn"], a:0}, {q:"Checkmate is:", choices:["Win","Draw"], a:0}],
      7:[{q:"Primes have:", choices:["2 factors","10 factors"], a:0}, {q:"Angles measure:", choices:["Turn","Weight"], a:0}]
    };

    function safeTZ(tz){ try { Intl.DateTimeFormat("en-US",{timeZone:tz}).format(new Date()); return tz; } catch { return "Asia/Kolkata"; } }
    function fmtLocal(dt, tz){
      const parts = new Intl.DateTimeFormat("en-US", {timeZone: tz, weekday:"short", month:"short", day:"numeric", hour:"numeric", minute:"2-digit", hour12:true}).formatToParts(dt);
      const map = Object.fromEntries(parts.map(p=>[p.type,p.value]));
      return {weekday: map.weekday, month: map.month, day: map.day, time: `${map.hour}:${map.minute} ${map.dayPeriod}`};
    }
    function dateKeyInTZ(dt, tz){ return new Intl.DateTimeFormat("en-CA", {timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit"}).format(dt); }

    let BOOKING=null, bookingTZ="Asia/Kolkata", bookingRegion=null, bookingCourseName="Coding";

    async function loadBooking(){
      if(!iduuid) return null;
      const { data } = await sb.from("demo_leads").select("*").eq("id", iduuid).single();
      return data;
    }

    function parseTime12hTo24(t){
      const m = (t||"").trim().match(/^(\d{1,2})\s*:\s*(\d{2})\s*(AM|PM)$/i);
      if(!m) return null;
      let h = parseInt(m[1],10); const mm = parseInt(m[2],10); const ap = m[3].toUpperCase();
      if(ap==="PM" && h!==12) h += 12; if(ap==="AM" && h===12) h = 0;
      return {h, m:mm};
    }
    function makeDateInTZ(dateStr, timeStr, tz){
      const t = parseTime12hTo24(timeStr); if(!dateStr || !t) return null;
      const [Y,M,D] = dateStr.split("-").map(x=>parseInt(x,10));
      const guessUTC = new Date(Date.UTC(Y, M-1, D, t.h, t.m, 0));
      const shown = new Intl.DateTimeFormat("en-CA", {timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", hour12:false}).formatToParts(guessUTC);
      const map = Object.fromEntries(shown.map(p=>[p.type,p.value]));
      const shownAsIfUTC = Date.UTC(parseInt(map.year), parseInt(map.month)-1, parseInt(map.day), parseInt(map.hour), parseInt(map.minute), 0);
      return new Date(guessUTC.getTime() + (Date.UTC(Y, M-1, D, t.h, t.m, 0) - shownAsIfUTC));
    }

    function setText(id, value){ const el = document.getElementById(id); if(el) el.textContent = value ?? "‚Äî"; }

    function renderBooking(b){
      BOOKING = b; bookingTZ = safeTZ(b.timezone); bookingRegion = b.region_key; bookingCourseName = (COURSE[b.course_id]||COURSE[1]).name;
      
      setText("vChild", b.child_name); setText("vGrade", b.child_grade); setText("vParent", b.parent_name);
      setText("vPhone", `${b.phone_country_code||""} ${b.phone_number||""}`); setText("vCourse", bookingCourseName);
      
      // FIX 1: Email Copy
      const eBox = document.getElementById("vEmail"); 
      eBox.textContent = b.parent_email; 
      eBox.onclick = async () => { try{await navigator.clipboard.writeText(b.parent_email); toast("Email copied!");}catch{} };

      const classDT = makeDateInTZ(b.preferred_date, b.preferred_time_slot, bookingTZ);
      if(classDT){
        const s = fmtLocal(classDT, bookingTZ);
        setText("calMonth", s.month); setText("calDay", s.day); setText("calDow", s.weekday);
        setText("schedTime", s.time); setText("schedMeta", `${b.preferred_date} ‚Ä¢ ${bookingTZ}`);
        setupCalendarLinks(classDT, bookingTZ, bookingCourseName, b.child_name);
        document.getElementById("btnCopy").onclick=()=>{navigator.clipboard.writeText(`Trial Class: ${s.weekday}, ${s.time}`); toast("Copied!");};
        startCountdown(classDT);
      } else {
        setText("schedTime", "Schedule not set"); document.getElementById("btnJoin").disabled=true;
      }

      // FIX 5: First Name Only + Gradient
      const fName = b.child_name ? b.child_name.split(' ')[0] : 'Student';
      document.getElementById("welcomeTitle").innerHTML = `Welcome to <span class="grad-text">${fName}</span>‚Äôs ${bookingCourseName} Trial Class`;

      // Safely init games
      const safeCID = b.course_id || courseId || 1;
      initFacts(safeCID); initPuzzle(safeCID); initMiniGames(); initRescheduleUI();
      document.getElementById("btnJoin").onclick=()=>{ window.open(null, "_blank"); };
    }

    function toast(msg){
      let el = document.getElementById("toast");
      if(!el){ el=document.createElement("div"); el.id="toast"; el.style.cssText="position:fixed; left:50%; bottom:16px; transform:translateX(-50%); padding:10px 12px; border-radius:14px; background:rgba(11,15,36,.95); border:1px solid rgba(255,255,255,.14); color:white; font-weight:900; font-size:13px; z-index:120;"; document.body.appendChild(el); }
      el.textContent=msg; el.style.display="block"; clearTimeout(window.tt); window.tt=setTimeout(()=>{el.style.display="none"},2200);
    }

    function setupCalendarLinks(dt, tz, c, ch){
      const end=new Date(dt.getTime()+3600000); const t=`Trial: ${c}`, d=`For ${ch}. ${tz}`;
      function icsDate(x){return x.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";}
      const g=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(t)}&details=${encodeURIComponent(d)}&dates=${icsDate(dt)}/${icsDate(end)}`;
      document.getElementById("calGoogle").href=g;
    }
    const calBtn=document.getElementById("btnCalendar"), calMenu=document.getElementById("calMenu");
    calBtn.onclick=(e)=>{e.stopPropagation(); calMenu.classList.toggle("open");};
    document.onclick=()=>{calMenu.classList.remove("open");};

    let factList=[], factIdx=0, fTimer=null;
    function initFacts(id){ 
        factList=FACT_BANK[id]||FACT_BANK[1]; factIdx=0; showFact(0); 
        clearInterval(fTimer); fTimer=setInterval(()=>nextFact(1), 5200); 
        document.getElementById("factPrev").onclick=()=>nextFact(-1,true); 
        document.getElementById("factNext").onclick=()=>nextFact(1,true); 
    }
    function showFact(i){ const x=factList[(i+factList.length)%factList.length]; setText("factEmoji",x[0]); setText("factText",x[1]); }
    function nextFact(d,m){ factIdx=(factIdx+d+factList.length)%factList.length; showFact(factIdx); if(m){clearInterval(fTimer); fTimer=setInterval(()=>nextFact(1),5200);} }

    let pList=[], pIdx=0;
    function initPuzzle(id){ pList=PUZZLES[id]||PUZZLES[1]; pIdx=0; renderPuzzle(); document.getElementById("pPrev").onclick=()=>{pIdx=(pIdx-1+pList.length)%pList.length;renderPuzzle();}; document.getElementById("pNext").onclick=()=>{pIdx=(pIdx+1)%pList.length;renderPuzzle();}; }
    function renderPuzzle(){
      const p=pList[pIdx]; setText("pQuestion",p.q); const c=document.getElementById("pChoices"); c.innerHTML="";
      p.choices.forEach((txt,i)=>{
        const b=document.createElement("button"); b.className="pill"; b.textContent=txt;
        b.onclick=()=>{ setText("pStatus", i===p.a ? "‚úÖ Correct!" : "‚ùå Try again"); setTimeout(()=>{pIdx=(pIdx+1)%pList.length;renderPuzzle()},700); };
        c.appendChild(b);
      });
      setText("pStatus","Pick an answer.");
    }

    /* FIX 4: Mini Games Bug Fixes */
    function initMiniGames(){
      const s=document.getElementById("gameSprint"), m=document.getElementById("gameMemory");
      document.getElementById("tabSprint").onclick=()=>{s.classList.remove("hide"); m.classList.add("hide");};
      document.getElementById("tabMemory").onclick=()=>{m.classList.remove("hide"); s.classList.add("hide");};
      s.classList.remove("hide"); m.classList.add("hide");
      startSprint(); // Initial load
    }
    
    // Sprint logic fix
    let sprintTimer=null, sprintLeft=60, sprintScore=0, sprintRunning=false;
    let sprintQ=null;
    function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
    
    function newSprintQ(){
       const a=randInt(2,12), b=randInt(2,12);
       const op=Math.random()<0.5?"+":"√ó";
       const ans=op==="+"?(a+b):(a*b);
       // Ensure unique options
       let w1=ans+randInt(1,5);
       let w2=ans-randInt(1,5);
       if(w1===ans) w1=ans+1; if(w2===ans || w2===w1) w2=ans+2;
       const opts=[ans,w1,w2].sort(()=>Math.random()-0.5);
       return {text:`${a} ${op} ${b} = ?`, ans, opts};
    }

    function startSprint(){
      clearInterval(sprintTimer);
      sprintLeft=60; sprintScore=0; sprintRunning=false;
      setText("sprintTime", sprintLeft);
      setText("sprintStatus", "Tap an answer to start.");
      nextSprint();
    }
    function nextSprint(){
      sprintQ = newSprintQ();
      setText("sprintQ", sprintQ.text);
      const box = document.getElementById("sprintChoices");
      box.innerHTML="";
      sprintQ.opts.forEach(v=>{
        const b=document.createElement("button"); b.className="pill"; b.textContent=String(v);
        b.onclick=()=>{
          // Timer check prevents clicking after end
          if(sprintLeft <= 0) return;

          if(!sprintRunning){
            sprintRunning=true;
            sprintTimer=setInterval(()=>{
              sprintLeft--;
              setText("sprintTime", sprintLeft);
              if(sprintLeft<=0){
                clearInterval(sprintTimer);
                sprintRunning=false;
                setText("sprintStatus", `‚è±Ô∏è Time! Score: ${sprintScore}`);
              }
            },1000);
          }
          if(v===sprintQ.ans){ sprintScore++; setText("sprintStatus", `‚úÖ Correct! Score: ${sprintScore}`); }
          else { setText("sprintStatus", `‚ùå Try again! Score: ${sprintScore}`); }
          setTimeout(nextSprint, 250);
        };
        box.appendChild(b);
      });
    }

    // Memory Match
    let memFirst=null, memLock=false, memMatches=0;
    function startMemory(){
      const emojis=["üçÄ","üöÄ","‚≠ê","üéØ","üß†","üêç","üåà","üéÆ"];
      const deck = emojis.concat(emojis).sort(()=>Math.random()-0.5);
      memFirst=null; memLock=false; memMatches=0;
      const grid=document.getElementById("memGrid"); grid.innerHTML="";
      deck.forEach(emo=>{
        const btn=document.createElement("button"); btn.className="slot"; btn.style.height="54px";
        btn.dataset.emo=emo; btn.dataset.open="0"; btn.textContent="‚ùì";
        btn.onclick=()=>{
          if(memLock || btn.dataset.open==="1") return;
          btn.textContent=emo; btn.dataset.open="1";
          if(!memFirst){ memFirst=btn; return; }
          if(memFirst.dataset.emo===btn.dataset.emo){
            memMatches++; memFirst=null;
            setText("memStatus", `‚úÖ Matched ${memMatches}/8 pairs`);
            if(memMatches===8) setText("memStatus", "üèÜ All pairs found!");
          } else {
            memLock=true;
            setTimeout(()=>{
              btn.textContent="‚ùì"; btn.dataset.open="0";
              memFirst.textContent="‚ùì"; memFirst.dataset.open="0";
              memFirst=null; memLock=false;
            }, 650);
          }
        };
        grid.appendChild(btn);
      });
      setText("memStatus","Find all pairs.");
    }

    let cdTimer=null;
    function startCountdown(dt){
      clearInterval(cdTimer);
      function tick(){
        const diff=dt.getTime()-new Date().getTime();
        if(diff<=0){ setText("countdown","Now"); document.getElementById("btnJoin").disabled=false; return; }
        const h=Math.floor(diff/3600000), m=Math.floor((diff%3600000)/60000), s=Math.floor((diff%60000)/1000);
        setText("countdown", `${h}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`);
        document.getElementById("btnJoin").disabled = diff > 300000;
      }
      tick(); cdTimer=setInterval(tick,1000);
    }

    const resDrawer=document.getElementById("resDrawer");
    document.getElementById("btnReschedule").onclick=()=>{resDrawer.classList.add("open"); buildResDates(); fetchResSlots();};
    document.getElementById("closeRes").onclick=()=>{resDrawer.classList.remove("open");};

    const TZ_OPTIONS=[
      {label:"India (IST) ‚Äî Asia/Kolkata", tz:"Asia/Kolkata"},
      {label:"UAE (GST) ‚Äî Asia/Dubai", tz:"Asia/Dubai"},
      {label:"Saudi Arabia ‚Äî Asia/Riyadh", tz:"Asia/Riyadh"},
      {label:"Singapore ‚Äî Asia/Singapore", tz:"Asia/Singapore"},
      {label:"Indonesia ‚Äî Asia/Jakarta", tz:"Asia/Jakarta"},
      {label:"Philippines ‚Äî Asia/Manila", tz:"Asia/Manila"},
      {label:"UK ‚Äî Europe/London", tz:"Europe/London"},
      {label:"USA (East) ‚Äî America/New_York", tz:"America/New_York"},
      {label:"USA (Pacific) ‚Äî America/Los_Angeles", tz:"America/Los_Angeles"},
    ];
    let resTZ="Asia/Kolkata", resDate=null, selectedResSlot=null;

    function initRescheduleUI(){
      const s=document.getElementById("tzSelect"); s.innerHTML="";
      let found = false;
      TZ_OPTIONS.forEach(o=>{
         const p=document.createElement("option"); p.value=o.tz; p.textContent=o.label; s.appendChild(p);
         if(o.tz === bookingTZ) found = true;
      });
      if(!found){
        const p=document.createElement("option"); p.value=bookingTZ; p.textContent=`Current (${bookingTZ})`; s.insertBefore(p, s.firstChild);
      }
      resTZ=bookingTZ; s.value=resTZ; 
      s.onchange=()=>{resTZ=s.value; fetchResSlots();};
    }

    function buildResDates(){
      const w=document.getElementById("resDates"); w.innerHTML="";
      const now=new Date(); const todayKey=dateKeyInTZ(now,"Asia/Kolkata");
      const [Y,M,D]=todayKey.split("-").map(x=>parseInt(x,10)); const base=new Date(Date.UTC(Y,M-1,D));
      for(let i=0; i<7; i++){
        const d=new Date(base.getTime()+i*86400000); const k=dateKeyInTZ(d,"Asia/Kolkata");
        const b=document.createElement("button"); b.className="pill"; b.textContent=k;
        b.onclick=()=>{resDate=k; fetchResSlots();}; w.appendChild(b);
        if(i===0){ b.click(); }
      }
    }

    async function fetchResSlots(){
      const g=document.getElementById("resSlots"), e=document.getElementById("resEmpty"); g.innerHTML=""; e.classList.add("hide");
      const { data } = await sb.from("demo_slots_live_view").select("*").eq("region_key", bookingRegion).eq("course_id", BOOKING.course_id).eq("slot_date", resDate);
      if(!data || !data.length){ e.classList.remove("hide"); return; }
      const now = new Date();
      data.forEach(r=>{
        const utc=new Date(r.slot_datetime_local); if(utc < now) return;
        const disp=utc.toLocaleTimeString("en-US",{timeZone:resTZ,hour:"numeric",minute:"2-digit"});
        const b=document.createElement("button"); b.className="slot"; b.textContent=disp;
        if(r.is_star_teacher) b.innerHTML+=`<div class="star">‚≠ê Star</div>`;
        b.onclick=()=>{selectedResSlot={slot_id:r.slot_id, display:disp}; document.getElementById("confirmRes").disabled=false;};
        g.appendChild(b);
      });
    }

    document.getElementById("confirmRes").onclick=async()=>{
      await sb.from("demo_leads").update({
        preferred_date:resDate, preferred_time_slot:selectedResSlot.display, 
        slot_id:selectedResSlot.slot_id, timezone:resTZ,
        updated_at: new Date().toISOString()
      }).eq("id",iduuid);
      toast("‚úÖ Rescheduled!"); 
      document.getElementById("closeRes").click();
      const loading = document.getElementById("stateLoading");
      if(loading) loading.classList.remove("hide");
      const fresh = await loadBooking();
      if(loading) loading.classList.add("hide");
      if(fresh) renderBooking(fresh);
    }

    (async()=>{ 
        const b=await loadBooking(); 
        if(b){ renderBooking(b); }
        else{ const el = document.getElementById("stateError"); if(el) el.classList.remove("hide"); } 
    })();
  </script>
</body>
</html>
