<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book a Free Trial Class | Unischooly</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Intl Tel Input -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.5/build/css/intlTelInput.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.5/build/js/intlTelInput.min.js"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #05081f;
      --card-bg: #0d1029;
      --border-subtle: #262a4d;
      --text-main: #ffffff;
      --muted: #a3b0d9;
      --accent-pink: #ff6ad5;
      --accent-blue: #4be1ff;
      --accent-purple: #8c54ff;
      --danger: #ff4b81;
      --success: #8cffc0;
      --radius-xl: 24px;
      --radius-lg: 14px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
        sans-serif;
      background: radial-gradient(circle at top, #1c1f57 0, #05081f 55%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px 12px;
    }

    .page {
      width: 100%;
      max-width: 1180px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 32px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .page {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .hero-heading {
      font-size: 40px;
      line-height: 1.1;
      font-weight: 800;
      margin-bottom: 16px;
    }

    .hero-heading span.gradient {
      background: linear-gradient(
        90deg,
        #ff6ad5,
        #ffb86c,
        #4be1ff,
        #8c54ff
      );
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .hero-sub {
      font-size: 16px;
      color: var(--muted);
      max-width: 460px;
      margin-bottom: 24px;
    }

    .hero-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(9, 12, 40, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.07);
      box-shadow: 0 0 18px rgba(0, 0, 0, 0.35);
      font-size: 13px;
      color: var(--muted);
      backdrop-filter: blur(8px);
    }

    .pill span.icon {
      font-size: 16px;
    }

    /* Card */

    .card {
      background: radial-gradient(circle at top left, #262a4d 0, #05081f 60%);
      border-radius: var(--radius-xl);
      padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
      max-width: 520px;
      margin-left: auto;
    }

    @media (max-width: 900px) {
      .card {
        margin: 0 auto;
        max-width: 100%;
      }
    }

    .card-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 6px;
      background: linear-gradient(90deg, #ff6ad5, #4be1ff);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .card-sub {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 18px;
    }

    .step-bar {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
    }

    .step-bar span {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    .step-bar span.active {
      background: linear-gradient(90deg, #ff6ad5, #4be1ff);
    }

    .field-row {
      display: flex;
      gap: 12px;
    }
    @media (max-width: 600px) {
      .field-row {
        flex-direction: column;
      }
    }

    .field {
      margin-bottom: 14px;
      width: 100%;
    }

    .field label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: var(--muted);
    }

    .input,
    select,
    textarea {
      width: 100%;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      background: rgba(3, 7, 31, 0.95);
      color: var(--text-main);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }

    .input:focus,
    select:focus,
    textarea:focus {
      border-color: #4be1ff;
      box-shadow: 0 0 0 1px rgba(75, 225, 255, 0.3);
    }

    .hint {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .error-text {
      color: var(--danger);
      font-size: 11px;
      margin-top: 3px;
    }

    .btn-primary {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 13px 18px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      color: #000;
      background: linear-gradient(90deg, #ff6ad5, #ffb86c, #4be1ff);
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
    }

    .btn-primary:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
    }

    .btn-secondary {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 10px 18px;
      font-size: 13px;
      background: transparent;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .btn-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-top: 16px;
    }

    .btn-row .btn-primary {
      flex: 1;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(10, 200, 140, 0.08);
      color: var(--success);
      border: 1px solid rgba(140, 255, 192, 0.25);
      margin-top: 10px;
    }

    .small-text {
      font-size: 11px;
      color: var(--muted);
      margin-top: 10px;
    }

    .checkbox-row {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-top: 10px;
      font-size: 11px;
      color: var(--muted);
    }

    .checkbox-row input[type="checkbox"] {
      margin-top: 2px;
    }

    /* Date + slot buttons */

    .dates-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0 4px;
    }

    .date-pill {
      min-width: 100px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: rgba(0, 0, 0, 0.3);
      color: var(--muted);
      font-size: 12px;
      text-align: center;
      cursor: pointer;
    }

    .date-pill strong {
      display: block;
      font-size: 13px;
      color: #fff;
    }

    .date-pill.active {
      border-color: #4be1ff;
      background: radial-gradient(circle at top left, #262a4d 0, #05081f 70%);
      box-shadow: 0 0 0 1px rgba(75, 225, 255, 0.55);
    }

    .date-pill.disabled {
      opacity: 0.4;
      cursor: default;
    }

    .slots-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .slot-btn {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: rgba(3, 6, 31, 0.9);
      font-size: 12px;
      cursor: pointer;
      color: var(--muted);
      min-width: 96px;
      text-align: center;
    }

    .slot-btn .star {
      display: block;
      font-size: 10px;
      margin-top: 2px;
      color: var(--accent-pink);
    }

    .slot-btn.active {
      border-color: #ffb86c;
      background: radial-gradient(circle at top, #ff6ad5 0, #05081f 75%);
      color: #fff;
      box-shadow: 0 0 0 1px rgba(255, 184, 108, 0.55);
    }

    .slot-btn.disabled {
      opacity: 0.35;
      cursor: default;
    }

    .status {
      font-size: 11px;
      margin-top: 8px;
    }

    .status.error {
      color: var(--danger);
    }

    .status.ok {
      color: var(--success);
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .chip {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(3, 6, 31, 0.95);
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
    }

    .chip.active {
      border-color: #4be1ff;
      color: #fff;
      box-shadow: 0 0 0 1px rgba(75, 225, 255, 0.4);
    }
  </style>
</head>

<body>
  <div class="page">
    <!-- HERO -->
    <section>
      <div class="hero-heading">
        Book a <span class="gradient">Free Live Coding</span><br />
        Class for your child.
      </div>
      <div class="hero-sub">
        A personalised 60-minute session to introduce your child to coding, logic
        skills & futuristic learning.
      </div>
      <div class="hero-badges">
        <div class="pill">
          <span class="icon">‚è±Ô∏è</span> 60-min Live Class
        </div>
        <div class="pill">
          <span class="icon">üë©‚Äçüè´</span> Top 1% Certified Teachers
        </div>
        <div class="pill">
          <span class="icon">üåç</span> Kids in 30+ Countries
        </div>
        <div class="pill">
          <span class="icon">üöÄ</span> Hands-On Projects
        </div>
      </div>
    </section>

    <!-- CARD -->
    <section>
      <div class="card">
        <div class="card-title">Book Now & Get Certified</div>
        <div id="card-sub" class="card-sub">
          Step 1 of 3 ¬∑ Share your child & parent details to unlock a personalised trial
          class.
        </div>

        <div class="step-bar">
          <span id="step-bar-1" class="active"></span>
          <span id="step-bar-2"></span>
          <span id="step-bar-3"></span>
        </div>

        <!-- STEP 1 -->
        <form id="step-1">
          <div class="field">
            <label>Parent WhatsApp Number</label>
            <input id="parentPhone" type="tel" class="input" placeholder="Enter mobile number" />
            <div class="hint">We‚Äôll send the class link on WhatsApp.</div>
            <div id="phone-error" class="error-text" style="display:none;"></div>
          </div>

          <div class="field-row">
            <div class="field">
              <label>Child Name</label>
              <input id="childName" type="text" class="input" placeholder="Enter child's name" />
            </div>
            <div class="field">
              <label>Child Grade</label>
              <select id="childGrade" class="input">
                <option value="">Select Grade</option>
                <option>Grade 1</option>
                <option>Grade 2</option>
                <option>Grade 3</option>
                <option>Grade 4</option>
                <option>Grade 5</option>
                <option>Grade 6</option>
                <option>Grade 7</option>
                <option>Grade 8</option>
                <option>Grade 9</option>
                <option>Grade 10</option>
              </select>
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label>Parent Name</label>
              <input id="parentName" type="text" class="input" placeholder="Enter parent name" />
            </div>
            <div class="field">
              <label>Parent Email</label>
              <input id="parentEmail" type="email" class="input" placeholder="Enter email" />
            </div>
          </div>

          <div class="field">
            <label>Do you have a Laptop or Desktop?</label>
            <div class="chips-row" id="laptopChips">
              <div data-value="Yes" class="chip active">Yes</div>
              <div data-value="No" class="chip">No</div>
            </div>
          </div>

          <button type="submit" class="btn-primary" id="step1-btn">
            Book a Free Trial Class ‚ú®
          </button>
          <div id="step1-status" class="status"></div>
        </form>

        <!-- STEP 2 -->
        <div id="step-2" style="display:none;">
          <div class="field">
            <label>Select Date</label>
            <div class="hint">You can choose a date within the next few days based on your region.</div>
            <div class="dates-row" id="datesRow"></div>
          </div>

          <div class="field">
            <label>Available Time Slots</label>
            <div class="slots-grid" id="slotsGrid"></div>
            <div id="slotStatus" class="status"></div>
            <div class="small-text">
              Times are shown in your local time zone. Each class is for 60 minutes.
            </div>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="consentCheckbox" />
            <label for="consentCheckbox">
              I agree to be contacted by Unischooly via WhatsApp / Phone / Email for this
              booking.
            </label>
          </div>

          <div class="btn-row">
            <button class="btn-secondary" id="back-to-1" type="button">‚Üê Back</button>
            <button class="btn-primary" id="step2-btn" type="button">
              Confirm Date & Time ‚ú®
            </button>
          </div>

          <div id="step2-status" class="status"></div>
        </div>

        <!-- STEP 3 -->
        <div id="step-3" style="display:none;">
          <div class="field">
            <label>Who are you?</label>
            <div class="chips-row" id="whoChips">
              <div data-value="Parent" class="chip active">Parent</div>
              <div data-value="Student" class="chip">Student</div>
              <div data-value="Guardian" class="chip">Guardian</div>
            </div>
          </div>

          <div class="field">
            <label>Why are you booking this demo class?</label>
            <div class="chips-row" id="reasonChips">
              <div data-value="Want to buy course" class="chip active">
                Want to buy course
              </div>
              <div data-value="Exploring Free Demo" class="chip">
                Exploring Free Demo
              </div>
              <div data-value="Just exploring options" class="chip">
                Just exploring options
              </div>
            </div>
          </div>

          <div class="field">
            <label>When are you planning to buy the course?</label>
            <div class="chips-row" id="timelineChips">
              <div data-value="After the demo" class="chip active">After the demo</div>
              <div data-value="This week" class="chip">This week</div>
              <div data-value="This month" class="chip">This month</div>
              <div data-value="Just exploring" class="chip">Just exploring</div>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn-secondary" id="back-to-2" type="button">‚Üê Back</button>
            <button class="btn-primary" id="step3-btn" type="button">
              Confirm Slot ‚ú®
            </button>
          </div>
          <div id="step3-status" class="status"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ---------- URL PARAMS ----------
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = parseInt(urlParams.get("courseId") || "1", 10);
    const regionKey = (urlParams.get("region") || "INDIA").toUpperCase();
    const lang = urlParams.get("lang") || "english";

    const utm_source = urlParams.get("utm_source") || null;
    const utm_medium = urlParams.get("utm_medium") || null;
    const utm_campaign = urlParams.get("utm_campaign") || null;
    const utm_term = urlParams.get("utm_term") || null;
    const utm_content = urlParams.get("utm_content") || null;
    const fmt = urlParams.get("fmt") || null;

    // ---------- SUPABASE ----------
    const supabaseUrl = "https://binklfyiypbhuzsvnlzg.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";

    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    // ---------- STATE ----------
    let currentStep = 1;
    let itiInstance = null;
    let leadRowId = null;
    let selectedDateKey = null;
    let selectedSlotId = null;
    let slotsByDate = {}; // { "YYYY-MM-DD": [slot, slot] }

    const regionToIso2 = {
      USA: "us",
      INDIA: "in",
      MEA: "ae",
      EUROPE: "gb",
      SEA: "sg",
      ANZ: "au",
      ROW: "in"
    };

    // ---------- UTILS ----------
    function setStep(step) {
      currentStep = step;
      document.getElementById("step-1").style.display =
        step === 1 ? "block" : "none";
      document.getElementById("step-2").style.display =
        step === 2 ? "block" : "none";
      document.getElementById("step-3").style.display =
        step === 3 ? "block" : "none";

      document.getElementById("step-bar-1").classList.toggle(
        "active",
        step >= 1
      );
      document.getElementById("step-bar-2").classList.toggle(
        "active",
        step >= 2
      );
      document.getElementById("step-bar-3").classList.toggle(
        "active",
        step >= 3
      );

      const sub = document.getElementById("card-sub");
      if (step === 1) {
        sub.textContent =
          "Step 1 of 3 ¬∑ Share your child & parent details to unlock a personalised trial class.";
      } else if (step === 2) {
        sub.textContent =
          "Step 2 of 3 ¬∑ Pick a convenient date & time for your child's trial class.";
      } else {
        sub.textContent =
          "Step 3 of 3 ¬∑ Tell us a bit about you so we can personalise the class.";
      }
    }

    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function labelForDateIndex(idx, dateObj) {
      if (idx === 0) return "Today";
      if (idx === 1) return "Tomorrow";
      const weekday = dateObj.toLocaleDateString("en-US", { weekday: "short" });
      const dayNum = dateObj.toLocaleDateString("en-US", { day: "2-digit" });
      const month = dateObj.toLocaleDateString("en-US", { month: "short" });
      return `${weekday} ${dayNum} ${month}`;
    }

    function addChipBehaviour(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.addEventListener("click", (e) => {
        const chip = e.target.closest(".chip");
        if (!chip) return;
        container.querySelectorAll(".chip").forEach((c) =>
          c.classList.remove("active")
        );
        chip.classList.add("active");
      });
    }

    function getActiveChipValue(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return null;
      const active = container.querySelector(".chip.active");
      return active ? active.getAttribute("data-value") : null;
    }

    // ---------- INIT PHONE ----------
    window.addEventListener("load", () => {
      const phoneInput = document.querySelector("#parentPhone");
      if (phoneInput && window.intlTelInput) {
        const defaultCountry = regionToIso2[regionKey] || "in";
        itiInstance = window.intlTelInput(phoneInput, {
          initialCountry: defaultCountry || "auto",
          separateDialCode: true,
          autoPlaceholder: "polite",
          preferredCountries: ["us", "in", "ae", "sa", "gb"],
          utilsScript:
            "https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.5/build/js/utils.js"
        });
      }

      addChipBehaviour("laptopChips");
      addChipBehaviour("whoChips");
      addChipBehaviour("reasonChips");
      addChipBehaviour("timelineChips");

      setStep(1);
      setupStep1();
      setupStep2();
      setupStep3();
    });

    // ---------- STEP 1 ----------
    function setupStep1() {
      const form = document.getElementById("step-1");
      const statusEl = document.getElementById("step1-status");
      const phoneError = document.getElementById("phone-error");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        statusEl.textContent = "";
        phoneError.style.display = "none";

        const childName = document.getElementById("childName").value.trim();
        const childGrade = document.getElementById("childGrade").value.trim();
        const parentName = document.getElementById("parentName").value.trim();
        const parentEmail = document.getElementById("parentEmail").value.trim();
        const laptop = getActiveChipValue("laptopChips") || "Yes";

        if (!itiInstance || !itiInstance.isValidNumber()) {
          phoneError.textContent = "Please enter a valid phone number.";
          phoneError.style.display = "block";
          return;
        }

        if (!childName || !childGrade || !parentName || !parentEmail) {
          statusEl.textContent = "Please fill all the fields.";
          statusEl.className = "status error";
          return;
        }

        const phoneNumber = document.getElementById("parentPhone").value.trim();
        const countryData = itiInstance.getSelectedCountryData();
        const phoneCountryCode = countryData.dialCode
          ? "+" + countryData.dialCode
          : null;

        const deviceType =
          /Mobi|Android/i.test(navigator.userAgent) ? "mobile" : "desktop";

        const payload = {
          child_name: childName,
          child_grade: childGrade,
          parent_name: parentName,
          parent_email: parentEmail,
          phone_country_code: phoneCountryCode,
          phone_number: phoneNumber,
          is_whatsapp: true,
          has_laptop: laptop,
          region_key: regionKey,
          course_id: courseId,
          lang,
          fmt,
          utm_source,
          utm_medium,
          utm_campaign,
          utm_term,
          utm_content,
          landing_page_path: window.location.pathname,
          full_url: window.location.href,
          device_type: deviceType,
          page_completed: 1
        };

        document.getElementById("step1-btn").disabled = true;
        statusEl.textContent = "Saving your details...";
        statusEl.className = "status";

        const { data, error } = await supabaseClient
          .from("demo_leads")
          .upsert(payload, {
            onConflict: "phone_country_code,phone_number",
            ignoreDuplicates: false
          })
          .select()
          .maybeSingle();

        document.getElementById("step1-btn").disabled = false;

        if (error) {
          console.error(error);
          statusEl.textContent = "Something went wrong. Please try again.";
          statusEl.className = "status error";
          return;
        }

        if (data && data.id) {
          leadRowId = data.id;
        }

        statusEl.textContent =
          "Great! Now choose a date and time for your trial class.";
        statusEl.className = "status ok";

        await loadSlotsAndDates();
        setStep(2);
      });
    }

// ---------- LOAD SLOTS + DATES ----------
async function loadSlotsAndDates() {
  const datesRow = document.getElementById("datesRow");
  const slotsGrid = document.getElementById("slotsGrid");
  const slotStatus = document.getElementById("slotStatus");

  datesRow.innerHTML = "";
  slotsGrid.innerHTML = "";
  slotStatus.textContent = "Loading slots...";

  // 1) Get ALL active slots for this course & region from Supabase
  //    (no date range filter here to avoid timezone issues)
  let { data, error } = await supabaseClient
    .from("demo_slots")
    .select("*")
    .eq("course_id", courseId)
    .eq("is_active", true)
    .eq("region_key", regionKey)
    .order("slot_start_ist", { ascending: true })
    .limit(500);

  if (error) {
    console.error(error);
    slotStatus.textContent = "Could not load slots. Please try again.";
    slotStatus.className = "status error";
    return;
  }

  // If somehow nothing is returned, just show the message
  if (!data || data.length === 0) {
    slotStatus.textContent =
      "No slots available for the next few days. Our team will contact you on WhatsApp.";
    slotStatus.className = "status";
    return;
  }

  // 2) Build a date ‚Üí slots map in the browser
  slotsByDate = {};
  selectedDateKey = null;
  selectedSlotId = null;

  const now = new Date();
  const nowPlus1h = new Date(now.getTime() + 60 * 60 * 1000);

  const today = new Date();
  const lastDay = new Date(today);
  lastDay.setDate(today.getDate() + 5);
  const lastDayEnd = new Date(lastDay);
  lastDayEnd.setHours(23, 59, 59, 999);

  data.forEach((slot) => {
    // Respect capacity
    if (slot.capacity_booked >= slot.capacity_total) return;

    const slotLocal = new Date(slot.slot_start_ist);

    // Only consider next 6 days
    if (slotLocal > lastDayEnd) return;

    // For today: enforce 1-hour rule
    if (slotLocal <= nowPlus1h) return;

    const key = formatDateKey(slotLocal);
    if (!slotsByDate[key]) slotsByDate[key] = [];
    slotsByDate[key].push(slot);
  });

  // 3) Build the 6 date buttons (Today + next 5 days)
  const dateButtons = [];
  for (let i = 0; i < 6; i++) {
    const d = new Date();
    d.setDate(today.getDate() + i);
    const key = formatDateKey(d);

    const btn = document.createElement("div");
    btn.className = "date-pill";
    btn.dataset.key = key;

    const label = labelForDateIndex(i, d);
    const hasSlots = (slotsByDate[key] || []).length > 0;

    btn.innerHTML = hasSlots
      ? `<strong>${label}</strong>`
      : `<strong>${label}</strong><span style="font-size:10px;display:block;color:#a3b0d9;">No slots</span>`;

    if (!hasSlots) {
      btn.classList.add("disabled");
    } else if (!selectedDateKey && hasSlots) {
      selectedDateKey = key;
      btn.classList.add("active");
    }

    btn.addEventListener("click", () => {
      if (!slotsByDate[key] || slotsByDate[key].length === 0) return;
      selectedDateKey = key;
      selectedSlotId = null;
      dateButtons.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      renderSlotsForDate(key);
    });

    datesRow.appendChild(btn);
    dateButtons.push(btn);
  }

  // 4) Render slots for default selected date (if any)
  if (selectedDateKey && slotsByDate[selectedDateKey]) {
    renderSlotsForDate(selectedDateKey);
    slotStatus.textContent = "";
    slotStatus.className = "status";
  } else {
    slotStatus.textContent =
      "No slots available for the next few days. Our team will contact you on WhatsApp.";
    slotStatus.className = "status";
  }
}

    // ---------- STEP 2 ----------
    function setupStep2() {
      document
        .getElementById("back-to-1")
        .addEventListener("click", () => setStep(1));

      const btn = document.getElementById("step2-btn");
      const statusEl = document.getElementById("step2-status");
      btn.addEventListener("click", async () => {
        statusEl.textContent = "";
        statusEl.className = "status";

        if (!selectedDateKey || !selectedSlotId) {
          statusEl.textContent =
            "Please choose a date and time slot for your trial class.";
          statusEl.className = "status error";
          return;
        }

        const consentChecked =
          document.getElementById("consentCheckbox").checked;
        if (!consentChecked) {
          statusEl.textContent =
            "Please tick the consent checkbox to continue.";
          statusEl.className = "status error";
          return;
        }

        const allSlots = slotsByDate[selectedDateKey] || [];
        const chosen = allSlots.find((s) => s.id === selectedSlotId);
        const preferred_time_slot = chosen
          ? new Date(chosen.slot_start_ist).toLocaleString()
          : null;

        btn.disabled = true;
        statusEl.textContent = "Saving your slot selection...";
        statusEl.className = "status";

        if (leadRowId) {
          const { error } = await supabaseClient
            .from("demo_leads")
            .update({
              preferred_date: selectedDateKey,
              preferred_time_slot,
              slot_id: selectedSlotId,
              page_completed: 2
            })
            .eq("id", leadRowId);

          if (error) {
            console.error(error);
            statusEl.textContent =
              "Could not save your slot. Please try again.";
            statusEl.className = "status error";
            btn.disabled = false;
            return;
          }
        }

        statusEl.textContent =
          "Great! Now answer a few quick questions to personalise your class.";
        statusEl.className = "status ok";
        btn.disabled = false;
        setStep(3);
      });
    }

    // ---------- STEP 3 ----------
    function setupStep3() {
      document
        .getElementById("back-to-2")
        .addEventListener("click", () => setStep(2));

      const btn = document.getElementById("step3-btn");
      const statusEl = document.getElementById("step3-status");

      btn.addEventListener("click", async () => {
        statusEl.textContent = "";
        statusEl.className = "status";

        const who = getActiveChipValue("whoChips");
        const reason = getActiveChipValue("reasonChips");
        const timeline = getActiveChipValue("timelineChips");

        btn.disabled = true;
        statusEl.textContent = "Saving your responses...";
        statusEl.className = "status";

        if (leadRowId) {
          const { error } = await supabaseClient
            .from("demo_leads")
            .update({
              who_are_you: who,
              booking_reason: reason,
              purchase_timeline: timeline,
              page_completed: 3
            })
            .eq("id", leadRowId);

          if (error) {
            console.error(error);
            statusEl.textContent =
              "Could not save your responses. Please try again.";
            statusEl.className = "status error";
            btn.disabled = false;
            return;
          }
        }

        statusEl.textContent =
          "Your trial class request has been submitted successfully! üéâ";
        statusEl.className = "status ok";
        btn.disabled = true;
      });
    }
  </script>
</body>
</html>
