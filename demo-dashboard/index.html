<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unischooly â€¢ Trial Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-dark: #060b14;
      --card-bg: #0d1833cc;
      --text-main: #eaf1ff;
      --text-muted: rgba(234, 241, 255, 0.7);
      --gold: #f59e0b;
      --gold-glow: rgba(245, 158, 11, 0.4);
      --brand-gradient: linear-gradient(90deg, #EC4899, #9333EA, #3B82F6);
      --success: #10B981;
      --container-width: 1100px;
      --r-card: 20px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle at top center, #1e1b4b 0%, #060b14 60%);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* --- LAYOUT UTILITIES --- */
    .container {
      max-width: var(--container-width);
      margin: 0 auto;
      padding: 0 1.5rem;
    }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .hidden { display: none !important; }
    
    /* --- SECTION 1: HEADER --- */
    header {
      background: rgba(6, 11, 20, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 1rem 0;
    }
    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo img { height: 36px; width: auto; }
    
    .status-pill {
      background: var(--brand-gradient);
      padding: 0.5rem 1.25rem;
      border-radius: 50px;
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(147, 51, 234, 0.4);
      white-space: nowrap;
    }

    /* --- MAIN GRID --- */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr; /* Left slightly wider */
      gap: 2rem;
      padding-top: 2rem;
      padding-bottom: 4rem;
    }

    /* --- CARD STYLES --- */
    .glass-card {
      background: var(--card-bg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--r-card);
      padding: 1.5rem;
      backdrop-filter: blur(12px);
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }

    /* --- 1. STUDENT TICKET --- */
    .ticket-card {
      position: relative;
      border: 2px solid var(--gold);
      box-shadow: 0 0 25px var(--gold-glow);
      background: linear-gradient(135deg, rgba(13,24,51,0.95), rgba(0,0,0,0.95));
      overflow: hidden;
    }
    .ticket-header {
      border-bottom: 2px dashed rgba(255,255,255,0.2);
      padding-bottom: 1rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ticket-title { 
      font-weight: 700; 
      color: var(--gold); 
      text-transform: uppercase; 
      letter-spacing: 1px; 
      font-size: 0.9rem;
    }
    .stamp-box {
      position: absolute;
      top: 15px;
      right: 15px;
      border: 3px double #ef4444;
      color: #ef4444;
      padding: 4px 8px;
      font-weight: 800;
      font-size: 0.8rem;
      text-transform: uppercase;
      transform: rotate(-12deg);
      opacity: 0.9;
      background: rgba(0,0,0,0.3);
      z-index: 10;
    }
    
    /* Strict Grid for Alignment */
    .ticket-grid {
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 12px 0;
      align-items: baseline;
    }
    .t-label {
      color: var(--text-muted);
      font-size: 0.8rem;
      text-transform: uppercase;
      font-weight: 500;
    }
    .t-val {
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      word-break: break-word;
    }
    .powered-by {
      margin-top: 1.5rem;
      text-align: center;
      font-size: 0.7rem;
      color: var(--text-muted);
      opacity: 0.6;
    }

    /* --- 2. SCHEDULE & RESCHEDULE (Inline) --- */
    .schedule-card h3 { margin: 0 0 1rem 0; font-size: 1.1rem; }
    .current-schedule {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .sched-icon { font-size: 1.5rem; }
    
    /* Accordion/Inline Reschedule */
    .reschedule-trigger {
      font-size: 0.85rem;
      color: var(--gold);
      text-decoration: underline;
      cursor: pointer;
      margin-bottom: 1rem;
      display: inline-block;
    }
    .reschedule-box {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      display: none; /* Hidden by default */
    }
    .reschedule-box.open { display: block; animation: fadeIn 0.3s ease; }
    
    /* Horizontal Date Scroll */
    .date-scroller {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 8px;
      margin-bottom: 1rem;
      scrollbar-width: thin;
      scrollbar-color: var(--gold) transparent;
    }
    .date-chip {
      min-width: 60px;
      height: 70px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.2s;
    }
    .date-chip.selected {
      background: var(--gold);
      color: #000;
      border-color: var(--gold);
    }
    .date-chip span:first-child { font-size: 0.7rem; }
    .date-chip span:last-child { font-size: 1.2rem; font-weight: 700; }

    /* Time Grid */
    .time-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 1rem;
    }
    .time-pill {
      padding: 8px;
      text-align: center;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .time-pill.selected {
      background: var(--gold);
      color: #000;
      font-weight: 600;
    }
    .tz-select {
      width: 100%;
      background: rgba(0,0,0,0.3);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    /* Sync Buttons */
    .btn-main {
      width: 100%;
      background: var(--brand-gradient);
      border: none;
      padding: 0.8rem;
      border-radius: 50px;
      color: white;
      font-weight: 700;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 0.2s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .btn-main:hover { transform: translateY(-2px); }
    .sync-icons {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 1rem;
      font-size: 1.5rem;
      color: var(--text-muted);
    }
    .sync-icons i:hover { color: #fff; cursor: pointer; }

    /* --- 3. WELCOME & COUNTDOWN --- */
    .welcome-panel { text-align: center; }
    .welcome-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 0.5rem; }
    .welcome-sub { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem; }
    .highlight { color: var(--gold); }

    .timer-row {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .timer-box {
      background: rgba(0,0,0,0.3);
      padding: 0.8rem;
      border-radius: 12px;
      min-width: 70px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .t-val { font-size: 1.5rem; font-weight: 700; display: block; line-height: 1; margin-bottom: 4px; }
    .t-lbl { font-size: 0.65rem; text-transform: uppercase; color: var(--text-muted); }

    /* JOIN BUTTON - Moved below timer */
    .join-container { margin-bottom: 1rem; }
    .btn-join {
      background: var(--success);
      color: #000;
      font-size: 1.1rem;
      padding: 1rem 3rem;
      border-radius: 50px;
      border: none;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
      animation: pulse 2s infinite;
      width: 100%;
      max-width: 320px;
    }
    .btn-join:disabled {
      background: #374151;
      color: #9CA3AF;
      cursor: not-allowed;
      box-shadow: none;
      animation: none;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); }
      100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    .terms-link {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-decoration: underline;
      cursor: pointer;
    }

    /* --- 4. GAMES --- */
    .game-tabs {
      display: flex;
      background: rgba(255,255,255,0.05);
      border-radius: 50px;
      padding: 4px;
      margin-bottom: 1.5rem;
    }
    .g-tab {
      flex: 1;
      text-align: center;
      padding: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 50px;
      color: var(--text-muted);
    }
    .g-tab.active {
      background: var(--brand-gradient);
      color: white;
      font-weight: 600;
    }
    .game-pane { display: none; text-align: center; }
    .game-pane.active { display: block; }
    .game-input {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 10px;
      color: white;
      border-radius: 8px;
      text-align: center;
      font-size: 1.2rem;
      width: 120px;
      margin: 10px 0;
    }

    /* --- 5. FUN FACTS --- */
    .fun-facts {
      margin-top: 2rem;
      background: linear-gradient(90deg, rgba(255,255,255,0.05), transparent);
      border-left: 4px solid var(--gold);
      padding: 1rem;
      border-radius: 8px;
    }
    .fact-nav { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
    .nav-btn {
      background: rgba(255,255,255,0.1);
      border: none; color: white;
      width: 30px; height: 30px; border-radius: 50%;
      cursor: pointer;
    }

    /* --- MODAL --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 999;
      display: none;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: #1f2937;
      padding: 2rem;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      position: relative;
    }

    /* --- MOBILE RESPONSIVE FIXES --- */
    @media (max-width: 900px) {
      .dashboard-grid {
        grid-template-columns: 1fr; /* Stack columns */
        gap: 1.5rem;
      }
      .header-inner { flex-direction: row; } 
      .status-pill span { display: none; } /* Show only checkmark on tiny screens if needed, usually text fits */
      .status-pill { padding: 0.5rem; }
      .status-pill::after { content: "Locked In!"; margin-left: 5px; } /* Shorten text for mobile */
      
      /* Order: Welcome (Right Col) should be first on Mobile? 
         If yes, use order: -1. Default flow puts left col first. 
         Usually users want to see the ticket first. Keeping default. */
    }
    
    @media (max-width: 480px) {
      .status-pill::after { content: "Confirmed"; }
      .timer-row { gap: 0.5rem; }
      .timer-box { min-width: 60px; padding: 0.5rem; }
      .t-val { font-size: 1.2rem; }
    }
  </style>
</head>
<body>

  <header>
    <div class="container header-inner">
      <div class="logo">
        <img src="https://res.cloudinary.com/dpapyknn4/image/upload/v1763143023/Unischooly_Horizontal_logo_qbu1l7.svg" alt="Unischooly">
      </div>
      <div class="status-pill">
        <i class="fas fa-check-circle"></i>
      </div>
    </div>
  </header>

  <main class="container dashboard-grid">

    <section>
      
      <div class="ticket-card glass-card">
        <div class="stamp-box">VALUE WAIVED</div>
        
        <div class="ticket-header">
          <div class="ticket-title">Official Entry Pass</div>
          <div style="font-size:1.2rem;">ðŸŽ«</div>
        </div>

        <div class="ticket-grid">
          <div class="t-label">Student</div>
          <div class="t-val" id="tk-student">Loading...</div>

          <div class="t-label">Grade</div>
          <div class="t-val" id="tk-grade">--</div>

          <div class="t-label">Course</div>
          <div class="t-val" id="tk-course">--</div>

          <div class="t-label" style="margin-top:10px;">Parent</div>
          <div class="t-val" style="margin-top:10px;" id="tk-parent">--</div>

          <div class="t-label">Email</div>
          <div class="t-val" id="tk-email">--</div>

          <div class="t-label">Phone</div>
          <div class="t-val" id="tk-phone">--</div>
        </div>

        <div class="powered-by">Powered by Unischooly</div>
      </div>

      <div class="schedule-card glass-card" style="margin-top: 2rem;">
        <h3>ðŸš€ Ready for Blast Off!!!</h3>
        
        <div class="current-schedule">
          <div class="sched-icon">ðŸ“…</div>
          <div>
            <div style="font-weight:700; font-size:1.1rem; color:var(--text-main);" id="sched-date">--</div>
            <div style="font-size:0.9rem; color:var(--text-muted);" id="sched-time">--</div>
          </div>
        </div>

        <div class="reschedule-trigger" onclick="toggleReschedule()">Need to Reschedule?</div>

        <div class="reschedule-box" id="reschedule-ui">
          <p style="margin:0 0 8px 0; font-weight:600;">Select New Date:</p>
          <div class="date-scroller" id="date-scroll-container">
            </div>

          <p style="margin:10px 0 8px 0; font-weight:600;">Select Time:</p>
          <div class="time-grid">
            <div class="time-pill" onclick="selTime(this, '4:00 PM')">4:00 PM</div>
            <div class="time-pill" onclick="selTime(this, '5:00 PM')">5:00 PM</div>
            <div class="time-pill" onclick="selTime(this, '6:00 PM')">6:00 PM</div>
            <div class="time-pill" onclick="selTime(this, '7:00 PM')">7:00 PM</div>
            <div class="time-pill" onclick="selTime(this, '8:00 PM')">8:00 PM</div>
            <div class="time-pill" onclick="selTime(this, '9:00 PM')">9:00 PM</div>
          </div>

          <select class="tz-select" id="new-tz">
            <option value="Asia/Kolkata">Asia/Kolkata</option>
            <option value="America/New_York">America/New_York</option>
            <option value="Europe/London">Europe/London</option>
            <option value="Asia/Dubai">Asia/Dubai</option>
          </select>

          <button class="btn-main" onclick="saveReschedule()" style="margin-top:10px;">Confirm New Time</button>
        </div>

        <button class="btn-main" id="cal-sync-btn">
          <i class="fas fa-calendar-alt"></i> &nbsp; Initiate Calendar Sync
        </button>

        <div class="sync-icons" id="sync-providers" style="display:none;">
          <i class="fab fa-google" title="Google" onclick="openCal('google')"></i>
          <i class="fab fa-apple" title="Apple" onclick="openCal('apple')"></i>
          <i class="fab fa-windows" title="Outlook" onclick="openCal('outlook')"></i>
          <i class="fab fa-yahoo" title="Yahoo" onclick="openCal('yahoo')"></i>
        </div>

        <div class="fun-facts">
          <div style="font-weight:700; color:var(--gold); font-size:0.9rem; margin-bottom:5px;">DID YOU KNOW?</div>
          <div id="fact-text" style="font-size:0.9rem; line-height:1.4;">Loading facts...</div>
          <div class="fact-nav">
            <button class="nav-btn" onclick="nextFact(-1)">â€¹</button>
            <button class="nav-btn" onclick="nextFact(1)">â€º</button>
          </div>
        </div>
      </div>

    </section>

    <section>
      
      <div class="welcome-panel glass-card">
        <div class="welcome-title">
          Welcome to <span class="highlight" id="w-name">Student</span>'s<br>
          <span id="w-course">Trial</span> Trial Class
        </div>
        <div class="welcome-sub">Keep this page open! Class starts in:</div>

        <div class="timer-row" id="countdown-wrapper">
          <div class="timer-box">
            <span class="t-val" id="d">00</span><span class="t-lbl">Days</span>
          </div>
          <div class="timer-box">
            <span class="t-val" id="h">00</span><span class="t-lbl">Hrs</span>
          </div>
          <div class="timer-box">
            <span class="t-val" id="m">00</span><span class="t-lbl">Mins</span>
          </div>
          <div class="timer-box">
            <span class="t-val" id="s">00</span><span class="t-lbl">Secs</span>
          </div>
        </div>

        <div class="join-container">
          <button id="join-btn" class="btn-join" disabled>Join Class</button>
          <div style="font-size:0.8rem; color:#6B7280; margin-top:5px;">(Enabled 5 mins before start)</div>
        </div>

        <div class="terms-link" onclick="openTerms()">Terms & Conditions</div>
      </div>

      <div class="glass-card" style="margin-top: 2rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
          <h3 style="margin:0;">Sharpen Your Brain ðŸ§ </h3>
        </div>

        <div class="game-tabs">
          <div class="g-tab active" onclick="setGame('puzzle', this)">Puzzle</div>
          <div class="g-tab" onclick="setGame('memory', this)">Memory</div>
          <div class="g-tab" onclick="setGame('sprint', this)">Sprint</div>
        </div>

        <div id="g-puzzle" class="game-pane active">
          <div id="math-q" style="font-size:1.5rem; font-weight:700; margin-bottom:10px;">5 + 3 = ?</div>
          <input type="number" id="math-in" class="game-input" placeholder="?">
          <br>
          <button class="btn-main" style="width:auto; padding:0.5rem 1.5rem; margin-top:10px;" onclick="checkMath()">Check</button>
          <p id="math-res" style="height:20px; color:var(--success); font-weight:700;"></p>
        </div>

        <div id="g-memory" class="game-pane">
          <div id="mem-grid" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; max-width:300px; margin:0 auto;"></div>
          <button class="btn-main" style="width:auto; margin-top:15px;" onclick="initMemory()">Reset</button>
        </div>

        <div id="g-sprint" class="game-pane">
          <p>Type "Unischooly" fast!</p>
          <input type="text" id="sprint-in" class="game-input" style="width:180px;">
          <p id="sprint-res" style="color:var(--success); font-weight:700; height:20px; margin-top:5px;"></p>
        </div>

      </div>

    </section>

  </main>

  <div class="modal-overlay" id="terms-modal">
    <div class="modal-box">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Terms & Conditions</h2>
        <span onclick="document.getElementById('terms-modal').classList.remove('open')" style="font-size:1.5rem; cursor:pointer;">&times;</span>
      </div>
      <div style="margin-top:1rem; font-size:0.9rem; color: #d1d5db; line-height:1.6;">
        <p><strong>Recording:</strong> This session will be recorded for quality and safety.</p>
        <p><strong>Behavior:</strong> We have a zero-tolerance policy for bullying or inappropriate language.</p>
        <p><strong>Dress Code:</strong> Students must be dressed appropriately for a classroom setting.</p>
      </div>
    </div>
  </div>

  <script>
    // --- 1. SETUP & CONFIG ---
    const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const params = new URLSearchParams(window.location.search);
    const iduuid = params.get('iduuid');
    let leadData = null;
    let classDateObj = null;

    // --- 2. MAIN LOGIC ---
    async function init() {
      if(!iduuid) { console.error("No ID"); return; }
      
      const { data, error } = await supabase.from('demo_leads').select('*').eq('id', iduuid).single();
      
      if(data) {
        leadData = data;
        renderLead();
        startTimer();
        initFacts();
        initRescheduleUI(); // Build the new inline dates
        initMath();
      } else {
        document.querySelector('.ticket-card').innerHTML = "<p style='padding:20px; color:red'>Error loading data.</p>";
      }
    }

    // --- 3. RENDERING ---
    function renderLead() {
      // Helpers
      const txt = (id, val) => document.getElementById(id).textContent = val || '--';
      const cMap = { 1:"Coding", 2:"Python", 3:"Web Dev", 4:"GenAI", 5:"Roblox", 6:"Chess", 7:"Math" };
      const cName = cMap[leadData.course_id] || "Coding";

      // Ticket
      txt('tk-student', leadData.child_name);
      txt('tk-grade', leadData.child_grade);
      txt('tk-course', cName);
      txt('tk-parent', leadData.parent_name);
      txt('tk-email', leadData.parent_email);
      txt('tk-phone', `+${leadData.phone_country_code} ${leadData.phone_number}`);

      // Welcome
      txt('w-name', leadData.child_name);
      txt('w-course', cName);

      // Schedule
      if(leadData.preferred_date && leadData.preferred_time_slot) {
        // Parse "YYYY-MM-DD" and "HH:MM"
        const dStr = `${leadData.preferred_date}T${leadData.preferred_time_slot}:00`;
        classDateObj = new Date(dStr); // Simple parse, assumes local for demo or improves with timezone lib
        
        const opts = { weekday:'long', month:'short', day:'numeric' };
        txt('sched-date', classDateObj.toLocaleDateString('en-US', opts));
        txt('sched-time', `${leadData.preferred_time_slot} (${leadData.timezone})`);
      }
    }

    // --- 4. COUNTDOWN ---
    function startTimer() {
      if(!classDateObj) return;
      
      const update = () => {
        const now = new Date();
        const diff = classDateObj - now;

        if(diff < 0) {
          // Check if within 1 hour duration
          if(Math.abs(diff) < 3600000) {
            enableJoin(true);
            document.getElementById('d').innerText = "00";
            document.getElementById('h').innerText = "00";
            document.getElementById('m').innerText = "00";
            document.getElementById('s').innerText = "00";
          } else {
             document.getElementById('join-btn').innerText = "Class Ended";
             document.getElementById('countdown-wrapper').style.opacity = "0.5";
          }
          return;
        }

        const d = Math.floor(diff / (1000*60*60*24));
        const h = Math.floor((diff / (1000*60*60)) % 24);
        const m = Math.floor((diff / 1000 / 60) % 60);
        const s = Math.floor((diff / 1000) % 60);

        document.getElementById('d').innerText = d<10?'0'+d:d;
        document.getElementById('h').innerText = h<10?'0'+h:h;
        document.getElementById('m').innerText = m<10?'0'+m:m;
        document.getElementById('s').innerText = s<10?'0'+s:s;

        // Enable at 5 mins (300000ms)
        if(diff <= 300000) enableJoin(false);
      };
      
      setInterval(update, 1000);
      update();
    }

    function enableJoin(isLive) {
      const btn = document.getElementById('join-btn');
      if(btn.disabled) {
        btn.disabled = false;
        btn.innerText = isLive ? "JOIN LIVE NOW" : "JOIN CLASS";
        btn.onclick = () => alert("Redirecting to Zoom...");
      }
    }

    // --- 5. RESCHEDULE (INLINE UX) ---
    function toggleReschedule() {
      const el = document.getElementById('reschedule-ui');
      el.classList.toggle('open');
    }

    let selectedDate = null;
    let selectedTime = null;

    function initRescheduleUI() {
      const con = document.getElementById('date-scroll-container');
      const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      let h = '';
      for(let i=1; i<=14; i++) {
        const d = new Date(); d.setDate(d.getDate()+i);
        const dateIso = d.toISOString().split('T')[0];
        h += `<div class="date-chip" onclick="selDate(this, '${dateIso}')">
                <span>${days[d.getDay()]}</span>
                <span>${d.getDate()}</span>
              </div>`;
      }
      con.innerHTML = h;
    }

    window.selDate = (el, date) => {
      document.querySelectorAll('.date-chip').forEach(c=>c.classList.remove('selected'));
      el.classList.add('selected');
      selectedDate = date;
    }

    window.selTime = (el, time) => {
      document.querySelectorAll('.time-pill').forEach(c=>c.classList.remove('selected'));
      el.classList.add('selected');
      selectedTime = time.replace(' PM','').replace(' AM',''); // naive parse
      // Add logic to convert 12h to 24h if needed for DB
      if(time.includes('PM') && parseInt(selectedTime) < 12) {
        selectedTime = (parseInt(selectedTime)+12) + ":00";
      } else if(time.includes('AM') || parseInt(selectedTime)===12) {
         selectedTime = selectedTime.padStart(5, '0'); // e.g 09:00
         if(!selectedTime.includes(':')) selectedTime += ":00";
      }
    }

    async function saveReschedule() {
      if(!selectedDate || !selectedTime) return alert("Please select date and time");
      const tz = document.getElementById('new-tz').value;
      
      const { error } = await supabase.from('demo_leads').update({
        preferred_date: selectedDate,
        preferred_time_slot: selectedTime,
        timezone: tz
      }).eq('id', iduuid);

      if(error) alert("Error");
      else {
         alert("Reschedule Confirmed!");
         window.location.reload();
      }
    }

    // --- 6. FUN FACTS ---
    const facts = [
      "Coding improves logic!", "Python is named after Monty Python.", 
      "The first bug was a real moth.", "AI learns from data.", 
      "SpaceX uses C++ for rockets.", "Minecraft is built in Java.",
      "Google performs 63,000 searches/second.", "The first mouse was wooden.",
      "1 Petabyte = 1.5 million CD-ROMs.", "Coding is a superpower."
    ];
    let fIdx = 0;
    function initFacts() {
      document.getElementById('fact-text').innerText = facts[0];
      setInterval(() => nextFact(1), 5000);
    }
    window.nextFact = (dir) => {
      fIdx += dir;
      if(fIdx >= facts.length) fIdx = 0;
      if(fIdx < 0) fIdx = facts.length - 1;
      document.getElementById('fact-text').innerText = facts[fIdx];
    }

    // --- 7. GAMES ---
    window.setGame = (g, el) => {
      document.querySelectorAll('.g-tab').forEach(t=>t.classList.remove('active'));
      el.classList.add('active');
      document.querySelectorAll('.game-pane').forEach(p=>p.classList.remove('active'));
      document.getElementById('g-'+g).classList.add('active');
      if(g==='memory') initMemory();
    }

    // Math
    let sum = 0;
    function initMath() {
      let a = Math.floor(Math.random()*10), b = Math.floor(Math.random()*10);
      sum = a+b;
      document.getElementById('math-q').innerText = `${a} + ${b} = ?`;
      document.getElementById('math-res').innerText = "";
      document.getElementById('math-in').value = "";
    }
    window.checkMath = () => {
      if(parseInt(document.getElementById('math-in').value) === sum) {
        document.getElementById('math-res').innerText = "Correct! ðŸŽ‰";
        setTimeout(initMath, 1000);
      } else {
        document.getElementById('math-res').innerText = "Try Again";
      }
    }

    // Memory
    function initMemory() {
      const emojis = ['ðŸ¶','ðŸ¶','ðŸ±','ðŸ±','ðŸ­','ðŸ­','ðŸ¹','ðŸ¹'];
      emojis.sort(()=>Math.random()-0.5);
      const grid = document.getElementById('mem-grid');
      grid.innerHTML = "";
      let sel = [], matched = 0;

      emojis.forEach(e => {
        const d = document.createElement('div');
        d.style.cssText = "height:60px; background:rgba(255,255,255,0.1); border-radius:8px; font-size:1.5rem; display:flex; align-items:center; justify-content:center; cursor:pointer;";
        d.onclick = () => {
          if(sel.length >= 2 || d.innerText !== "") return;
          d.innerText = e;
          d.style.background = "#fff";
          sel.push(d);
          if(sel.length === 2) {
             if(sel[0].innerText === sel[1].innerText) {
               sel=[]; matched++;
               if(matched===4) alert("You Win!");
             } else {
               setTimeout(()=>{
                 sel[0].innerText=""; sel[0].style.background="rgba(255,255,255,0.1)";
                 sel[1].innerText=""; sel[1].style.background="rgba(255,255,255,0.1)";
                 sel=[];
               }, 600);
             }
          }
        }
        grid.appendChild(d);
      });
    }

    // Sprint
    document.getElementById('sprint-in').addEventListener('input', (e)=>{
      if(e.target.value.toLowerCase() === "unischooly") document.getElementById('sprint-res').innerText = "Nice! âš¡";
      else document.getElementById('sprint-res').innerText = "";
    });

    // Calendar Sync
    document.getElementById('cal-sync-btn').onclick = () => {
      document.getElementById('sync-providers').style.display = 'flex';
    }
    window.openCal = (type) => alert("Opening " + type + " calendar..."); 

    // Terms
    window.openTerms = () => document.getElementById('terms-modal').classList.add('open');

    // Run
    init();

  </script>
</body>
</html>
