<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unischooly ‚Äì 3‚ÄëStep Booking Form (Backend Test)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-main: #050818;
      --bg-card: #0b1020;
      --accent-1: #ff6ad5;
      --accent-2: #4be1ff;
      --accent-3: #8b5cff;
      --text-main: #e5f0ff;
      --text-soft: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --danger: #f97373;
      --success: #22c55e;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text-main);
    }
    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px 12px;
    }
    .shell {
      width: 100%;
      max-width: 1120px;
      background: radial-gradient(circle at top left, #1f2937 0, #020617 60%);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.8);
      padding: 24px 24px 28px;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      background: linear-gradient(90deg,#e5e7eb,#a5b4fc,#22d3ee);
      -webkit-background-clip: text;
      color: transparent;
    }
    .subtitle {
      margin: 0;
      font-size: 13px;
      color: var(--text-soft);
    }
    .step-indicator {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 18px 0 20px;
      font-size: 12px;
      color: var(--text-soft);
    }
    .step-bars {
      display: flex;
      gap: 8px;
      width: 160px;
    }
    .step-bar {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: #111827;
    }
    .step-bar.active {
      background: linear-gradient(90deg,#ff6ad5,#4be1ff);
    }
    .step-bar.completed {
      background: linear-gradient(90deg,#22c55e,#a7f3d0);
    }
    .banner {
      display: none;
      margin-bottom: 12px;
      padding: 9px 11px;
      border-radius: 10px;
      font-size: 12px;
      display: none;
    }
    .banner.show { display: flex; align-items: center; gap: 8px; }
    .banner.error {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(248,113,113,0.8);
      color: #fecaca;
    }
    .banner.success {
      background: rgba(22,163,74,0.12);
      border: 1px solid rgba(34,197,94,0.85);
      color: #bbf7d0;
    }
    .banner-icon { font-size: 16px; }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .section-sub {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0,1fr));
      gap: 16px;
    }
    @media (max-width: 768px) {
      body { padding: 12px 8px; }
      .shell { padding: 18px 14px 22px; border-radius: 18px; }
      .grid { grid-template-columns: repeat(1,minmax(0,1fr)); }
    }
    .field-group { margin-bottom: 2px; }
    .field-label-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 5px;
    }
    .field-label {
      font-size: 13px;
      font-weight: 500;
    }
    .field-hint {
      font-size: 11px;
      color: var(--text-soft);
    }
    .input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top,#020617 0,#020617 60%);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
    }
    .input::placeholder { color: #4b5563; }
    .input:focus, select:focus {
      border-color: var(--accent-2);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.5);
    }
    .pill-toggle {
      display: inline-flex;
      gap: 4px;
      padding: 4px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: radial-gradient(circle at top,#020617 0,#020617 60%);
    }
    .pill-toggle button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: var(--text-soft);
    }
    .pill-toggle button.active {
      background: radial-gradient(circle at top,#111827 0,#020617 60%);
      color: #e5e7eb;
      box-shadow: 0 0 0 1px rgba(96,165,250,0.7);
    }
    .btn-main {
      border-radius: 999px;
      border: none;
      padding: 13px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      background-image: linear-gradient(90deg,#ff6ad5,#8b5cff,#4be1ff);
      color: #020617;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    .btn-main:disabled { opacity: .65; cursor: wait; }
    .btn-secondary {
      border-radius: 999px;
      border: none;
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
    }
    .btn-secondary:hover { color: #e5e7eb; }
    .date-row,.time-row { display:flex; flex-wrap:wrap; gap:8px; margin-top:4px; }
    .date-pill, .time-pill {
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top,#020617 0,#020617 60%);
      font-size: 11px;
      color: var(--text-soft);
      cursor: pointer;
      padding: 7px 10px;
      min-width: 100px;
      text-align: center;
    }
    .date-pill.selected, .time-pill.selected {
      border-color: var(--accent-2);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.6);
      color: #f9fafb;
    }
    .time-pill-main { font-size: 13px; font-weight: 600; color: #e5e7eb; }
    .star-badge {
      margin-top: 3px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      border-radius:999px;
      padding:2px 7px;
      border:1px solid rgba(250,204,21,0.8);
      background:rgba(250,204,21,0.12);
      color:#facc15;
      font-size:10px;
    }
    .pill-options {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .pill-option {
      border-radius:999px;
      padding:7px 12px;
      border:1px solid var(--border-subtle);
      background:radial-gradient(circle at top,#020617 0,#020617 60%);
      font-size:12px;
      color:var(--text-soft);
      cursor:pointer;
    }
    .pill-option.selected {
      border-color:var(--accent-2);
      color:#f9fafb;
      box-shadow:0 0 0 1px rgba(59,130,246,0.6);
    }
    .footer-note {
      margin-top:8px;
      font-size:11px;
      color:var(--text-soft);
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <h1>Unischooly ‚Äì Booking Form (Backend Test)</h1>
      <p class="subtitle">Single‚Äëfile 3‚Äëstep form wired to Supabase. Focus is on correct backend logic.</p>
    </header>

    <div class="step-indicator">
      <span>Step <strong id="step-label">1</strong> of 3 ‚Äì <span id="step-title">Details</span></span>
      <div class="step-bars">
        <div class="step-bar active"></div>
        <div class="step-bar" id="step-bar-2"></div>
        <div class="step-bar" id="step-bar-3"></div>
      </div>
    </div>

    <div id="error-banner" class="banner error">
      <span class="banner-icon">‚ö†Ô∏è</span>
      <span id="error-text">Error</span>
    </div>
    <div id="success-banner" class="banner success">
      <span class="banner-icon">‚úÖ</span>
      <span id="success-text">Success</span>
    </div>

    <!-- STEP 1 -->
    <section id="step-1">
      <div class="section-title">Step 1 ‚Äì Contact & Country</div>
      <div class="section-sub">
        Detects country & timezone from IP. You can change these. Region key comes from selected country.
      </div>

      <div class="grid">
        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Country</label>
          </div>
          <select id="country-select"></select>
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Timezone</label>
            <span class="field-hint">If country has multiple timezones, choose correct one.</span>
          </div>
          <select id="timezone-select"></select>
        </div>

        <div class="field-group" style="grid-column: span 4;">
          <div class="field-label-row">
            <label class="field-label">Phone country code</label>
          </div>
          <input id="phone-code" class="input" placeholder="+91" />
        </div>
        <div class="field-group" style="grid-column: span 8;">
          <div class="field-label-row">
            <label class="field-label">WhatsApp number</label>
            <span class="field-hint">Digits only ‚Äì we'll send class link here.</span>
          </div>
          <input id="phone-number" class="input" />
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Child's name</label>
          </div>
          <input id="child-name" class="input" />
        </div>
        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Child's grade</label>
          </div>
          <select id="child-grade">
            <option value="">Select grade</option>
            <script>
              for(let i=1;i<=12;i++){document.write(`<option>Grade ${i}</option>`);}
            </script>
          </select>
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Parent / Guardian name</label>
          </div>
          <input id="parent-name" class="input" />
        </div>
        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Parent email</label>
          </div>
          <input id="parent-email" class="input" type="email" />
        </div>

        <div class="field-group" style="grid-column: span 12;">
          <div class="field-label-row">
            <label class="field-label">Do you have a Laptop / Desktop?</label>
          </div>
          <div class="pill-toggle">
            <button type="button" id="laptop-yes" class="active">üíª Yes</button>
            <button type="button" id="laptop-no">üì± No (Tablet / Mobile only)</button>
          </div>
        </div>
      </div>

      <button id="btn-step-1" class="btn-main" style="margin-top: 12px;">
        <span>üöÄ</span><span>Save & Continue to Date & Time</span>
      </button>
      <div class="footer-note">
        We‚Äôll save this in <code>demo_leads</code> with <strong>page_completed = 1</strong>.
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step-2" style="display:none;">
      <button class="btn-secondary" id="btn-back-1">‚Üê Back to details</button>

      <div class="section-title">Step 2 ‚Äì Select Date & Time</div>
      <div class="section-sub">
        Shows Today + next 5 days for your region & course. Only future slots (‚â• now + 1hr).
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Language</label>
        </div>
        <select id="language-select">
          <option value="english">English</option>
          <option value="arabic">Arabic</option>
          <option value="bahasa">Bahasa</option>
          <option value="vietnamese">Vietnamese</option>
          <option value="filipino">Filipino</option>
          <option value="thai">Thai</option>
        </select>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Select Date</label>
          <span class="field-hint" id="date-range-label"></span>
        </div>
        <div id="date-row" class="date-row"></div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Select Start Time</label>
          <span class="field-hint">Times shown in the timezone selected on Step 1.</span>
        </div>
        <div id="time-row" class="time-row"></div>
      </div>

      <button id="btn-step-2" class="btn-main" style="margin-top: 12px;">
        <span>‚ú®</span><span>Confirm class time</span>
      </button>
      <div class="footer-note">
        Saves <code>preferred_date</code>, <code>preferred_time_slot</code>, <code>slot_id</code>, <code>star_teacher_selected</code>, <code>lang</code>, <code>page_completed = 2</code>.
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="step-3" style="display:none;">
      <button class="btn-secondary" id="btn-back-2">‚Üê Back to date & time</button>

      <div class="section-title">Step 3 ‚Äì Motivation & Intent</div>
      <div class="section-sub">
        Help us plan the trial class better. These are stored in <code>demo_leads</code>.
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Who are you?</label>
        </div>
        <div id="who-options" class="pill-options">
          <button type="button" class="pill-option" data-value="Parent">Parent</button>
          <button type="button" class="pill-option" data-value="Student">Student</button>
          <button type="button" class="pill-option" data-value="Guardian">Guardian</button>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Why are you booking this trial class?</label>
        </div>
        <div id="why-options" class="pill-options">
          <button type="button" class="pill-option" data-value="Want to buy course">Want to buy course</button>
          <button type="button" class="pill-option" data-value="To Compare Platform">To Compare Platform</button>
          <button type="button" class="pill-option" data-value="To strengthen Concept">To strengthen Concept</button>
          <button type="button" class="pill-option" data-value="Just for free demo">Just for free demo</button>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">When are you planning to purchase?</label>
        </div>
        <div id="when-options" class="pill-options">
          <button type="button" class="pill-option" data-value="After the Demo">After the Demo</button>
          <button type="button" class="pill-option" data-value="This Week">This Week</button>
          <button type="button" class="pill-option" data-value="This Month">This Month</button>
          <button type="button" class="pill-option" data-value="Just Exploring">Just Exploring</button>
        </div>
      </div>

      <button id="btn-step-3" class="btn-main" style="margin-top: 12px;">
        <span>‚úÖ</span><span>Submit</span>
      </button>
      <div class="footer-note" id="final-message" style="display:none;">
        Booking complete. You can now close this page.
      </div>
    </section>
  </div>

  <script>
    // ---- Supabase config ----
    const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";

    const { createClient } = supabase;
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---- URL params (course & lang) ----
    const urlParams = new URLSearchParams(window.location.search);
    const courseIdFromURL = parseInt(urlParams.get("courseId") || "1", 10);
    const langFromURL = (urlParams.get("lang") || "english").toLowerCase();

    // ---- Basic mapping: country -> region_key ----
    const countryToRegion = {
      "United Arab Emirates":"MEA","Saudi Arabia":"MEA","Oman":"MEA","Qatar":"MEA","Kuwait":"MEA","Bahrain":"MEA",
      "India":"ASIA","Pakistan":"ASIA","Bangladesh":"ASIA","Nepal":"ASIA","Sri Lanka":"ASIA","Japan":"ASIA","South Korea":"ASIA","China":"ASIA",
      "United States":"USA","Canada":"USA",
      "United Kingdom":"EUROPE","France":"EUROPE","Germany":"EUROPE","Italy":"EUROPE","Spain":"EUROPE","Ireland":"EUROPE","Netherlands":"EUROPE","Sweden":"EUROPE","Norway":"EUROPE","Finland":"EUROPE","Denmark":"EUROPE",
      "Australia":"ANZ","New Zealand":"ANZ",
      "Singapore":"SEA","Malaysia":"SEA","Philippines":"SEA","Indonesia":"SEA","Vietnam":"SEA","Thailand":"SEA","Cambodia":"SEA","Laos":"SEA","Myanmar":"SEA","Brunei":"SEA"
    };

    // Countries with multiple timezone options
    const countryTimezones = {
      "United States":["America/New_York","America/Chicago","America/Denver","America/Los_Angeles","America/Phoenix"],
      "Canada":["America/Toronto","America/Vancouver","America/Halifax"],
      "Australia":["Australia/Sydney","Australia/Adelaide","Australia/Perth","Australia/Melbourne"]
    };

    // Country -> phone code
    const phoneCodes = {
      "India":"+91","United Arab Emirates":"+971","Saudi Arabia":"+966","United States":"+1","Canada":"+1","United Kingdom":"+44",
      "Australia":"+61","Bangladesh":"+880","Pakistan":"+92","Philippines":"+63","Singapore":"+65","Malaysia":"+60","Vietnam":"+84",
      "Thailand":"+66","Oman":"+968","Qatar":"+974","Kuwait":"+965","Bahrain":"+973","Indonesia":"+62","Sri Lanka":"+94","Japan":"+81",
      "South Korea":"+82","China":"+86","New Zealand":"+64"
    };

    // Short country list for dropdown (extend if you like)
    const countryList = [
      "United Arab Emirates","Saudi Arabia","Oman","Qatar","Kuwait","Bahrain",
      "India","Pakistan","Bangladesh","Nepal","Sri Lanka","Japan","South Korea","China",
      "United States","Canada",
      "United Kingdom","France","Germany","Italy","Spain","Ireland","Netherlands","Sweden","Norway","Denmark","Finland",
      "Australia","New Zealand",
      "Singapore","Malaysia","Philippines","Indonesia","Vietnam","Thailand","Cambodia","Laos","Myanmar","Brunei",
      "Other"
    ];

    // ---- State ----
    let currentStep = 1;
    let leadId = null;
    let regionKey = "ROW";
    let timezoneIana = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
    let selectedSlot = null;
    let selectedDateKey = null;
    let slotsByDate = {};
    let whoValue = null, whyValue = null, whenValue = null;
    let hasLaptopValue = "Yes";

    // ---- Helpers ----
    const $ = (id) => document.getElementById(id);
    const step1El = $("step-1");
    const step2El = $("step-2");
    const step3El = $("step-3");
    const stepLabelEl = $("step-label");
    const stepTitleEl = $("step-title");
    const stepBars = document.querySelectorAll(".step-bar");
    const errorBanner = $("error-banner");
    const successBanner = $("success-banner");
    const errorText = $("error-text");
    const successText = $("success-text");
    const dateRowEl = $("date-row");
    const timeRowEl = $("time-row");
    const dateRangeLabelEl = $("date-range-label");
    const languageSelectEl = $("language-select");
    const btnStep1 = $("btn-step-1");
    const btnStep2 = $("btn-step-2");
    const btnStep3 = $("btn-step-3");

    function showBanner(type, msg) {
      if (type === "error") {
        errorText.textContent = msg;
        errorBanner.classList.add("show");
        successBanner.classList.remove("show");
      } else {
        successText.textContent = msg;
        successBanner.classList.add("show");
        errorBanner.classList.remove("show");
      }
    }
    function clearBanners() {
      errorBanner.classList.remove("show");
      successBanner.classList.remove("show");
    }

    function showStep(step) {
      currentStep = step;
      step1El.style.display = step === 1 ? "block" : "none";
      step2El.style.display = step === 2 ? "block" : "none";
      step3El.style.display = step === 3 ? "block" : "none";
      stepLabelEl.textContent = String(step);
      stepTitleEl.textContent = step === 1 ? "Details" : step === 2 ? "Date & Time" : "Intent";
      stepBars.forEach((b, idx) => {
        b.classList.remove("active","completed");
        if (idx < step-1) b.classList.add("completed");
        else if (idx === step-1) b.classList.add("active");
      });
      window.scrollTo(0,0);
      clearBanners();
    }

    function fmtDateKey(d) { return d.toISOString().slice(0,10); }
    function formatDateRangeLabel(minDate, maxDate) {
      const opt = { day:"2-digit", month:"short", year:"numeric" };
      return `${minDate.toLocaleDateString("en-GB",opt)} ‚Äì ${maxDate.toLocaleDateString("en-GB",opt)}`;
    }
    function formatTimeLabel(date) {
      return date.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:true,timeZone:timezoneIana});
    }

    function detectDeviceType() {
      const ua = navigator.userAgent || "";
      if (/tablet|ipad/i.test(ua)) return "tablet";
      if (/mobi|android|iphone|ipod/i.test(ua)) return "mobile";
      return "desktop";
    }
    function detectBrowser() {
      const ua = navigator.userAgent || "";
      if (ua.includes("Edg/")) return "Edge";
      if (ua.includes("OPR/") || ua.includes("Opera")) return "Opera";
      if (ua.includes("Chrome/")) return "Chrome";
      if (ua.includes("Safari/")) return "Safari";
      if (ua.includes("Firefox/")) return "Firefox";
      return ua.slice(0,120);
    }
    function getInternetSpeedMbps() {
      const c = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (!c || typeof c.downlink !== "number") return null;
      return Math.round(c.downlink * 10)/10;
    }

    // ---- Country / timezone UI ----
    function populateCountryDropdown(selectedCountry) {
      const sel = $("country-select");
      sel.innerHTML = "";
      countryList.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        if (c === selectedCountry) opt.selected = true;
        sel.appendChild(opt);
      });
      if (!selectedCountry && countryList.indexOf("India") !== -1) {
        sel.value = "India";
      }
    }
    function populateTimezoneDropdown(country, defaultTz) {
      const tzSel = $("timezone-select");
      tzSel.innerHTML = "";
      const list = countryTimezones[country];
      if (list) {
        list.forEach(tz => {
          const opt = document.createElement("option");
          opt.value = tz;
          opt.textContent = tz;
          if (tz === defaultTz) opt.selected = true;
          tzSel.appendChild(opt);
        });
      } else {
        const opt = document.createElement("option");
        opt.value = defaultTz;
        opt.textContent = defaultTz;
        tzSel.appendChild(opt);
      }
    }

    async function detectIPDefaults() {
      let ipData = null;
      try {
        const res = await fetch("https://ipapi.co/json/");
        if (res.ok) ipData = await res.json();
      } catch (e) { console.warn("IP detect failed", e); }
      const country = ipData?.country_name || "India";
      const tz = ipData?.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone || "Asia/Kolkata";
      populateCountryDropdown(country);
      populateTimezoneDropdown(country, tz);
      timezoneIana = tz;
      regionKey = countryToRegion[country] || "ROW";
      const phoneCodeInput = $("phone-code");
      phoneCodeInput.value = phoneCodes[country] || (ipData?.country_calling_code || "");
    }

    // ---- Step 1 submit ----
    async function handleStep1() {
      clearBanners();
      const phone_country_code = $("phone-code").value.trim();
      const phone_number = $("phone-number").value.replace(/\\D/g,"").trim();
      const child_name = $("child-name").value.trim();
      const child_grade = $("child-grade").value;
      const parent_name = $("parent-name").value.trim();
      const parent_email = $("parent-email").value.trim();
      const country = $("country-select").value;
      timezoneIana = $("timezone-select").value;
      const has_laptop = hasLaptopValue;

      if (!phone_country_code || !phone_number || !child_name || !child_grade || !parent_name || !parent_email) {
        showBanner("error","Please fill all required fields.");
        return;
      }
      regionKey = countryToRegion[country] || "ROW";

      const internetSpeed = getInternetSpeedMbps();
      const deviceType = detectDeviceType();
      const browserName = detectBrowser();
      let ipInfo = {};
      try {
        const r = await fetch("https://ipapi.co/json/");
        if (r.ok) ipInfo = await r.json();
      } catch (e) {}

      const payload = {
        child_name,
        child_grade,
        parent_name,
        parent_email,
        phone_country_code,
        phone_number,
        has_laptop,
        region_key: regionKey,
        timezone: timezoneIana,
        country,
        course_id: courseIdFromURL,
        lang: langFromURL,
        full_url: window.location.href,
        landing_page_path: window.location.pathname + window.location.search,
        ip_address: ipInfo.ip || null,
        city: ipInfo.city || null,
        device_type: deviceType,
        browser: browserName,
        internet_speed_mbps: internetSpeed,
        page_completed: 1
      };

      btnStep1.disabled = true;
      btnStep1.innerHTML = "<span>‚è≥</span><span>Saving...</span>";

      try {
        const { data, error } = await supa
          .from("demo_leads")
          .upsert(payload, { onConflict: "phone_country_code,phone_number" })
          .select("id,region_key,timezone,course_id")
          .single();

        if (error) throw error;
        leadId = data.id;
        regionKey = data.region_key || regionKey;
        timezoneIana = data.timezone || timezoneIana;
        showBanner("success","Details saved. Loading slots...");
        await loadSlots();
        showStep(2);
      } catch (err) {
        console.error(err);
        showBanner("error","Failed to save details. See console.");
      } finally {
        btnStep1.disabled = false;
        btnStep1.innerHTML = "<span>üöÄ</span><span>Save & Continue to Date & Time</span>";
      }
    }

    // ---- Step 2: load slots from demo_slots_live ----
    async function loadSlots() {
      if (!leadId) return;
      dateRowEl.innerHTML = "";
      timeRowEl.innerHTML = "";
      slotsByDate = {};
      selectedDateKey = null;
      selectedSlot = null;

      const now = new Date();
      const today = new Date();
      const end = new Date();
      end.setDate(end.getDate() + 5);
      const todayKey = fmtDateKey(today);
      const endKey = fmtDateKey(end);
      const minTime = new Date(now.getTime() + 60*60*1000);

      try {
        const { data, error } = await supa
          .from("demo_slots_live")
          .select("*")
          .eq("region_key", regionKey)
          .eq("course_id", courseIdFromURL);

        if (error) throw error;

        const rows = (data || []).map(row => {
          let dt = null;
          if (row.slot_datetime_local) dt = new Date(row.slot_datetime_local);
          else if (row.slot_datetime_ist) dt = new Date(row.slot_datetime_ist);
          else if (row.slot_date && row.slot_time_ist) dt = new Date(row.slot_date + "T" + row.slot_time_ist);
          else if (row.slot_date) dt = new Date(row.slot_date + "T00:00:00");

          let dateKey = null;
          if (row.slot_date) dateKey = row.slot_date;
          else if (dt) dateKey = fmtDateKey(dt);

          return {
            ...row,
            _dt: dt,
            _dateKey: dateKey,
            slot_id: row.slot_id || row.id
          };
        });

        let valid = rows.filter(r => r._dt && r._dateKey);
        valid = valid.filter(r => {
          if (r._dt < minTime) return false;
          if (r._dateKey < todayKey) return false;
          if (r._dateKey > endKey) return false;
          return true;
        });
        valid.sort((a,b) => a._dt - b._dt);

        if (!valid.length) {
          dateRowEl.innerHTML = "<p>No slots available.</p>";
          return;
        }

        let minDate = null, maxDate = null;
        valid.forEach(r => {
          const key = r._dateKey;
          if (!slotsByDate[key]) slotsByDate[key] = [];
          slotsByDate[key].push(r);
          const d = new Date(key + "T00:00:00");
          if (!minDate || d < minDate) minDate = d;
          if (!maxDate || d > maxDate) maxDate = d;
        });

        if (minDate && maxDate) {
          dateRangeLabelEl.textContent = formatDateRangeLabel(minDate, maxDate);
        }
        renderDatePills(todayKey);
      } catch (err) {
        console.error(err);
        showBanner("error","Failed to load slots.");
      }
    }

    function renderDatePills(todayKey) {
      dateRowEl.innerHTML = "";
      const keys = Object.keys(slotsByDate).sort();
      if (!keys.length) {
        dateRowEl.innerHTML = "<p>No slots.</p>";
        return;
      }
      const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowKey = fmtDateKey(tomorrow);

      keys.forEach(key => {
        const d = new Date(key + "T00:00:00");
        let top;
        if (key === todayKey) top = "Today";
        else if (key === tomorrowKey) top = "Tomorrow";
        else top = d.toLocaleDateString("en-US",{weekday:"short"});

        const bottom = d.toLocaleDateString("en-GB",{day:"2-digit",month:"short"});

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "date-pill";
        if (!selectedDateKey) selectedDateKey = key;
        if (selectedDateKey === key) btn.classList.add("selected");
        btn.innerHTML = `<div><strong>${top}</strong></div><div>${bottom}</div>`;
        btn.addEventListener("click", () => {
          selectedDateKey = key;
          renderDatePills(todayKey);
          renderTimePills();
        });
        dateRowEl.appendChild(btn);
      });
      renderTimePills();
    }

    function renderTimePills() {
      timeRowEl.innerHTML = "";
      selectedSlot = null;
      const list = slotsByDate[selectedDateKey] || [];
      if (!list.length) {
        timeRowEl.innerHTML = "<p>No slots for this date.</p>";
        return;
      }
      list.forEach(row => {
        const dt = row._dt;
        const label = formatTimeLabel(dt);
        const pill = document.createElement("button");
        pill.type = "button";
        pill.className = "time-pill";
        pill.innerHTML = `
          <div class="time-pill-main">${label}</div>
          <div>Live 1:1 ¬∑ 60 mins</div>
          ${row.is_star_teacher ? '<div class="star-badge">‚≠ê Star teacher</div>' : ""}
        `;
        pill.addEventListener("click", () => {
          selectedSlot = { ...row, timeLabel: label };
          Array.from(timeRowEl.children).forEach(c => c.classList.remove("selected"));
          pill.classList.add("selected");
        });
        timeRowEl.appendChild(pill);
      });
    }

    async function handleStep2() {
      clearBanners();
      if (!leadId || !selectedSlot) {
        showBanner("error","Please pick a date and time.");
        return;
      }
      btnStep2.disabled = true;
      btnStep2.innerHTML = "<span>‚è≥</span><span>Saving...</span>";

      const lang = (languageSelectEl.value || "english").toLowerCase();

      try {
        const { error } = await supa
          .from("demo_leads")
          .update({
            preferred_date: selectedSlot._dateKey,
            preferred_time_slot: selectedSlot.timeLabel,
            slot_id: selectedSlot.slot_id,
            star_teacher_selected: !!selectedSlot.is_star_teacher,
            lang,
            page_completed: 2
          })
          .eq("id", leadId);

        if (error) throw error;
        showBanner("success","Slot saved.");
        showStep(3);
      } catch (err) {
        console.error(err);
        showBanner("error","Failed to save slot.");
      } finally {
        btnStep2.disabled = false;
        btnStep2.innerHTML = "<span>‚ú®</span><span>Confirm class time</span>";
      }
    }

    function setupPillGroup(containerId, setter) {
      const container = $(containerId);
      container.querySelectorAll(".pill-option").forEach(btn => {
        btn.addEventListener("click", () => {
          container.querySelectorAll(".pill-option").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          setter(btn.dataset.value);
        });
      });
    }

    async function handleStep3() {
      clearBanners();
      if (!leadId) return;
      if (!whoValue || !whyValue || !whenValue) {
        showBanner("error","Please answer all questions.");
        return;
      }
      btnStep3.disabled = true;
      btnStep3.innerHTML = "<span>‚è≥</span><span>Saving...</span>";

      try {
        const { error } = await supa
          .from("demo_leads")
          .update({
            who_are_you: whoValue,
            booking_reason: whyValue,
            purchase_timeline: whenValue,
            page_completed: 3
          })
          .eq("id", leadId);

        if (error) throw error;
        showBanner("success","All details saved. Trial class booked.");
        $("final-message").style.display = "block";
      } catch (err) {
        console.error(err);
        showBanner("error","Failed to save final answers.");
      } finally {
        btnStep3.disabled = false;
        btnStep3.innerHTML = "<span>‚úÖ</span><span>Submit</span>";
      }
    }

    // ---- Event wiring on DOM ready ----
    document.addEventListener("DOMContentLoaded", () => {
      showStep(1);
      detectIPDefaults();

      // laptop toggle
      $("laptop-yes").addEventListener("click", () => {
        hasLaptopValue = "Yes";
        $("laptop-yes").classList.add("active");
        $("laptop-no").classList.remove("active");
      });
      $("laptop-no").addEventListener("click", () => {
        hasLaptopValue = "No";
        $("laptop-no").classList.add("active");
        $("laptop-yes").classList.remove("active");
      });

      $("country-select").addEventListener("change", (e) => {
        const country = e.target.value;
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || timezoneIana;
        populateTimezoneDropdown(country, tz);
        $("phone-code").value = phoneCodes[country] || "";
        regionKey = countryToRegion[country] || "ROW";
      });
      $("timezone-select").addEventListener("change", (e) => {
        timezoneIana = e.target.value;
      });

      btnStep1.addEventListener("click", handleStep1);
      $("btn-back-1").addEventListener("click", () => showStep(1));
      btnStep2.addEventListener("click", handleStep2);
      $("btn-back-2").addEventListener("click", () => showStep(2));
      btnStep3.addEventListener("click", handleStep3);

      setupPillGroup("who-options", v => whoValue = v);
      setupPillGroup("why-options", v => whyValue = v);
      setupPillGroup("when-options", v => whenValue = v);
    });
  </script>
</body>
</html>
