<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unischooly Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary: #4F46E5;
            --secondary: #9333EA;
            --pink: #EC4899;
            --gold: #F59E0B;
            --gold-glow: rgba(245, 158, 11, 0.4);
            --bg-body: #F3F4F6;
            --white: #FFFFFF;
            --text-dark: #111827;
            --text-gray: #6B7280;
            --success: #10B981;
            --brand-gradient: linear-gradient(90deg, #EC4899, #9333EA, #3B82F6);
            --container-width: 1150px;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-dark); overflow-x: hidden; }

        /* --- UTILS --- */
        .container { max-width: var(--container-width); margin: 0 auto; padding: 0 1rem; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        
        /* --- SECTION 1: HEADER --- */
        header {
            background: var(--white);
            border-bottom: 1px solid #E5E7EB;
            padding: 0.75rem 0;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .header-inner { display: flex; justify-content: space-between; align-items: center; }
        .logo img { height: 40px; width: auto; }
        .status-pill {
            background-image: var(--brand-gradient);
            color: white;
            padding: 0.5rem 1.25rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
        }

        /* --- SECTION 2: GRID LAYOUT --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr; /* Left col slightly wider */
            gap: 2rem;
            margin-top: 2rem;
            margin-bottom: 4rem;
        }

        /* --- COMPONENT: TICKET CARD --- */
        .ticket-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            position: relative;
            border: 2px solid var(--gold);
            box-shadow: 0 0 20px var(--gold-glow);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .ticket-header {
            border-bottom: 2px dashed #E5E7EB;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .ticket-title { font-size: 1.1rem; font-weight: 800; text-transform: uppercase; color: var(--text-dark); letter-spacing: 1px; }
        
        /* Stamp */
        .stamp-box {
            position: absolute;
            top: 20px;
            right: 20px;
            border: 3px double #DC2626;
            color: #DC2626;
            padding: 0.25rem 0.75rem;
            font-weight: 800;
            font-size: 0.9rem;
            text-transform: uppercase;
            transform: rotate(-12deg);
            opacity: 0.8;
            mask-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='); 
        }

        /* Ticket Grid to Prevent Drift */
        .ticket-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            margin-bottom: 0.8rem;
            align-items: baseline;
        }
        .t-label { color: var(--text-gray); font-size: 0.8rem; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .t-value { color: var(--text-dark); font-weight: 600; font-size: 1rem; overflow-wrap: break-word; }
        
        .powered-by {
            margin-top: 1.5rem;
            text-align: center;
            font-size: 0.75rem;
            color: #9CA3AF;
            font-weight: 500;
        }

        /* --- COMPONENT: SCHEDULE CARD --- */
        .schedule-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }
        .schedule-display {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex; align-items: center; gap: 1rem;
        }
        .calendar-icon { font-size: 2rem; color: var(--primary); }
        
        /* Reschedule Accordion */
        .reschedule-toggle {
            color: var(--primary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            margin-bottom: 1rem;
            display: inline-block;
        }
        .reschedule-panel {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none; /* Hidden by default */
        }
        .reschedule-panel.active { display: block; animation: fadeIn 0.3s ease; }

        /* BrightChamps Style Date Picker */
        .date-scroll { display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; margin-bottom: 1rem; scrollbar-width: none; }
        .date-chip {
            min-width: 60px;
            height: 70px;
            border: 1px solid #E5E7EB;
            border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
            background: #F9FAFB;
        }
        .date-chip.selected { background: var(--text-dark); color: white; border-color: var(--text-dark); }
        .date-chip span:first-child { font-size: 0.75rem; }
        .date-chip span:last-child { font-weight: 700; font-size: 1.1rem; }

        .time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .time-chip {
            padding: 0.6rem;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            text-align: center;
            font-size: 0.85rem;
            cursor: pointer;
            background: #fff;
        }
        .time-chip.selected { background: var(--text-dark); color: white; border-color: var(--text-dark); }
        .timezone-select { width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid #E5E7EB; margin-bottom: 1rem; }

        .btn-sync {
            width: 100%;
            background: var(--brand-gradient);
            color: white; border: none;
            padding: 1rem; border-radius: 50px;
            font-weight: 700; font-size: 1rem;
            cursor: pointer; transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-sync:hover { transform: translateY(-2px); }
        
        .sync-row { display: flex; justify-content: center; gap: 1.5rem; margin-top: 1rem; color: #9CA3AF; font-size: 1.4rem; }
        .sync-row i:hover { color: var(--primary); cursor: pointer; }

        /* --- COMPONENT: FUN FACTS --- */
        .fun-facts-card {
            background: linear-gradient(135deg, #FFFFFF, #F3F4F6);
            border-radius: 16px;
            padding: 1.5rem;
            border-left: 5px solid var(--secondary);
            box-shadow: var(--card-shadow);
        }
        .fact-content { min-height: 80px; display: flex; align-items: center; font-size: 0.95rem; line-height: 1.5; color: var(--text-dark); }
        .fact-nav { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.5rem; }
        .fact-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: #E5E7EB; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* --- RIGHT SIDE: WELCOME & GAMES --- */
        .welcome-panel {
            background: var(--white);
            border-radius: 16px;
            padding: 2.5rem 2rem;
            text-align: center;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }
        .welcome-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; line-height: 1.3; }
        .welcome-subtitle { color: var(--text-gray); font-size: 0.9rem; margin-bottom: 1.5rem; }

        .timer-container { display: flex; justify-content: center; gap: 0.8rem; margin-bottom: 1.5rem; }
        .timer-box { background: var(--text-dark); color: white; padding: 0.8rem 0.5rem; border-radius: 8px; min-width: 65px; }
        .timer-val { font-size: 1.5rem; font-weight: 700; display: block; line-height: 1; margin-bottom: 2px; }
        .timer-label { font-size: 0.65rem; text-transform: uppercase; color: #9CA3AF; }

        .btn-join {
            background: #10B981;
            color: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem; font-weight: 700;
            border: none; cursor: pointer;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            width: 100%; transition: all 0.3s;
        }
        .btn-join:disabled { background: #D1D5DB; cursor: not-allowed; box-shadow: none; }
        .btn-join.pulse { animation: pulse-green 2s infinite; }
        
        .terms-link { font-size: 0.8rem; color: var(--text-gray); text-decoration: underline; cursor: pointer; margin-top: 1rem; display: block; }

        /* --- GAMES SECTION --- */
        .games-card { background: var(--white); border-radius: 16px; overflow: hidden; box-shadow: var(--card-shadow); }
        .games-header { padding: 1rem; border-bottom: 1px solid #F3F4F6; }
        .game-tabs { display: flex; background: #F3F4F6; }
        .game-tab { flex: 1; padding: 0.8rem; text-align: center; cursor: pointer; font-weight: 600; color: var(--text-gray); border-bottom: 3px solid transparent; }
        .game-tab.active { background: white; color: var(--primary); border-bottom-color: var(--primary); }
        .game-content { padding: 2rem; min-height: 250px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .game-pane { display: none; width: 100%; text-align: center; }
        .game-pane.active { display: block; animation: fadeIn 0.3s; }
        .game-input { padding: 0.5rem; font-size: 1.2rem; text-align: center; border: 2px solid #E5E7EB; border-radius: 8px; width: 120px; margin: 10px 0; }
        
        /* Memory Grid */
        .memory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-width: 280px; margin: 0 auto; }
        .memory-card { height: 60px; background: #F3F4F6; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .memory-card.flipped { background: white; border: 2px solid var(--primary); }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 2rem; border-radius: 16px; width: 90%; max-width: 500px; position: relative; }
        .close-modal { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

        /* --- RESPONSIVE --- */
        @media (max-width: 900px) {
            .dashboard-grid { grid-template-columns: 1fr; gap: 1.5rem; }
            .header-inner { flex-direction: row; }
            .logo img { height: 32px; }
            .status-pill { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
            /* On mobile, reorder columns if needed using flex order, but grid default is usually Left then Right. 
               If you want Welcome Panel first on mobile, uncomment below: */
            /* .dashboard-grid { display: flex; flex-direction: column; }
            .right-column { order: -1; } */
        }
    </style>
</head>
<body>

    <header>
        <div class="container header-inner">
            <div class="logo">
                <img src="https://res.cloudinary.com/dpapyknn4/image/upload/v1763143023/Unischooly_Horizontal_logo_qbu1l7.svg" alt="Unischooly">
            </div>
            <div class="status-pill">
                <i class="fas fa-check-circle"></i>
                <span>Your trial class is locked in!</span>
            </div>
        </div>
    </header>

    <div class="container dashboard-grid">
        
        <div class="left-column">
            
            <div class="ticket-card">
                <div class="stamp-box">VALUE WAIVED</div>
                <div class="ticket-header">
                    <div class="ticket-title">Student Entry Pass</div>
                </div>
                
                <div class="ticket-row">
                    <div class="t-label">Student</div>
                    <div class="t-value" id="t-student">Loading...</div>
                </div>
                <div class="ticket-row">
                    <div class="t-label">Grade</div>
                    <div class="t-value" id="t-grade">--</div>
                </div>
                <div class="ticket-row">
                    <div class="t-label">Course</div>
                    <div class="t-value" id="t-course">--</div>
                </div>
                <div class="ticket-row">
                    <div class="t-label">Parent</div>
                    <div class="t-value" id="t-parent">--</div>
                </div>
                <div class="ticket-row">
                    <div class="t-label">Email</div>
                    <div class="t-value" id="t-email">--</div>
                </div>
                <div class="ticket-row">
                    <div class="t-label">Phone</div>
                    <div class="t-value" id="t-phone">--</div>
                </div>

                <div class="powered-by">Powered by Unischooly</div>
            </div>

            <div class="schedule-card">
                <h3 style="margin-bottom: 1rem;">ðŸš€ Ready for Blast Off!!!</h3>
                
                <div class="schedule-display">
                    <i class="far fa-calendar-alt calendar-icon"></i>
                    <div>
                        <div style="font-weight: 700; font-size: 1.1rem;" id="s-date">--</div>
                        <div style="color: var(--text-gray); font-size: 0.9rem;" id="s-time">--</div>
                    </div>
                </div>

                <div class="reschedule-toggle" onclick="toggleReschedule()">Need to Reschedule?</div>
                <div class="reschedule-panel" id="reschedule-panel">
                    <p style="font-size: 0.85rem; font-weight: 700; margin-bottom: 0.5rem;">Select New Date:</p>
                    <div class="date-scroll" id="date-scroller"></div> <p style="font-size: 0.85rem; font-weight: 700; margin-bottom: 0.5rem;">Select Time:</p>
                    <div class="time-grid">
                        <div class="time-chip" onclick="selTime(this)">4:00 PM</div>
                        <div class="time-chip" onclick="selTime(this)">5:00 PM</div>
                        <div class="time-chip" onclick="selTime(this)">6:00 PM</div>
                        <div class="time-chip" onclick="selTime(this)">7:00 PM</div>
                        <div class="time-chip" onclick="selTime(this)">8:00 PM</div>
                        <div class="time-chip" onclick="selTime(this)">9:00 PM</div>
                    </div>

                    <select class="timezone-select" id="rs-timezone">
                        <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
                        <option value="America/New_York">America/New_York (EST)</option>
                        <option value="Europe/London">Europe/London (GMT)</option>
                        <option value="Asia/Dubai">Asia/Dubai (GST)</option>
                    </select>

                    <button class="btn-sync" style="background: var(--text-dark); border-radius: 12px; font-size: 0.9rem;" onclick="submitReschedule()">Confirm New Time</button>
                </div>

                <button class="btn-sync" onclick="alert('Opening Calendar Sync...')">
                    Initiate Calendar Sync
                </button>
                <div class="sync-row">
                    <i class="fab fa-google" title="Google"></i>
                    <i class="fab fa-apple" title="Apple"></i>
                    <i class="fab fa-windows" title="Outlook"></i>
                    <i class="fab fa-yahoo" title="Yahoo"></i>
                </div>
            </div>

            <div class="fun-facts-card">
                <h4 style="color: var(--secondary); margin-bottom: 0.5rem;">Did you know?</h4>
                <div class="fact-content" id="fact-display">Loading facts...</div>
                <div class="fact-nav">
                    <button class="fact-btn" onclick="rotateFact(-1)"><i class="fas fa-chevron-left"></i></button>
                    <button class="fact-btn" onclick="rotateFact(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>

        </div>

        <div class="right-column">
            
            <div class="welcome-panel">
                <div class="welcome-title">
                    Welcome to <span style="color: var(--pink);" id="w-name">Student</span>'s <br>
                    <span id="w-course">Trial</span> Trial Class
                </div>
                <div class="welcome-subtitle">Class starts in:</div>

                <div class="timer-container" id="countdown-box">
                    <div class="timer-box">
                        <span class="timer-val" id="d">00</span><span class="timer-label">Days</span>
                    </div>
                    <div class="timer-box">
                        <span class="timer-val" id="h">00</span><span class="timer-label">Hrs</span>
                    </div>
                    <div class="timer-box">
                        <span class="timer-val" id="m">00</span><span class="timer-label">Mins</span>
                    </div>
                    <div class="timer-box">
                        <span class="timer-val" id="s">00</span><span class="timer-label">Secs</span>
                    </div>
                </div>
                
                <div id="class-ended" class="hidden" style="color: red; font-weight: 700; margin-bottom: 1rem;">Class has ended.</div>

                <button class="btn-join" id="join-btn" disabled>Join Class</button>
                <div style="font-size: 0.75rem; color: #9CA3AF; margin-top: 0.5rem;" id="join-hint">(Button activates 5 mins before class)</div>

                <div class="terms-link" onclick="toggleModal(true)">Terms & Conditions</div>
            </div>

            <div class="games-card">
                <div class="games-header">
                    <h3 style="font-size: 1.1rem;">Sharpen Your Brain ðŸ§ </h3>
                </div>
                <div class="game-tabs">
                    <div class="game-tab active" onclick="switchGame('puzzle', this)">Puzzle</div>
                    <div class="game-tab" onclick="switchGame('memory', this)">Memory</div>
                    <div class="game-tab" onclick="switchGame('sprint', this)">Sprint</div>
                </div>
                <div class="game-content">
                    
                    <div id="game-puzzle" class="game-pane active">
                        <div id="math-q" style="font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">5 + 3 = ?</div>
                        <input type="number" id="math-in" class="game-input" placeholder="?">
                        <br>
                        <button style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;" onclick="checkMath()">Check</button>
                        <p id="math-res" style="margin-top: 0.5rem; height: 20px; font-weight: 600;"></p>
                    </div>

                    <div id="game-memory" class="game-pane">
                        <div class="memory-grid" id="memory-grid"></div>
                        <button style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--text-dark); color: white; border: none; border-radius: 8px; cursor: pointer;" onclick="initMemory()">Reset Game</button>
                    </div>

                    <div id="game-sprint" class="game-pane">
                        <p style="margin-bottom: 1rem;">Type <strong>"Unischooly"</strong> fast!</p>
                        <input type="text" id="sprint-in" class="game-input" style="width: 180px;">
                        <p id="sprint-res" style="margin-top: 0.5rem; height: 20px; color: var(--success); font-weight: 700;"></p>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="t-modal">
        <div class="modal-content">
            <div class="close-modal" onclick="toggleModal(false)">&times;</div>
            <h3 style="margin-bottom: 1rem;">Terms & Conditions</h3>
            <ul style="margin-left: 1.5rem; font-size: 0.9rem; line-height: 1.6;">
                <li><strong>Recording:</strong> This session may be recorded for quality purposes.</li>
                <li><strong>Zero Tolerance:</strong> No bullying or inappropriate language.</li>
                <li><strong>Guidelines:</strong> Students should be dressed appropriately. Parents can sit nearby but please let the student answer.</li>
            </ul>
        </div>
    </div>

    <script>
        // 1. SUPABASE CONFIG
        const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. STATE
        const params = new URLSearchParams(window.location.search);
        const iduuid = params.get('iduuid');
        const courseIdParam = params.get('courseId');
        let leadData = null;
        let classDateObj = null;

        // 3. COURSE DATA
        const courses = {
            1: { name: "Coding", facts: ["Coding improves logic!", "Python is named after Monty Python.", "The first bug was a real moth.", "There are 700+ coding languages.", "Computers use binary (0 & 1).", "Ada Lovelace was the first programmer.", "Coding powers the internet.", "Minecraft is built on Java.", "Google uses Python.", "It's a superpower!"] },
            2: { name: "Python", facts: ["Python is great for AI.", "It reads like English.", "Used by NASA.", "No curly braces needed!", "Great for data science.", "Instagram uses Python.", "Automate boring stuff.", "Very beginner friendly.", "Huge community support.", "Named after a comedy show."] },
            3: { name: "Web Dev", facts: ["HTML is the skeleton.", "CSS is the style.", "JS is the brain.", "The first website is still online.", "Websites live on servers.", "Chrome is a browser.", "Mobile-first is key.", "HTTP runs the web.", "Cloudflare protects sites.", "Cookies store data."] },
            4: { name: "GenAI", facts: ["AI learns from data.", "ChatGPT is an LLM.", "AI can generate art.", "Neural networks mimic brains.", "AI helps doctors.", "Self-driving cars use AI.", "AI is growing fast.", "Prompt engineering is a skill.", "Deepfakes are AI generated.", "Robots use AI."] },
            5: { name: "Roblox", facts: ["Roblox uses Lua code.", "You can make real money.", "Millions of games exist.", "Not just a game, a platform.", "Started in 2006.", "Developers earn Robux.", "Learn 3D design.", "Physics engine is built-in.", "Play with friends anywhere.", "Host virtual concerts."] },
            6: { name: "Chess", facts: ["Chess improves memory.", "Infinite possibilities.", "Queen is most powerful.", "Checkmate wins the game.", "Originates from India.", "Computers beat humans now.", "Opening moves matter.", "Tactics vs Strategy.", "Time control is key.", "Pawns can promote."] },
            7: { name: "Math", facts: ["Math is the universal language.", "Zero was invented in India.", "Pi is infinite.", "Golden ratio is everywhere.", "Prime numbers are special.", "Geometry measures earth.", "Algebra solves for X.", "Calculus studies change.", "Patterns rule the world.", "Math builds logic."] }
        };

        // 4. INIT
        async function init() {
            if (!iduuid) {
                console.error("No ID UUID provided");
                document.querySelector('.ticket-card').innerHTML = '<p style="color:red; text-align:center;">No Booking ID Found</p>';
                return;
            }

            // Fetch Data
            let { data, error } = await supabase
                .from('demo_leads')
                .select('*')
                .eq('id', iduuid)
                .single();

            if (error) {
                console.error("Supabase Error:", error);
                document.querySelector('.ticket-card').innerHTML = '<p style="color:red; text-align:center;">Error Loading Data</p>';
                return;
            }

            leadData = data;
            renderData();
            startTimer();
            setupFacts();
            setupRescheduleUI();
            setupGames(); // Init Math
        }

        // 5. RENDER
        function renderData() {
            // Determine Course
            const cId = leadData.course_id || courseIdParam || 1;
            const cInfo = courses[cId] || courses[1];

            // Ticket
            setText('t-student', leadData.child_name || "Student");
            setText('t-grade', leadData.child_grade || "N/A");
            setText('t-course', cInfo.name);
            setText('t-parent', leadData.parent_name || "Parent");
            setText('t-email', leadData.parent_email || "N/A");
            setText('t-phone', `+${leadData.phone_country_code || ""} ${leadData.phone_number || ""}`);

            // Welcome
            setText('w-name', leadData.child_name || "Student");
            setText('w-course', cInfo.name);

            // Schedule
            if (leadData.preferred_date && leadData.preferred_time_slot) {
                // Parse Date
                const dStr = `${leadData.preferred_date}T${leadData.preferred_time_slot}:00`;
                classDateObj = new Date(dStr);
                
                const dateOpts = { weekday: 'long', month: 'long', day: 'numeric' };
                setText('s-date', classDateObj.toLocaleDateString('en-US', dateOpts));
                setText('s-time', `${leadData.preferred_time_slot} (${leadData.timezone || 'Local'})`);
            } else {
                setText('s-date', "Not Scheduled");
            }
        }

        function setText(id, val) {
            const el = document.getElementById(id);
            if(el) el.innerText = val;
        }

        // 6. TIMER
        function startTimer() {
            if (!classDateObj) return;

            const tick = () => {
                const now = new Date();
                const diff = classDateObj - now;

                if (diff <= 0) {
                    // Check if class ended (e.g., > 1 hour ago)
                    if (Math.abs(diff) > 3600000) {
                        document.getElementById('countdown-box').classList.add('hidden');
                        document.getElementById('class-ended').classList.remove('hidden');
                        document.getElementById('join-btn').innerText = "Class Ended";
                        document.getElementById('join-btn').disabled = true;
                    } else {
                        // Class is Live
                        enableJoin(true);
                        document.getElementById('d').innerText = "00";
                        document.getElementById('h').innerText = "00";
                        document.getElementById('m').innerText = "00";
                        document.getElementById('s').innerText = "00";
                    }
                    return;
                }

                // Calc time
                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);

                document.getElementById('d').innerText = d < 10 ? '0'+d : d;
                document.getElementById('h').innerText = h < 10 ? '0'+h : h;
                document.getElementById('m').innerText = m < 10 ? '0'+m : m;
                document.getElementById('s').innerText = s < 10 ? '0'+s : s;

                // Enable Join at 5 mins (300,000ms)
                if (diff <= 300000) enableJoin(false);
            };

            setInterval(tick, 1000);
            tick();
        }

        function enableJoin(isLive) {
            const btn = document.getElementById('join-btn');
            if (btn.disabled) {
                btn.disabled = false;
                btn.classList.add('pulse');
                btn.innerText = isLive ? "JOIN CLASS NOW" : "JOIN CLASS";
                document.getElementById('join-hint').style.display = 'none';
                
                // Add Link Logic Here (Placeholder)
                btn.onclick = () => alert("Redirecting to Zoom Class...");
            }
        }

        // 7. FUN FACTS
        let currentFact = 0;
        function setupFacts() {
            const cId = leadData?.course_id || courseIdParam || 1;
            const factList = courses[cId].facts;
            
            const showFact = () => {
                const el = document.getElementById('fact-display');
                el.style.opacity = 0;
                setTimeout(() => {
                    el.innerText = factList[currentFact];
                    el.style.opacity = 1;
                }, 200);
            };
            
            window.rotateFact = (dir) => {
                currentFact += dir;
                if(currentFact >= factList.length) currentFact = 0;
                if(currentFact < 0) currentFact = factList.length - 1;
                showFact();
            };
            
            showFact();
            setInterval(() => window.rotateFact(1), 5000); // Auto rotate
        }

        // 8. RESCHEDULE UI
        function toggleReschedule() {
            document.getElementById('reschedule-panel').classList.toggle('active');
        }

        function setupRescheduleUI() {
            const scroll = document.getElementById('date-scroller');
            const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            let html = '';
            
            for(let i=1; i<=14; i++) {
                const d = new Date(); d.setDate(d.getDate() + i);
                const dayName = days[d.getDay()];
                const dateNum = d.getDate();
                html += `<div class="date-chip" onclick="selDate(this)"><span>${dayName}</span><span>${dateNum}</span></div>`;
            }
            scroll.innerHTML = html;
        }
        
        window.selDate = (el) => {
            document.querySelectorAll('.date-chip').forEach(x => x.classList.remove('selected'));
            el.classList.add('selected');
        }
        window.selTime = (el) => {
            document.querySelectorAll('.time-chip').forEach(x => x.classList.remove('selected'));
            el.classList.add('selected');
        }
        window.submitReschedule = () => {
            alert("Reschedule Request Sent! (Logic Placeholder)");
            // Add Supabase update logic here if needed
        }

        // 9. GAMES & MODAL
        window.toggleModal = (show) => {
            const m = document.getElementById('t-modal');
            show ? m.classList.add('open') : m.classList.remove('open');
        }

        window.switchGame = (g, tab) => {
            document.querySelectorAll('.game-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            document.querySelectorAll('.game-pane').forEach(p => p.classList.remove('active'));
            document.getElementById('game-'+g).classList.add('active');
            if(g==='memory') initMemory();
            if(g==='puzzle') setupGames();
        }

        // Math
        let sum = 0;
        function setupGames() {
            const a = Math.floor(Math.random()*10)+1;
            const b = Math.floor(Math.random()*10)+1;
            sum = a + b;
            document.getElementById('math-q').innerText = `${a} + ${b} = ?`;
            document.getElementById('math-res').innerText = "";
            document.getElementById('math-in').value = "";
        }
        window.checkMath = () => {
            if(parseInt(document.getElementById('math-in').value) === sum) {
                document.getElementById('math-res').innerText = "Correct! ðŸŽ‰";
                document.getElementById('math-res').style.color = "green";
                setTimeout(setupGames, 1000);
            } else {
                document.getElementById('math-res').innerText = "Try Again";
                document.getElementById('math-res').style.color = "red";
            }
        }

        // Memory
        function initMemory() {
            const grid = document.getElementById('memory-grid');
            grid.innerHTML = "";
            const icons = ['ðŸ¶','ðŸ¶','ðŸ±','ðŸ±','ðŸš€','ðŸš€','â­','â­'];
            icons.sort(() => Math.random() - 0.5);
            let sel = [], matched = 0;

            icons.forEach(ico => {
                const c = document.createElement('div');
                c.className = 'memory-card';
                c.onclick = () => {
                    if(c.classList.contains('flipped') || sel.length >= 2) return;
                    c.classList.add('flipped');
                    c.innerText = ico;
                    sel.push(c);
                    if(sel.length === 2) {
                        if(sel[0].innerText === sel[1].innerText) {
                            sel = []; matched++;
                            if(matched === 4) alert("You Win!");
                        } else {
                            setTimeout(() => {
                                sel.forEach(s => { s.classList.remove('flipped'); s.innerText = ''; });
                                sel = [];
                            }, 600);
                        }
                    }
                }
                grid.appendChild(c);
            });
        }

        // Sprint
        document.getElementById('sprint-in').addEventListener('input', (e) => {
            if(e.target.value.toLowerCase() === 'unischooly') document.getElementById('sprint-res').innerText = "Nice Speed! âš¡";
            else document.getElementById('sprint-res').innerText = "";
        });

        // Start
        init();
    </script>
</body>
</html>
