<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unischooly | Demo Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">
// Email copy helper
function copyEmailToClipboard(el){
  const email = el.innerText || el.textContent;
  navigator.clipboard.writeText(email).then(()=>{
    let t=document.getElementById('copyToast');
    if(!t){
      t=document.createElement('div');
      t.id='copyToast'; t.className='copy-toast';
      t.innerText='Email copied';
      document.body.appendChild(t);
    }
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),1200);
  });
}


// Reschedule slot filtering
function filterRescheduleSlots(slots, tz){
  const now = new Date();
  const end = new Date(); end.setDate(end.getDate()+6);
  return slots.filter(s=>{
    const d = new Date(s.slot_datetime_local || s.slot_datetime_ist);
    if(d < now) return false;
    if(d > end) return false;
    return true;
  });
}

</script>

  <style>
    :root{
      --bg:#050816;
      --card:#0b0f24;
      --card2:#0f1633;
      --border:rgba(255,255,255,.10);
      --text:#f8f5ff;
      --sub:#a8acd0;
      --muted:#7b7fa9;
      --shadow:0 18px 40px rgba(0,0,0,.55);

      /* Brand gradient (logo vibes) */
      --g1:#9b5bff;
      --g2:#ff7b5f;
      --grad:linear-gradient(135deg,var(--g1),var(--g2));
      --radius:18px;
      --pill:999px;
      --t: .18s ease-out;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:radial-gradient(circle at top, #211a44 0, #050816 55%, #020010 100%);
    }

    .page{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:14px 12px 24px;
    }

    /* Section 1 - Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:22px;
      background:rgba(7,10,28,.72);
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .brand img{
      height:30px;
      width:auto;
      display:block;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,.55));
    }

    /* Animated Tick & Gradient for "Locked In" */
    .locked{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 16px;
      border-radius:var(--pill);
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color:white;
      font-weight:800;
      letter-spacing:.2px;
      font-size:13px;
      white-space:nowrap;
    }
    .locked-icon {
        width: 20px; height: 20px;
        border-radius: 50%;
        background: var(--grad);
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 10px rgba(155, 91, 255, 0.4);
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(155, 91, 255, 0.7); }
        70% { box-shadow: 0 0 0 8px rgba(155, 91, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(155, 91, 255, 0); }
    }

    /* Section 2 - Two column */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (min-width: 980px){
      .grid{grid-template-columns: 1fr 1fr;
      gap:14px;}
    }

    .card{
      background:radial-gradient(circle at 0 0, rgba(155,91,255,.18), transparent 55%), rgba(11,15,36,.92);
      border:1px solid var(--border);
      border-radius:26px;
      box-shadow:var(--shadow);
      position:relative;
      /* removed overflow:hidden to allow calendar popup to show */
    }
    .card-inner{padding:16px 14px;}
    @media (min-width: 720px){
      .card-inner{padding:18px 18px;}
    }

    /* Ticket look */
    .ticket{
      position:relative;
      background:
        radial-gradient(circle at 0 0, rgba(255,123,95,.18), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(155,91,255,.18), transparent 55%),
        rgba(12,16,40,.94);
      border:1px solid rgba(255,255,255,.14);
      border-radius:20px;
      overflow:hidden;
      transition: transform var(--t), box-shadow var(--t), border-color var(--t);
    }
    .ticket:hover{
      transform: translateY(-2px);
      border-color: rgba(155,91,255,.55);
      box-shadow:0 22px 48px rgba(0,0,0,.6);
    }

    .ticket::before, .ticket::after{
      content:"";
      position:absolute;
      top:50%;
      width:34px; height:34px;
      border-radius:50%;
      background: rgba(5,8,22,1);
      border:1px solid rgba(255,255,255,.12);
      transform: translateY(-50%);
      z-index:2;
    }
    .ticket::before{left:-17px}
    .ticket::after{right:-17px}

    .ticket-head{
      display:flex;
      align-items:flex-start; justify-content:space-between; gap:10px;
      padding:14px 14px 10px;
      border-bottom:1px dashed rgba(255,255,255,.18);
    }
    .ticket-title{
      font-weight:900;
      letter-spacing:.4px;
      font-size:13px;
      text-transform:uppercase;
      opacity:.98;
    }
    .ticket-sub{
      font-size:12px;
      color:var(--sub);
      margin-top:2px;
    }

    .stamp{
      position:absolute;
      right:12px; top:12px;
      transform: rotate(10deg);
      background: rgba(0,0,0,.25);
      border:2px solid rgba(255,255,255,.22);
      border-radius:14px;
      padding:10px 10px 8px;
      color:white;
      box-shadow:0 18px 30px rgba(0,0,0,.45);
      z-index:3;
      backdrop-filter: blur(6px);
    }
    .stamp .big{
      font-weight:1000;
      font-size:12px;
      letter-spacing:.6px;
      text-transform:uppercase;
      background:var(--grad);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .stamp .small{
      font-size:10px;
      color:rgba(255,255,255,.88);
      margin-top:2px;
      text-align:center;
    }

    .ticket-body{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding:12px 14px 14px;
    }
    @media (min-width: 520px){
      .ticket-body{grid-template-columns:1fr 1fr}
    }
    .ticket-col h4{
      margin:0 0 6px;
      font-size:12px;
      letter-spacing:.4px;
      color:rgba(255,255,255,.92);
      text-transform:uppercase;
    }
    .kv{
      display:grid;
      grid-template-columns: 86px 1fr;
      gap:8px 10px;
      font-size:13px;
      align-items:center;
    }
    .k{color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.3px}
    
    /* FIX: Email Overflow Ellipsis */
    .v{
        font-weight:800; color:var(--text); 
        min-width:0; 
        overflow:hidden; 
        text-overflow:ellipsis;
        white-space:nowrap;
        display: block;
    }

    .powered{
      text-align:center;
      font-size:10px;
      color:rgba(255,255,255,.70);
      padding:8px 10px 10px;
      border-top:1px dashed rgba(255,255,255,.14);
    }

    /* Schedule card */
    .schedule-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .schedule-title{
      display:flex; flex-direction:column; gap:2px;
    }
    .schedule-title .tag{
      display:inline-flex; align-items:center; gap:7px;
      font-weight:900;
      letter-spacing:.2px;
      font-size:12px;
      color:white;
    }
    .schedule-title .tag span{
      display:inline-flex; width:22px; height:22px; border-radius:8px;
      align-items:center; justify-content:center;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
    }
    .schedule-title .sub{
      color:var(--sub);
      font-size:12px;
    }

    .btn{
      border:0;
      border-radius: var(--pill);
      padding:10px 14px;
      font-weight:900;
      color:white;
      background: var(--grad);
      cursor:pointer;
      box-shadow:0 16px 28px rgba(155,91,255,.22);
      transition: transform var(--t), box-shadow var(--t), opacity var(--t);
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); box-shadow:0 22px 34px rgba(155,91,255,.28);}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none;
      box-shadow:none;}
    .btn-ghost{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      color:rgba(255,255,255,.92);
      box-shadow:none;
    }
    .btn-ghost:hover{background:rgba(255,255,255,.12); transform: translateY(-1px);}

    .schedule-box{
      display:grid;
      grid-template-columns: 104px 1fr;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,28,.72);
      /* FIX: Changed from hidden to visible so menu works */
      overflow:visible; 
    }

    .cal{
      width:104px; height:104px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.25), transparent 55%), rgba(10,13,42,.95);
      display:flex; flex-direction:column;
      overflow:hidden;
    }
    .cal .m{
      padding:8px 10px;
      background: rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.10);
      font-size:12px;
      font-weight:900;
      letter-spacing:.8px;
      text-transform:uppercase;
      text-align:center;
    }
    .cal .d{
      flex:1;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:2px;
    }
    .cal .daynum{
      font-size:34px;
      font-weight:1000;
      line-height:1;
    }
    .cal .dow{
      font-size:12px;
      color:rgba(255,255,255,.78);
      font-weight:800;
      letter-spacing:.4px;
      text-transform:uppercase;
    }

    .sched-info .line1{
      font-weight:1000;
      font-size:16px;
      margin-bottom:4px;
    }
    .sched-info .line2{
      color:var(--sub);
      font-size:13px;
      line-height:1.25;
    }
    .sched-actions{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
    }

    /* calendar dropdown */
    .dropdown{position:relative}
    .menu{
      position:absolute;
      left:0; top:44px; /* Changed from right:0 to left:0 for better wrapping */
      width:260px;
      background: rgba(11,15,36,.98);
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      box-shadow:0 22px 50px rgba(0,0,0,.6);
      padding:8px;
      display:none;
      z-index:100;
    }
    .menu.open{display:block}
    .menu a, .menu button{
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      border:0;
      background: transparent;
      color: rgba(255,255,255,.92);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
    }
    .menu a:hover, .menu button:hover{background: rgba(255,255,255,.08);}

    /* fun facts */
    .facts{
      margin-top:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,28,.72);
      padding:12px;
      overflow:hidden;
      min-height: 100px; /* FIX: Prevents empty looking box */
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .facts-head{
      display:flex; align-items:center;
      justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .facts-head .t{
      font-weight:1000;
      font-size:14px;
    }
    .facts-nav{display:flex; gap:8px;}
    .iconbtn{
      width:36px; height:36px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:white;
      font-weight:900;
      cursor:pointer;
      transition: transform var(--t), background var(--t);
    }
    .iconbtn:hover{transform: translateY(-1px);
      background: rgba(255,255,255,.10);}
    .factbox{
      min-height:62px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      flex-grow: 1; /* Ensures it fills space */
    }
    .factemoji{font-size:20px}
    .facttext{font-size:14px; color:rgba(255,255,255,.92); font-weight:800;
      line-height:1.25;}

    /* Right side welcome/timer */
    .welcome{
      padding:16px 14px;
    }
    .welcome h2{
      margin:0 0 6px;
      font-size:22px;
      letter-spacing:.2px;
    }
    .welcome p{
      margin:0 0 10px;
      color:var(--sub);
      font-size:14px;
      line-height:1.35;
    }
    .timer{
      display:flex; flex-direction:column; gap:10px;
      margin-top:10px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,28,.72);
    }
    .timer-row{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .timer-label{font-weight:1000; font-size:14px;}
    .count{
      font-variant-numeric: tabular-nums;
      font-size:22px;
      font-weight:1000;
      letter-spacing:.6px;
    }
    .joinwrap{
      display:flex;
      justify-content:center;
      margin-top:6px;
    }
    .disclaimer{
      margin-top:10px;
      font-size:11px;
      color:rgba(255,255,255,.70);
      line-height:1.35;
    }
    .linklike{
      color:white;
      text-decoration:underline;
      cursor:pointer;
      font-weight:900;
    }

    /* Reschedule */
    .res-btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius: var(--pill);
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:white;
      font-weight:900;
      cursor:pointer;
      transition: transform var(--t), background var(--t);
      white-space:nowrap;
    }
    .res-btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.10);}

    .drawer{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index:80;
    }
    .drawer.open{display:block}
    .panel{
      position:absolute;
      top:0;
      right:0;
      width:min(520px, 100%);
      height:100%;
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.20), transparent 55%), rgba(11,15,36,.98);
      border-left:1px solid rgba(255,255,255,.12);
      box-shadow:-22px 0 60px rgba(0,0,0,.65);
      padding:14px 14px 18px;
      overflow:auto;
    }
    .panel h3{margin:8px 0 4px; font-size:18px;}
    .panel .sub{margin:0 0 10px;
      color:var(--sub); font-size:13px;}
    .panel-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .xbtn{
      width:40px; height:40px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:white;
      cursor:pointer;
      font-size:18px;
      font-weight:900;
    }

    .select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(7,10,28,.72);
      color:white;
      padding:10px 12px;
      outline:none;
      font-weight:800;
      font-size:13px;
    }

    .pills{display:flex; flex-wrap:wrap; gap:10px;
      margin-top:8px;}
    .pill{
      padding:9px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:rgba(255,255,255,.86);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      transition: transform var(--t), background var(--t), border-color var(--t);
      min-width:120px;
    }
    .pill:hover{transform: translateY(-1px);
      background: rgba(255,255,255,.10);}
    .pill.active{
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.34), transparent 60%), rgba(10,13,42,.95);
      border-color: rgba(155,91,255,.55);
      color:white;
    }

    .slotgrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (min-width:420px){
      .slotgrid{grid-template-columns: repeat(3, minmax(0,1fr));}
    }
    
    /* FIX: Slot Colors for visibility */
    .slot{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      padding:10px 10px;
      cursor:pointer;
      font-weight:1000;
      text-align:center;
      transition: transform var(--t), background var(--t), border-color var(--t);
      font-size:13px;
      position:relative;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      color: #e9ecff; /* Force readable color */
    }
    .slot:hover{transform: translateY(-1px); background: rgba(255,255,255,.10);}
    .slot.active{
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.34), transparent 60%), rgba(10,13,42,.95);
      border-color: rgba(155,91,255,.55);
      color:white;
    }
    .star{
      position:absolute; top:6px; right:6px;
      font-size:10px;
      padding:2px 6px;
      border-radius:var(--pill);
      border:1px solid rgba(255,222,140,.8);
      background: rgba(79,54,7,.45);
      color:#ffeec4;
      font-weight:1000;
    }

    /* Modal - Terms */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      background: rgba(0,0,0,.60);
      z-index:90;
      padding:18px 12px;
    }
    .modal.open{display:flex; align-items:center;
      justify-content:center;}
    .modal-card{
      width:min(760px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background: radial-gradient(circle at 0 0, rgba(155,91,255,.20), transparent 55%), rgba(11,15,36,.98);
      box-shadow:0 22px 60px rgba(0,0,0,.75);
      padding:16px 16px 14px;
    }
    .modal-top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .modal-top h3{margin:0; font-size:18px;}
    .modal-top p{margin:4px 0 0; color:var(--sub);
      font-size:13px;}
    .modal-card ul{
      margin:10px 0 0;
      padding-left:18px;
      color:rgba(255,255,255,.88);
      font-size:13px;
      line-height:1.5;
    }

    /* Loading / errors */
    .state{
      margin-top:12px;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,28,.72);
      color:rgba(255,255,255,.86);
      font-weight:800;
      font-size:13px;
    }
    .hide{display:none !important;}

    /* MOBILE OPTIMIZATIONS */
    @media (max-width: 768px) {
        .brand img { height: 24px; } /* Smaller Logo */
        
        .topbar {
            flex-direction: row; /* Keep row but ensure space */
        }
        
        /* Ensure calendar menu fits on screen */
        .menu {
            width: 220px;
            left: -50px; 
        }
        
        /* Stack ticket columns on very small screens */
        .ticket-body { grid-template-columns: 1fr; }
    }
  
/* Email ellipsis + copy */
.ellipsis-email{
  max-width: 220px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
}
.ellipsis-email:hover{ text-decoration: underline; }
.copy-toast{
  position: fixed; bottom: 16px; right: 16px;
  background: #111827; color: #fff; padding: 8px 12px;
  border-radius: 8px; font-size: 12px; opacity: 0; transition: .3s;
  z-index: 9999;
}
.copy-toast.show{ opacity: 1; }


/* Fun facts visual filler */
.fun-divider{
  height: 3px; width: 100%;
  background: linear-gradient(90deg,#7c3aed,#22d3ee,#7c3aed);
  background-size: 200% 100%;
  animation: funflow 2.5s linear infinite;
  border-radius: 999px; margin: 10px 0;
}
@keyframes funflow{0%{background-position:0%}100%{background-position:200%}}
.fun-dots{display:flex; gap:6px; justify-content:center; margin-top:6px;}
.fun-dots span{width:6px;height:6px;border-radius:50%;background:#c7d2fe;opacity:.5}
.fun-dots span.active{opacity:1;background:#6366f1}


/* Reschedule popup fixes */
.resched-time{ color:#e9ecff; }
.resched-time.disabled{ opacity:.35; pointer-events:none; }
.star-badge{ z-index:2; }


.name-gradient{
  background: linear-gradient(90deg,#7c3aed,#22d3ee);
  -webkit-background-clip:text; background-clip:text;
  color: transparent; font-weight: 800;
}

</style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <div class="brand">
        <img src="https://res.cloudinary.com/dpapyknn4/image/upload/v1763143023/Unischooly_Horizontal_logo_qbu1l7.svg" alt="Unischooly" />
      </div>
      <div class="locked">
        <div class="locked-icon">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        </div>
        Your trial class is locked in!
      </div>
    </div>

    <div id="stateError" class="state hide">Booking not found. Please check the link.</div>

    <div id="section2" class="grid">
      <div class="card">
        <div class="card-inner">
          <div class="ticket" id="ticketCard">
            <div class="stamp" aria-label="Value waived stamp">
              <div class="big">VALUE<br/>WAIVED</div>
              <div class="small">$30</div>
            </div>
            <div class="ticket-head">
              <div>
                <div class="ticket-title">üé´ OFFICIAL FREE TRIAL PASS</div>
                <div class="ticket-sub">Valid for 1 session ‚Ä¢ Powered by Unischooly</div>
              </div>
            </div>
            <div class="ticket-body">
              <div class="ticket-col">
                <h4>Admit One Student</h4>
                <div class="kv">
                   <div class="k">Name</div><div class="v" id="vChild">‚Äî</div>
                  <div class="k">Grade</div><div class="v" id="vGrade">‚Äî</div>
                  <div class="k">Course</div><div class="v" id="vCourse">‚Äî</div>
                </div>
              </div>
              <div class="ticket-col">
                 <h4>Parent Confirmation</h4>
                <div class="kv">
                  <div class="k">Sent to</div><div class="v" id="vParent">‚Äî</div>
                  <div class="k">Cell</div><div class="v" id="vPhone">‚Äî</div>
                  <div class="k">Email</div><div class="v" id="vEmail" title="Hover to see email">‚Äî</div>
                </div>
              </div>
            </div>
            <div class="powered">Powered by Unischooly</div>
          </div>

          <div style="height:12px"></div>
          <div class="schedule-head">
             <div class="schedule-title">
              <div class="tag"><span>üöÄ</span> Ready for Blast Off!!!</div>
              <div class="sub">Class Schedule</div>
            </div>
            <button class="res-btn" id="btnReschedule">üóìÔ∏è Reschedule</button>
          </div>

          <div class="schedule-box">
            <div class="cal" aria-label="Calendar">
              <div class="m" id="calMonth">‚Äî</div>
              <div class="d">
                <div class="daynum" id="calDay">‚Äî</div>
                <div class="dow" id="calDow">‚Äî</div>
              </div>
            </div>
 
            <div class="sched-info">
              <div class="line1" id="schedTime">‚Äî</div>
              <div class="line2" id="schedMeta">‚Äî</div>

              <div class="sched-actions">
                <div class="dropdown">
                  <button class="btn" id="btnCalendar">üìÖ Initiate Calendar Sync</button>
                  <div class="menu" id="calMenu">
                    <a id="calGoogle" target="_blank" rel="noreferrer">Google Calendar <span>‚Üó</span></a>
                    <a id="calApple" target="_blank" rel="noreferrer">Apple Calendar (ICS) <span>‚¨á</span></a>
                    <a id="calOutlook" target="_blank" rel="noreferrer">Outlook.com <span>‚Üó</span></a>
                    <a id="calYahoo" target="_blank" rel="noreferrer">Yahoo Calendar <span>‚Üó</span></a>
                    <button id="calDownload">Download .ics <span>‚¨á</span></button>
                  </div>
                </div>
                <button class="btn btn-ghost" id="btnCopy">üîó Copy class time</button>
             </div>
            </div>
          </div>

          <div class="facts">
            <div class="facts-head">
              <div class="t">‚ú® Fun Facts</div>
              <div class="facts-nav">
                <button class="iconbtn" id="factPrev">‚Äπ</button>
                <button class="iconbtn" id="factNext">‚Ä∫</button>
              </div>
            </div>
            <div class="factbox" aria-live="polite">
              <div class="factemoji" id="factEmoji">üí°</div>
              <div class="facttext" id="factText">‚Äî</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="welcome">
          <h2 id="welcomeTitle">Welcome!</h2>
         
          <p id="welcomeSub">Your trial class details are loading.</p>

          <div class="timer">
            <div class="timer-row">
              <div class="timer-label" id="timerLabel">Join class in</div>
              <div class="count" id="countdown">--:--:--</div>
            </div>

            <div class="joinwrap">
              <button class="btn" id="btnJoin" disabled>üé• Join Class</button>
            </div>

            <div class="disclaimer">
              By clicking join class, you are confirming that you have read, understood and agree to
              <span class="linklike" id="openTerms">Terms & Conditions</span>.
            </div>
          </div>

          <div class="facts" style="margin-top:12px">
            <div class="facts-head">
              <div class="t">Sharpen Your Brain üß†</div>
              <div class="facts-nav">
                <button class="iconbtn" id="pPrev">‚Äπ</button>
                <button class="iconbtn" id="pNext">‚Ä∫</button>
              </div>
            </div>

            <div class="factbox" style="align-items:flex-start">
              <div class="factemoji">üß©</div>
              <div style="flex:1">
                <div class="facttext" id="pQuestion" style="margin-bottom:8px">‚Äî</div>
                 <div class="pills" id="pChoices" style="margin-top:0"></div>
                <div style="margin-top:8px; font-size:11px; color:rgba(255,255,255,.72); font-weight:800" id="pStatus">‚Äî</div>
              </div>
            </div>
          </div>

          <div class="facts" style="margin-top:12px">
            <div class="facts-head">
              <div class="t">Mini Games üéÆ</div>
              <div style="font-size:11px; color:rgba(255,255,255,.72); font-weight:800">Quick brain boosters</div>
            </div>
            <div class="factbox" style="flex-direction:column; align-items:stretch; gap:10px">
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn btn-ghost" id="tabSprint">Quick Sprint</button>
                <button class="btn btn-ghost" id="tabMemory">Memory Match</button>
              </div>

              <div id="gameSprint" class="hide">
                 <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
                  <div style="font-weight:1000">Quick Math Sprint (60s)</div>
                  <div style="font-variant-numeric:tabular-nums; font-weight:1000" id="sprintTime">60</div>
                </div>
                <div style="margin-top:8px; font-size:14px; font-weight:1000" id="sprintQ">‚Äî</div>
                <div class="pills" style="margin-top:10px" id="sprintChoices"></div>
                <div style="margin-top:8px; font-size:11px; color:rgba(255,255,255,.72); font-weight:800" id="sprintStatus">Tap an answer to start.</div>
              </div>

              <div id="gameMemory" class="hide">
                <div style="font-weight:1000; margin-bottom:6px">Memory Match (Emoji)</div>
                <div style="display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:8px" id="memGrid"></div>
                <div style="margin-top:8px; font-size:11px; color:rgba(255,255,255,.72); font-weight:800" id="memStatus">Find all pairs.</div>
              </div>

              <div style="font-size:11px; color:rgba(255,255,255,.70); font-weight:800">Tip: Solving puzzles helps warm up your brain before class!</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div id="termsModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-top">
        <div>
          <h3>Terms & Conditions</h3>
           <p>Please keep these video conferencing etiquette tips in mind so you know what NOT to do during your demo/trial class:</p>
        </div>
        <button class="xbtn" id="closeTerms">‚úï</button>
      </div>

      <ul>
        <li>By taking this demo/trial session, you consent to Unischooly/Company recording this session.</li>
        <li>This demo/trial session or class will be recorded for the whole duration for training, constant process improvement, and audit purposes.</li>
        <li>Unischooly/Company adheres to zero tolerance towards sexual, non-sexual, verbal and visual abuse. Inappropriate hand gestures, threats, or any other indecent behaviour captured or reported during the session shall also be considered a violation of the Company‚Äôs internal policies.</li>
        <li>While taking the demo/trial session, kindly avoid clothing with controversial messages, including but not limited to racial and/or religious slurs or any type of sexual or non-sexual abuse.</li>
      </ul>
    </div>
  </div>

  <div id="resDrawer" class="drawer" aria-hidden="true">
    <div class="panel">
      <div class="panel-top">
        <div>
          <h3>Reschedule your class</h3>
          <div class="sub">Timezone is prefilled. You can change it.</div>
        </div>
        <button class="xbtn" id="closeRes">‚úï</button>
      </div>

      <div style="margin-top:10px">
        <div style="font-weight:1000; font-size:13px; margin-bottom:8px">Timezone</div>
        <select id="tzSelect" class="select"></select>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:1000; font-size:13px; margin-bottom:8px">Select Date</div>
        <div class="pills" id="resDates"></div>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:1000; font-size:13px; margin-bottom:8px">Select Start Time</div>
        <div class="sub">Slots shown in your selected timezone.</div>
        <div class="slotgrid" id="resSlots"></div>
        <div id="resEmpty" class="state hide" style="margin-top:10px">No slots available for this date.</div>
      </div>

      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
        <button class="btn btn-ghost" id="cancelRes">Cancel</button>
        <button class="btn" id="confirmRes" disabled>Confirm Reschedule</button>
      </div>

      <div style="margin-top:10px; font-size:11px; color:rgba(255,255,255,.70); font-weight:800">
        Your class timing will update instantly once confirmed.
      </div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG: Supabase
    // =========================
    const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // =========================
    // URL params
    // =========================
    const url = new URL(window.location.href);
    const iduuid = url.searchParams.get("iduuid"); // IMPORTANT: demo_leads primary key
    const courseId = parseInt(url.searchParams.get("courseId") || "1", 10);

    // =========================
    // Course mapping + facts + puzzles
    // =========================
    const COURSE = {
      1:{name:"Coding", emoji:"üíª"},
      2:{name:"Python", emoji:"üêç"},
      3:{name:"Website Development", emoji:"üåê"},
      4:{name:"Generative AI", emoji:"‚ú®"},
      5:{name:"Roblox", emoji:"üß±"},
      6:{name:"Chess", emoji:"‚ôüÔ∏è"},
      7:{name:"Mathematics", emoji:"‚ûó"},
    };
    const FACT_BANK = {
      1:[
        ["üí°","The first computer bug was an actual moth found in 1947!"],
        ["üß†","Coding is like giving step-by-step instructions to a super-fast helper."],
        ["üß©","Algorithms are just smart recipes for solving problems."],
        ["üéÆ","Many games run at 60 frames per second‚Äîyour code helps make that smooth!"],
        ["üîÅ","Loops save time by repeating actions so you don‚Äôt write the same code again."],
        ["üß±","Scratch blocks teach logic the same way real code does."],
        ["üåç","The Internet works because of protocols‚Äîrules computers agree on."],
        ["üîê","Encryption turns messages into secret code to keep them safe."],
        ["üõ∞Ô∏è","GPS relies on satellites + math + code to find your location."],
        ["‚ö°","Computers love patterns‚Äîgood coders learn to spot patterns too!"],
      ],
      2:[
        ["üêç","Python is named after Monty Python‚Äînot the snake!"],
        ["üì¶","Python has packages so you can add superpowers quickly."],
        ["üß†","Indentation in Python matters‚Äîit shows what belongs together."],
        ["üî¢","Python is great for math, data, and AI projects."],
        ["üß©","Lists in Python hold many items, like a backpack of values."],
        ["üß™","You can test code in small pieces to find bugs faster."],
        ["ü§ñ","Many AI tools use Python behind the scenes."],
        ["‚öôÔ∏è","Functions are mini-machines: input ‚Üí work ‚Üí output."],
        ["üßØ","Errors are normal‚Äîdebugging is a coder‚Äôs superpower."],
        ["üåü","Readable code is powerful code."],
      ],
      3:[
        ["üåê","Web pages are built with HTML (structure), CSS (style), and JS (logic)."],
        ["üé®","CSS can animate shapes without images!"],
        ["üì±","Responsive design makes sites look great on phones and desktops."],
        ["üß≠","Links connect pages like roads connect cities."],
        ["‚ö°","Browsers run JavaScript to make sites interactive."],
        ["üî§","A URL is an address to a page on the Internet."],
        ["üß±","Components help reuse the same UI blocks."],
        ["üñºÔ∏è","Images should be optimized so pages load faster."],
        ["üîê","HTTPS keeps website data secure."],
        ["üß†","Good UX is about clarity and confidence."],
      ],
      4:[
        ["‚ú®","Generative AI can create text, images, and music from prompts."],
        ["üß†","Models learn patterns from lots of examples."],
        ["üß©","Prompts work best when they‚Äôre specific and clear."],
        ["üß™","AI outputs should be checked‚Äîhumans stay in control."],
        ["üìö","AI can help summarize, brainstorm, and explain concepts."],
        ["üé®","AI art tools turn words into pictures."],
        ["üß†","Training data shapes what AI knows."],
        ["‚öñÔ∏è","Using AI responsibly is important‚Äîbe kind and respectful."],
        ["üîÅ","Iteration is key: prompt ‚Üí result ‚Üí improve prompt."],
        ["üåü","AI is a tool‚Äîyour ideas are the magic."],
      ],
      5:[
        ["üß±","Roblox games are built with Lua scripting."],
        ["üéÆ","Game loops update the world many times per second."],
        ["üß†","Design + code = fun gameplay."],
        ["üó∫Ô∏è","Levels are like puzzles you build for others."],
        ["üîÅ","Events trigger actions‚Äîlike when a player touches a part."],
        ["üé®","Lighting and colors change the mood of a game."],
        ["üß©","Physics rules make jumping and falling feel real."],
        ["üîä","Sound effects make games feel alive."],
        ["üß™","Testing helps you catch glitches before players do."],
        ["üèÜ","Small improvements add up to big fun."],
      ],
      6:[
        ["‚ôüÔ∏è","In chess, controlling the center gives you more options."],
        ["üß†","Tactics are short puzzles; strategy is the long plan."],
        ["üéØ","Forks attack two pieces at once."],
        ["üõ°Ô∏è","Develop pieces early to activate your army."],
        ["üè∞","Castling helps keep your king safe."],
        ["üìå","Pins stop a piece from moving."],
        ["üîÅ","Checkmate means the king cannot escape."],
        ["üß©","Good players look for threats AND defenses."],
        ["‚è±Ô∏è","Time management matters in fast games."],
        ["üåü","Every game teaches something new."],
      ],
      7:[
        ["‚ûó","Math is a language for patterns."],
        ["üß†","Fractions are just parts of a whole."],
        ["üìà","Graphs show relationships visually."],
        ["üî¢","Prime numbers have only two factors: 1 and themselves."],
        ["üß©","Geometry is like drawing with rules."],
        ["‚ö°","Mental math is a skill‚Äîpractice makes it fast."],
        ["üß†","Estimation helps you check if answers make sense."],
        ["üîÅ","Multiplication is repeated addition."],
        ["üìê","Angles tell you how much you turn."],
        ["üåü","Math helps in games, coding, and real life."],
      ],
    };
    const PUZZLES = {
      1:[
        {q:"What comes next? 2, 4, 8, 16, ?", choices:["18","24","32","34"], a:2},
        {q:"If a loop runs 5 times, and prints 'Hi' each time, how many 'Hi'?", choices:["1","5","10","0"], a:1},
        {q:"Which is a 'condition'?", choices:["Run fast","If it rains","Blue is nice","Hello!"], a:1},
        {q:"Pick the best order to solve a task:", choices:["Plan ‚Üí Code ‚Üí Test","Code ‚Üí Hope","Skip plan","Only test"], a:0},
        {q:"Binary uses only:", choices:["0 and 1","1 and 2","2 and 3","A and B"], a:0},
        {q:"A bug is:", choices:["A feature","A mistake in code","A keyboard","A mouse"], a:1},
        {q:"Which repeats actions?", choices:["Loop","Variable","Comment","Pixel"], a:0},
        {q:"Algorithm is like:", choices:["A recipe","A color","A shoe","A cloud"], a:0},
        {q:"What stores a value?", choices:["Variable","Monitor","Speaker","Cable"], a:0},
        {q:"Debugging means:", choices:["Adding bugs","Fixing issues","Deleting files","Shouting"], a:1},
      ],
      2:[
        {q:"Python is great for:", choices:["Only painting","Data & AI","Only music","Only chess"], a:1},
        {q:"In Python, indentation shows:", choices:["Color","Block of code","Volume","Speed"], a:1},
        {q:"A list is:", choices:["One value","Many values together","A keyboard","A website"], a:1},
        {q:"Function is like:", choices:["A mini-machine","A sandwich","A bus stop","A cloud"], a:0},
        {q:"Which is a number?", choices:["'7'","7","Seven","None"], a:1},
        {q:"Bug fixing is called:", choices:["Debugging","Painting","Sleeping","Singing"], a:0},
        {q:"Print() does:", choices:["Shows output","Deletes code","Plays music","Makes tea"], a:0},
        {q:"If x=3, x+2 = ?", choices:["3","4","5","6"], a:2},
        {q:"A loop repeats until:", choices:["It wants","Condition ends","Keyboard breaks","Sun sets"], a:1},
        {q:"Best coder habit:", choices:["Never test","Write readable code","Hide errors","Skip learning"], a:1},
      ],
      3:[
        {q:"HTML is for:", choices:["Style","Structure","Music","Painting"], a:1},
        {q:"CSS is for:", choices:["Style","Math","Storage","Network"], a:0},
        {q:"JS is for:", choices:["Interactivity","Only images","Only fonts","Only paper"], a:0},
        {q:"Responsive means:", choices:["Fast","Fits all screens","Only desktop","Only mobile"], a:1},
        {q:"A link connects:", choices:["Shoes","Pages","Clouds","Books"], a:1},
        {q:"URL is:", choices:["A page address","A game score","A color","A bug"], a:0},
        {q:"Button click is handled by:", choices:["JavaScript","Paper","Wind","Paint"], a:0},
        {q:"Best for speed:", choices:["Huge images","Optimized images","No images ever","Random"], a:1},
        {q:"HTTPS means:", choices:["Secure site","Slow site","Fun site","Old site"], a:0},
        {q:"UX is about:", choices:["Confusing users","User experience","Only colors","Only text"], a:1},
      ],
      4: [
        {q:"Generative AI can:", choices:["Only sleep","Create content","Only run","Only paint walls"], a:1},
        {q:"Good prompts are:", choices:["Vague","Specific","Empty","Angry"], a:1},
        {q:"AI outputs should be:", choices:["Always trusted","Checked by humans","Ignored","Printed"], a:1},
        {q:"AI learns from:", choices:["Patterns in data","Rain","Shoes","Cars"], a:0},
        {q:"Iteration means:", choices:["Try once","Improve repeatedly","Stop","Delete"], a:1},
        {q:"AI is a:", choices:["Tool","Wizard","Monster","Book"], a:0},
        {q:"Responsible AI is:", choices:["Kind & safe","Mean","Secret","Lazy"], a:0},
        {q:"Models are:", choices:["Pattern learners","Sandwiches","Shoes","Buses"], a:0},
        {q:"Clear prompts help:", choices:["Confuse AI","Get better results","Break code","Slow down"], a:1},
        {q:"Human role is:", choices:["None","In control","Only watch","Only sleep"], a:1},
      ],
      5: [
        {q:"Roblox scripting uses:", choices:["Lua","Python","HTML","Cement"], a:0},
        {q:"Game loop does:", choices:["Updates world","Stops time","Cooks","Draws"], a:0},
        {q:"Events trigger:", choices:["Actions","Rain","Sand","Paper"], a:0},
        {q:"Testing helps:", choices:["Catch glitches","Add bugs","Make noise","Hide work"], a:0},
        {q:"Lighting changes:", choices:["Mood","Math","Keyboard","Cable"], a:0},
        {q:"Physics makes:", choices:["Movement real","Only colors","Only text","Only sound"], a:0},
        {q:"Levels are:", choices:["Puzzles you build","Shoes","Bikes","Clouds"], a:0},
        {q:"Sound effects:", choices:["Add life","Remove fun","Break code","Delete"], a:0},
        {q:"Design + code =", choices:["Fun gameplay","Nothing","Confusion","Sleep"], a:0},
        {q:"Small improvements:", choices:["Add up big","Never matter","Break all","Stop"], a:0},
      ],
      6: [
        {q:"Control the center gives:", choices:["More options","Less moves","No moves","Only pawns"], a:0},
        {q:"Fork attacks:", choices:["Two pieces","Zero pieces","Only king","Only pawn"], a:0},
        {q:"Castling keeps:", choices:["King safer","Queen faster","Pawns taller","Time slower"], a:0},
        {q:"Pin means:", choices:["Piece can't move","Piece flies","Board breaks","Win instantly"], a:0},
        {q:"Checkmate is:", choices:["King trapped","King happy","Queen gone","Draw"], a:0},
        {q:"Strategy is:", choices:["Long plan","Short trick","Random","No plan"], a:0},
        {q:"Tactics are:", choices:["Short puzzles","Long speeches","Books","Songs"], a:0},
        {q:"Develop pieces:", choices:["Early","Never","Only end","Only start"], a:0},
        {q:"Time matters in:", choices:["Fast games","Only slow","Never","Only puzzles"], a:0},
        {q:"Every game teaches:", choices:["Something","Nothing","Only loss","Only win"], a:0},
      ],
      7: [
        {q:"Prime numbers have:", choices:["2 factors","3 factors","0 factors","10 factors"], a:0},
        {q:"Multiplication is:", choices:["Repeated addition","Repeated division","Drawing","Singing"], a:0},
        {q:"Estimation helps:", choices:["Check answers","Confuse","Hide","Lose"], a:0},
        {q:"Angles measure:", choices:["Turn","Speed","Weight","Sound"], a:0},
        {q:"Graphs show:", choices:["Relationships","Only colors","Only sounds","Only bugs"], a:0},
        {q:"Fractions are:", choices:["Parts of whole","Only big numbers","Only primes","Only shapes"], a:0},
        {q:"Geometry is:", choices:["Drawing with rules","Cooking","Flying","Typing"], a:0},
        {q:"Math is:", choices:["Pattern language","Random","Only hard","Only easy"], a:0},
        {q:"Mental math is:", choices:["Practice skill","Magic","Luck","Sleep"], a:0},
        {q:"Math helps in:", choices:["Life & coding","Only school","Only games","Nowhere"], a:0},
      ]
    };
    // =========================
    // Helpers: timezone formatting
    // =========================
    function safeTZ(tz){
      try { Intl.DateTimeFormat("en-US",{timeZone:tz}).format(new Date());
      return tz; } catch { return "Asia/Kolkata"; }
    }
    function fmtLocal(dt, tz){
      const parts = new Intl.DateTimeFormat("en-US", {
        timeZone: tz,
        weekday: "short",
        month: "short",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      }).formatToParts(dt);
      const map = Object.fromEntries(parts.map(p=>[p.type,p.value]));
      return {weekday: map.weekday, month: map.month, day: map.day, time: `${map.hour}:${map.minute} ${map.dayPeriod}`};
    }
    function dateKeyInTZ(dt, tz){
      const p = new Intl.DateTimeFormat("en-CA", {timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit"}).format(dt);
      return p; // YYYY-MM-DD
    }

    // =========================
    // Booking load
    // =========================
    let BOOKING = null;
    let bookingTZ = "Asia/Kolkata";
    let bookingRegion = null;
    let bookingCourseName = (COURSE[courseId]||COURSE[1]).name;
    async function loadBooking(){
      if(!iduuid){ return null; }
      const { data, error } = await sb
        .from("demo_leads")
        .select("*")
        .eq("id", iduuid)
        .single();
      if(error || !data){ console.error(error); return null; }
      return data;
    }

    // =========================
    // Derive class datetime for countdown + calendar
    // preferred_date is date (no timezone), preferred_time_slot is local string (e.g., "10:00 AM")
    // We'll compute a Date by combining preferred_date with local time in booking.timezone
    // =========================
    function parseTime12hTo24(t){
      // "10:00 AM" -> {h:10,m:0}
      const m = (t||"").trim().match(/^(\d{1,2})\s*:\s*(\d{2})\s*(AM|PM)$/i);
      if(!m) return null;
      let h = parseInt(m[1],10);
      const mm = parseInt(m[2],10);
      const ap = m[3].toUpperCase();
      if(ap==="PM" && h!==12) h += 12;
      if(ap==="AM" && h===12) h = 0;
      return {h, m:mm};
    }

    function makeDateInTZ(dateStr, timeStr, tz){
      // Build a Date that represents the same wall-clock time in tz.
      // Approach: create in UTC then adjust using tz offset at that moment by formatting.
      const t = parseTime12hTo24(timeStr);
      if(!dateStr || !t) return null;

      // Start with UTC date
      const [Y,M,D] = dateStr.split("-").map(x=>parseInt(x,10));
      const guessUTC = new Date(Date.UTC(Y, M-1, D, t.h, t.m, 0));
      // Determine what wall clock that UTC time shows in tz; then shift.
      // We want the tz wall clock == (Y-M-D + t.h:t.m).
      const shown = new Intl.DateTimeFormat("en-CA", {timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", hour12:false})
        .formatToParts(guessUTC);
      const map = Object.fromEntries(shown.map(p=>[p.type,p.value]));
      const shownY = parseInt(map.year,10);
      const shownM = parseInt(map.month,10);
      const shownD = parseInt(map.day,10);
      const shownH = parseInt(map.hour,10);
      const shownMin = parseInt(map.minute,10);

      // Calculate delta minutes between desired and shown in tz
      const desired = Date.UTC(Y, M-1, D, t.h, t.m, 0);
      const shownAsIfUTC = Date.UTC(shownY, shownM-1, shownD, shownH, shownMin, 0);
      const deltaMs = desired - shownAsIfUTC;
      return new Date(guessUTC.getTime() + deltaMs);
    }

    function buildMeetLink(){
      // Placeholder until meet link column exists (wise/zoom/etc).
      // If you later store a meet link in demo_leads (e.g., meeting_link), read it here.
      return null;
    }

    // =========================
    // Render Section 2
    // =========================
    function setText(id, value){
      const el = document.getElementById(id);
      if(el) el.textContent = value ?? "‚Äî";
    }

    function renderBooking(b){
      BOOKING = b;
      bookingTZ = safeTZ(b.timezone || "Asia/Kolkata");
      bookingRegion = b.region_key || null;
      bookingCourseName = (COURSE[b.course_id]||COURSE[courseId]||COURSE[1]).name;
      // Ticket fields
      setText("vChild", b.child_name);
      setText("vGrade", b.child_grade);
      setText("vParent", b.parent_name);
      setText("vEmail", b.parent_email);
      setText("vPhone", `${b.phone_country_code || ""} ${b.phone_number || ""}`.trim());
      setText("vCourse", bookingCourseName);

      // Schedule
      const classDT = makeDateInTZ(b.preferred_date, b.preferred_time_slot, bookingTZ);
      if(classDT){
        const s = fmtLocal(classDT, bookingTZ);
        setText("calMonth", s.month);
        setText("calDay", s.day);
        setText("calDow", s.weekday);
        setText("schedTime", `${s.time}`);
        setText("schedMeta", `${b.preferred_date} ‚Ä¢ ${bookingTZ}`);

        // calendar links
        setupCalendarLinks(classDT, bookingTZ, bookingCourseName, b.child_name);
        // copy
        document.getElementById("btnCopy").onclick = async () => {
          const txt = `Unischooly Trial Class for ${b.child_name} ‚Äî ${s.weekday}, ${s.month} ${s.day} at ${s.time} (${bookingTZ})`;
          try{ await navigator.clipboard.writeText(txt); toast("Copied!"); } catch { toast("Copy failed"); }
        };
        // countdown
        startCountdown(classDT, bookingTZ);
      } else {
        setText("schedTime", "Schedule not set");
        setText("schedMeta", "Please reschedule or contact support.");
        document.getElementById("btnJoin").disabled = true;
        document.getElementById("countdown").textContent = "--:--:--";
      }

      // Welcome
      setText("welcomeTitle", `Welcome to ${b.child_name}‚Äôs ${bookingCourseName} Trial Class`);
      setText("welcomeSub", "You‚Äôre all set. Explore fun puzzles & mini-games while you wait ‚Äî and sync the class to your calendar.");
      // facts
      initFacts(b.course_id || courseId);
      // puzzles & games
      initPuzzle(b.course_id || courseId);
      initMiniGames();
      // reschedule prefill
      initRescheduleUI();

      // join button logic
      const meetLink = buildMeetLink();
      document.getElementById("btnJoin").onclick = () => {
        if(meetLink){ window.open(meetLink, "_blank", "noopener,noreferrer"); }
        else toast("Meet link will appear 5 mins before class.");
      };
    }

    // =========================
    // Toast (tiny)
    // =========================
    let toastTimer=null;
    function toast(msg){
      let el = document.getElementById("toast");
      if(!el){
        el=document.createElement("div");
        el.id="toast";
        el.style.position="fixed";
        el.style.left="50%";
        el.style.bottom="16px";
        el.style.transform="translateX(-50%)";
        el.style.padding="10px 12px";
        el.style.borderRadius="14px";
        el.style.background="rgba(11,15,36,.95)";
        el.style.border="1px solid rgba(255,255,255,.14)";
        el.style.color="white";
        el.style.fontWeight="900";
        el.style.fontSize="13px";
        el.style.boxShadow="0 18px 40px rgba(0,0,0,.6)";
        el.style.zIndex="120";
        document.body.appendChild(el);
      }
      el.textContent=msg;
      el.style.display="block";
      clearTimeout(toastTimer);
      toastTimer=setTimeout(()=>{el.style.display="none"}, 2200);
    }

    // =========================
    // Calendar integration
    // =========================
    function pad2(n){return String(n).padStart(2,"0");}
    function toIcsDateUTC(d){
      // YYYYMMDDTHHMMSSZ
      return `${d.getUTCFullYear()}${pad2(d.getUTCMonth()+1)}${pad2(d.getUTCDate())}T${pad2(d.getUTCHours())}${pad2(d.getUTCMinutes())}00Z`;
    }
    function escapeICS(s){ return String(s||"").replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;");}

    function makeICS({title, desc, startUTC, endUTC}){
      return [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//Unischooly//Demo//EN",
        "CALSCALE:GREGORIAN",
        "METHOD:PUBLISH",
        "BEGIN:VEVENT",
        `UID:${Date.now()}@unischooly.com`,
        `DTSTAMP:${toIcsDateUTC(new Date())}`,
        `DTSTART:${toIcsDateUTC(startUTC)}`,
        `DTEND:${toIcsDateUTC(endUTC)}`,
        `SUMMARY:${escapeICS(title)}`,
        `DESCRIPTION:${escapeICS(desc)}`,
        "END:VEVENT",
        "END:VCALENDAR"
      ].join("\r\n");
    }

    function setupCalendarLinks(classDT, tz, course, child){
      const start = classDT; // already actual instant
      const end = new Date(start.getTime() + 60*60*1000);
      const title = `Unischooly Trial Class - ${course}`;
      const desc = `Trial class for ${child}. Timezone: ${tz}.`;
      // Google Calendar uses dates in UTC in URL parameters
      const gBase = "https://calendar.google.com/calendar/render?action=TEMPLATE";
      const gDates = `${toIcsDateUTC(start)}/${toIcsDateUTC(end)}`;
      const gUrl = `${gBase}&text=${encodeURIComponent(title)}&details=${encodeURIComponent(desc)}&dates=${encodeURIComponent(gDates)}`;

      // Outlook.com
      const oBase = "https://outlook.live.com/calendar/0/deeplink/compose";
      const oUrl = `${oBase}?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(desc)}&startdt=${encodeURIComponent(start.toISOString())}&enddt=${encodeURIComponent(end.toISOString())}`;

      // Yahoo
      const yBase = "https://calendar.yahoo.com/";
      const dur = "0100";
      const yUrl = `${yBase}?v=60&title=${encodeURIComponent(title)}&st=${encodeURIComponent(toIcsDateUTC(start))}&dur=${dur}&desc=${encodeURIComponent(desc)}`;

      // ICS download (Apple uses .ics)
      const ics = makeICS({title, desc, startUTC:start, endUTC:end});
      const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
      const icsUrl = URL.createObjectURL(blob);

      document.getElementById("calGoogle").href = gUrl;
      document.getElementById("calOutlook").href = oUrl;
      document.getElementById("calYahoo").href = yUrl;
      document.getElementById("calApple").href = icsUrl;

      document.getElementById("calDownload").onclick = () => {
        const a = document.createElement("a");
        a.href = icsUrl;
        a.download = "unischooly-trial.ics";
        a.click();
      };
    }

    // Calendar dropdown
    const calBtn = document.getElementById("btnCalendar");
    const calMenu = document.getElementById("calMenu");
    calBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      calMenu.classList.toggle("open");
      // subtle pulse animation by reflowing box-shadow
      calBtn.animate([{transform:"translateY(0)"},{transform:"translateY(-2px)"},{transform:"translateY(0)"}], {duration:700});
    });
    document.addEventListener("click", ()=> calMenu.classList.remove("open"));

    // =========================
    // Fun Facts auto-rotate
    // =========================
    let factIdx=0, factList=[];
    let factTimer=null;
    function initFacts(cid){
      factList = (FACT_BANK[cid]||FACT_BANK[1]).slice();
      factIdx = 0;
      showFact(0);
      clearInterval(factTimer);
      factTimer = setInterval(()=> nextFact(1), 5200);

      document.getElementById("factPrev").onclick = ()=> nextFact(-1, true);
      document.getElementById("factNext").onclick = ()=> nextFact(1, true);
    }
    function showFact(i){
      const item = factList[(i+factList.length)%factList.length];
      document.getElementById("factEmoji").textContent = item[0];
      document.getElementById("factText").textContent = item[1];
    }
    function nextFact(delta, manual=false){
      factIdx = (factIdx + delta + factList.length) % factList.length;
      showFact(factIdx);
      if(manual){
        clearInterval(factTimer);
        factTimer = setInterval(()=> nextFact(1), 5200);
      }
    }

    // =========================
    // Puzzles
    // =========================
    let pList=[], pIdx=0, pScore=0, pAnswered=0;
    function initPuzzle(cid){
      pList = (PUZZLES[cid]||PUZZLES[1]).slice();
      pIdx = 0; pScore = 0; pAnswered = 0;
      renderPuzzle();
      document.getElementById("pPrev").onclick = ()=> { pIdx = (pIdx - 1 + pList.length)%pList.length; renderPuzzle(true); };
      document.getElementById("pNext").onclick = ()=> { pIdx = (pIdx + 1)%pList.length; renderPuzzle(true); };
    }
    function renderPuzzle(resetMsg=false){
      const p = pList[pIdx];
      document.getElementById("pQuestion").textContent = p.q;
      const choices = document.getElementById("pChoices");
      choices.innerHTML = "";
      p.choices.forEach((c, idx)=>{
        const b=document.createElement("button");
        b.className="pill";
        b.textContent=c;
        b.onclick=()=>{
          pAnswered++;
          if(idx===p.a){ pScore++; document.getElementById("pStatus").textContent=`‚úÖ Correct! Score: ${pScore}/${pAnswered}`; }
          else { document.getElementById("pStatus").textContent=`‚ùå Oops! Correct: ${p.choices[p.a]} ‚Ä¢ Score: ${pScore}/${pAnswered}`; }
          // auto next
          setTimeout(()=>{ pIdx = (pIdx + 1)%pList.length; renderPuzzle(); }, 700);
        };
        choices.appendChild(b);
      });
      if(resetMsg){ document.getElementById("pStatus").textContent=`Score: ${pScore}/${pAnswered}`; }
      if(pAnswered===0){ document.getElementById("pStatus").textContent="Pick an answer to start.";}
    }

    // =========================
    // Mini games (super light)
    // =========================
    function initMiniGames(){
      const tabSprint = document.getElementById("tabSprint");
      const tabMemory = document.getElementById("tabMemory");
      const gameSprint = document.getElementById("gameSprint");
      const gameMemory = document.getElementById("gameMemory");

      let active = null;
      function show(which){
        gameSprint.classList.add("hide");
        gameMemory.classList.add("hide");
        if(which==="sprint"){ gameSprint.classList.remove("hide"); }
        if(which==="memory"){ gameMemory.classList.remove("hide"); }
        active = which;
      }
      tabSprint.onclick = ()=> { show("sprint"); startSprint(); };
      tabMemory.onclick = ()=> { show("memory"); startMemory(); };
      // default
      show("sprint");
      startSprint();
    }

    // Quick Sprint
    let sprintTimer=null, sprintLeft=60, sprintScore=0, sprintRunning=false;
    function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
    function newSprintQ(){
      const a=randInt(2,12), b=randInt(2,12);
      const op = Math.random()<0.5 ? "+" : "√ó";
      const ans = op==="+" ? (a+b) : (a*b);
      const wrong1 = ans + randInt(-3,3) || ans+1;
      const wrong2 = ans + randInt(-6,6) || ans+2;
      const opts = [ans, wrong1, wrong2].sort(()=>Math.random()-0.5);
      return {text:`${a} ${op} ${b} = ?`, ans, opts};
    }
    let sprintQ=null;
    function startSprint(){
      clearInterval(sprintTimer);
      sprintLeft=60; sprintScore=0; sprintRunning=false;
      document.getElementById("sprintTime").textContent = sprintLeft;
      document.getElementById("sprintStatus").textContent = "Tap an answer to start.";
      nextSprint();
    }
    function nextSprint(){
      sprintQ = newSprintQ();
      document.getElementById("sprintQ").textContent = sprintQ.text;
      const box = document.getElementById("sprintChoices");
      box.innerHTML="";
      sprintQ.opts.forEach(v=>{
        const b=document.createElement("button");
        b.className="pill";
        b.textContent=String(v);
        b.onclick=()=>{
          if(!sprintRunning){
            sprintRunning=true;
            sprintTimer=setInterval(()=>{
              sprintLeft--;
              document.getElementById("sprintTime").textContent = sprintLeft;
              if(sprintLeft<=0){
                clearInterval(sprintTimer);
                sprintRunning=false;
                document.getElementById("sprintStatus").textContent = `‚è±Ô∏è Time! Score: ${sprintScore}`;
              }
            },1000);
          }
          if(sprintLeft<=0) return;
          if(v===sprintQ.ans){ sprintScore++; document.getElementById("sprintStatus").textContent = `‚úÖ Correct! Score: ${sprintScore}`; }
          else { document.getElementById("sprintStatus").textContent = `‚ùå Try again! Score: ${sprintScore}`; }
          setTimeout(nextSprint, 350);
        };
        box.appendChild(b);
      });
    }

    // Memory Match
    let memFirst=null, memLock=false, memMatches=0;
    function startMemory(){
      const emojis=["üçÄ","üöÄ","‚≠ê","üéØ","üß†","üêç","üåà","üéÆ"];
      const deck = emojis.concat(emojis).sort(()=>Math.random()-0.5);
      memFirst=null; memLock=false; memMatches=0;
      const grid=document.getElementById("memGrid");
      grid.innerHTML="";
      deck.forEach((emo, idx)=>{
        const btn=document.createElement("button");
        btn.className="slot";
        btn.style.height="54px";
        btn.dataset.emo=emo;
        btn.dataset.open="0";
        btn.textContent="‚ùì";
        btn.onclick=()=>{
          if(memLock) return;
          if(btn.dataset.open==="1") return;
          btn.textContent=emo;
          btn.dataset.open="1";
          if(!memFirst){ memFirst=btn; return; }
          if(memFirst.dataset.emo===btn.dataset.emo){
            memMatches++;
            memFirst=null;
            document.getElementById("memStatus").textContent = `‚úÖ Matched ${memMatches}/8 pairs`;
            if(memMatches===8){ document.getElementById("memStatus").textContent = "üèÜ All pairs found!"; }
          } else {
            memLock=true;
            setTimeout(()=>{
              btn.textContent="‚ùì"; btn.dataset.open="0";
              memFirst.textContent="‚ùì"; memFirst.dataset.open="0";
              memFirst=null;
              memLock=false;
            }, 650);
          }
        };
        grid.appendChild(btn);
      });
      document.getElementById("memStatus").textContent="Find all pairs.";
    }

    // =========================
    // Countdown + join enable (T-5min)
    // Hide countdown if ended
    // =========================
    let cdTimer=null;
    function startCountdown(classDT, tz){
      clearInterval(cdTimer);
      const joinBtn=document.getElementById("btnJoin");
      const cd=document.getElementById("countdown");
      const label=document.getElementById("timerLabel");
      function tick(){
        const now = new Date();
        const diff = classDT.getTime() - now.getTime();
        // ended if more than +60 min past start
        if(now.getTime() > classDT.getTime() + 60*60*1000){
          label.textContent = "Class status";
          cd.textContent = "Ended";
          joinBtn.disabled = true;
          return;
        }

        if(diff <= 0){
          label.textContent = "Class is live";
          cd.textContent = "Now";
          joinBtn.disabled = false;
          return;
        }

        const totalSec = Math.floor(diff/1000);
        const hh = Math.floor(totalSec/3600);
        const mm = Math.floor((totalSec%3600)/60);
        const ss = totalSec%60;
        cd.textContent = `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
        // enable join at T-5 minutes
        joinBtn.disabled = diff > 5*60*1000;
      }
      tick();
      cdTimer=setInterval(tick, 1000);
    }

    // =========================
    // Terms modal
    // =========================
    const termsModal = document.getElementById("termsModal");
    document.getElementById("openTerms").onclick = ()=> termsModal.classList.add("open");
    document.getElementById("closeTerms").onclick = ()=> termsModal.classList.remove("open");
    termsModal.addEventListener("click", (e)=>{ if(e.target===termsModal) termsModal.classList.remove("open"); });
    // =========================
    // Reschedule logic (Brightchamps-style drawer)
    // Updates: preferred_date, preferred_time_slot, timezone (optional)
    // and slot_id (optional) based on chosen slot
    // =========================
    const resDrawer = document.getElementById("resDrawer");
    document.getElementById("btnReschedule").onclick = ()=> openRes();
    document.getElementById("closeRes").onclick = ()=> closeRes();
    document.getElementById("cancelRes").onclick = ()=> closeRes();
    resDrawer.addEventListener("click", (e)=>{ if(e.target===resDrawer) closeRes(); });
    function openRes(){
      if(!BOOKING) return;
      resDrawer.classList.add("open");
      resDrawer.setAttribute("aria-hidden","false");
      // default selection
      buildResDates();
      fetchResSlots();
    }
    function closeRes(){
      resDrawer.classList.remove("open");
      resDrawer.setAttribute("aria-hidden","true");
      // reset active slot
      selectedResSlot = null;
      document.getElementById("confirmRes").disabled = true;
    }

    // timezone dropdown (like page 1 style, but simplified list)
    const TZ_OPTIONS = [
      {label:"India (IST) ‚Äî Asia/Kolkata", tz:"Asia/Kolkata"},
      {label:"UAE (GST) ‚Äî Asia/Dubai", tz:"Asia/Dubai"},
      {label:"Saudi Arabia ‚Äî Asia/Riyadh", tz:"Asia/Riyadh"},
      {label:"Singapore ‚Äî Asia/Singapore", tz:"Asia/Singapore"},
      {label:"Indonesia (Jakarta) ‚Äî Asia/Jakarta", tz:"Asia/Jakarta"},
      {label:"Philippines ‚Äî Asia/Manila", tz:"Asia/Manila"},
      {label:"Vietnam ‚Äî Asia/Ho_Chi_Minh", tz:"Asia/Ho_Chi_Minh"},
      {label:"Thailand ‚Äî Asia/Bangkok", tz:"Asia/Bangkok"},
      {label:"UK ‚Äî Europe/London", tz:"Europe/London"},
      {label:"Germany ‚Äî Europe/Berlin", tz:"Europe/Berlin"},
      {label:"USA (Eastern) ‚Äî America/New_York", tz:"America/New_York"},
      {label:"USA (Central) ‚Äî America/Chicago", tz:"America/Chicago"},
      {label:"USA (Pacific) ‚Äî America/Los_Angeles", tz:"America/Los_Angeles"},
      {label:"Australia ‚Äî Australia/Sydney", tz:"Australia/Sydney"},
      {label:"New Zealand ‚Äî Pacific/Auckland", tz:"Pacific/Auckland"},
    ];
    let resTZ = "Asia/Kolkata";
    let resDate = null; // YYYY-MM-DD (in IST date for DB fetch)
    let selectedResSlot = null;
    // {slot_id, display, localDate}

    function initRescheduleUI(){
      const sel = document.getElementById("tzSelect");
      sel.innerHTML="";
      TZ_OPTIONS.forEach(o=>{
        const op=document.createElement("option");
        op.value=o.tz;
        op.textContent=o.label;
        sel.appendChild(op);
      });
      resTZ = bookingTZ;
      // pick nearest option or set custom at top if not in list
      if(!TZ_OPTIONS.some(o=>o.tz===resTZ)){
        const op=document.createElement("option");
        op.value=resTZ;
        op.textContent=`Your timezone ‚Äî ${resTZ}`;
        sel.insertBefore(op, sel.firstChild);
      }
      sel.value = resTZ;
      sel.onchange = ()=>{
        resTZ = safeTZ(sel.value);
        fetchResSlots();
      };
    }

    function buildResDates(){
      const wrap=document.getElementById("resDates");
      wrap.innerHTML="";
      // Next 3 days including today, based on IST date for DB (same as your slot generation)
      const now = new Date();
      const todayISTKey = dateKeyInTZ(now, "Asia/Kolkata"); // DB dates are built in IST
      const [Y,M,D] = todayISTKey.split("-").map(n=>parseInt(n,10));
      const base = new Date(Date.UTC(Y,M-1,D,0,0,0));
      const dates=[];
      for(let i=0;i<3;i++){
        const d = new Date(base.getTime() + i*24*60*60*1000);
        const key = dateKeyInTZ(d, "Asia/Kolkata");
        dates.push(key);
      }
      resDate = dates[0];
      dates.forEach((key, idx)=>{
        const dt = new Date(key+"T00:00:00Z");
        const shown = new Intl.DateTimeFormat("en-US",{timeZone: resTZ, weekday:"short", month:"short", day:"numeric"}).format(dt);
        const pill=document.createElement("button");
        pill.className="pill"+(idx===0?" active":"");
        pill.textContent = (idx===0?"Today ‚Ä¢ ":"")+shown;
        pill.onclick=()=>{
          [...wrap.querySelectorAll(".pill")].forEach(p=>p.classList.remove("active"));
          pill.classList.add("active");
          resDate = key;
          fetchResSlots();
        };
        wrap.appendChild(pill);
      });
    }

    async function fetchResSlots(){
      const grid=document.getElementById("resSlots");
      const empty=document.getElementById("resEmpty");
      grid.innerHTML="";
      empty.classList.add("hide");
      selectedResSlot = null;
      document.getElementById("confirmRes").disabled = true;

      if(!BOOKING || !bookingRegion) { empty.classList.remove("hide"); empty.textContent="Missing region. Please contact support."; return;
      }
      if(!resDate) buildResDates();

      const { data, error } = await sb
        .from("demo_slots_live_view")
        .select("*")
        .eq("region_key", bookingRegion)
        .eq("course_id", BOOKING.course_id || courseId)
        .eq("slot_date", resDate);
      if(error){ console.error(error); empty.classList.remove("hide"); empty.textContent="Failed to load slots."; return; }
      if(!data || data.length===0){ empty.classList.remove("hide"); return;
      }

      // convert to local tz, apply SEA hide <7am;
      // also shift if local time <3am to next day (only for display grouping)
      const slots=[];
      data.forEach(r=>{
        const utc = new Date(r.slot_datetime_local);
        // convert by formatting in tz then re-parsing
        const localStr = utc.toLocaleString("en-US",{timeZone: resTZ});
        let local = new Date(localStr);

        // shift if local < 03:00
        if(local.getHours() < 3){
          local = new Date(local.getTime() + 24*60*60*1000);
        }

        // SEA hide < 7AM
        if(bookingRegion === "SEA" && local.getHours() < 7) return;

        const parts = new Intl.DateTimeFormat("en-US",{timeZone: resTZ, hour:"numeric", minute:"2-digit", hour12:true}).formatToParts(utc);
        const map = Object.fromEntries(parts.map(p=>[p.type,p.value]));
        const display = `${map.hour}:${map.minute} ${map.dayPeriod}`;
        slots.push({slot_id:r.slot_id, isStar:r.is_star_teacher, display, localInstant: utc});
      });
      // sort by local display using localInstant numeric in resTZ via formatted hour/min
      slots.sort((a,b)=>a.localInstant - b.localInstant);
      if(slots.length===0){ empty.classList.remove("hide"); return; }

      slots.forEach(s=>{
        const btn=document.createElement("button");
        btn.className="slot";
        btn.textContent = s.display;
        if(s.isStar){
          const tag=document.createElement("div");
          tag.className="star";
          tag.textContent="‚≠ê Star";
          btn.appendChild(tag);
        }
        btn.onclick=()=>{
          [...grid.querySelectorAll(".slot")].forEach(x=>x.classList.remove("active"));
          btn.classList.add("active");
          selectedResSlot = s;
          document.getElementById("confirmRes").disabled = false;
        };
        grid.appendChild(btn);
      });
    }

    document.getElementById("confirmRes").onclick = async ()=>{
      if(!BOOKING || !selectedResSlot) return;
      // We store preferred_date as DB date (IST date) and preferred_time_slot as display string
      // Additionally store timezone if user changed it.
      const upd = {
        preferred_date: resDate,
        preferred_time_slot: selectedResSlot.display,
        slot_id: selectedResSlot.slot_id,
        timezone: resTZ,
        updated_at: new Date().toISOString()
      };

      const { error } = await sb
        .from("demo_leads")
        .update(upd)
        .eq("id", iduuid);

      if(error){
        console.error(error);
        toast("Reschedule failed. Try again.");
        return;
      }

      toast("‚úÖ Rescheduled!");
      closeRes();

      // reload booking fresh
      document.getElementById("stateLoading").classList.remove("hide"); // kept for visual feedback on refresh
      const fresh = await loadBooking();
      document.getElementById("stateLoading").classList.add("hide");
      if(fresh) renderBooking(fresh);
    };

    // =========================
    // Boot
    // =========================
    (async function init(){
      const loading=document.getElementById("stateLoading");
      const err=document.getElementById("stateError");
      const section2=document.getElementById("section2");

      if(!iduuid){
        // loading.classList.add("hide"); // REMOVED to keep UI visible
        err.classList.remove("hide");
        err.textContent = "Missing iduuid in URL. Example: ?iduuid=<demo_leads.id>";
        return;
      }

      const b = await loadBooking();
      // loading.classList.add("hide"); // REMOVED - element no longer exists in same form

      if(!b){
        err.classList.remove("hide");
        return;
      }

      err.classList.add("hide");
      // section2.classList.remove("hide"); // REMOVED - UI is visible by default
      renderBooking(b);
    })();
  
// Email copy helper
function copyEmailToClipboard(el){
  const email = el.innerText || el.textContent;
  navigator.clipboard.writeText(email).then(()=>{
    let t=document.getElementById('copyToast');
    if(!t){
      t=document.createElement('div');
      t.id='copyToast'; t.className='copy-toast';
      t.innerText='Email copied';
      document.body.appendChild(t);
    }
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),1200);
  });
}


// Reschedule slot filtering
function filterRescheduleSlots(slots, tz){
  const now = new Date();
  const end = new Date(); end.setDate(end.getDate()+6);
  return slots.filter(s=>{
    const d = new Date(s.slot_datetime_local || s.slot_datetime_ist);
    if(d < now) return false;
    if(d > end) return false;
    return true;
  });
}

</script>
</body>
</html>
