<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Book Now & Get Certified ‚Äî Unischooly</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Compact CSS for three-step booking form ‚Äî aesthetic, responsive */
    :root{
      --bg:#061229;--card:#071028;--accent:#4f46e5;--muted:#9aa6bf;--text:#e6eef8;
      --pill:#0b1220;--radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#031022 0%,#021022 100%);color:var(--text);display:flex;align-items:center;justify-content:center;padding:28px}
    .container{width:100%;max-width:960px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:20px;padding:20px;border:1px solid rgba(255,255,255,0.04)}
    h1{margin:0;font-size:1.6rem}
    p.lead{color:var(--muted);margin:6px 0 16px}
    .steps{display:flex;gap:10px;margin-bottom:18px}
    .pill{background:var(--pill);padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);font-size:0.9rem;color:var(--muted)}
    .pill.active{background:linear-gradient(90deg,var(--accent),#2563eb);color:#fff;box-shadow:0 6px 18px rgba(79,70,229,0.2)}
    .card{background:var(--card);padding:18px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03)}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:760px){.grid{grid-template-columns:1fr}}
    label{font-size:0.86rem;color:var(--text);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);outline:none}
    .small{font-size:0.78rem;color:var(--muted)}
    .hint{font-size:0.78rem;color:var(--muted);margin-top:6px}
    .actions{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:14px;flex-wrap:wrap}
    .btn{padding:10px 16px;border-radius:999px;border:none;cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#2563eb);color:white;box-shadow:0 12px 32px rgba(37,99,235,0.15)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .error{color:#ff6b6b;font-size:0.86rem;margin-top:8px}
    /* Step 2 date chips */
    .days-row{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    .day-chip{min-width:120px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer;text-align:left}
    .day-chip.active{border-color:var(--accent);box-shadow:0 8px 18px rgba(79,70,229,0.08)}
    .slots{display:flex;flex-direction:column;gap:8px}
    .slot{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .slot.active{border:1px solid var(--accent);box-shadow:0 8px 18px rgba(79,70,229,0.08)}
    .lang-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .lang{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .lang.active{background:linear-gradient(90deg,var(--accent),#2563eb);color:#fff}
    .back-arrow{display:inline-flex;align-items:center;gap:8px;cursor:pointer;color:var(--muted);margin-bottom:10px}
    .muted-small{font-size:0.78rem;color:var(--muted)}
    .success{padding:16px;border-radius:12px;background:linear-gradient(90deg,#052426,#0b2b40);border:1px solid rgba(255,255,255,0.04)}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Book Now &amp; Get Certified</h1>
    <p class="lead">Share your details to unlock a personalised free trial class.</p>
    <div style="color:var(--muted);margin-bottom:12px">
      <div>Three quick steps ‚Äî this is a 3-page booking form</div>
      <div class="small" style="margin-top:6px">We‚Äôll ask your details, let you pick a slot, then personalise the trial.</div>
    </div>
    <div class="steps">
      <div class="pill active" id="pill-1">1. Details</div>
      <div class="pill" id="pill-2">2. Date &amp; Time</div>
      <div class="pill" id="pill-3">3. Personalise</div>
    </div>
  </header>

  <main class="card">
    <!-- STEP 1 -->
    <form id="form-step-1" autocomplete="on">
      <div class="grid">
        <div style="grid-column:1 / -1">
          <label>Country Code + Mobile Number <span style="color:#facc15">*</span></label>
          <div style="display:flex;gap:8px">
            <select id="phone-country-code" style="flex:0 0 110px">
              <option value="+91">üáÆüá≥ +91</option>
              <option value="+1">üá∫üá∏ +1</option>
              <option value="+44">üá¨üáß +44</option>
              <option value="+65">üá∏üá¨ +65</option>
              <option value="+60">üá≤üáæ +60</option>
              <option value="+62">üáÆüá© +62</option>
              <option value="+63">üáµüá≠ +63</option>
              <option value="+66">üáπüá≠ +66</option>
              <option value="+84">üáªüá≥ +84</option>
              <option value="+971">üá¶üá™ +971</option>
              <option value="+966">üá∏üá¶ +966</option>
            </select>
            <input type="tel" id="phone-number" placeholder="81234 56789" required style="flex:1" />
          </div>
          <div class="small" style="margin-top:6px;color:var(--muted)">Please share the number that you use for WhatsApp</div>
        </div>

        <div>
          <label>Child's Name <span style="color:#facc15">*</span></label>
          <input id="child-name" type="text" placeholder="Alex" required />
        </div>

        <div>
          <label>Select Child's Grade <span style="color:#facc15">*</span></label>
          <select id="child-grade" required>
            <option value="">Select grade</option>
            <script>for(let i=1;i<=12;i++){document.write(`<option value="${i}">Grade ${i}</option>`)};</script>
          </select>
        </div>

        <div>
          <label>Parent's Name <span style="color:#facc15">*</span></label>
          <input id="parent-name" type="text" placeholder="Parent full name" required />
        </div>

        <div>
          <label>Email ID <span style="color:#facc15">*</span></label>
          <input id="parent-email" type="email" placeholder="you@example.com" required />
        </div>

        <div style="grid-column:1 / -1">
          <label>Do you have a Laptop or Desktop? <span style="color:#facc15">*</span></label>
          <div style="display:flex;gap:8px">
            <button type="button" class="btn ghost" id="laptop-yes" aria-pressed="true">Yes</button>
            <button type="button" class="btn ghost" id="laptop-no" aria-pressed="false">No</button>
          </div>
        </div>
      </div>

      <div class="actions" style="margin-top:18px">
        <div class="muted-small">Step 1 of 3</div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <button class="btn primary" id="to-step-2" type="submit">Book a Free Trial Class ‚ú®</button>
          <div class="small" style="text-align:right;color:var(--muted)">Note: We will share the class link &amp; certificate on Email &amp; WhatsApp</div>
        </div>
      </div>
      <div class="error" id="error-1" style="display:none"></div>
    </form>

    <!-- STEP 2 -->
    <form id="form-step-2" class="hidden" style="margin-top:8px">
      <div class="back-arrow" id="back-to-1">&#8592; Back</div>
      <h2 style="margin:6px 0">Select Date &amp; Time</h2>
      <div class="muted-small">Select Date ‚Äî Your class will be for 1 hour</div>

      <div style="margin-top:12px">
        <div class="days-row" id="days-row"></div>
      </div>

      <div style="margin-top:10px">
        <div class="muted-small">Select Start Time ‚Äî Class slots are limited. Times are shown in your local time zone.</div>
        <div class="slots" id="slots-list" style="margin-top:8px">
          <div class="muted-small">Choose a date to load slots</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="muted-small">Select Language</div>
        <div class="lang-row" id="lang-row">
          <div class="lang active" data-lang="English">English</div>
          <div class="lang" data-lang="Arabic">Arabic</div>
          <div class="lang" data-lang="Bahasa">Bahasa</div>
          <div class="lang" data-lang="Vietnamese">Vietnamese</div>
          <div class="lang" data-lang="Filipino">Filipino</div>
          <div class="lang" data-lang="Thai">Thai</div>
        </div>
      </div>

      <div class="actions">
        <div style="display:flex;gap:8px">
          <button type="button" class="btn ghost" id="back-step-1">‚Üê Back</button>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end">
          <button class="btn primary" id="to-step-3" type="submit">Confirm Class Time ‚úÖ</button>
          <div class="small" style="text-align:right;color:var(--muted)">Note: Free class will be conducted by reputed teachers.<br><label style="font-size:12px"><input type="checkbox" id="consent-contact" checked/> By continuing I agree to be contacted by Unischooly via WhatsApp / Phone / Email for this booking.</label></div>
        </div>
      </div>
      <div class="error" id="error-2" style="display:none"></div>
    </form>

    <!-- STEP 3 -->
    <form id="form-step-3" class="hidden" style="margin-top:8px">
      <h2 style="margin:6px 0">Help us personalise your experience</h2>
      <div class="muted-small" style="margin-bottom:8px">Who are you?</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap" id="who-row">
        <button type="button" class="btn ghost" data-who="Parent">Parent</button>
        <button type="button" class="btn ghost" data-who="Student">Student</button>
        <button type="button" class="btn ghost" data-who="Guardian">Guardian</button>
      </div>

      <div style="margin-top:12px" class="muted-small">Why are you booking this trial class?</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px" id="reason-row">
        <button type="button" class="btn ghost" data-reason="Want to buy course">Want to buy course</button>
        <button type="button" class="btn ghost" data-reason="To Compare Platform">To Compare Platform</button>
        <button type="button" class="btn ghost" data-reason="To strengthen Concept">To strengthen Concept</button>
        <button type="button" class="btn ghost" data-reason="Just for free demo">Just for free demo</button>
      </div>

      <div style="margin-top:12px" class="muted-small">When are you planning to purchase?</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px" id="timeline-row">
        <button type="button" class="btn ghost" data-timeline="After the Demo">After the Demo</button>
        <button type="button" class="btn ghost" data-timeline="This Week">This Week</button>
        <button type="button" class="btn ghost" data-timeline="This Month">This Month</button>
        <button type="button" class="btn ghost" data-timeline="Just Exploring">Just Exploring</button>
      </div>

      <div class="actions" style="margin-top:14px">
        <div style="display:flex;gap:8px">
          <button type="button" class="btn ghost" id="back-step-2">‚Üê Back</button>
        </div>
        <div>
          <button type="submit" class="btn primary" id="submit-btn">Submit üöÄ</button>
        </div>
      </div>
      <div class="error" id="error-3" style="display:none"></div>
    </form>

    <section id="success-view" class="hidden" style="margin-top:12px">
      <div class="success">
        <h3>All set ‚Äî your trial is booked üéâ</h3>
        <div class="muted-small" id="success-summary"></div>
      </div>
    </section>
  </main>
</div>

<script>
  // --------- CONFIG: fill with your Supabase project values ----------
  const SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
  const INTERIM_REDIRECT_URL = "/interim"; // after success, redirect here
  // -----------------------------------------------------------------

  // CourseId from URL param (camelCase courseId)
  const COURSE_ID = Number(new URLSearchParams(window.location.search).get("courseId")) || 1;

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // state
  let leadId = null;
  let selectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
  let regionKey = null;
  let selectedSlot = null;
  let selectedLang = "English";
  let laptopYes = true;
  let clientMeta = {
    ip_address: null,
    browser: navigator.userAgent || null,
    device_type: /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) ? "mobile" : "desktop",
    internet_speed_mbps: null
  };

  try {
    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    if (conn && typeof conn.downlink === "number") clientMeta.internet_speed_mbps = conn.downlink;
  } catch(e){}

  // utils
  function qs(sel){return document.querySelector(sel)}
  function qsa(sel){return Array.from(document.querySelectorAll(sel))}

  // UI helpers
  function showStep(n){
    qs('#form-step-1').classList.toggle('hidden', n!==1);
    qs('#form-step-2').classList.toggle('hidden', n!==2);
    qs('#form-step-3').classList.toggle('hidden', n!==3);
    qs('#success-view').classList.add('hidden');
    qsa('.pill').forEach((p,i)=>p.classList.toggle('active', i+1===n));
  }

  // init country auto-detect (IPAPI)
  async function detectIP(){
    try{
      const r = await fetch('https://ipapi.co/json/');
      if(!r.ok) return;
      const d = await r.json();
      clientMeta.ip_address = d.ip || null;
      // find country mapping ‚Äî we'll set regionKey based on country code if present in select option
      const cc = d.country || d.country_code;
      if(cc){
        // try to pick a matching phone country code option
        const opt = Array.from(qs('#phone-country-code').options).find(o=>o.text.includes(cc) || o.value===('+'+d.country_calling_code));
        if(opt) qs('#phone-country-code').value = opt.value;
      }
    }catch(e){}
  }

  // init handlers
  document.addEventListener('DOMContentLoaded', ()=>{

    detectIP();

    // laptop toggle
    qs('#laptop-yes').addEventListener('click', ()=>{ laptopYes=true; qs('#laptop-yes').style.boxShadow='0 6px 18px rgba(79,70,229,0.12)'; qs('#laptop-no').style.boxShadow=''; });
    qs('#laptop-no').addEventListener('click', ()=>{ laptopYes=false; qs('#laptop-no').style.boxShadow='0 6px 18px rgba(79,70,229,0.12)'; qs('#laptop-yes').style.boxShadow=''; });

    // Step 1 submit
    qs('#form-step-1').addEventListener('submit', handleStep1);

    // navigation
    qs('#back-to-1').addEventListener('click', ()=>showStep(1));
    qs('#back-step-1').addEventListener('click', ()=>showStep(1));
    qs('#back-step-2').addEventListener('click', ()=>showStep(2));

    // languages
    qsa('.lang').forEach(el=>el.addEventListener('click', (e)=>{ qsa('.lang').forEach(x=>x.classList.remove('active')); el.classList.add('active'); selectedLang = el.dataset.lang; }));

    // who / reason / timeline selectors (radio-like)
    ['who-row','reason-row','timeline-row'].forEach(id=>{
      qsa('#'+id+' .btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{ qsa('#'+id+' .btn').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); });
      });
    });

    // Step 2 submit
    qs('#form-step-2').addEventListener('submit', handleStep2);

    // Step 3 submit
    qs('#form-step-3').addEventListener('submit', handleStep3);

    // initial UI
    showStep(1);
  });

  // ---------- Step 1 ----------
  async function handleStep1(e){
    e.preventDefault();
    qs('#error-1').style.display='none';

    const phone_country_code = qs('#phone-country-code').value;
    const phone_number = qs('#phone-number').value.trim();
    const child_name = qs('#child-name').value.trim();
    const child_grade = qs('#child-grade').value;
    const parent_name = qs('#parent-name').value.trim();
    const parent_email = qs('#parent-email').value.trim();

    // basic validation
    if(!phone_number||!child_name||!child_grade||!parent_name||!parent_email){
      qs('#error-1').textContent='Please fill all required fields.'; qs('#error-1').style.display='block'; return;
    }

    // payload aligned with schema
    const payload = {
      phone_country_code,
      phone_number,
      child_name,
      child_grade: String(child_grade),
      parent_name,
      parent_email,
      is_whatsapp: true,
      has_laptop: laptopYes ? 'yes' : 'no',
      course_id: COURSE_ID,
      landing_page_path: window.location.pathname,
      full_url: window.location.href,
      ip_address: clientMeta.ip_address,
      browser: clientMeta.browser,
      device_type: clientMeta.device_type,
      internet_speed_mbps: clientMeta.internet_speed_mbps,
      timezone: selectedTimezone,
      page_completed: 1
    };

    // try insert ‚Äî if unique phone exists, update instead
    try{
      // attempt insert
      let res = await supabase
        .from('demo_leads')
        .insert(payload)
        .select('id')
        .maybeSingle();

      if(res.error){
        // if unique constraint error, attempt to find existing by phone and update
        console.warn('Insert error', res.error);
        // try fetch existing
        const find = await supabase
          .from('demo_leads')
          .select('id')
          .eq('phone_country_code', phone_country_code)
          .eq('phone_number', phone_number)
          .maybeSingle();

        if(find.error){
          throw find.error;
        }
        if(find.data && find.data.id){
          leadId = find.data.id;
          const upd = await supabase
            .from('demo_leads')
            .update(payload)
            .eq('id', leadId);
          if(upd.error) throw upd.error;
        } else {
          throw res.error;
        }
      } else {
        // success insert
        leadId = res.data && res.data.id ? res.data.id : (res.data && res.data[0] && res.data[0].id) || null;
      }

      // proceed to step 2
      showStep(2);
      qs('#pill-2').classList.add('active');
      // load slots now
      await loadSlots();
    }catch(err){
      console.error('Step1 error',err);
      qs('#error-1').textContent = 'Could not save details. See console.'; qs('#error-1').style.display='block';
    }
  }

  // ---------- Slot loading ----------
  // We'll query demo_slots_live_view where region_key = regionKey (if set) AND course_id = COURSE_ID
  // and slot_date between today and +5 days.
  async function loadSlots(){
    const daysRow = qs('#days-row');
    const slotsList = qs('#slots-list');
    daysRow.innerHTML='Loading...';
    slotsList.innerHTML='';

    // compute IST date strings for today..+5 using Asia/Kolkata
    const dates = []; for(let i=0;i<6;i++){
      const now = new Date(); now.setDate(now.getDate()+i);
      // get IST date components
      const parts = new Intl.DateTimeFormat('en-CA',{timeZone:'Asia/Kolkata',year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now);
      const yyyy = parts.find(p=>p.type==='year').value;
      const mm = parts.find(p=>p.type==='month').value;
      const dd = parts.find(p=>p.type==='day').value;
      dates.push({iso:`${yyyy}-${mm}-${dd}`, js: new Date(`${yyyy}-${mm}-${dd}T00:00:00+05:30`)});
    }

    daysRow.innerHTML='';
    dates.forEach((d,idx)=>{
      const btn = document.createElement('button');
      btn.type='button';
      btn.className='day-chip';
      btn.dataset.iso = d.iso;
      btn.innerHTML = `<div style="font-weight:600">${d.js.toLocaleDateString(undefined,{weekday:'short'})}</div><div style="font-size:13px">${d.js.toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div>`;
      btn.addEventListener('click', ()=>{ qsa('.day-chip').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); loadSlotsForDate(d.iso); });
      daysRow.appendChild(btn);
    });

    // initial select today automatically
    if(daysRow.firstChild) daysRow.firstChild.click();
  }

  async function loadSlotsForDate(dateIso){
    const slotsList = qs('#slots-list');
    slotsList.innerHTML='Loading slots...';

    try{
      const from = dateIso; const to = dateIso;
      const { data, error } = await supabase
        .from('demo_slots_live_view')
        .select('*')
        .eq('course_id', COURSE_ID)
        .gte('slot_date', from)
        .lte('slot_date', to)
        .gt('capacity_remaining', 0);

      if(error) throw error;
      const slots = (data || []).slice().sort((a,b)=> new Date(a.slot_datetime_local || a.slot_datetime_ist) - new Date(b.slot_datetime_local || b.slot_datetime_ist));
      if(!slots.length){
        slotsList.innerHTML = '<div class="muted-small">No slots available for this date</div>';
        return;
      }

      slotsList.innerHTML='';
      slots.forEach(s=>{
        const localIso = s.slot_datetime_local || s.slot_datetime_ist;
        const localLabel = new Date(localIso).toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit',hour12:true, timeZone: selectedTimezone});
        const row = document.createElement('div');
        row.className='slot';
        row.dataset.slotId = s.slot_id || s.id;
        row.innerHTML = `<div><div style="font-weight:600">${localLabel}</div><div class="small">Local time ¬∑ ${selectedTimezone}</div></div>` + (s.is_star_teacher?`<div style="font-size:12px;color:#facc15">‚òÖ Star Teacher</div>`:'');
        row.addEventListener('click', ()=>{
          qsa('.slot').forEach(x=>x.classList.remove('active'));
          row.classList.add('active');
          selectedSlot = {
            slot_id: row.dataset.slotId,
            slot_date: s.slot_date,
            local_label: localLabel,
            is_star_teacher: !!s.is_star_teacher
          };
        });
        slotsList.appendChild(row);
      });
    }catch(err){
      console.error('Load slots error',err);
      slotsList.innerHTML = '<div class="muted-small">Could not load slots. See console.</div>';
    }
  }

  // ---------- Step 2 ----------
  async function handleStep2(e){
    e.preventDefault();
    qs('#error-2').style.display='none';
    if(!selectedSlot){
      qs('#error-2').textContent='Please select a slot.'; qs('#error-2').style.display='block'; return;
    }
    if(!qs('#consent-contact').checked){
      qs('#error-2').textContent='Please consent to be contacted to proceed.'; qs('#error-2').style.display='block'; return;
    }

    // Save preferred slot and language to lead
    const payload = {
      preferred_date: selectedSlot.slot_date,
      preferred_time_slot: selectedSlot.local_label,
      slot_id: selectedSlot.slot_id,
      lang: selectedLang,
      star_teacher_selected: selectedSlot.is_star_teacher ? true : false,
      page_completed: 2
    };

    try{
      let res;
      if(leadId){
        res = await supabase.from('demo_leads').update(payload).eq('id',leadId);
      } else {
        // fallback: create partial lead (shouldn't normally happen)
        res = await supabase.from('demo_leads').insert({...payload, course_id: COURSE_ID}).select('id').maybeSingle();
        if(res.error) throw res.error;
        leadId = res.data && res.data.id ? res.data.id : leadId;
      }
      if(res.error) throw res.error;
      showStep(3);
    }catch(err){
      console.error('Step2 save error',err);
      qs('#error-2').textContent='Could not save slot. See console.'; qs('#error-2').style.display='block';
    }
  }

  // ---------- Step 3 ----------
  async function handleStep3(e){
    e.preventDefault();
    qs('#error-3').style.display='none';

    const who = qsa('#who-row .btn.active')[0]?.dataset.who || null;
    const reason = qsa('#reason-row .btn.active')[0]?.dataset.reason || null;
    const timeline = qsa('#timeline-row .btn.active')[0]?.dataset.timeline || null;

    if(!who||!reason||!timeline){ qs('#error-3').textContent='Please choose all options.'; qs('#error-3').style.display='block'; return; }

    const payload = {
      who_are_you: who,
      booking_reason: reason,
      purchase_timeline: timeline,
      page_completed: 3
    };

    try{
      let res;
      if(leadId){
        res = await supabase.from('demo_leads').update(payload).eq('id', leadId);
      } else {
        res = await supabase.from('demo_leads').insert({...payload, course_id: COURSE_ID}).select('id').maybeSingle();
        if(res.error) throw res.error;
        leadId = res.data && res.data.id ? res.data.id : leadId;
      }
      if(res.error) throw res.error;

      // show success summary and redirect to interim
      const summ = qs('#success-summary');
      summ.textContent = `Time: ${selectedSlot ? selectedSlot.local_label + ' on ' + selectedSlot.slot_date : 'Booked'} ¬∑ Parent: ${qs('#parent-name').value} ¬∑ Email: ${qs('#parent-email').value}`;
      showStep(4);
      qs('#success-view').classList.remove('hidden');

      // small delay then redirect
      setTimeout(()=>{ window.location.href = INTERIM_REDIRECT_URL; }, 1200);
    }catch(err){
      console.error('Step3 save error',err);
      qs('#error-3').textContent='Could not submit booking. See console.'; qs('#error-3').style.display='block';
    }
  }

</script>
</body>
</html>
