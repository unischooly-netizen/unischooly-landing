
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unischooly | Book Trial Class</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #7b3ffc;
      --primary-dark: #5b2ec0;
      --primary-light: #e8ddff;
      --accent: #ff7b5f;
      --bg: #050816;
      --bg-alt: #0b1020;
      --text: #f5f5ff;
      --muted: #a0a4c0;
      --border: #262a40;
      --error: #ff4b4b;
      --success: #28c76f;
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.45);
      --transition-fast: 0.18s ease-out;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1b1538 0, #050816 55%);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 12px;
    }

    .booking-shell {
      width: 100%;
      max-width: 980px;
      background: linear-gradient(135deg, #0b1020 0, #050816 50%, #120c2b 100%);
      border-radius: 26px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: var(--shadow-soft);
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    @media (min-width: 900px) {
      .booking-shell {
        padding: 32px 32px 28px;
      }
    }

    .booking-shell::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(124, 77, 255, 0.24), transparent 52%),
        radial-gradient(circle at 100% 0%, rgba(255, 121, 76, 0.18), transparent 52%);
      opacity: 0.8;
      pointer-events: none;
      z-index: -1;
    }

    .booking-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 18px;
    }

    .booking-kicker {
      font-size: 13px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .booking-kicker-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fff, #52ff9c);
      box-shadow: 0 0 12px rgba(82, 255, 156, 0.9);
    }

    .booking-title-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: baseline;
      justify-content: space-between;
    }

    .booking-title {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    @media (min-width: 768px) {
      .booking-title {
        font-size: 28px;
      }
    }

    .booking-title-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.2), transparent 60%);
    }

    .booking-subtitle {
      font-size: 14px;
      color: var(--muted);
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .pill-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(5, 8, 22, 0.85);
      color: var(--muted);
    }

    .pill-badge strong {
      color: #fefefe;
      font-weight: 600;
    }

    .pill-icon {
      font-size: 13px;
    }

    .booking-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.1fr);
      gap: 20px;
      margin-top: 18px;
    }

    @media (max-width: 900px) {
      .booking-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .form-panel {
      background: rgba(5, 8, 22, 0.96);
      border-radius: 22px;
      padding: 18px 16px 18px;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    @media (min-width: 900px) {
      .form-panel {
        padding: 20px 22px 20px;
      }
    }

    .form-panel::before {
      content: "";
      position: absolute;
      inset: -50%;
      opacity: 0.35;
      background:
        radial-gradient(circle at 0 0, rgba(124, 77, 255, 0.5), transparent 65%),
        radial-gradient(circle at 100% 100%, rgba(255, 129, 71, 0.4), transparent 65%);
      pointer-events: none;
    }

    .form-panel-inner {
      position: relative;
      z-index: 1;
    }

    .side-panel {
      background: radial-gradient(circle at 0% 0%, #1c1036 0, #050816 55%);
      border-radius: 22px;
      padding: 18px 16px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      flex-direction: column;
      gap: 14px;
      position: relative;
      overflow: hidden;
    }

    @media (min-width: 900px) {
      .side-panel {
        padding: 22px 18px;
      }
    }

    .side-panel::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0 0, rgba(124, 77, 255, 0.3), transparent 60%),
        radial-gradient(circle at 100% 0, rgba(255, 121, 76, 0.15), transparent 60%);
      opacity: 0.85;
      pointer-events: none;
    }

    .side-panel-inner {
      position: relative;
      z-index: 1;
    }

    .stepper {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .step-pill {
      flex: 1;
      min-width: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(10, 14, 32, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 12px;
      color: var(--muted);
      transition: background var(--transition-fast), border-color var(--transition-fast),
        color var(--transition-fast), box-shadow var(--transition-fast);
      cursor: default;
    }

    .step-pill.active {
      background: linear-gradient(135deg, #7b3ffc, #ff7b5f);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.18),
        0 12px 24px rgba(123, 63, 252, 0.6);
    }

    .step-pill.completed {
      border-color: rgba(88, 199, 160, 0.85);
      color: #e6fff5;
    }

    .step-index {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.06);
    }

    .step-pill.active .step-index {
      background: rgba(5, 5, 26, 0.9);
    }

    .step-label-main {
      font-weight: 600;
    }

    .step-label-sub {
      font-size: 11px;
      opacity: 0.85;
    }

    .step-progress-bar {
      width: 100%;
      height: 3px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      overflow: hidden;
      margin-bottom: 10px;
    }

    .step-progress-fill {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #7b3ffc, #ff7b5f);
      transition: width 0.22s ease-out;
    }

    .step-view {
      display: none;
      animation: fadeIn 0.25s ease-out;
    }

    .step-view.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .field-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 720px) {
      .field-grid.two-col {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field-label-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 6px;
    }

    .field label {
      font-size: 13px;
      color: #dadbf7;
      font-weight: 500;
    }

    .field-hint {
      font-size: 11px;
      color: var(--muted);
    }

    .required-dot {
      color: #ff9f7a;
      margin-left: 2px;
    }

    .input,
    .select,
    .textarea {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: linear-gradient(135deg, rgba(8, 12, 30, 0.85), rgba(6, 10, 24, 0.85));
      color: var(--text);
      padding: 9px 10px;
      font-size: 14px;
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast),
        background var(--transition-fast), transform 0.08s ease-out;
    }

    .input::placeholder {
      color: rgba(160, 164, 192, 0.9);
    }

    .select {
      padding-right: 34px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: linear-gradient(135deg, rgba(8, 12, 30, 0.85), rgba(6, 10, 24, 0.85)),
        linear-gradient(45deg, transparent 50%, rgba(255, 255, 255, 0.8) 50%),
        linear-gradient(135deg, rgba(255, 255, 255, 0.8) 50%, transparent 50%);
      background-repeat: no-repeat, no-repeat, no-repeat;
      background-position: 0 0, calc(100% - 18px) 50%, calc(100% - 12px) 50%;
      background-size: 100% 100%, 6px 6px, 6px 6px;
    }

    .input:focus,
    .select:focus,
    .textarea:focus {
      border-color: rgba(142, 120, 255, 0.9);
      box-shadow: 0 0 0 1px rgba(142, 120, 255, 0.4);
      transform: translateY(-0.5px);
      background: radial-gradient(circle at 0 0, rgba(142, 120, 255, 0.18), transparent 55%),
        linear-gradient(135deg, rgba(8, 12, 30, 0.9), rgba(6, 10, 24, 0.9));
    }

    .radio-chip-group,
    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .radio-chip {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 7px 11px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(5, 9, 26, 0.85);
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      transition: border-color var(--transition-fast), background var(--transition-fast),
        color var(--transition-fast), box-shadow var(--transition-fast), transform 0.09s ease-out;
    }

    .radio-chip:hover {
      border-color: rgba(167, 139, 250, 0.9);
      transform: translateY(-0.5px);
    }

    .radio-chip input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .radio-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .radio-dot-inner {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: transparent;
      transition: background var(--transition-fast);
    }

    .radio-chip.selected {
      border-color: rgba(132, 180, 255, 0.95);
      background: radial-gradient(circle at 0 0, rgba(132, 180, 255, 0.3), transparent 60%),
        rgba(9, 11, 36, 0.96);
      color: #fefefe;
      box-shadow: 0 10px 24px rgba(9, 20, 70, 0.75);
    }

    .radio-chip.selected .radio-dot-inner {
      background: linear-gradient(135deg, #7b3ffc, #ff7b5f);
    }

    .toggle-row {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 2px;
    }

    .toggle-label {
      font-size: 13px;
      color: var(--muted);
    }

    .toggle-switch {
      position: relative;
      width: 36px;
      height: 20px;
      border-radius: 999px;
      background: rgba(15, 18, 40, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.32);
      cursor: pointer;
      transition: background var(--transition-fast), border-color var(--transition-fast);
      flex-shrink: 0;
    }

    .toggle-thumb {
      position: absolute;
      top: 1px;
      left: 1px;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: #fefefe;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.55);
      transition: transform var(--transition-fast);
    }

    .toggle-input {
      display: none;
    }

    .toggle-input:checked + .toggle-switch {
      background: linear-gradient(135deg, #7b3ffc, #ff7b5f);
      border-color: transparent;
    }

    .toggle-input:checked + .toggle-switch .toggle-thumb {
      transform: translateX(14px);
    }

    .button-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      padding: 9px 18px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out,
        background 0.18s ease-out, opacity 0.12s ease-out;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #7b3ffc, #ff7b5f);
      color: #fff;
      box-shadow: 0 12px 24px rgba(123, 63, 252, 0.7);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 26px rgba(123, 63, 252, 0.75);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(123, 63, 252, 0.6);
    }

    .btn-secondary {
      background: rgba(11, 15, 36, 0.96);
      color: var(--muted);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .btn-secondary:hover {
      background: rgba(18, 22, 48, 0.96);
      color: #f3f3ff;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn-icon {
      font-size: 16px;
    }

    .error-text {
      color: var(--error);
      font-size: 12px;
      margin-top: 4px;
    }

    .global-error {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 107, 107, 0.4);
      background: rgba(63, 11, 11, 0.82);
      font-size: 12px;
      color: #ffe4e4;
      display: none;
    }

    .global-error.visible {
      display: block;
    }

    .global-success {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(40, 199, 111, 0.6);
      background: rgba(8, 51, 38, 0.86);
      font-size: 13px;
      color: #e3fff1;
      display: none;
    }

    .global-success.visible {
      display: block;
    }

    .slot-dates-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 6px;
    }

    .slot-date-pill {
      min-width: 100px;
      padding: 7px 10px;
      border-radius: 13px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(6, 10, 28, 0.95);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
      color: var(--muted);
      transition: border-color var(--transition-fast), background var(--transition-fast),
        transform 0.1s ease-out, box-shadow 0.15s ease-out;
    }

    .slot-date-pill:hover {
      border-color: rgba(143, 170, 255, 0.95);
      transform: translateY(-0.5px);
    }

    .slot-date-pill.active {
      border-color: rgba(132, 180, 255, 0.98);
      background: radial-gradient(circle at 0 0, rgba(132, 180, 255, 0.32), transparent 60%),
        rgba(9, 11, 36, 0.96);
      color: #fefefe;
      box-shadow: 0 12px 26px rgba(9, 20, 70, 0.9);
    }

    .slot-date-main {
      font-size: 13px;
      font-weight: 600;
    }

    .slot-date-sub {
      font-size: 11px;
      opacity: 0.85;
    }

    .slot-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    @media (min-width: 640px) {
      .slot-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .slot-chip {
      padding: 7px 9px;
      border-radius: 11px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(6, 8, 28, 0.96);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      color: var(--muted);
      transition: border-color var(--transition-fast), background var(--transition-fast),
        transform 0.1s ease-out, box-shadow 0.15s ease-out;
    }

    .slot-chip:hover {
      border-color: rgba(163, 141, 252, 0.95);
      transform: translateY(-0.5px);
    }

    .slot-chip.selected {
      border-color: rgba(132, 180, 255, 0.98);
      background: radial-gradient(circle at 0 0, rgba(132, 180, 255, 0.3), transparent 60%),
        rgba(9, 11, 36, 0.98);
      color: #fefefe;
      box-shadow: 0 10px 24px rgba(9, 20, 70, 0.9);
    }

    .slot-time-main {
      font-weight: 600;
      font-size: 12px;
    }

    .slot-time-sub {
      font-size: 10px;
      opacity: 0.86;
    }

    .slot-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(255, 217, 119, 0.05);
      border: 1px solid rgba(255, 217, 119, 0.7);
      color: #ffe9a6;
      white-space: nowrap;
    }

    .slot-empty {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    .lang-select-row {
      margin-top: 12px;
    }

    .side-highlight-card {
      border-radius: 18px;
      background: rgba(8, 11, 32, 0.96);
      padding: 12px 11px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .side-highlight-icon {
      width: 26px;
      height: 26px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.8), rgba(123, 63, 252, 0.8));
      color: #050816;
      font-size: 16px;
      flex-shrink: 0;
    }

    .side-highlight-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .side-highlight-text {
      font-size: 12px;
      color: var(--muted);
    }

    .side-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    .side-pill {
      border-radius: 14px;
      padding: 7px 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(5, 9, 26, 0.98);
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .side-pill strong {
      color: #f1f0ff;
    }

    .side-pill span {
      font-size: 10px;
      opacity: 0.86;
    }

    .side-footer-text {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .pill-inline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(5, 9, 26, 0.96);
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .pill-inline strong {
      color: #f3f3ff;
    }

    .success-check {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #ffffff, #28c76f);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #050816;
      font-size: 24px;
      margin-bottom: 6px;
      box-shadow: 0 14px 32px rgba(40, 199, 111, 0.9);
    }

    .success-heading {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .success-sub {
      font-size: 13px;
      color: var(--muted);
    }

    .success-highlight {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      border: 1px dashed rgba(40, 199, 111, 0.7);
      font-size: 12px;
      color: #d9fff0;
      background: rgba(7, 55, 38, 0.9);
    }

    .speed-meter {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px dashed rgba(255, 255, 255, 0.12);
      font-size: 11px;
      color: var(--muted);
      background: rgba(5, 9, 26, 0.96);
    }

    .speed-meter strong {
      color: #fdfdff;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="booking-shell">
    <header class="booking-header">
      <div class="booking-kicker">
        <span class="booking-kicker-dot"></span>
        LIVE 1:1 TRIAL ¬∑ 45 MIN ¬∑ CERTIFICATE INCLUDED
      </div>
      <div class="booking-title-row">
        <div>
          <div class="booking-title">
            Book a Free Live Coding Class
            <span class="booking-title-badge">Limited slots for this week ‚ö°</span>
          </div>
          <div class="booking-subtitle">
            3 quick steps &mdash; lock in your child‚Äôs ideal time with a world‚Äëclass instructor.
          </div>
        </div>
        <div class="badge-row">
          <div class="pill-badge">
            <span class="pill-icon">üåé</span>
            <span><strong>Kids in 30+ countries</strong></span>
          </div>
          <div class="pill-badge">
            <span class="pill-icon">üöÄ</span>
            <span><strong>Hands‚Äëon project demo</strong></span>
          </div>
        </div>
      </div>
    </header>

    <div class="booking-layout">
      <main class="form-panel">
        <div class="form-panel-inner">
          <div class="stepper">
            <div class="step-pill" data-step-pill="1">
              <div class="step-index">1</div>
              <div>
                <div class="step-label-main">Details</div>
                <div class="step-label-sub">Child &amp; parent</div>
              </div>
            </div>
            <div class="step-pill" data-step-pill="2">
              <div class="step-index">2</div>
              <div>
                <div class="step-label-main">Date &amp; Time</div>
                <div class="step-label-sub">Your local timezone</div>
              </div>
            </div>
            <div class="step-pill" data-step-pill="3">
              <div class="step-index">3</div>
              <div>
                <div class="step-label-main">Goals</div>
                <div class="step-label-sub">Help us personalise</div>
              </div>
            </div>
          </div>

          <div class="step-progress-bar">
            <div class="step-progress-fill" id="stepProgress"></div>
          </div>

          <div id="globalError" class="global-error"></div>
          <div id="globalSuccess" class="global-success"></div>

          <section class="step-view active" id="step-1">
            <div class="field-grid two-col">
              <div class="field">
                <div class="field-label-row">
                  <label for="countrySelect">Country &amp; Timezone<span class="required-dot">*</span></label>
                  <span class="field-hint">Automatically detected &mdash; you can change.</span>
                </div>
                <select id="countrySelect" class="select">
                  <option value="">Detecting your country...</option>
                </select>
              </div>

              <div class="field">
                <div class="field-label-row">
                  <label for="phoneInput">Parent WhatsApp Number<span class="required-dot">*</span></label>
                  <span class="field-hint">We‚Äôll share the class link here.</span>
                </div>
                <input id="phoneInput" type="tel" class="input" placeholder="Enter phone number" />
              </div>
            </div>

            <div class="field-grid two-col" style="margin-top: 10px;">
              <div class="field">
                <div class="field-label-row">
                  <label for="childName">Child‚Äôs Name<span class="required-dot">*</span></label>
                </div>
                <input id="childName" type="text" class="input" placeholder="E.g., Aanya Gupta" />
              </div>
              <div class="field">
                <div class="field-label-row">
                  <label for="childGrade">Child‚Äôs Grade<span class="required-dot">*</span></label>
                </div>
                <select id="childGrade" class="select">
                  <option value="">Select grade</option>
                  <option value="1">Grade 1</option>
                  <option value="2">Grade 2</option>
                  <option value="3">Grade 3</option>
                  <option value="4">Grade 4</option>
                  <option value="5">Grade 5</option>
                  <option value="6">Grade 6</option>
                  <option value="7">Grade 7</option>
                  <option value="8">Grade 8</option>
                  <option value="9">Grade 9</option>
                  <option value="10">Grade 10</option>
                  <option value="11">Grade 11</option>
                  <option value="12">Grade 12</option>
                </select>
              </div>
            </div>

            <div class="field-grid two-col" style="margin-top: 10px;">
              <div class="field">
                <div class="field-label-row">
                  <label for="parentName">Parent / Guardian Name<span class="required-dot">*</span></label>
                </div>
                <input id="parentName" type="text" class="input" placeholder="Your full name" />
              </div>
              <div class="field">
                <div class="field-label-row">
                  <label for="parentEmail">Email ID<span class="required-dot">*</span></label>
                </div>
                <input id="parentEmail" type="email" class="input" placeholder="name@email.com" />
              </div>
            </div>

            <div class="field-grid" style="margin-top: 10px;">
              <div class="field">
                <div class="field-label-row">
                  <label>Do you have a laptop or desktop for the class?<span class="required-dot">*</span></label>
                </div>
                <div class="radio-chip-group" id="laptopGroup">
                  <label class="radio-chip" data-laptop="yes">
                    <input type="radio" name="hasLaptop" value="yes" />
                    <span class="radio-dot"><span class="radio-dot-inner"></span></span>
                    Yes, available
                  </label>
                  <label class="radio-chip" data-laptop="no">
                    <input type="radio" name="hasLaptop" value="no" />
                    <span class="radio-dot"><span class="radio-dot-inner"></span></span>
                    No, only mobile / tablet
                  </label>
                </div>
              </div>

              <div class="field">
                <div class="field-label-row">
                  <label>WhatsApp updates?</label>
                </div>
                <div class="toggle-row">
                  <input id="isWhatsapp" class="toggle-input" type="checkbox" checked />
                  <label for="isWhatsapp" class="toggle-switch">
                    <span class="toggle-thumb"></span>
                  </label>
                  <span class="toggle-label">Yes, send class reminders &amp; updates on WhatsApp.</span>
                </div>
              </div>
            </div>

            <div class="button-row">
              <button id="step1Next" class="btn btn-primary">
                Continue to Date &amp; Time
                <span class="btn-icon">‚Üí</span>
              </button>
            </div>
          </section>

          <section class="step-view" id="step-2">
            <div class="field">
              <div class="field-label-row">
                <label>Select a date in your local time<span class="required-dot">*</span></label>
                <span class="field-hint">We automatically handle time conversion for you.</span>
              </div>
              <div id="slotDatesRow" class="slot-dates-row"></div>
            </div>

            <div class="field">
              <div class="field-label-row">
                <label>Available time slots</label>
              </div>
              <div id="slotGrid" class="slot-grid"></div>
              <div id="slotEmpty" class="slot-empty hidden">
                No slots left for this day. Please pick another date.
              </div>
            </div>

            <div class="field lang-select-row">
              <div class="field-label-row">
                <label for="languageSelect">Preferred language for the trial<span class="required-dot">*</span></label>
              </div>
              <select id="languageSelect" class="select">
                <option value="english">English</option>
                <option value="arabic">Arabic</option>
                <option value="bahasa">Bahasa</option>
                <option value="vietnamese">Vietnamese</option>
                <option value="filipino">Filipino</option>
                <option value="thai">Thai</option>
              </select>
            </div>

            <div class="button-row">
              <button id="step2Back" class="btn btn-secondary">
                <span class="btn-icon">‚Üê</span>
                Back
              </button>
              <button id="step2Next" class="btn btn-primary">
                Continue to Final Step
                <span class="btn-icon">‚Üí</span>
              </button>
            </div>
          </section>

          <section class="step-view" id="step-3">
            <div class="field">
              <div class="field-label-row">
                <label>Who are you booking this for?<span class="required-dot">*</span></label>
              </div>
              <div id="whoGroup" class="radio-chip-group">
                <label class="radio-chip" data-who="Parent">
                  <input type="radio" name="whoAreYou" value="Parent" />
                  <span class="radio-dot"><span class="radio-dot-inner"></span></span>
                  I‚Äôm the parent
                </label>
                <label class="radio-chip" data-who="Student">
                  <input type="radio" name="whoAreYou" value="Student" />
                  <span class="radio-dot"><span class="radio-dot-inner"></span></span>
                  I‚Äôm the student
                </label>
                <label class="radio-chip" data-who="Guardian">
                  <input type="radio" name="whoAreYou" value="Guardian" />
                  <span class="radio-dot"><span class="radio-dot-inner"></span></span>
                  I‚Äôm a guardian
                </label>
              </div>
            </div>

            <div class="field" style="margin-top: 12px;">
              <div class="field-label-row">
                <label>Why are you booking this trial?<span class="required-dot">*</span></label>
              </div>
              <div id="reasonGroup" class="radio-chip-group">
                <label class="radio-chip" data-reason="Explore coding basics">
                  <input type="radio" name="bookingReason" value="Explore coding basics" />
                  <span class="radio-dot"><span class="radio-dot-inner"></span></span>
                  Explore coding basics
                </label>
                <label class="radio-chip" data-reason="Upgrade existing skills">
                  <input type="radio" name="bookingReason" value="Upgrade existing skills" />
                  <span class="radio-dot"><span class="radio-dot-inner"></span></span>
                  Upgrade existing skills
                </label>
                <label class="radio-chip" data-reason="School / competition support ">
                  <input type="radio" name="bookingReason" value="School / competition support " />
                  <span class="radio-dot"><span class="radio-dot-inner"></span></span>
                  School / competition support
                </label>
                <label class="radio-chip" data-reason="Just exploring options">
                  <input type="radio" name="bookingReason" value="Just exploring options" />
                  <span class="radio-dot"><span class="radio-dot-inner"></span></span>
                  Just exploring options
                </label>
              </div>
            </div>

            <div class="field" style="margin-top: 12px;">
              <div class="field-label-row">
                <label>When do you plan to enroll if your child likes the class?<span class="required-dot">*</span></label>
              </div>
              <div id="timelineGroup" class="radio-chip-group">
                <label class="radio-chip" data-timeline="Immediately after trial">
                  <input type="radio" name="purchaseTimeline" value="Immediately after trial" />
                  <span class="radio-dot"><span class="radio-dot-inner"></span></span>
                  Immediately after trial
                </label>
                <label class="radio-chip" data-timeline="Within this month">
                  <input type="radio" name="purchaseTimeline" value="Within this month" />
                  <span class="radio-dot"><span class="radio-dot-inner"></span></span>
                  Within this month
                </label>
                <label class="radio-chip" data-timeline="In 1‚Äì3 months">
                  <input type="radio" name="purchaseTimeline" value="In 1‚Äì3 months" />
                  <span class="radio-dot"><span class="radio-dot-inner"></span></span>
                  In 1‚Äì3 months
                </label>
                <label class="radio-chip" data-timeline="Not sure yet">
                  <input type="radio" name="purchaseTimeline" value="Not sure yet" />
                  <span class="radio-dot"><span class="radio-dot-inner"></span></span>
                  Not sure yet
                </label>
              </div>
            </div>

            <div class="button-row">
              <button id="step3Back" class="btn btn-secondary">
                <span class="btn-icon">‚Üê</span>
                Back
              </button>
              <button id="step3Submit" class="btn btn-primary">
                Confirm Booking
                <span class="btn-icon">‚úÖ</span>
              </button>
            </div>
          </section>

          <section class="step-view" id="step-4-success">
            <div style="text-align: left; margin-top: 6px;">
              <div class="success-check">‚úì</div>
              <div class="success-heading">Your trial class is locked in!</div>
              <div class="success-sub">
                We‚Äôve emailed and WhatsApped your session details. Our team may contact you
                if we need to fine‚Äëtune your slot.
              </div>
              <div class="success-highlight" id="successSlotSummary">
                Thank you for booking with Unischooly. We‚Äôre setting up the perfect live coding
                experience for your child. üöÄ
              </div>
            </div>
          </section>
        </div>
      </main>

      <aside class="side-panel">
        <div class="side-panel-inner">
          <div class="side-highlight-card">
            <div class="side-highlight-icon">üéì</div>
            <div>
              <div class="side-highlight-title">What happens in the trial?</div>
              <div class="side-highlight-text">
                A live, 1:1 hands‚Äëon project with a top instructor, followed by a short parent
                counselling to help you design a perfect learning path.
              </div>
            </div>
          </div>

          <div class="side-grid">
            <div class="side-pill">
              <strong>100% Live &amp; Interactive</strong>
              <span>Not recorded. Your child codes in real‚Äëtime with the teacher.</span>
            </div>
            <div class="side-pill">
              <strong>Beginner Friendly</strong>
              <span>No prior experience needed. Just curiosity &amp; enthusiasm.</span>
            </div>
            <div class="side-pill">
              <strong>Parent Counselling</strong>
              <span>Understand your child‚Äôs readiness &amp; next steps.</span>
            </div>
            <div class="side-pill">
              <strong>Certificate Included</strong>
              <span>Personalised digital certificate post class.</span>
            </div>
          </div>

          <div class="side-footer-text">
            <div class="pill-inline">
              <span>‚è±</span>
              <span>
                <strong>Average booking time:</strong>
                under 90 seconds
              </span>
            </div>
            <br />
            You‚Äôre in control &mdash; pick a day and time that perfectly fits your family‚Äôs schedule.
          </div>

          <div id="speedMeter" class="speed-meter">
            <strong>Tip:</strong> Better slots fill fast in high‚Äëdemand regions. If you don‚Äôt see
            your perfect time, our academic counsellor will help rearrange it after booking.
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    /*******************************************************
     * CONFIG: FILL THESE FOR YOUR PROJECT
     *******************************************************/
    const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co"; // TODO: replace
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw"; // TODO: replace

    // Table / view names
    const DEMO_LEADS_TABLE = "demo_leads";
    const DEMO_SLOTS_VIEW = "demo_slots_live_view";

    // Create client
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /*******************************************************
     * URL PARAMETERS: courseId, region, utm_* etc.
     *******************************************************/
    const urlParams = new URLSearchParams(window.location.search);

    const courseIdFromQuery = (() => {
      const raw = urlParams.get("courseId");
      const parsed = raw ? parseInt(raw, 10) : null;
      return Number.isFinite(parsed) ? parsed : null;
    })();

    const regionKeyFromQuery = urlParams.get("region") || null;
    const langFromQuery = urlParams.get("lang") || null;

    const utmPayload = {
      utm_source: urlParams.get("utm_source") || null,
      utm_medium: urlParams.get("utm_medium") || null,
      utm_campaign: urlParams.get("utm_campaign") || null,
      utm_term: urlParams.get("utm_term") || null,
      utm_content: urlParams.get("utm_content") || null,
    };

    /*******************************************************
     * COUNTRY / TIMEZONE DATA
     * - Multiple timezones for US, Canada, etc.
     * - region_key is NOT hardcoded here; that comes from URL.
     *******************************************************/
    const COUNTRY_OPTIONS = [
      {
        code: "IN",
        name: "India",
        cityLabel: "All Cities (IST)",
        timeZone: "Asia/Kolkata",
        dialCode: "+91",
      },
      {
        code: "AE",
        name: "United Arab Emirates",
        cityLabel: "Dubai / Abu Dhabi (GMT+4)",
        timeZone: "Asia/Dubai",
        dialCode: "+971",
      },
      {
        code: "SA",
        name: "Saudi Arabia",
        cityLabel: "Riyadh / Jeddah (GMT+3)",
        timeZone: "Asia/Riyadh",
        dialCode: "+966",
      },
      {
        code: "QA",
        name: "Qatar",
        cityLabel: "Doha (GMT+3)",
        timeZone: "Asia/Qatar",
        dialCode: "+974",
      },
      {
        code: "KW",
        name: "Kuwait",
        cityLabel: "Kuwait City (GMT+3)",
        timeZone: "Asia/Kuwait",
        dialCode: "+965",
      },
      {
        code: "OM",
        name: "Oman",
        cityLabel: "Muscat (GMT+4)",
        timeZone: "Asia/Muscat",
        dialCode: "+968",
      },
      {
        code: "BH",
        name: "Bahrain",
        cityLabel: "Manama (GMT+3)",
        timeZone: "Asia/Bahrain",
        dialCode: "+973",
      },
      {
        code: "US",
        name: "United States",
        cityLabel: "New York / Miami (Eastern)",
        timeZone: "America/New_York",
        dialCode: "+1",
      },
      {
        code: "US",
        name: "United States",
        cityLabel: "Chicago / Houston (Central)",
        timeZone: "America/Chicago",
        dialCode: "+1",
      },
      {
        code: "US",
        name: "United States",
        cityLabel: "Denver (Mountain)",
        timeZone: "America/Denver",
        dialCode: "+1",
      },
      {
        code: "US",
        name: "United States",
        cityLabel: "Los Angeles / Seattle (Pacific)",
        timeZone: "America/Los_Angeles",
        dialCode: "+1",
      },
      {
        code: "CA",
        name: "Canada",
        cityLabel: "Toronto / Montreal (Eastern)",
        timeZone: "America/Toronto",
        dialCode: "+1",
      },
      {
        code: "CA",
        name: "Canada",
        cityLabel: "Vancouver (Pacific)",
        timeZone: "America/Vancouver",
        dialCode: "+1",
      },
      {
        code: "GB",
        name: "United Kingdom",
        cityLabel: "London (GMT/BST)",
        timeZone: "Europe/London",
        dialCode: "+44",
      },
      {
        code: "EU",
        name: "Europe",
        cityLabel: "Central Europe (Berlin / Paris)",
        timeZone: "Europe/Berlin",
        dialCode: "+49",
      },
      {
        code: "ID",
        name: "Indonesia",
        cityLabel: "Jakarta (GMT+7)",
        timeZone: "Asia/Jakarta",
        dialCode: "+62",
      },
      {
        code: "VN",
        name: "Vietnam",
        cityLabel: "Ho Chi Minh City / Hanoi (GMT+7)",
        timeZone: "Asia/Ho_Chi_Minh",
        dialCode: "+84",
      },
      {
        code: "PH",
        name: "Philippines",
        cityLabel: "Manila (GMT+8)",
        timeZone: "Asia/Manila",
        dialCode: "+63",
      },
      {
        code: "TH",
        name: "Thailand",
        cityLabel: "Bangkok (GMT+7)",
        timeZone: "Asia/Bangkok",
        dialCode: "+66",
      },
      {
        code: "MY",
        name: "Malaysia",
        cityLabel: "Kuala Lumpur (GMT+8)",
        timeZone: "Asia/Kuala_Lumpur",
        dialCode: "+60",
      },
      {
        code: "SG",
        name: "Singapore",
        cityLabel: "Singapore (GMT+8)",
        timeZone: "Asia/Singapore",
        dialCode: "+65",
      },
      {
        code: "AU",
        name: "Australia",
        cityLabel: "Sydney / Melbourne (GMT+10)",
        timeZone: "Australia/Sydney",
        dialCode: "+61",
      },
    ];

    /*******************************************************
     * STATE
     *******************************************************/
    const state = {
      currentStep: 1,
      leadId: null,
      regionKey: regionKeyFromQuery,
      courseId: courseIdFromQuery,
      selectedCountry: null,
      selectedDialCode: "",
      selectedTimeZone: null,
      ipAddress: null,
      browser: navigator.userAgent || null,
      deviceType: detectDeviceType(),
      internetSpeedMbps: null,
      slotDataByDate: {},
      selectedSlot: null,
      selectedLanguage: langFromQuery || "english",
      whoAreYou: null,
      bookingReason: null,
      purchaseTimeline: null,
    };

    /*******************************************************
     * UTILS
     *******************************************************/
    function detectDeviceType() {
      const ua = navigator.userAgent || "";
      if (/mobile/i.test(ua)) return "mobile";
      if (/tablet/i.test(ua)) return "tablet";
      return "desktop";
    }

    function formatDateLabel(dateObj, timeZone) {
      const options = { weekday: "short", month: "short", day: "numeric" };
      const parts = new Intl.DateTimeFormat("en-US", {
        ...options,
        timeZone,
      }).formatToParts(dateObj);
      const weekday = parts.find((p) => p.type === "weekday")?.value || "";
      const month = parts.find((p) => p.type === "month")?.value || "";
      const day = parts.find((p) => p.type === "day")?.value || "";
      return {
        weekday,
        label: `${month} ${day}`,
      };
    }

    function toIstDateString(dateInUtc) {
      const formatter = new Intl.DateTimeFormat("en-CA", {
        timeZone: "Asia/Kolkata",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
      });
      return formatter.format(dateInUtc);
    }

    function addDays(dateObj, days) {
      const clone = new Date(dateObj.getTime());
      clone.setUTCDate(clone.getUTCDate() + days);
      return clone;
    }

    function formatTimeToLocal(isoStringAssumedIST, targetTimeZone) {
      if (!isoStringAssumedIST || !targetTimeZone) return "";
      try {
        const date = new Date(isoStringAssumedIST);
        const options = {
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
          timeZone: targetTimeZone,
        };
        return new Intl.DateTimeFormat("en-US", options).format(date);
      } catch (err) {
        console.error("Time formatting error", err);
        return "";
      }
    }

    function showGlobalError(msg) {
      const el = document.getElementById("globalError");
      el.textContent = msg;
      el.classList.add("visible");
    }

    function clearGlobalError() {
      const el = document.getElementById("globalError");
      el.textContent = "";
      el.classList.remove("visible");
    }

    function showGlobalSuccess(msg) {
      const el = document.getElementById("globalSuccess");
      el.textContent = msg;
      el.classList.add("visible");
    }

    function clearGlobalSuccess() {
      const el = document.getElementById("globalSuccess");
      el.textContent = "";
      el.classList.remove("visible");
    }

    function setLoading(buttonEl, isLoading, labelWhenLoading) {
      if (!buttonEl) return;
      if (isLoading) {
        buttonEl.dataset.originalLabel = buttonEl.innerHTML;
        buttonEl.innerHTML = `${labelWhenLoading} <span class="btn-icon">‚è≥</span>`;
        buttonEl.disabled = true;
      } else {
        if (buttonEl.dataset.originalLabel) {
          buttonEl.innerHTML = buttonEl.dataset.originalLabel;
        }
        buttonEl.disabled = false;
      }
    }

    function updateStepUI(step) {
      state.currentStep = step;

      const views = document.querySelectorAll(".step-view");
      views.forEach((v) => v.classList.remove("active"));
      const activeView = document.getElementById(
        step === 4 ? "step-4-success" : `step-${step}`
      );
      if (activeView) activeView.classList.add("active");

      const pills = document.querySelectorAll(".step-pill");
      pills.forEach((pill) => {
        const pillStep = parseInt(pill.dataset.stepPill, 10);
        pill.classList.remove("active", "completed");
        if (pillStep === step) pill.classList.add("active");
        if (pillStep < step) pill.classList.add("completed");
      });

      const progress = document.getElementById("stepProgress");
      const percent = step === 4 ? 100 : (step - 1) * 50;
      progress.style.width = `${percent}%`;
    }

    /*******************************************************
     * COUNTRY DROPDOWN INITIALISATION
     *******************************************************/
    function populateCountrySelect() {
      const select = document.getElementById("countrySelect");
      select.innerHTML = "";

      const placeholderOption = document.createElement("option");
      placeholderOption.value = "";
      placeholderOption.textContent = "Select your country & timezone";
      select.appendChild(placeholderOption);

      COUNTRY_OPTIONS.forEach((c, index) => {
        const option = document.createElement("option");
        option.value = index.toString();
        option.textContent = `${c.name} ‚Ä¢ ${c.cityLabel} ‚Ä¢ ${c.dialCode}`;
        select.appendChild(option);
      });

      select.addEventListener("change", () => {
        const selectedIndex = select.value;
        if (!selectedIndex && selectedIndex !== "0") {
          state.selectedCountry = null;
          state.selectedDialCode = "";
          state.selectedTimeZone = null;
          return;
        }
        const data = COUNTRY_OPTIONS[parseInt(selectedIndex, 10)];
        if (!data) return;
        state.selectedCountry = data;
        state.selectedDialCode = data.dialCode;
        state.selectedTimeZone = data.timeZone;

        const phoneInput = document.getElementById("phoneInput");
        if (phoneInput && phoneInput.value.trim() === "") {
          phoneInput.value = data.dialCode + " ";
        }
      });
    }

    async function autoDetectCountry() {
      try {
        const res = await fetch("https://ipapi.co/json/");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        state.ipAddress = data.ip || null;

        const countryCode = data.country || data.country_code;
        if (!countryCode) return;

        const select = document.getElementById("countrySelect");
        let foundIndex = -1;
        COUNTRY_OPTIONS.forEach((c, index) => {
          if (c.code === countryCode && foundIndex === -1) {
            foundIndex = index;
          }
        });

        if (foundIndex !== -1) {
          select.value = String(foundIndex);
          const event = new Event("change");
          select.dispatchEvent(event);
        } else {
          const deviceTZ =
            Intl.DateTimeFormat().resolvedOptions().timeZone || "Asia/Kolkata";
          const tzMatchIndex = COUNTRY_OPTIONS.findIndex(
            (c) => c.timeZone === deviceTZ
          );
          if (tzMatchIndex !== -1) {
            select.value = String(tzMatchIndex);
            select.dispatchEvent(new Event("change"));
          }
        }
      } catch (err) {
        console.warn("IP auto-detection failed", err);
        const select = document.getElementById("countrySelect");
        const deviceTZ =
          Intl.DateTimeFormat().resolvedOptions().timeZone || "Asia/Kolkata";
        const tzMatchIndex = COUNTRY_OPTIONS.findIndex(
          (c) => c.timeZone === deviceTZ
        );
        if (tzMatchIndex !== -1) {
          select.value = String(tzMatchIndex);
          select.dispatchEvent(new Event("change"));
        }
      }
    }

    /*******************************************************
     * DEMO_LEADS INSERT / UPDATE HELPERS
     *******************************************************/
    async function createLeadFromStep1() {
      clearGlobalError();
      clearGlobalSuccess();

      const countrySelect = document.getElementById("countrySelect");
      const phoneInput = document.getElementById("phoneInput");
      const childName = document.getElementById("childName");
      const childGrade = document.getElementById("childGrade");
      const parentName = document.getElementById("parentName");
      const parentEmail = document.getElementById("parentEmail");
      const isWhatsapp = document.getElementById("isWhatsapp");

      const laptopGroup = document.getElementById("laptopGroup");
      const selectedLaptopChip = laptopGroup.querySelector(".radio-chip.selected");
      const hasLaptop =
        selectedLaptopChip?.dataset.laptop === "yes"
          ? true
          : selectedLaptopChip?.dataset.laptop === "no"
          ? false
          : null;

      if (!countrySelect.value) {
        showGlobalError("Please select your country and timezone.");
        return null;
      }
      if (!phoneInput.value.trim()) {
        showGlobalError("Please enter your WhatsApp number.");
        return null;
      }
      if (!childName.value.trim()) {
        showGlobalError("Please enter your child‚Äôs name.");
        return null;
      }
      if (!childGrade.value) {
        showGlobalError("Please select your child‚Äôs grade.");
        return null;
      }
      if (!parentName.value.trim()) {
        showGlobalError("Please enter your name.");
        return null;
      }
      if (!parentEmail.value.trim()) {
        showGlobalError("Please enter your email.");
        return null;
      }
      if (hasLaptop === null) {
        showGlobalError("Please select whether you have a laptop or desktop.");
        return null;
      }

      const selectedCountryObj = state.selectedCountry;
      const phoneValue = phoneInput.value.trim();

      const browserTZ =
        Intl.DateTimeFormat().resolvedOptions().timeZone || null;

      const payload = {
        child_name: childName.value.trim(),
        child_grade: childGrade.value,
        parent_name: parentName.value.trim(),
        parent_email: parentEmail.value.trim(),
        phone_country_code: selectedCountryObj
          ? selectedCountryObj.dialCode
          : null,
        phone_number: phoneValue,
        is_whatsapp: !!isWhatsapp.checked,
        has_laptop: hasLaptop,
        region_key: state.regionKey,
        country: selectedCountryObj ? selectedCountryObj.name : null,
        timezone: state.selectedTimeZone || browserTZ,
        ip_address: state.ipAddress,
        browser: state.browser,
        device_type: state.deviceType,
        internet_speed_mbps: state.internetSpeedMbps,
        page_completed: 1,
        ...utmPayload,
        course_id: state.courseId,
      };

      const { data, error } = await supabaseClient
        .from(DEMO_LEADS_TABLE)
        .insert([payload])
        .select("id")
        .single();

      if (error) {
        console.error("Supabase insert error (step1)", error);
        showGlobalError(
          "We couldn‚Äôt save your details. Please try again or contact support."
        );
        return null;
      }

      state.leadId = data.id;
      showGlobalSuccess("Details saved. Now pick your perfect date & time.");
      return data.id;
    }

    async function updateLeadWithSlot(stepButtonEl) {
      clearGlobalError();
      clearGlobalSuccess();

      if (!state.leadId) {
        showGlobalError(
          "We couldn‚Äôt find your booking record. Please go back and re‚Äësubmit Step 1."
        );
        return false;
      }

      if (!state.selectedSlot) {
        showGlobalError("Please select a date and time slot for your trial.");
        return false;
      }

      const languageSelect = document.getElementById("languageSelect");
      const language = languageSelect.value || "english";
      state.selectedLanguage = language;

      const slot = state.selectedSlot;
      const payload = {
        preferred_date: slot.slot_date,
        preferred_time_slot: slot.localTimeLabel,
        slot_id: slot.slot_id,
        language: language,
        page_completed: 2,
      };

      setLoading(stepButtonEl, true, "Saving slot...");

      const { error } = await supabaseClient
        .from(DEMO_LEADS_TABLE)
        .update(payload)
        .eq("id", state.leadId);

      setLoading(stepButtonEl, false);
      if (error) {
        console.error("Supabase update error (step2)", error);
        showGlobalError(
          "We couldn‚Äôt save your chosen slot. Please try again or pick a different time."
        );
        return false;
      }

      showGlobalSuccess("Slot saved. Final step: tell us about your goals.");
      return true;
    }

    async function updateLeadWithMotivations(stepButtonEl) {
      clearGlobalError();
      clearGlobalSuccess();

      if (!state.leadId) {
        showGlobalError(
          "We couldn‚Äôt find your booking record. Please go back and re‚Äësubmit Step 1."
        );
        return false;
      }

      if (!state.whoAreYou) {
        showGlobalError("Please tell us who you are booking the class for.");
        return false;
      }
      if (!state.bookingReason) {
        showGlobalError("Please select a reason for booking this trial.");
        return false;
      }
      if (!state.purchaseTimeline) {
        showGlobalError("Please select your expected enrollment timeline.");
        return false;
      }

      const payload = {
        who_are_you: state.whoAreYou,
        booking_reason: state.bookingReason,
        purchase_timeline: state.purchaseTimeline,
        page_completed: 3,
      };

      setLoading(stepButtonEl, true, "Confirming booking...");

      const { error } = await supabaseClient
        .from(DEMO_LEADS_TABLE)
        .update(payload)
        .eq("id", state.leadId);

      setLoading(stepButtonEl, false);

      if (error) {
        console.error("Supabase update error (step3)", error);
        showGlobalError(
          "Something went wrong while confirming your booking. Please try again."
        );
        return false;
      }

      const summaryEl = document.getElementById("successSlotSummary");
      if (summaryEl && state.selectedSlot) {
        const slot = state.selectedSlot;
        const tzLabel =
          state.selectedCountry?.cityLabel ||
          state.selectedTimeZone ||
          "your local timezone";
        summaryEl.textContent =
          `Trial booked for ${slot.humanDateLabel} at ${slot.localTimeLabel} (${tzLabel}). ` +
          `Language: ${state.selectedLanguage.toUpperCase()}.`;
      }

      clearGlobalError();
      clearGlobalSuccess();
      updateStepUI(4);
      return true;
    }

    /*******************************************************
     * SLOT FETCHING & RENDERING
     *******************************************************/
    async function fetchSlotsForNextSixDays() {
      if (!state.regionKey || !state.courseId) {
        console.warn(
          "Missing regionKey or courseId. Ensure ?region=...&courseId=... are in the URL."
        );
        showGlobalError(
          "We couldn‚Äôt identify your course or region. Please open the booking link again."
        );
        return;
      }

      clearGlobalError();

      const nowUtc = new Date();
      const todayIst = toIstDateString(nowUtc);
      const plus5Ist = toIstDateString(addDays(nowUtc, 5));

      const { data, error } = await supabaseClient
        .from(DEMO_SLOTS_VIEW)
        .select(
          "slot_id, region_key, course_id, slot_date, slot_time_ist, slot_datetime_ist, slot_datetime_local, is_star_teacher, capacity_remaining"
        )
        .eq("region_key", state.regionKey)
        .eq("course_id", state.courseId)
        .gte("slot_date", todayIst)
        .lte("slot_date", plus5Ist)
        .gt("capacity_remaining", 0)
        .order("slot_datetime_ist", { ascending: true });

      if (error) {
        console.error("Supabase slot fetch error", error);
        showGlobalError(
          "We couldn‚Äôt load the available slots. Please refresh and try again."
        );
        return;
      }

      const byDate = {};
      (data || []).forEach((row) => {
        if (!byDate[row.slot_date]) byDate[row.slot_date] = [];
        byDate[row.slot_date].push(row);
      });

      state.slotDataByDate = byDate;
      renderSlotDates();
    }

    function renderSlotDates() {
      const container = document.getElementById("slotDatesRow");
      container.innerHTML = "";

      const nowUtc = new Date();
      const targetTZ = state.selectedTimeZone || "Asia/Kolkata";

      const slotsByDate = state.slotDataByDate;
      const availableDates = Object.keys(slotsByDate).sort();

      if (!availableDates.length) {
        container.innerHTML =
          '<div class="slot-empty">No slots left for the next 6 days in your region.</div>';
        document.getElementById("slotGrid").innerHTML = "";
        document.getElementById("slotEmpty").classList.remove("hidden");
        return;
      }

      const dateElements = [];
      for (let offset = 0; offset < 6; offset++) {
        const istDateString = toIstDateString(addDays(nowUtc, offset));
        if (!slotsByDate[istDateString]) continue;

        const dateIso = istDateString + "T00:00:00+05:30";
        const dateObj = new Date(dateIso);
        const { weekday, label } = formatDateLabel(dateObj, targetTZ);

        const pill = document.createElement("button");
        pill.type = "button";
        pill.className = "slot-date-pill";
        pill.dataset.slotDate = istDateString;
        pill.innerHTML = `
          <span class="slot-date-main">${weekday}</span>
          <span class="slot-date-sub">${label}</span>
        `;

        pill.addEventListener("click", () => {
          document
            .querySelectorAll(".slot-date-pill")
            .forEach((el) => el.classList.remove("active"));
          pill.classList.add("active");
          renderSlotsForDate(istDateString);
        });

        container.appendChild(pill);
        dateElements.push(pill);
      }

      if (!dateElements.length) {
        container.innerHTML =
          '<div class="slot-empty">No slots left for the next 6 days in your region.</div>';
        document.getElementById("slotGrid").innerHTML = "";
        document.getElementById("slotEmpty").classList.remove("hidden");
        return;
      }

      dateElements[0].classList.add("active");
      renderSlotsForDate(dateElements[0].dataset.slotDate);
    }

    function renderSlotsForDate(slotDate) {
      const grid = document.getElementById("slotGrid");
      const emptyEl = document.getElementById("slotEmpty");
      grid.innerHTML = "";

      const rows = (state.slotDataByDate[slotDate] || []).slice();
      if (!rows.length) {
        emptyEl.classList.remove("hidden");
        return;
      } else {
        emptyEl.classList.add("hidden");
      }

      rows.sort((a, b) => {
        const da = new Date(a.slot_datetime_ist || a.slot_datetime_local);
        const db = new Date(b.slot_datetime_ist || b.slot_datetime_local);
        return da - db;
      });

      const targetTZ = state.selectedTimeZone || "Asia/Kolkata";

      rows.forEach((row) => {
        const localLabel = formatTimeToLocal(
          row.slot_datetime_ist || row.slot_datetime_local,
          targetTZ
        );

        const humanDate = (() => {
          const dateIso = row.slot_date + "T00:00:00+05:30";
          const dateObj = new Date(dateIso);
          const { weekday, label } = formatDateLabel(dateObj, targetTZ);
          return `${weekday}, ${label}`;
        })();

        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "slot-chip";
        chip.dataset.slotId = row.slot_id;
        chip.dataset.slotDate = row.slot_date;

        chip.innerHTML = `
          <div>
            <div class="slot-time-main">${localLabel}</div>
            <div class="slot-time-sub">Local time</div>
          </div>
          <div>
            ${
              row.is_star_teacher
                ? '<div class="slot-tag">‚≠ê Star Teacher</div>'
                : ""
            }
          </div>
        `;

        chip.addEventListener("click", () => {
          document
            .querySelectorAll(".slot-chip")
            .forEach((el) => el.classList.remove("selected"));
          chip.classList.add("selected");

          state.selectedSlot = {
            slot_id: row.slot_id,
            slot_date: row.slot_date,
            slot_datetime_ist: row.slot_datetime_ist,
            slot_datetime_local: row.slot_datetime_local,
            localTimeLabel: localLabel,
            humanDateLabel: humanDate,
            is_star_teacher: row.is_star_teacher,
          };
        });

        grid.appendChild(chip);
      });

      const preselected = grid.querySelector(".slot-chip");
      if (preselected) preselected.click();
    }

    /*******************************************************
     * RADIO CHIP GROUP HANDLERS
     *******************************************************/
    function setupRadioChipGroup(containerId, stateKey, dataAttr) {
      const container = document.getElementById(containerId);
      if (!container) return;
      const chips = container.querySelectorAll(".radio-chip");
      chips.forEach((chip) => {
        chip.addEventListener("click", () => {
          chips.forEach((c) => c.classList.remove("selected"));
          chip.classList.add("selected");
          const value = chip.dataset[dataAttr];
          state[stateKey] = value;
        });
      });
    }

    /*******************************************************
     * INTERNET SPEED (BEST EFFORT, NON-BLOCKING)
     *******************************************************/
    async function measureInternetSpeed() {
      const image = new Image();
      const imageSizeBytes = 50000;
      const start = performance.now();

      return new Promise((resolve) => {
        image.onload = () => {
          const durationSec = (performance.now() - start) / 1000;
          const bitsLoaded = imageSizeBytes * 8;
          const mbps = (bitsLoaded / durationSec / (1024 * 1024)).toFixed(2);
          const parsed = parseFloat(mbps);
          if (Number.isFinite(parsed)) {
            state.internetSpeedMbps = parsed;
          }
          resolve(parsed);
        };
        image.onerror = () => {
          resolve(null);
        };
        image.src =
          "https://via.placeholder.com/300x300.png?text=Speed+Test+" +
          Math.random();
      });
    }

    /*******************************************************
     * EVENT BINDINGS
     *******************************************************/
    document.addEventListener("DOMContentLoaded", async () => {
      populateCountrySelect();
      await autoDetectCountry();
      measureInternetSpeed().catch(() => {});

      setupRadioChipGroup("laptopGroup", "hasLaptop", "laptop");
      setupRadioChipGroup("whoGroup", "whoAreYou", "who");
      setupRadioChipGroup("reasonGroup", "bookingReason", "reason");
      setupRadioChipGroup("timelineGroup", "purchaseTimeline", "timeline");

      const languageSelect = document.getElementById("languageSelect");
      if (state.selectedLanguage) {
        languageSelect.value = state.selectedLanguage;
      }
      languageSelect.addEventListener("change", () => {
        state.selectedLanguage = languageSelect.value;
      });

      const step1NextBtn = document.getElementById("step1Next");
      step1NextBtn.addEventListener("click", async () => {
        setLoading(step1NextBtn, true, "Saving details");
        const id = await createLeadFromStep1();
        setLoading(step1NextBtn, false);
        if (id) {
          await fetchSlotsForNextSixDays();
          updateStepUI(2);
        }
      });

      const step2BackBtn = document.getElementById("step2Back");
      step2BackBtn.addEventListener("click", () => {
        updateStepUI(1);
      });

      const step2NextBtn = document.getElementById("step2Next");
      step2NextBtn.addEventListener("click", async () => {
        const ok = await updateLeadWithSlot(step2NextBtn);
        if (ok) {
          updateStepUI(3);
        }
      });

      const step3BackBtn = document.getElementById("step3Back");
      step3BackBtn.addEventListener("click", () => {
        updateStepUI(2);
      });

      const step3SubmitBtn = document.getElementById("step3Submit");
      step3SubmitBtn.addEventListener("click", async () => {
        const ok = await updateLeadWithMotivations(step3SubmitBtn);
        if (ok) {
          const formButtons = document.querySelectorAll(".btn");
          formButtons.forEach((btn) => {
            if (
              btn.id === "step3Submit" ||
              btn.id === "step1Next" ||
              btn.id === "step2Next"
            ) {
              btn.disabled = true;
            }
          });
        }
      });
    });
  </script>
</body>
</html>
