<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unischooly Interim Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { box-sizing: border-box; font-family: Inter, sans-serif; }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #1b1440, #070a1a 60%);
      color: #fff;
    }

    /* ================= SECTION 1 ================= */
    .top-bar {
      max-width: 1280px;
      margin: 20px auto;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 16px;
      background: rgba(255,255,255,0.04);
      backdrop-filter: blur(12px);
    }

    .logo img {
      height: 34px;
    }

    .locked-pill {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      border-radius: 999px;
      background: linear-gradient(90deg,#7c3aed,#22d3ee);
      box-shadow: 0 0 20px rgba(124,58,237,0.6);
      font-weight: 600;
      font-size: 14px;
    }

    .locked-pill span {
      animation: pulse 1.6s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    /* ================= LAYOUT ================= */
    .page {
      max-width: 1280px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 900px) {
      .page {
        grid-template-columns: 1fr;
      }
      .logo img {
        height: 28px;
      }
    }

    /* ================= CARD BASE ================= */
    .card {
      background: linear-gradient(180deg,rgba(255,255,255,0.08),rgba(255,255,255,0.02));
      border-radius: 20px;
      padding: 20px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
    }

    /* ================= TRIAL PASS ================= */
    .trial-pass {
      position: relative;
    }

    .trial-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      border-radius: 12px;
      background: linear-gradient(90deg,#fde68a,#facc15);
      color: #111;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .stamp {
      position: absolute;
      top: 80px;
      right: 20px;
      transform: rotate(-12deg);
      border: 2px dashed #facc15;
      padding: 10px 14px;
      border-radius: 10px;
      color: #facc15;
      font-weight: 700;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .label {
      font-size: 12px;
      opacity: 0.6;
    }

    .value {
      font-weight: 600;
      word-break: break-all;
    }

    .powered {
      text-align: center;
      margin-top: 16px;
      font-size: 12px;
      opacity: 0.5;
    }

    /* ================= SCHEDULE ================= */
    .schedule {
      margin-top: 16px;
    }

    .schedule-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .calendar-box {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 14px;
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
    }

    .calendar-date {
      text-align: center;
      background: rgba(255,255,255,0.08);
      padding: 10px;
      border-radius: 10px;
      min-width: 60px;
    }

    .calendar-date strong {
      font-size: 22px;
      display: block;
    }

    .calendar-btn {
      margin-top: 12px;
      width: 100%;
      padding: 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      color: #111;
      font-weight: 700;
      background: linear-gradient(90deg,#f472b6,#60a5fa);
      animation: float 2.5s ease-in-out infinite;
    }

    @keyframes float {
      0% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
      100% { transform: translateY(0); }
    }

    /* ================= RIGHT PANEL ================= */
    .welcome h2 span {
      background: linear-gradient(90deg,#a78bfa,#22d3ee);
      -webkit-background-clip: text;
      color: transparent;
    }

    .timer {
      display: flex;
      gap: 12px;
      margin: 16px 0;
    }

    .timer-box {
      flex: 1;
      padding: 14px;
      text-align: center;
      background: rgba(255,255,255,0.06);
      border-radius: 14px;
    }

    .join-btn {
      margin: 20px auto;
      display: block;
      padding: 14px 40px;
      border-radius: 999px;
      border: none;
      cursor: not-allowed;
      opacity: 0.6;
      background: linear-gradient(90deg,#7c3aed,#22d3ee);
      color: #fff;
      font-weight: 700;
    }

    .terms {
      font-size: 12px;
      opacity: 0.7;
      text-align: center;
    }

    /* ================= FUN FACTS ================= */
    .fun-facts {
      margin-top: 16px;
      min-height: 120px;
    }

    .fact-box {
      padding: 14px;
      background: rgba(255,255,255,0.05);
      border-radius: 14px;
    }
  
/* === PATCH: Email ellipsis + click to copy === */
#parentEmail{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width: 100%;
  cursor: copy;
}
#parentEmail.copied{ box-shadow: 0 0 0 1px rgba(255,255,255,.22) inset; }

/* === PATCH: Welcome name gradient === */
.grad-name{
  background: linear-gradient(90deg, #a855f7, #ff7b5f, #22c55e);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

/* === PATCH: Fun facts visual filler === */
.funfacts-divider{
  height: 2px;
  width: 100%;
  margin-top: 14px;
  border-radius: 999px;
  background: linear-gradient(90deg, rgba(168,85,247,.15), rgba(255,123,95,.45), rgba(34,197,94,.2));
  background-size: 200% 100%;
  animation: ffmove 3.6s ease-in-out infinite;
  opacity: .9;
}
@keyframes ffmove { 0%{background-position:0% 0%} 50%{background-position:100% 0%} 100%{background-position:0% 0%} }
.funfacts-dots{
  display:flex; gap:6px; margin-top: 10px; align-items:center; justify-content:center;
}
.funfacts-dots .dot{
  width:7px; height:7px; border-radius:999px;
  background: rgba(255,255,255,.18);
  border: 1px solid rgba(255,255,255,.14);
  transition: transform .18s ease, background .18s ease, border-color .18s ease;
}
.funfacts-dots .dot.active{
  background: linear-gradient(135deg,#a855f7,#ff7b5f);
  border-color: rgba(255,255,255,.28);
  transform: scale(1.2);
}

/* === PATCH: Calendar Sync popover === */
.cal-pop{
  position:absolute;
  right: 16px;
  top: calc(100% + 10px);
  width: min(320px, calc(100vw - 40px));
  background: rgba(10, 14, 34, .98);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 14px;
  padding: 10px;
  box-shadow: 0 20px 50px rgba(0,0,0,.55);
  display:none;
  z-index: 60;
}
.cal-pop.open{ display:block; }
.cal-pop a{
  display:flex; align-items:center; justify-content:space-between;
  padding: 10px 10px;
  border-radius: 12px;
  text-decoration:none;
  color: rgba(255,255,255,.92);
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  margin-top: 8px;
}
.cal-pop a:hover{
  background: rgba(255,255,255,.07);
  border-color: rgba(255,255,255,.18);
}
.cal-pop small{ color: rgba(255,255,255,.62); }
.cal-pop .head{ font-weight:700; letter-spacing:.02em; }

/* === PATCH: Reschedule right drawer === */
.drawer-overlay{
  position: fixed; inset: 0; background: rgba(0,0,0,.55);
  backdrop-filter: blur(4px);
  display:none; z-index: 70;
}
.drawer-overlay.open{ display:block; }
.drawer{
  position: fixed;
  top: 0; right: 0;
  height: 100vh;
  width: min(440px, 92vw);
  background: rgba(8, 11, 26, .98);
  border-left: 1px solid rgba(255,255,255,.12);
  box-shadow: -20px 0 60px rgba(0,0,0,.55);
  transform: translateX(110%);
  transition: transform .22s ease;
  z-index: 80;
  display:flex; flex-direction:column;
}
.drawer.open{ transform: translateX(0); }
.drawer-header{
  padding: 16px 16px 12px;
  display:flex; align-items:center; justify-content:space-between; gap: 10px;
  border-bottom: 1px solid rgba(255,255,255,.10);
}
.drawer-title{ font-size: 16px; font-weight: 800; }
.drawer-close{
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.9);
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
}
.drawer-body{ padding: 14px 16px 16px; overflow:auto; }
.drawer-sub{ color: rgba(255,255,255,.70); font-size: 12px; margin-top: 4px; }
.tz-select{
  width:100%;
  margin-top: 10px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.92);
}
.date-pills{
  display:flex; flex-wrap:wrap; gap: 10px; margin-top: 12px;
}
.date-pill{
  min-width: 108px;
  padding: 9px 10px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  cursor:pointer;
  transition: transform .14s ease, border-color .14s ease, background .14s ease;
}
.date-pill:hover{ transform: translateY(-1px); border-color: rgba(168,85,247,.65); }
.date-pill.active{
  border-color: rgba(168,85,247,.95);
  background: radial-gradient(circle at 0 0, rgba(168,85,247,.25), transparent 62%), rgba(255,255,255,.04);
}
.date-pill .top{ font-weight: 800; }
.date-pill .sub{ font-size: 11px; color: rgba(255,255,255,.65); }

.time-grid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 10px;
  margin-top: 12px;
}
@media (max-width: 520px){
  .time-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
.time-pill{
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color: rgba(233,236,255,.95); /* FIX: not black */
  padding: 10px 10px;
  cursor:pointer;
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  transition: transform .14s ease, border-color .14s ease, background .14s ease;
}
.time-pill:hover{ transform: translateY(-1px); border-color: rgba(168,85,247,.65); }
.time-pill.active{
  border-color: rgba(168,85,247,.95);
  background: radial-gradient(circle at 0 0, rgba(168,85,247,.25), transparent 62%), rgba(255,255,255,.04);
}
.time-pill.disabled{ opacity:.45; cursor:not-allowed; transform:none; }
.star-badge{
  font-size: 10px;
  padding: 3px 7px;
  border-radius: 999px;
  background: rgba(255, 200, 80, .18);
  border: 1px solid rgba(255, 200, 80, .35);
  color: rgba(255, 228, 170, .95);
  white-space: nowrap;
  flex: 0 0 auto; /* FIX overlap */
}
.drawer-actions{
  margin-top: 14px;
  display:flex; gap: 10px;
}
.btn-primary{
  width:100%;
}
.drawer-note{
  margin-top: 10px;
  font-size: 12px;
  color: rgba(255,255,255,.70);
}

</style>
</head>
<body>

  <!-- SECTION 1 -->
  <div class="top-bar">
    <div class="logo">
      <img src="https://res.cloudinary.com/dpapyknn4/image/upload/v1763143023/Unischooly_Horizontal_logo_qbu1l7.svg">
    </div>
    <div class="locked-pill">
      <span>‚úî</span> Your trial class is locked in!
    </div>
  </div>

  <!-- SECTION 2 -->
  <div class="page">

    <!-- LEFT -->
    <div>
      <div class="card trial-pass">
        <div class="trial-header">
          üé´ OFFICIAL FREE TRIAL PASS
          <span>[ VALUE: $30 ‚Äì WAIVED ]</span>
        </div>

        <div class="stamp">VALUE<br>WAIVED<br>$30</div>

        <div class="grid">
          <div>
            <div class="label">Student Name</div>
            <div class="value" id="studentName">‚Äî</div>
          </div>
          <div>
            <div class="label">Grade</div>
            <div class="value" id="grade">‚Äî</div>
          </div>
          <div>
            <div class="label">Course</div>
            <div class="value" id="course">‚Äî</div>
          </div>
          <div>
            <div class="label">Parent Name</div>
            <div class="value" id="parentName">‚Äî</div>
          </div>
          <div>
            <div class="label">Parent Email</div>
            <div class="value" id="parentEmail">‚Äî</div>
          </div>
          <div>
            <div class="label">Parent Phone</div>
            <div class="value" id="parentPhone">‚Äî</div>
          </div>
        </div>

        <div class="powered">Powered by Unischooly</div>
      </div>

      <div class="card schedule">
        <div class="schedule-row">
          üöÄ <strong>Ready for Blast Off!!!</strong>
          <button id="openRescheduleBtn" type="button">Reschedule</button>
        </div>

        <div class="calendar-box">
          <div class="calendar-date">
            DEC<strong>15</strong>MON
          </div>
          <div>
            <strong id="classTime">1:30 PM</strong><br>
            <small id="timezone">Asia/Kolkata</small>
          </div>
        </div>

        <button class="calendar-btn">üìÖ Initiate Calendar Sync</button>
      </div>

      <div class="card fun-facts">
        ‚ú® <strong>Fun Facts</strong>
        <div class="fact-box" id="fact">Coding helps you think logically.</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card welcome">
        <h2>Welcome to <span id="welcomeName">Your</span> Trial Class</h2>
        <p>Keep this page open ‚Äî everything you need is right here.</p>

        <div class="timer">
          <div class="timer-box">1<br>Days</div>
          <div class="timer-box">12<br>Hours</div>
          <div class="timer-box">30<br>Min</div>
          <div class="timer-box">15<br>Sec</div>
        </div>

        <button class="join-btn">Join Class</button>

        <div class="terms">
          By clicking join class, you agree to <u>Terms & Conditions</u>
        </div>
      </div>

      <div class="card">
        <strong>Sharpen Your Brain üß†</strong>
        <p>What comes next? 2, 4, 8, 16, ?</p>
        <div class="grid">
          <button>18</button>
          <button>24</button>
          <button>32</button>
          <button>34</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  
// ============================
// RESCHEDULE + CALENDAR (PATCH)
// ============================
const TZ_OPTIONS = [
  "Asia/Kolkata","Asia/Dubai","Asia/Riyadh","Asia/Jakarta","Asia/Singapore","Asia/Manila","Asia/Bangkok","Asia/Ho_Chi_Minh",
  "Europe/London","Europe/Berlin","Europe/Paris",
  "America/New_York","America/Chicago","America/Denver","America/Los_Angeles",
  "Australia/Sydney","Pacific/Auckland"
];

function isoTodayInTZ(tz){
  const now = new Date();
  const parts = new Intl.DateTimeFormat('en-CA',{ timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(now);
  const y = parts.find(p=>p.type==='year').value;
  const m = parts.find(p=>p.type==='month').value;
  const d = parts.find(p=>p.type==='day').value;
  return `${y}-${m}-${d}`;
}

function parseTimeLabel(label){
  const m = String(label||'').trim().match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
  if(!m) return null;
  let h = parseInt(m[1],10);
  const min = parseInt(m[2],10);
  const ap = m[3].toUpperCase();
  if(ap==='PM' && h!==12) h+=12;
  if(ap==='AM' && h===12) h=0;
  return {h, min};
}

function makeDateInTZ(dateISO, h, min, tz){
  const [Y,M,D]=dateISO.split('-').map(Number);
  let guess = new Date(Date.UTC(Y, M-1, D, h, min, 0));
  for(let i=0;i<3;i++){
    const parts = new Intl.DateTimeFormat('en-US',{
      timeZone: tz, hour12:false, year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit'
    }).formatToParts(guess);
    const yy=+parts.find(p=>p.type==='year').value;
    const mm=+parts.find(p=>p.type==='month').value;
    const dd=+parts.find(p=>p.type==='day').value;
    const hh=+parts.find(p=>p.type==='hour').value;
    const mn=+parts.find(p=>p.type==='minute').value;

    const desired = Date.UTC(Y, M-1, D, h, min, 0);
    const got = Date.UTC(yy, mm-1, dd, hh, mn, 0);
    const diff = desired - got;
    if(Math.abs(diff) < 60000) break;
    guess = new Date(guess.getTime() + diff);
  }
  return guess;
}

function fmtHM(date, tz){
  return new Intl.DateTimeFormat('en-US',{ timeZone: tz, hour:'numeric', minute:'2-digit', hour12:true }).format(date);
}

function fmtDateLabel(dateISO, tz){
  const d = makeDateInTZ(dateISO, 12, 0, tz);
  const parts = new Intl.DateTimeFormat('en-US',{ timeZone: tz, weekday:'short', day:'numeric', month:'short' }).formatToParts(d);
  const wk = parts.find(p=>p.type==='weekday')?.value || '';
  const day = parts.find(p=>p.type==='day')?.value || '';
  const mon = parts.find(p=>p.type==='month')?.value || '';
  return {top: `${wk} ${day}`, sub: `${mon}`};
}

function openDrawer(){
  document.getElementById('drawerOverlay').classList.add('open');
  document.getElementById('rescheduleDrawer').classList.add('open');
  document.getElementById('rescheduleDrawer').setAttribute('aria-hidden','false');
}
function closeDrawer(){
  document.getElementById('drawerOverlay').classList.remove('open');
  document.getElementById('rescheduleDrawer').classList.remove('open');
  document.getElementById('rescheduleDrawer').setAttribute('aria-hidden','true');
}

function buildTzSelect(currentTz){
  const sel=document.getElementById('tzSelect');
  if(!sel) return;
  sel.innerHTML='';
  const set = new Set([currentTz, ...TZ_OPTIONS].filter(Boolean));
  [...set].forEach(t=>{
    const o=document.createElement('option');
    o.value=t; o.textContent=t;
    sel.appendChild(o);
  });
  sel.value = currentTz || 'Asia/Kolkata';
}

let RS_STATE = { tz:null, date:null, slotId:null, slotLabel:null, booking:null, _slotsByDate:{} };

async function loadRescheduleSlots(){
  const tz = RS_STATE.tz;
  const todayISO = isoTodayInTZ(tz);

  const baseDate = makeDateInTZ(todayISO, 12, 0, tz);
  const dates = [];
  for(let i=0;i<7;i++){
    const d = new Date(baseDate.getTime() + i*86400000);
    const parts = new Intl.DateTimeFormat('en-CA',{ timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(d);
    const y=parts.find(p=>p.type==='year').value;
    const m=parts.find(p=>p.type==='month').value;
    const da=parts.find(p=>p.type==='day').value;
    dates.push(`${y}-${m}-${da}`);
  }

  const pills=document.getElementById('rsDatePills');
  if(!pills) return;
  pills.innerHTML='';
  RS_STATE.date = RS_STATE.date && dates.includes(RS_STATE.date) ? RS_STATE.date : dates[0];

  dates.forEach(ds=>{
    const lab=fmtDateLabel(ds, tz);
    const div=document.createElement('div');
    div.className='date-pill' + (ds===RS_STATE.date?' active':'');
    div.innerHTML = `<div class="top">${lab.top}</div><div class="sub">${lab.sub}</div>`;
    div.addEventListener('click', ()=>{
      RS_STATE.date = ds;
      [...pills.children].forEach(c=>c.classList.remove('active'));
      div.classList.add('active');
      renderTimesForDate(ds);
    });
    pills.appendChild(div);
  });

  RS_STATE._slotsByDate = {};
  for(const ds of dates){
    const { data, error } = await supabase
      .from("demo_slots_live_view")
      .select("slot_id, slot_datetime_local, is_star_teacher")
      .eq("region_key", RS_STATE.booking.region_key)
      .eq("course_id", RS_STATE.booking.course_id)
      .eq("slot_date", ds);

    if(error){ RS_STATE._slotsByDate[ds]=[]; continue; }

    const slots = (data||[]).map(r=>{
      const utc = new Date(r.slot_datetime_local);
      const local = new Date(utc.toLocaleString('en-US',{ timeZone: tz }));
      return { slot_id: r.slot_id, local, isStar: !!r.is_star_teacher };
    }).sort((a,b)=>a.local-b.local);

    RS_STATE._slotsByDate[ds]=slots;
  }

  renderTimesForDate(RS_STATE.date);
}

function renderTimesForDate(dateISO){
  const grid=document.getElementById('rsTimeGrid');
  if(!grid) return;
  grid.innerHTML='';
  RS_STATE.slotId=null;
  RS_STATE.slotLabel=null;

  const tz=RS_STATE.tz;
  const now = new Date();
  const nowLocal = new Date(now.toLocaleString('en-US',{ timeZone: tz }));
  const todayISO = isoTodayInTZ(tz);

  const slots = (RS_STATE._slotsByDate?.[dateISO] || []);
  if(!slots.length){
    grid.innerHTML = `<div style="grid-column:1/-1; color: rgba(255,255,255,.7); font-size: 12px;">No slots available.</div>`;
    return;
  }

  slots.forEach(s=>{
    const label = fmtHM(s.local, tz);
    const pill=document.createElement('div');
    pill.className='time-pill';
    const isPastToday = (dateISO===todayISO) && (s.local.getTime() <= nowLocal.getTime());
    if(isPastToday) pill.classList.add('disabled');

    pill.innerHTML = `<span>${label}</span>${s.isStar?`<span class="star-badge">‚≠ê Star</span>`:''}`;
    pill.addEventListener('click', ()=>{
      if(pill.classList.contains('disabled')) return;
      [...grid.children].forEach(c=>c.classList.remove('active'));
      pill.classList.add('active');
      RS_STATE.slotId = s.slot_id;
      RS_STATE.slotLabel = label;
    });
    grid.appendChild(pill);
  });
}

async function confirmReschedule(){
  if(!RS_STATE.slotId || !RS_STATE.booking?.id) return;

  await supabase
    .from("demo_leads")
    .update({
      preferred_date: RS_STATE.date,
      preferred_time_slot: RS_STATE.slotLabel,
      slot_id: RS_STATE.slotId,
      timezone: RS_STATE.tz
    })
    .eq("id", RS_STATE.booking.id);

  try{
    document.getElementById("date").textContent = RS_STATE.date;
    document.getElementById("classTime").textContent = RS_STATE.slotLabel;
    document.getElementById("timezone").textContent = RS_STATE.tz;
  }catch(e){}

  try{
    startCountdown({ ...RS_STATE.booking, preferred_date: RS_STATE.date, preferred_time_slot: RS_STATE.slotLabel, timezone: RS_STATE.tz });
  }catch(e){}

  closeDrawer();
}

(function wireReschedule(){
  const btn=document.getElementById('openRescheduleBtn');
  const ov=document.getElementById('drawerOverlay');
  const close=document.getElementById('closeRescheduleBtn');
  const tzSel=document.getElementById('tzSelect');
  const confirm=document.getElementById('confirmRescheduleBtn');

  if(btn){
    btn.addEventListener('click', async ()=>{
      if(!window.__BOOKING) return;
      RS_STATE.booking = window.__BOOKING;
      RS_STATE.tz = window.__BOOKING.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Kolkata';
      buildTzSelect(RS_STATE.tz);
      openDrawer();
      await loadRescheduleSlots();
    });
  }
  if(ov) ov.addEventListener('click', closeDrawer);
  if(close) close.addEventListener('click', closeDrawer);
  if(tzSel) tzSel.addEventListener('change', async ()=>{
    RS_STATE.tz = tzSel.value;
    await loadRescheduleSlots();
  });
  if(confirm) confirm.addEventListener('click', confirmReschedule);
})();

// Calendar sync popover
function buildCalendarLinks(booking){
  const btn=document.getElementById('calendarSyncBtn');
  const pop=document.getElementById('calPop');
  if(!btn || !pop) return;

  const tz = booking.timezone || 'Asia/Kolkata';
  const t = parseTimeLabel(String(booking.preferred_time_slot||'').trim());
  if(!booking.preferred_date || !t) return;

  const start = makeDateInTZ(booking.preferred_date, t.h, t.min, tz);
  const end = new Date(start.getTime() + 60*60000);

  const titleRaw = `Unischooly Trial Class - ${booking.child_name || 'Student'}`;
  const title = encodeURIComponent(titleRaw);
  const details = encodeURIComponent('Join your Unischooly trial class. See you soon!');
  const location = encodeURIComponent('Online');

  const toICS = (d)=>d.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
  const startZ = toICS(start);
  const endZ = toICS(end);

  const gUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&location=${location}&dates=${startZ}/${endZ}`;
  const durMin = Math.round((end-start)/60000);
  const yUrl = `https://calendar.yahoo.com/?v=60&view=d&type=20&title=${title}&st=${startZ}&dur=${durMin}&desc=${details}&in_loc=${location}`;
  const oUrl = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${title}&body=${details}&location=${location}&startdt=${encodeURIComponent(start.toISOString())}&enddt=${encodeURIComponent(end.toISOString())}`;

  const ics = [
    'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Unischooly//Interim//EN','CALSCALE:GREGORIAN','METHOD:PUBLISH',
    'BEGIN:VEVENT',
    `DTSTART:${startZ}`,
    `DTEND:${endZ}`,
    `SUMMARY:${titleRaw}`,
    `DESCRIPTION:Join your Unischooly trial class. See you soon!`,
    `LOCATION:Online`,
    'END:VEVENT','END:VCALENDAR'
  ].join('\\r\\n');

  const blob = new Blob([ics], {type:'text/calendar;charset=utf-8'});
  const icsUrl = URL.createObjectURL(blob);

  pop.innerHTML = `
    <div class="head">Add to calendar</div>
    <a href="${gUrl}" target="_blank" rel="noopener"><span>Google Calendar</span><small>‚Üó</small></a>
    <a href="${icsUrl}" download="unischooly-trial.ics"><span>Apple Calendar (ICS)</span><small>‚Üì</small></a>
    <a href="${oUrl}" target="_blank" rel="noopener"><span>Outlook.com</span><small>‚Üó</small></a>
    <a href="${yUrl}" target="_blank" rel="noopener"><span>Yahoo</span><small>‚Üó</small></a>
  `;

  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    e.stopPropagation();
    pop.classList.toggle('open');
  });
  document.addEventListener('click', ()=>pop.classList.remove('open'));
}

</script>


<!-- === Reschedule Drawer (PATCH) === -->
<div class="drawer-overlay" id="drawerOverlay"></div>
<aside class="drawer" id="rescheduleDrawer" aria-hidden="true">
  <div class="drawer-header">
    <div>
      <div class="drawer-title">Reschedule your trial</div>
      <div class="drawer-sub">Pick a new date & time (shown in your timezone)</div>
    </div>
    <button class="drawer-close" id="closeRescheduleBtn" type="button">‚úï</button>
  </div>
  <div class="drawer-body">
    <label class="drawer-sub" for="tzSelect" style="display:block; margin-top:2px;">Timezone</label>
    <select class="tz-select" id="tzSelect"></select>

    <div class="date-pills" id="rsDatePills"></div>

    <div class="drawer-sub" style="margin-top:12px;">Available times</div>
    <div class="time-grid" id="rsTimeGrid"></div>

    <div class="drawer-actions">
      <button class="btn-primary" id="confirmRescheduleBtn" type="button">Confirm Reschedule</button>
    </div>

    <div class="drawer-note" id="rsNote">Your class timing will update instantly once confirmed.</div>
  </div>
</aside>


<script>
/* ============================
   PATCH: UX helpers
   ============================ */
(function(){
  const emailEl = document.getElementById('parentEmail');
  if(emailEl){
    emailEl.addEventListener('click', async () => {
      const text = emailEl.getAttribute('data-full') || emailEl.textContent || '';
      if(!text || text === '‚Äî') return;
      try{
        await navigator.clipboard.writeText(text);
        emailEl.classList.add('copied');
        const prev = emailEl.textContent;
        emailEl.textContent = 'Copied ‚úÖ';
        setTimeout(()=>{ emailEl.textContent = prev; emailEl.classList.remove('copied'); }, 900);
      }catch(e){}
    });
  }

  window.__renderFunDots = function(total, activeIdx){
    const dots = document.getElementById('funDots');
    if(!dots) return;
    dots.innerHTML = '';
    for(let i=0;i<total;i++){
      const d=document.createElement('div');
      d.className='dot' + (i===activeIdx?' active':'');
      dots.appendChild(d);
    }
  };

  window.__firstName = function(full){
    if(!full) return '';
    const parts = String(full).trim().split(/\s+/).filter(Boolean);
    return parts[0] || full;
  };
})();
</script>

</body>
</html>
