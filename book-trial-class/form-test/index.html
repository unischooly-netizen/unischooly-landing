<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Book Now &amp; Get Certified | Unischooly</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg:#020617;
      --bg-soft:#05081a;
      --card:#050816;
      --primary:#6366f1;
      --primary-soft:#818cf8;
      --accent:#22c55e;
      --danger:#fb7185;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2937;
    }

    * { box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Inter",system-ui,sans-serif;
      background:radial-gradient(circle at top,#111827 0,#020617 48%,#000 100%);
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:24px;
    }

    .shell{
      width:100%;
      max-width:470px;
      background:
        linear-gradient(145deg,rgba(148,163,184,0.16),transparent 40%) border-box,
        radial-gradient(circle at top left,rgba(96,165,250,0.16),transparent 55%) border-box,
        linear-gradient(180deg,#020617,#020617) padding-box;
      border-radius:26px;
      border:1px solid rgba(148,163,184,0.45);
      padding:18px 18px 20px;
      box-shadow:0 22px 60px rgba(15,23,42,0.9);
    }

    header{
      padding:4px 4px 10px;
    }

    h1{
      margin:0 0 4px;
      font-size:1.6rem;
      letter-spacing:-0.03em;
      background:linear-gradient(120deg,#f97316,#ec4899,#6366f1);
      -webkit-background-clip:text;
      color:transparent;
    }

    .subtitle{
      margin:0;
      font-size:0.88rem;
      color:var(--muted);
    }

    .step-label{
      margin-top:6px;
      font-size:0.78rem;
      color:var(--muted);
    }

    .progress-bar{
      margin-top:10px;
      height:4px;
      background:rgba(15,23,42,0.9);
      border-radius:999px;
      overflow:hidden;
      display:flex;
    }
    .progress-seg{
      flex:1;
      background:radial-gradient(circle at top,#1f2937,transparent);
    }
    .progress-seg.active{
      background:linear-gradient(90deg,#22c55e,#22c55e);
    }
    .progress-seg.current{
      background:linear-gradient(90deg,#22c55e,#6366f1);
    }

    main{
      margin-top:12px;
      background:radial-gradient(circle at top,rgba(15,23,42,0.9),rgba(2,6,23,1));
      border-radius:22px;
      border:1px solid rgba(31,41,55,0.9);
      padding:16px 14px 14px;
    }

    .hidden{ display:none !important; }

    label{
      font-size:0.82rem;
      display:block;
      margin-bottom:4px;
    }

    .field{ margin-bottom:10px; }

    .hint{
      font-size:0.75rem;
      color:var(--muted);
    }

    .stack{
      display:flex;
      gap:8px;
      align-items:stretch;
    }

    select,
    input[type="text"],
    input[type="tel"],
    input[type="email"],
    textarea{
      width:100%;
      padding:9px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
      font-size:0.9rem;
      outline:none;
      transition:border-color 0.12s ease,box-shadow 0.12s ease,background 0.12s ease;
    }

    textarea{
      border-radius:12px;
      resize:vertical;
      min-height:60px;
    }

    select:focus,
    input:focus,
    textarea:focus{
      border-color:var(--primary-soft);
      box-shadow:0 0 0 1px rgba(129,140,248,0.55);
      background:#020617;
    }

    select{
      appearance:none;
      background-image:
        linear-gradient(45deg,transparent 50%,#6b7280 50%),
        linear-gradient(135deg,#6b7280 50%,transparent 50%);
      background-position:calc(100% - 14px) 52%,calc(100% - 9px) 52%;
      background-size:6px 6px,6px 6px;
      background-repeat:no-repeat;
    }

    .radio-row{
      display:flex;
      gap:12px;
      align-items:center;
      font-size:0.86rem;
      margin-top:4px;
    }

    .radio-row label{
      margin:0;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }

    .btn{
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:0.94rem;
      font-weight:600;
      padding:10px 16px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:transform 0.08s ease,box-shadow 0.12s ease,background 0.12s ease,opacity 0.12s ease;
    }

    .btn-primary{
      width:100%;
      background:linear-gradient(135deg,#ec4899,#6366f1,#22c55e);
      color:#f9fafb;
      box-shadow:0 18px 40px rgba(79,70,229,0.55);
      margin-top:10px;
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 22px 48px rgba(79,70,229,0.75);
    }
    .btn-primary:active{
      transform:translateY(0);
      box-shadow:0 12px 30px rgba(79,70,229,0.6);
    }
    .btn[disabled]{
      opacity:0.6;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .btn-outline{
      background:transparent;
      border:1px solid var(--border);
      color:var(--muted);
      padding:7px 12px;
      font-size:0.82rem;
    }

    .cta-note{
      margin-top:4px;
      font-size:0.72rem;
      color:var(--muted);
      text-align:center;
    }

    .global-error{
      margin-top:6px;
      font-size:0.8rem;
      color:var(--danger);
    }

    .top-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
      font-size:0.8rem;
    }

    .back-link{
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      color:var(--muted);
      font-size:0.8rem;
    }
    .back-link span.icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      border-radius:999px;
      border:1px solid var(--border);
    }

    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }

    .date-pill{
      flex:1 1 calc(33.333% - 8px);
      min-width:90px;
      padding:8px 9px;
      text-align:left;
      border-radius:12px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(31,41,55,1);
      cursor:pointer;
      font-size:0.8rem;
    }

    .date-pill .dow{font-weight:600;font-size:0.8rem;}
    .date-pill .dom{font-size:0.78rem;color:var(--muted);}

    .date-pill.active{
      border-color:var(--primary-soft);
      box-shadow:0 12px 30px rgba(79,70,229,0.5);
      background:radial-gradient(circle at top,rgba(99,102,241,0.18),#020617);
    }

    .slots-wrap{
      margin-top:10px;
      max-height:220px;
      overflow-y:auto;
      border-radius:12px;
      border:1px solid rgba(31,41,55,1);
      background:rgba(2,6,23,0.9);
      padding:6px;
    }

    .slot-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:7px 8px;
      border-radius:10px;
      cursor:pointer;
      font-size:0.82rem;
      border:1px solid transparent;
    }

    .slot-row + .slot-row{ margin-top:4px; }

    .slot-row:hover{
      background:rgba(15,23,42,0.95);
      border-color:rgba(55,65,81,0.95);
    }

    .slot-row.active{
      background:radial-gradient(circle at top left,rgba(99,102,241,0.25),rgba(2,6,23,1));
      border-color:var(--primary-soft);
      box-shadow:0 0 0 1px rgba(79,70,229,0.7);
    }

    .slot-meta{
      font-size:0.74rem;
      color:var(--muted);
      margin-top:2px;
    }

    .tag-star{
      font-size:0.72rem;
      color:#fde68a;
      border-radius:999px;
      padding:3px 7px;
      border:1px solid rgba(250,204,21,0.7);
      background:rgba(30,64,175,0.35);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .tag-star span.badge-dot{
      width:8px;height:8px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0,#facc15,#eab308);
      box-shadow:0 0 0 4px rgba(234,179,8,0.4);
    }

    .lang-pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(31,41,55,1);
      background:rgba(2,6,23,0.9);
      font-size:0.8rem;
      cursor:pointer;
    }

    .lang-pill.active{
      border-color:var(--primary-soft);
      background:radial-gradient(circle at top,rgba(99,102,241,0.3),rgba(2,6,23,1));
      box-shadow:0 0 0 1px rgba(79,70,229,0.6);
    }

    .section-title{
      font-size:0.9rem;
      font-weight:600;
      margin-top:4px;
    }

    .section-sub{
      font-size:0.76rem;
      color:var(--muted);
      margin-top:2px;
    }

    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:7px;
      margin-top:6px;
    }

    .chip{
      border-radius:999px;
      border:1px solid rgba(31,41,55,1);
      background:rgba(2,6,23,0.9);
      padding:7px 11px;
      font-size:0.8rem;
      cursor:pointer;
    }

    .chip.active{
      border-color:var(--primary-soft);
      background:radial-gradient(circle at top left,rgba(99,102,241,0.26),rgba(2,6,23,1));
      box-shadow:0 0 0 1px rgba(79,70,229,0.7);
    }
  </style>
</head>
<body>
<div class="shell">
  <header>
    <h1>Book Now &amp; Get Certified</h1>
    <p class="subtitle">Step 1 of 3 ¬∑ Share your child &amp; parent details to unlock a personalised trial class.</p>
    <div class="step-label">Three quick steps: details ‚Üí time slot ‚Üí motivation.</div>
    <div class="progress-bar">
      <div class="progress-seg current" data-step-bar="1"></div>
      <div class="progress-seg" data-step-bar="2"></div>
      <div class="progress-seg" data-step-bar="3"></div>
    </div>
  </header>

  <main>
    <!-- STEP 1 -->
    <form id="step-1" autocomplete="on">
      <div class="field">
        <label>Parent WhatsApp Number<span style="color:#facc15;"> *</span></label>
        <div class="stack">
          <div style="flex:0 0 140px;">
            <div class="hint" style="margin-bottom:3px;">Country code</div>
            <select id="phone-country-code"></select>
          </div>
          <div style="flex:1;">
            <div class="hint" style="margin-bottom:3px;">Mobile number</div>
            <input type="tel" id="phone-number" placeholder="Enter mobile number" inputmode="tel" required />
          </div>
        </div>
        <div class="hint" style="margin-top:6px;">Please share the number that you use for WhatsApp.</div>
      </div>

      <div class="field">
        <label for="child-name">Child Name<span style="color:#facc15;"> *</span></label>
        <input type="text" id="child-name" placeholder="Enter child's name" required />
      </div>

      <div class="field">
        <label for="child-grade">Child Grade<span style="color:#facc15;"> *</span></label>
        <select id="child-grade" required>
          <option value="">Select Grade</option>
          <option value="1">Grade 1</option>
          <option value="2">Grade 2</option>
          <option value="3">Grade 3</option>
          <option value="4">Grade 4</option>
          <option value="5">Grade 5</option>
          <option value="6">Grade 6</option>
          <option value="7">Grade 7</option>
          <option value="8">Grade 8</option>
          <option value="9">Grade 9</option>
          <option value="10">Grade 10</option>
          <option value="11">Grade 11</option>
          <option value="12">Grade 12</option>
        </select>
      </div>

      <div class="field">
        <label for="parent-name">Parent Name<span style="color:#facc15;"> *</span></label>
        <input type="text" id="parent-name" placeholder="Enter parent name" required />
      </div>

      <div class="field">
        <label for="parent-email">Parent Email<span style="color:#facc15;"> *</span></label>
        <input type="email" id="parent-email" placeholder="Enter email" required />
      </div>

      <div class="field">
        <label>Do you have a Laptop or Desktop?<span style="color:#facc15;"> *</span></label>
        <div class="radio-row">
          <label><input type="radio" name="has-laptop" value="yes" checked /> Yes</label>
          <label><input type="radio" name="has-laptop" value="no" /> No</label>
        </div>
      </div>

      <button type="submit" class="btn btn-primary" id="step-1-submit">
        <span>Book a Free Trial Class</span><span aria-hidden="true">‚ú®</span>
      </button>
      <div class="cta-note">
        Note: We will share the class link &amp; certificate on Email &amp; WhatsApp.
      </div>
      <div class="global-error" id="error-step-1" style="display:none;"></div>
    </form>

    <!-- STEP 2 -->
    <form id="step-2" class="hidden">
      <div class="top-row">
        <div class="back-link" data-back="1">
          <span class="icon">‚Üê</span><span>Back</span>
        </div>
        <div style="color:var(--muted);font-size:0.78rem;">Step 2 of 3</div>
      </div>

      <h2 class="section-title">Select Date &amp; Time</h2>

      <div class="field" style="margin-top:6px;">
        <div class="section-title">Select Date</div>
        <div class="section-sub">Your class will be for 1 hour.</div>
        <div class="pill-row" id="date-pills"></div>
      </div>

      <div class="field" style="margin-top:8px;">
        <div class="section-title">Select Start Time</div>
        <div class="section-sub">Class slots are limited. Times are shown in your local time zone.</div>
        <div class="slots-wrap" id="slots-wrap">
          <div class="hint">Choose a date above to view live slots.</div>
        </div>
      </div>

      <div class="field" style="margin-top:10px;">
        <div class="section-title">Select Language</div>
        <div class="pill-row" id="lang-pills">
          <button type="button" class="lang-pill active" data-lang="English">English</button>
          <button type="button" class="lang-pill" data-lang="Arabic">Arabic</button>
          <button type="button" class="lang-pill" data-lang="Bahasa">Bahasa</button>
          <button type="button" class="lang-pill" data-lang="Vietnamese">Vietnamese</button>
          <button type="button" class="lang-pill" data-lang="Filipino">Filipino</button>
          <button type="button" class="lang-pill" data-lang="Thai">Thai</button>
        </div>
      </div>

      <button type="submit" class="btn btn-primary" id="step-2-submit">
        <span>Confirm Class Time</span><span aria-hidden="true">‚úÖ</span>
      </button>
      <div class="cta-note">
        Note: Free class will be conducted by reputed teachers.<br/>
        By continuing I agree to be contacted by Unischooly via WhatsApp / Phone / Email for this booking.
      </div>
      <div class="global-error" id="error-step-2" style="display:none;"></div>
    </form>

    <!-- STEP 3 -->
    <form id="step-3" class="hidden">
      <div class="top-row">
        <div class="back-link" data-back="2">
          <span class="icon">‚Üê</span><span>Back</span>
        </div>
        <div style="color:var(--muted);font-size:0.78rem;">Step 3 of 3</div>
      </div>
      <h2 class="section-title">Help us personalise your experience</h2>

      <div class="field" style="margin-top:10px;">
        <div class="section-sub">Who are you?</div>
        <div class="chip-row" id="who-chips">
          <button type="button" class="chip" data-who="Parent">Parent</button>
          <button type="button" class="chip" data-who="Student">Student</button>
          <button type="button" class="chip" data-who="Guardian">Guardian</button>
        </div>
      </div>

      <div class="field" style="margin-top:8px;">
        <div class="section-sub">Why are you booking this trial class?</div>
        <div class="chip-row" id="reason-chips">
          <button type="button" class="chip" data-reason="Want to buy course">Want to buy course</button>
          <button type="button" class="chip" data-reason="To Compare Platform">To Compare Platform</button>
          <button type="button" class="chip" data-reason="To strengthen Concept">To strengthen Concept</button>
          <button type="button" class="chip" data-reason="Just for free demo">Just for free demo</button>
        </div>
      </div>

      <div class="field" style="margin-top:8px;">
        <div class="section-sub">When are you planning to purchase?</div>
        <div class="chip-row" id="timeline-chips">
          <button type="button" class="chip" data-timeline="After the Demo">After the Demo</button>
          <button type="button" class="chip" data-timeline="This Week">This Week</button>
          <button type="button" class="chip" data-timeline="This Month">This Month</button>
          <button type="button" class="chip" data-timeline="Just Exploring">Just Exploring</button>
        </div>
      </div>

      <button type="submit" class="btn btn-primary" id="step-3-submit">
        <span>Submit</span><span aria-hidden="true">üöÄ</span>
      </button>
      <div class="global-error" id="error-step-3" style="display:none;"></div>
    </form>

    <!-- SUCCESS -->
    <section id="success-section" class="hidden">
      <h2 class="section-title">Your trial is booked! üéâ</h2>
      <p class="section-sub">Your trial is booked! Check your WhatsApp &amp; email for details.</p>
    </section>
  </main>
</div>

<script>
  // ---------- CONFIG ----------
  const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";

  // after step 3, redirect here (change if needed)
  const INTERIM_REDIRECT_URL = "/book-trial-class/interim";

  // courseId from URL (?courseId=1)
  const COURSE_ID = Number(new URLSearchParams(window.location.search).get("courseId")) || 1;

  // Minimal mapping; extend this array from your CSV as needed.
  const COUNTRY_OPTIONS = [
    // US (multiple TZ, same region)
    { code:"US", name:"United States ‚Äî Eastern",  timeZone:"America/New_York",    dialCode:"+1",  region_key:"USA" },
    { code:"US", name:"United States ‚Äî Central",  timeZone:"America/Chicago",     dialCode:"+1",  region_key:"USA" },
    { code:"US", name:"United States ‚Äî Mountain", timeZone:"America/Denver",      dialCode:"+1",  region_key:"USA" },
    { code:"US", name:"United States ‚Äî Pacific",  timeZone:"America/Los_Angeles", dialCode:"+1",  region_key:"USA" },

    // India (adjust region_key if needed)
    { code:"IN", name:"India ‚Äî IST", timeZone:"Asia/Kolkata", dialCode:"+91", region_key:"INDIA" },

    // MEA
    { code:"AE", name:"UAE ‚Äî Dubai (GMT+4)",      timeZone:"Asia/Dubai",  dialCode:"+971", region_key:"MEA" },
    { code:"SA", name:"Saudi Arabia ‚Äî Riyadh",    timeZone:"Asia/Riyadh", dialCode:"+966", region_key:"MEA" },

    // SEA
    { code:"SG", name:"Singapore",                timeZone:"Asia/Singapore",   dialCode:"+65", region_key:"SEA" },
    { code:"MY", name:"Malaysia ‚Äî Kuala Lumpur",  timeZone:"Asia/Kuala_Lumpur",dialCode:"+60", region_key:"SEA" },
    { code:"ID", name:"Indonesia ‚Äî Jakarta",      timeZone:"Asia/Jakarta",     dialCode:"+62", region_key:"SEA" },
    { code:"PH", name:"Philippines ‚Äî Manila",     timeZone:"Asia/Manila",      dialCode:"+63", region_key:"SEA" },
    { code:"TH", name:"Thailand ‚Äî Bangkok",       timeZone:"Asia/Bangkok",     dialCode:"+66", region_key:"SEA" },
    { code:"VN", name:"Vietnam ‚Äî Ho Chi Minh",    timeZone:"Asia/Ho_Chi_Minh", dialCode:"+84", region_key:"SEA" },

    // Europe
    { code:"GB", name:"United Kingdom ‚Äî London",  timeZone:"Europe/London", dialCode:"+44", region_key:"EUROPE" },
    { code:"DE", name:"Germany ‚Äî Berlin",         timeZone:"Europe/Berlin", dialCode:"+49", region_key:"EUROPE" },
    { code:"FR", name:"France ‚Äî Paris",           timeZone:"Europe/Paris", dialCode:"+33", region_key:"EUROPE" }
  ];

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function $(s){return document.querySelector(s);}
  function $all(s){return Array.from(document.querySelectorAll(s));}

  let leadId = null;
  let selectedRegionKey = null;
  let selectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
  let selectedSlot = null;
  let selectedLang = "English";
  let utmParams = {};
  let clientMeta = {
    ip_address:null,
    browser:navigator.userAgent || null,
    device_type:/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)?"mobile":"desktop",
    internet_speed_mbps:null
  };

  try{
    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    if(conn && typeof conn.downlink === "number"){
      clientMeta.internet_speed_mbps = conn.downlink;
    }
  }catch(e){}

  function setStep(step){
    $("#step-1").classList.toggle("hidden", step !== 1);
    $("#step-2").classList.toggle("hidden", step !== 2);
    $("#step-3").classList.toggle("hidden", step !== 3);
    $("#success-section").classList.toggle("hidden", step !== 4);

    $all("[data-step-bar]").forEach(el=>{
      const s = Number(el.dataset.stepBar);
      el.classList.remove("active","current");
      if(s < step) el.classList.add("active");
      if(s === step) el.classList.add("current");
    });
  }

  function qsError(step){ return document.getElementById("error-step-"+step); }

  function parseUtm(){
    const params = new URLSearchParams(window.location.search);
    ["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(k=>{
      const v = params.get(k);
      if(v) utmParams[k]=v;
    });
  }

  async function detectCountry(){
    try{
      const res = await fetch("https://ipapi.co/json/");
      if(!res.ok) return;
      const data = await res.json();
      clientMeta.ip_address = data.ip || null;
      const cc = data.country || data.country_code;
      if(cc){
        const match = COUNTRY_OPTIONS.find(c=>c.code === cc);
        if(match){
          $("#phone-country-code").value =
            match.dialCode+"|"+match.timeZone+"|"+match.region_key+"|"+match.name;
          selectedRegionKey = match.region_key;
          selectedTimezone = match.timeZone;
        }
      }
    }catch(e){
      console.warn("IP detection failed", e);
    }
  }

  function initCountryDropdown(){
    const select = $("#phone-country-code");
    COUNTRY_OPTIONS.forEach(opt=>{
      const o = document.createElement("option");
      o.value = opt.dialCode+"|"+opt.timeZone+"|"+opt.region_key+"|"+opt.name;
      o.textContent = `${opt.dialCode} ${opt.name}`;
      select.appendChild(o);
    });
    select.addEventListener("change",()=>{
      const [dial,tz,region,name] = select.value.split("|");
      selectedRegionKey = region;
      selectedTimezone = tz;
    });
    if(select.options.length){
      const [dial,tz,region,name] = select.options[0].value.split("|");
      selectedRegionKey = region;
      selectedTimezone = tz;
    }
  }

  async function saveLeadStep1(){
    const [phone_country_code, tz, region_key, countryName] =
      $("#phone-country-code").value.split("|");

    const phone_number = $("#phone-number").value.trim();
    const child_name = $("#child-name").value.trim();
    const child_grade = $("#child-grade").value;
    const parent_name = $("#parent-name").value.trim();
    const parent_email = $("#parent-email").value.trim();
    const hasLaptop = document.querySelector("input[name='has-laptop']:checked")?.value === "yes";

    const payload = {
      child_name,
      child_grade:String(child_grade),
      parent_name,
      parent_email,
      phone_country_code,
      phone_number,
      is_whatsapp:true,
      has_laptop:hasLaptop?"yes":"no",
      course_id:COURSE_ID,
      region_key:region_key,
      country:countryName,
      timezone:tz,
      landing_page_path:window.location.pathname,
      full_url:window.location.href,
      ip_address:clientMeta.ip_address,
      browser:clientMeta.browser,
      device_type:clientMeta.device_type,
      internet_speed_mbps:clientMeta.internet_speed_mbps,
      page_completed:1,
      ...utmParams
    };

    // insert; if unique phone conflict, update instead
    const { data, error } = await supabase
      .from("demo_leads")
      .insert(payload)
      .select("id")
      .maybeSingle();

    if(error){
      if(error.code === "23505" || (error.message && error.message.includes("unique_lead_per_phone"))){
        const existing = await supabase
          .from("demo_leads")
          .select("id")
          .eq("phone_country_code", phone_country_code)
          .eq("phone_number", phone_number)
          .maybeSingle();
        if(existing.error) throw existing.error;
        if(existing.data && existing.data.id){
          leadId = existing.data.id;
          const upd = await supabase
            .from("demo_leads")
            .update(payload)
            .eq("id", leadId);
          if(upd.error) throw upd.error;
          return;
        }
      }
      throw error;
    } else {
      leadId = data && data.id ? data.id :
               (Array.isArray(data) && data[0] && data[0].id) || leadId;
    }
  }

  function getIstDateRange(days){
    const out = [];
    const now = new Date();
    for(let i=0;i<days;i++){
      const d = new Date(now.getTime() + i*24*60*60*1000);
      const parts = new Intl.DateTimeFormat("en-CA",{
        timeZone:"Asia/Kolkata",
        year:"numeric",
        month:"2-digit",
        day:"2-digit"
      }).formatToParts(d);
      const y = parts.find(p=>p.type==="year").value;
      const m = parts.find(p=>p.type==="month").value;
      const da = parts.find(p=>p.type==="day").value;
      const iso = `${y}-${m}-${da}`;
      const js = new Date(`${iso}T00:00:00+05:30`);
      out.push({ iso, js });
    }
    return out;
  }

  async function loadSlotsForRange(){
    const pillsWrap = $("#date-pills");
    const slotsWrap = $("#slots-wrap");
    pillsWrap.innerHTML = "";
    slotsWrap.innerHTML = '<div class="hint">Loading slots‚Ä¶</div>';
    selectedSlot = null;

    if(!selectedRegionKey){
      slotsWrap.innerHTML = '<div class="hint">Please go back and choose a country / code to detect region.</div>';
      return;
    }

    const range = getIstDateRange(6);
    const fromIso = range[0].iso;
    const toIso = range[range.length-1].iso;

    const { data, error } = await supabase
      .from("demo_slots_live_view")
      .select("*")
      .eq("course_id", COURSE_ID)
      .eq("region_key", selectedRegionKey)
      .gte("slot_date", fromIso)
      .lte("slot_date", toIso);

    if(error){
      console.error("Slots load error", error);
      slotsWrap.innerHTML = '<div class="hint">Could not load slots. Please try again later.</div>';
      return;
    }

    const slots = (data || []).slice().sort((a,b)=>{
      const da = new Date(a.slot_datetime_local || a.slot_datetime_ist);
      const db = new Date(b.slot_datetime_local || b.slot_datetime_ist);
      return da - db;
    });

    const grouped = {};
    slots.forEach(s=>{
      if(!grouped[s.slot_date]) grouped[s.slot_date]=[];
      grouped[s.slot_date].push(s);
    });

    range.forEach(({iso,js})=>{
      const btn = document.createElement("button");
      btn.type="button";
      btn.className="date-pill";
      btn.dataset.dateIso = iso;
      const count = (grouped[iso] || []).length;
      btn.innerHTML = `
        <div class="dow">${js.toLocaleDateString(undefined,{weekday:"short"})}</div>
        <div class="dom">${js.toLocaleDateString(undefined,{month:"short",day:"numeric"})}</div>
        <div class="dom">${count ? count+" slots" : "No slots"}</div>
      `;
      if(!count){
        btn.disabled = true;
        btn.style.opacity = "0.5";
      }else{
        btn.addEventListener("click",()=>{
          $all(".date-pill").forEach(p=>p.classList.remove("active"));
          btn.classList.add("active");
          renderSlotsForDate(grouped[iso]);
        });
      }
      pillsWrap.appendChild(btn);
    });

    const firstWithSlots = range.find(r => (grouped[r.iso]||[]).length);
    if(firstWithSlots){
      const btn = $all(".date-pill").find(b=>b.dataset.dateIso===firstWithSlots.iso);
      if(btn) btn.click();
    }else{
      slotsWrap.innerHTML = '<div class="hint">No live slots available in the next 6 days for your region.</div>';
    }
  }

  function renderSlotsForDate(slotsForDate){
    const wrap = $("#slots-wrap");
    wrap.innerHTML = "";
    selectedSlot = null;

    const tz = selectedTimezone || "UTC";

    const sorted = slotsForDate.slice().sort((a,b)=>{
      const da = new Date(a.slot_datetime_local || a.slot_datetime_ist);
      const db = new Date(b.slot_datetime_local || b.slot_datetime_ist);
      return da - db;
    });

    if(!sorted.length){
      wrap.innerHTML = '<div class="hint">No slots available for this date.</div>';
      return;
    }

    sorted.forEach(slot=>{
      const iso = slot.slot_datetime_local || slot.slot_datetime_ist;
      const localLabel = new Date(iso).toLocaleTimeString(undefined,{
        hour:"2-digit",
        minute:"2-digit",
        hour12:true,
        timeZone:tz
      });

      const row = document.createElement("div");
      row.className="slot-row";
      row.dataset.slotId = slot.slot_id || slot.id;
      row.innerHTML = `
        <div>
          <div>${localLabel}</div>
          <div class="slot-meta">${tz}</div>
        </div>
        ${slot.is_star_teacher ? `<div class="tag-star"><span class="badge-dot"></span><span>Star Teacher</span></div>` : ""}
      `;
      row.addEventListener("click",()=>{
        $all(".slot-row").forEach(r=>r.classList.remove("active"));
        row.classList.add("active");
        selectedSlot = {
          slot_id: row.dataset.slotId,
          slot_date: slot.slot_date,
          local_label: localLabel,
          is_star_teacher: !!slot.is_star_teacher
        };
      });
      wrap.appendChild(row);
    });
  }

  async function saveLeadStep2(){
    if(!selectedSlot) throw new Error("No slot selected");
    const payload = {
      preferred_date:selectedSlot.slot_date,
      preferred_time_slot:selectedSlot.local_label,
      slot_id:selectedSlot.slot_id,
      lang:selectedLang,
      star_teacher_selected:selectedSlot.is_star_teacher,
      page_completed:2
    };
    if(leadId){
      const { error } = await supabase
        .from("demo_leads")
        .update(payload)
        .eq("id", leadId);
      if(error) throw error;
    }else{
      const { data, error } = await supabase
        .from("demo_leads")
        .insert({ ...payload, course_id:COURSE_ID })
        .select("id")
        .maybeSingle();
      if(error) throw error;
      leadId = data && data.id ? data.id : leadId;
    }
  }

  async function saveLeadStep3(who,reason,timeline){
    const payload = {
      who_are_you:who,
      booking_reason:reason,
      purchase_timeline:timeline,
      page_completed:3
    };
    if(leadId){
      const { error } = await supabase
        .from("demo_leads")
        .update(payload)
        .eq("id", leadId);
      if(error) throw error;
    }else{
      const { data, error } = await supabase
        .from("demo_leads")
        .insert({ ...payload, course_id:COURSE_ID })
        .select("id")
        .maybeSingle();
      if(error) throw error;
      leadId = data && data.id ? data.id : leadId;
    }
  }

  document.addEventListener("DOMContentLoaded",()=>{
    initCountryDropdown();
    detectCountry();
    parseUtm();
    setStep(1);

    $("#step-1").addEventListener("submit",async e=>{
      e.preventDefault();
      const errBox = qsError(1);
      errBox.style.display="none";

      const phone = $("#phone-number").value.trim();
      const child = $("#child-name").value.trim();
      const grade = $("#child-grade").value;
      const parent = $("#parent-name").value.trim();
      const email = $("#parent-email").value.trim();

      if(!phone || !child || !grade || !parent || !email){
        errBox.textContent = "Please fill all required fields.";
        errBox.style.display="block";
        return;
      }

      const btn = $("#step-1-submit");
      btn.disabled = true;
      btn.textContent = "Saving details‚Ä¶";

      try{
        await saveLeadStep1();
        setStep(2);
        await loadSlotsForRange();
      }catch(err){
        console.error("Step1 error", err);
        errBox.textContent = "We couldn't save your details. Please try again.";
        errBox.style.display="block";
      }finally{
        btn.disabled = false;
        btn.textContent = "Book a Free Trial Class";
      }
    });

    $all("[data-back]").forEach(el=>{
      el.addEventListener("click",()=>{
        const step = Number(el.dataset.back);
        setStep(step);
      });
    });

    $("#step-2").addEventListener("submit",async e=>{
      e.preventDefault();
      const errBox = qsError(2);
      errBox.style.display="none";

      if(!selectedSlot){
        errBox.textContent = "Please select a class time.";
        errBox.style.display="block";
        return;
      }

      const btn = $("#step-2-submit");
      btn.disabled = true;
      btn.textContent = "Locking your slot‚Ä¶";

      try{
        await saveLeadStep2();
        setStep(3);
      }catch(err){
        console.error("Step2 error", err);
        errBox.textContent = "We couldn't save your selected slot. Please try again.";
        errBox.style.display="block";
      }finally{
        btn.disabled = false;
        btn.textContent = "Confirm Class Time";
      }
    });

    $all(".lang-pill").forEach(p=>{
      p.addEventListener("click",()=>{
        $all(".lang-pill").forEach(x=>x.classList.remove("active"));
        p.classList.add("active");
        selectedLang = p.dataset.lang;
      });
    });

    function initChipGroup(id, attr){
      const chips = $all("#"+id+" .chip");
      chips.forEach(ch=>{
        ch.addEventListener("click",()=>{
          chips.forEach(c=>c.classList.remove("active"));
          ch.classList.add("active");
        });
      });
      return ()=> {
        const active = chips.find(c=>c.classList.contains("active"));
        return active ? active.getAttribute(attr) : null;
      };
    }

    const getWho = initChipGroup("who-chips","data-who");
    const getReason = initChipGroup("reason-chips","data-reason");
    const getTimeline = initChipGroup("timeline-chips","data-timeline");

    $("#step-3").addEventListener("submit",async e=>{
      e.preventDefault();
      const errBox = qsError(3);
      errBox.style.display="none";

      const who = getWho();
      const reason = getReason();
      const timeline = getTimeline();

      if(!who || !reason || !timeline){
        errBox.textContent = "Please select all options.";
        errBox.style.display="block";
        return;
      }

      const btn = $("#step-3-submit");
      btn.disabled = true;
      btn.textContent = "Submitting‚Ä¶";

      try{
        await saveLeadStep3(who,reason,timeline);
        setStep(4);
        setTimeout(()=>{ window.location.href = INTERIM_REDIRECT_URL; }, 1200);
      }catch(err){
        console.error("Step3 error", err);
        errBox.textContent = "We couldn't submit your booking. Please try again.";
        errBox.style.display="block";
      }finally{
        btn.disabled = false;
        btn.textContent = "Submit";
      }
    });
  });
</script>
</body>
</html>
