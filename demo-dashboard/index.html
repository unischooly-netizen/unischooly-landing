<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unischooly ‚Ä¢ Trial Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#060b14;
      --bg1:#091327;
      --card:#0d1833cc;
      --card2:#0b142bdd;
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.16);
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.70);
      --muted2:rgba(234,241,255,.55);
      --gold:#f7d98a;
      --gold2:#caa24c;
      --pink:#ff4fd8;
      --purple:#8b5cf6;
      --blue:#4cc9ff;
      --teal:#2dd4bf;
      --ok:#22c55e;
      --danger:#ef4444;
      --shadow: 0 20px 70px rgba(0,0,0,.45);
      --r24:24px;
      --r18:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 18% 15%, rgba(139,92,246,.22) 0%, rgba(139,92,246,0) 55%),
        radial-gradient(900px 600px at 82% 35%, rgba(76,201,255,.18) 0%, rgba(76,201,255,0) 50%),
        radial-gradient(900px 600px at 35% 85%, rgba(45,212,191,.12) 0%, rgba(45,212,191,0) 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* ====== SECTION 1 (Top bar) ====== */
    .topbar{
      width:100%;
      background: rgba(6,11,20,0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .topContent {
        width: min(1200px, 100%);
        margin: 0 auto;
        padding: 14px 22px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:14px;
    }
    .brand{ display:flex; align-items:center; gap:14px; }
    .brand img{
      height:34px;
      width:auto;
      display:block;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
    }
    .status-pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 16px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(90deg, rgba(255,79,216,.22), rgba(139,92,246,.22), rgba(76,201,255,.22));
      box-shadow: 0 12px 40px rgba(0,0,0,.30);
      backdrop-filter: blur(10px);
      font-weight:800;
      font-size: 0.9rem;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .status-pill .check{
      width:20px;height:20px;border-radius:999px;
      display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(16,185,129,.95));
      box-shadow: 0 5px 15px rgba(34,197,94,.22);
      color:#04110b;
      font-weight:900;
      font-size: 12px;
    }

    /* ====== SECTION 2 (Main layout) ====== */
    .wrap{
      width:min(1200px, 100%);
      margin:0 auto;
      padding:24px 22px 40px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:24px;
      align-items:start;
    }

    /* FIX: Better Mobile Stacking */
    @media (max-width: 900px){
      .grid2{grid-template-columns: 1fr;}
      .topContent{padding:12px 16px}
      .wrap{padding:16px 16px 40px}
      .brand img{height:28px}
      .status-pill{font-size:12px; padding: 6px 12px;}
    }

    .card{
      background: linear-gradient(180deg, rgba(13,24,51,.88), rgba(8,14,28,.88));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r24);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      position:relative;
    }
    .card.pad{padding:24px}
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
      margin:20px 0;
    }

    /* ====== Ticket/Pass Card ====== */
    .ticket{
      padding:20px;
      position:relative;
      border-radius: var(--r24);
      border:2px solid var(--gold); /* Gold Border */
      background:
        radial-gradient(900px 420px at 10% 10%, rgba(139,92,246,.20), rgba(139,92,246,0) 55%),
        linear-gradient(180deg, rgba(9,16,34,.95), rgba(5,10,22,.95));
      box-shadow: 0 0 25px rgba(247,217,138, 0.15); /* Glow */
      overflow:hidden;
      transition: transform .22s ease;
    }
    .ticket:hover{ transform: translateY(-2px); box-shadow: 0 0 35px rgba(247,217,138, 0.25); }

    /* Perforation line */
    .perforation{
      position:absolute;
      top:80px; left:50%; transform:translateX(-50%);
      width:1px; height: calc(100% - 100px);
      background: repeating-linear-gradient(to bottom, rgba(247,217,138,.5) 0 6px, transparent 6px 12px);
    }
    .notch{
      position:absolute; top:50%; width:24px;height:24px; border-radius:50%;
      background: #0d1833; border:1px solid rgba(255,255,255,.1);
      z-index: 5;
    }
    .notch.left{left:-12px}
    .notch.right{right:-12px}

    /* Ticket Header */
    .ticketHeader{
      display:flex; justify-content:space-between; align-items:center;
      padding-bottom: 12px;
      border-bottom: 2px dashed rgba(255,255,255,0.15);
      margin-bottom: 16px;
    }
    .ticketHeader span {
        font-weight: 800; font-size: 14px; letter-spacing: 1px; color: var(--gold); text-transform: uppercase;
    }

    /* FIX: Stamp Position Top Right */
    .stamp{
      position:absolute;
      top: 15px;
      right: 15px;
      border: 3px double #ef4444;
      color: #ef4444;
      padding: 4px 8px;
      font-weight: 900;
      font-size: 11px;
      text-transform: uppercase;
      transform: rotate(-12deg);
      border-radius: 4px;
      background: rgba(0,0,0,0.3);
      z-index: 10;
      letter-spacing: 1px;
    }

    .ticketBody{
      display:grid;
      grid-template-columns: 1fr 1fr; /* Two Columns */
      gap: 20px;
    }
    @media (max-width: 600px){
      .ticketBody{grid-template-columns: 1fr;} /* Stack on mobile */
      .perforation{display:none} 
    }

    .field{ margin-bottom: 12px; }
    .k{ font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;}
    .v{ font-size: 14px; font-weight: 700; color: #fff; word-break: break-word; }

    .powered{ margin-top:16px; text-align:center; font-size:11px; color: rgba(255,255,255,0.4); }

    /* ====== Schedule Card ====== */
    .scheduleTop{ display:flex; align-items:center; gap:10px; margin-bottom:16px; }
    .badge{
      padding:6px 12px; border-radius:20px; background: rgba(255,255,255,0.08); font-weight:700; font-size:13px;
    }
    .mini{
      background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.1); border-radius: 12px;
      padding: 12px; display:flex; align-items:center; gap: 12px; margin-bottom: 10px;
    }
    .mini .ico{ font-size: 20px; }
    .mini .t { font-weight: 700; font-size: 15px; }
    .mini .s { font-size: 12px; color: var(--muted); }

    .calendarBtn{
      width:100%; border:none; padding:12px; border-radius:30px;
      background: linear-gradient(90deg, #ff4fd8, #8b5cf6, #4cc9ff);
      color: #000; font-weight: 800; font-size: 14px; cursor: pointer;
      margin-top: 10px;
      transition: transform 0.2s;
    }
    .calendarBtn:hover{ transform: scale(1.02); }

    .providers{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; display:none;}
    .chip{ padding:6px 12px; border-radius:20px; background:rgba(255,255,255,0.1); font-size:12px; cursor:pointer; }
    
    /* ====== Fun Facts ====== */
    .funfacts { margin-top: 20px; background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; border-left: 3px solid var(--purple); }
    .factTitle { font-weight: 800; font-size: 13px; color: var(--purple); margin-bottom: 6px; text-transform: uppercase;}
    .factText { font-size: 13px; line-height: 1.5; color: var(--muted); min-height: 40px;}
    .factsNav { display:flex; justify-content: flex-end; gap: 8px; margin-top: 8px;}
    .navBtn { background: rgba(255,255,255,0.1); border:none; color:white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer;}

    /* ====== Welcome + Timer ====== */
    .welcomeTitle { font-size: 20px; font-weight: 800; margin-bottom: 8px; line-height: 1.3; text-align: center;}
    .welcomeTitle .accent { color: var(--pink); }
    .subline { text-align: center; font-size: 13px; color: var(--muted); margin-bottom: 24px; }

    .countRow {
        display:flex; justify-content:center; gap: 8px; margin-bottom: 24px;
    }
    .tb { background: #000; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; min-width: 60px; text-align: center;}
    .tb .n { font-size: 20px; font-weight: 800; display: block; line-height: 1;}
    .tb .l { font-size: 10px; text-transform: uppercase; color: var(--muted); margin-top: 4px;}

    /* FIX: Join Button Centered Below Timer */
    .joinWrapper { display: flex; justify-content: center; margin-bottom: 16px; }
    .joinBtn {
        background: #10b981; color: #000; padding: 14px 32px; border-radius: 50px; font-weight: 800; font-size: 16px; border:none; cursor: pointer;
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); transition: transform 0.2s;
    }
    .joinBtn:disabled { background: #333; color: #666; box-shadow: none; cursor: not-allowed; }
    .joinBtn:not(:disabled):hover { transform: scale(1.05); }

    .disclaimer { text-align: center; font-size: 12px; color: var(--muted2); }
    .link { color: var(--gold); text-decoration: underline; cursor: pointer; }

    /* ====== Reschedule UI (Pills) ====== */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: flex-end; justify-content: center;}
    .overlay.open { display: flex; }
    .sheet { background: #0f172a; width: 100%; max-width: 600px; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 24px; border-top: 1px solid rgba(255,255,255,0.1); animation: slideUp 0.3s ease-out;}
    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }

    .sheetHead { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center;}
    .sheetHead h2 { margin: 0; font-size: 18px; color: #fff;}
    .closeX { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer;}

    .resLabel { font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; }
    
    /* Scrollable Date Pills */
    .dateScroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; scrollbar-width: none; }
    .datePill { 
        min-width: 70px; height: 75px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
        display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
    }
    .datePill.active { background: var(--gold); color: #000; border-color: var(--gold); }
    .datePill span:first-child { font-size: 11px; text-transform: uppercase; }
    .datePill span:last-child { font-size: 20px; font-weight: 800; }

    /* Time Grid Pills */
    .timeGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
    .timePill { 
        padding: 10px; text-align: center; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
        border-radius: 8px; font-size: 13px; cursor: pointer; color: var(--text);
    }
    .timePill.active { background: var(--gold); color: #000; border-color: var(--gold); font-weight: 700; }

    .tzSelect { width: 100%; padding: 12px; border-radius: 8px; background: #000; color: #fff; border: 1px solid #333; margin-bottom: 20px; }

    .saveBtn { width: 100%; padding: 14px; background: #fff; color: #000; font-weight: 800; border: none; border-radius: 12px; cursor: pointer; }

    /* Games Styles (Minimal) */
    .brainHeader { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; margin-bottom: 12px;}
    .gameTabs { display: flex; background: rgba(255,255,255,0.1); padding: 4px; border-radius: 20px; }
    .gTab { padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer; color: var(--muted); }
    .gTab.active { background: var(--purple); color: #fff; font-weight: 700; }
    .gamePanel { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 16px; min-height: 150px; text-align: center; }
    .gameInput { background: #000; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 6px; text-align: center; width: 80px; margin-top: 10px;}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topContent">
        <div class="brand">
        <img src="https://res.cloudinary.com/dpapyknn4/image/upload/v1763143023/Unischooly_Horizontal_logo_qbu1l7.svg" alt="Unischooly" />
        </div>

        <div class="status-pill" id="lockedPill" title="Status">
        <div class="check">‚úì</div>
        <div>Your trial class is locked in!</div>
        </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid2">
      <section>
        <div class="ticket" id="ticketCard">
          <div class="notch left"></div>
          <div class="notch right"></div>
          <div class="perforation"></div>

          <div class="stamp">VALUE WAIVED</div>

          <div class="ticketHeader">
            <span>OFFICIAL ENTRY PASS</span>
            <span style="opacity: 0.6">üé´ ADMIT ONE</span>
          </div>

          <div class="ticketBody">
            <div>
              <div class="field"><div class="k">Student Name</div><div class="v" id="v_child_name">Loading...</div></div>
              <div class="field"><div class="k">Grade</div><div class="v" id="v_child_grade">--</div></div>
              <div class="field"><div class="k">Course</div><div class="v" id="v_course_name">--</div></div>
            </div>
            <div>
              <div class="field"><div class="k">Parent Name</div><div class="v" id="v_parent_name">--</div></div>
              <div class="field"><div class="k">Phone</div><div class="v" id="v_parent_phone">--</div></div>
              <div class="field"><div class="k">Email</div><div class="v" id="v_parent_email" style="font-size: 12px;">--</div></div>
            </div>
          </div>

          <div class="powered">Powered by <b>Unischooly</b></div>
        </div>

        <div class="card pad" style="margin-top: 24px;">
            <div class="scheduleTop">
                <div class="badge">üöÄ Ready for Blast Off!!!</div>
            </div>
            
            <div class="mini">
                <div class="ico">üìÖ</div>
                <div>
                    <div class="t" id="v_demo_date">--</div>
                    <div class="s">Date</div>
                </div>
            </div>
            <div class="mini">
                <div class="ico">‚è∞</div>
                <div>
                    <div class="t" id="v_demo_time">--</div>
                    <div class="s" id="v_demo_tz">Timezone</div>
                </div>
            </div>

            <button class="calendarBtn" id="calendarSyncBtn">üìÖ Initiate Calendar Sync</button>
            <div class="providers" id="calendarProviders">
                <div class="chip" data-cal="google">Google</div>
                <div class="chip" data-cal="apple">Apple</div>
                <div class="chip" data-cal="outlook">Outlook</div>
            </div>

            <div class="funfacts">
                <div class="factTitle">DID YOU KNOW?</div>
                <div class="factText" id="factText">Loading...</div>
                <div class="factsNav">
                    <button class="navBtn" id="factPrev">‚Äπ</button>
                    <button class="navBtn" id="factNext">‚Ä∫</button>
                </div>
            </div>
        </div>
      </section>

      <section class="card pad">
        <h1 class="welcomeTitle">Welcome to <span class="accent" id="welcomeName">Student</span>'s <br>Trial Class</h1>
        <p class="subline">Class starts in:</p>

        <div class="countRow" id="countRow">
            <div class="tb"><div class="n" id="t_days">00</div><div class="l">Days</div></div>
            <div class="tb"><div class="n" id="t_hours">00</div><div class="l">Hrs</div></div>
            <div class="tb"><div class="n" id="t_mins">00</div><div class="l">Mins</div></div>
            <div class="tb"><div class="n" id="t_secs">00</div><div class="l">Secs</div></div>
        </div>

        <div class="joinWrapper">
            <button class="joinBtn" id="joinBtn" disabled>Join Class</button>
        </div>

        <div class="disclaimer">
            <div style="margin-bottom: 8px;">(Button activates 5 mins before class)</div>
            <span class="link" id="openTerms">Terms & Conditions</span> ‚Ä¢ 
            <span class="link" id="openReschedule">Reschedule Class</span>
        </div>

        <div class="divider"></div>

        <div class="brainHeader">
            <h3 style="margin:0; font-size:16px;">Sharpen Your Brain üß†</h3>
            <div class="gameTabs">
                <div class="gTab active" onclick="switchGame('math', this)">Math</div>
                <div class="gTab" onclick="switchGame('memory', this)">Memory</div>
            </div>
        </div>
        
        <div class="gamePanel" id="gamePanel">
            <div id="gMath">
                <h2 id="mathQ" style="margin:10px 0;">5 + 3 = ?</h2>
                <input type="number" id="mathIn" class="gameInput">
                <button onclick="checkMath()" style="padding:6px 12px; border-radius:6px; background:var(--pink); border:none; margin-left:8px; cursor:pointer;">Check</button>
                <div id="mathRes" style="margin-top:10px; font-weight:700; color: var(--ok);"></div>
            </div>
            <div id="gMem" style="display:none;">
                <p>Memory Game Loading...</p>
                <button onclick="switchGame('math', document.querySelector('.gTab'))" style="padding:8px;">Back to Math</button>
            </div>
        </div>

      </section>
    </div>
  </main>

  <div class="overlay" id="resOverlay">
    <div class="sheet">
        <div class="sheetHead">
            <h2>Reschedule Class</h2>
            <button class="closeX" id="closeRes">‚úï</button>
        </div>

        <div class="resLabel">Select New Date</div>
        <div class="dateScroll" id="datePillsContainer">
            </div>

        <div class="resLabel">Select New Time</div>
        <div class="timeGrid" id="timePillsContainer">
            <div class="timePill" onclick="selectTime(this, '10:00')">10:00 AM</div>
            <div class="timePill" onclick="selectTime(this, '11:00')">11:00 AM</div>
            <div class="timePill" onclick="selectTime(this, '14:00')">02:00 PM</div>
            <div class="timePill" onclick="selectTime(this, '15:00')">03:00 PM</div>
            <div class="timePill" onclick="selectTime(this, '16:00')">04:00 PM</div>
            <div class="timePill" onclick="selectTime(this, '17:00')">05:00 PM</div>
        </div>

        <div class="resLabel">Timezone</div>
        <select class="tzSelect" id="resTz">
            <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
            <option value="America/New_York">America/New_York (EST)</option>
            <option value="Europe/London">Europe/London (GMT)</option>
            <option value="Asia/Dubai">Asia/Dubai (GST)</option>
        </select>

        <button class="saveBtn" id="resSave">Confirm Reschedule</button>
    </div>
  </div>

  <div class="overlay" id="termsOverlay">
    <div class="sheet">
        <div class="sheetHead"><h2>Terms</h2><button class="closeX" id="closeTerms">‚úï</button></div>
        <ul style="color:#ccc; line-height:1.6; padding-left:20px;">
            <li>Class is recorded for quality purposes.</li>
            <li>Zero tolerance for bullying.</li>
            <li>Parental supervision advised.</li>
        </ul>
    </div>
  </div>

<script>
/* =========================
   CONFIG & HELPERS
========================= */
const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const qs = new URLSearchParams(location.search);
const $ = (id)=>document.getElementById(id);

// Course Data
const FUNFACTS = {
  1: ["Coding is logic!", "First bug was a moth.", "Computers use binary.", "Python is not a snake."],
  2: ["Python reads like English.", "Used by NASA.", "Great for AI.", "Indentation matters."],
  3: ["HTML is structure.", "CSS is style.", "JS is logic.", "The web is huge."]
};
let lead = null;
let classUtc = null;
let selectedDateVal = null; // For Reschedule Logic
let selectedTimeVal = null;

/* =========================
   INIT & DATA FETCH
========================= */
async function loadLead(){
  const iduuid = qs.get("iduuid");
  if(!iduuid) { alert("Missing ID in URL"); return; }

  const { data, error } = await sb.from("demo_leads").select("*").eq("id", iduuid).maybeSingle();
  
  if(error || !data){ console.error(error); alert("Booking not found"); return; }
  lead = data;

  // Render Pass
  $("v_child_name").textContent = lead.child_name;
  $("v_child_grade").textContent = lead.child_grade || "--";
  $("v_parent_name").textContent = lead.parent_name;
  $("v_parent_phone").textContent = `+${lead.phone_country_code} ${lead.phone_number}`;
  $("v_parent_email").textContent = lead.parent_email;
  $("v_course_name").textContent = getCourseName(lead.course_id);
  $("welcomeName").textContent = lead.child_name;

  // Schedule
  $("v_demo_date").textContent = lead.preferred_date;
  $("v_demo_time").textContent = lead.preferred_time_slot;
  $("v_demo_tz").textContent = lead.timezone;
  
  // Reschedule Pre-fill
  $("resTz").value = lead.timezone || "Asia/Kolkata";

  // Countdown
  if(lead.preferred_date && lead.preferred_time_slot) {
     const dateStr = `${lead.preferred_date}T${lead.preferred_time_slot}:00`; // Naive parse
     classUtc = new Date(dateStr); 
     startCountdown();
  }

  setupFunFacts(lead.course_id);
}

function getCourseName(id){
    const map = {1:"Coding", 2:"Python", 3:"Web Dev", 4:"GenAI", 5:"Roblox", 6:"Chess", 7:"Math"};
    return map[id] || "Course";
}

/* =========================
   COUNTDOWN
========================= */
function startCountdown(){
    setInterval(()=>{
        if(!classUtc) return;
        const now = new Date();
        const diff = classUtc - now;
        
        if(diff <= 0) {
            if(Math.abs(diff) < 3600000) enableJoin(true); // Live
            else { $("joinBtn").innerText = "Class Ended"; $("countRow").style.opacity = 0.5; }
            return;
        }

        const d = Math.floor(diff / (1000*60*60*24));
        const h = Math.floor((diff / (1000*60*60)) % 24);
        const m = Math.floor((diff / 1000 / 60) % 60);
        const s = Math.floor((diff / 1000) % 60);

        $("t_days").innerText = d<10?"0"+d:d;
        $("t_hours").innerText = h<10?"0"+h:h;
        $("t_mins").innerText = m<10?"0"+m:m;
        $("t_secs").innerText = s<10?"0"+s:s;

        if(diff <= 300000) enableJoin(false); // 5 mins
    }, 1000);
}

function enableJoin(live){
    const b = $("joinBtn");
    if(b.disabled){
        b.disabled = false;
        b.innerText = live ? "JOIN NOW (LIVE)" : "JOIN CLASS";
        b.onclick = () => alert("Joining Zoom...");
    }
}

/* =========================
   RESCHEDULE LOGIC (PILLS)
========================= */
function initReschedulePills(){
    const con = $("datePillsContainer");
    const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    let html = "";
    for(let i=1; i<=14; i++){
        const d = new Date(); d.setDate(d.getDate()+i);
        const iso = d.toISOString().split('T')[0];
        html += `<div class="datePill" onclick="selectDate(this, '${iso}')">
            <span>${days[d.getDay()]}</span>
            <span>${d.getDate()}</span>
        </div>`;
    }
    con.innerHTML = html;
}

window.selectDate = (el, val) => {
    document.querySelectorAll('.datePill').forEach(x => x.classList.remove('active'));
    el.classList.add('active');
    selectedDateVal = val;
}
window.selectTime = (el, val) => {
    document.querySelectorAll('.timePill').forEach(x => x.classList.remove('active'));
    el.classList.add('active');
    selectedTimeVal = val;
}

$("resSave").onclick = async () => {
    if(!lead?.id) return;
    if(!selectedDateVal || !selectedTimeVal) { alert("Please select date and time"); return; }
    
    const tz = $("resTz").value;
    const { error } = await sb.from("demo_leads").update({
        preferred_date: selectedDateVal,
        preferred_time_slot: selectedTimeVal,
        timezone: tz
    }).eq("id", lead.id);

    if(error) alert("Error updating");
    else { alert("Rescheduled!"); location.reload(); }
}

/* =========================
   UI INTERACTIONS
========================= */
// Modal Toggles
$("openReschedule").onclick = () => { $("resOverlay").classList.add("open"); initReschedulePills(); }
$("closeRes").onclick = () => $("resOverlay").classList.remove("open");
$("openTerms").onclick = () => $("termsOverlay").classList.add("open");
$("closeTerms").onclick = () => $("termsOverlay").classList.remove("open");
$("calendarSyncBtn").onclick = () => $("calendarProviders").style.display = "flex";

// Fun Facts
let fIdx = 0;
function setupFunFacts(cid){
    const list = FUNFACTS[cid] || FUNFACTS[1];
    const render = () => $("factText").innerText = list[fIdx];
    $("factNext").onclick = () => { fIdx = (fIdx+1)%list.length; render(); }
    $("factPrev").onclick = () => { fIdx = (fIdx-1+list.length)%list.length; render(); }
    render();
}

// Math Game
let sum = 0;
function newMath(){
    let a=Math.floor(Math.random()*10), b=Math.floor(Math.random()*10);
    sum = a+b;
    $("mathQ").innerText = `${a} + ${b} = ?`;
    $("mathIn").value = "";
    $("mathRes").innerText = "";
}
window.checkMath = () => {
    if(parseInt($("mathIn").value) === sum) {
        $("mathRes").innerText = "Correct! üéâ"; setTimeout(newMath, 1000);
    } else $("mathRes").innerText = "Try Again";
}
window.switchGame = (g, el) => {
    document.querySelectorAll('.gTab').forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
    $("gMath").style.display = g==='math'?'block':'none';
    $("gMem").style.display = g==='memory'?'block':'none';
}

// Start
loadLead();
newMath();

</script>
</body>
</html>
