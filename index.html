<!-- ===============================
   UNISCHOOLY - HEADER + HERO + STEP 1 FORM
   Version: 1.5 (Mobile radio layout + slightly brighter hero image)
================================ -->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Unischooly - Book a Free Trial Class</title>

<!-- International telephone input (for country code + flags + search) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@17.0.19/build/css/intlTelInput.css"/>

<style>
/* GLOBAL */
:root {
  --primary-gradient: linear-gradient(135deg, #ff6bcb, #8459ff, #36d1dc);
  --primary-gradient-soft: linear-gradient(135deg, rgba(255,107,203,0.85), rgba(132,89,255,0.9), rgba(54,209,220,0.85));
  --card-bg: #161922;
  --page-bg: #050716;
  --input-bg: #0f111a;
  --muted: rgba(255,255,255,0.7);
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #020617;
  color: #f9fafb;
  overflow-x: hidden;
}

.container {
  width: 100%;
  max-width: 1180px;
  margin: 0 auto;
  padding: 0 16px;
}

/* ===================================
   HEADER
=================================== */

header {
  width: 100%;
  padding: 18px 0;
  background: rgba(2, 6, 23, 0.85);
  backdrop-filter: blur(14px);
  position: fixed;
  top: 0;
  z-index: 999;
}

.navbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 18px;
}

/* Gradient logo using provided SVG as mask */
.logo {
  width: 170px;
  height: 40px;
  background-image: var(--primary-gradient);
  -webkit-mask: url("https://res.cloudinary.com/dpapyknn4/image/upload/v1763143023/Unischooly_Horizontal_logo_qbu1l7.svg") no-repeat center;
          mask: url("https://res.cloudinary.com/dpapyknn4/image/upload/v1763143023/Unischooly_Horizontal_logo_qbu1l7.svg") no-repeat center;
  -webkit-mask-size: contain;
          mask-size: contain;
  cursor: pointer;
  transition: box-shadow 0.25s ease, transform 0.25s ease, filter 0.25s ease;
  filter: drop-shadow(0 0 10px rgba(255,107,203,0.18));
}

.logo:hover,
.logo:active {
  transform: translateY(-1px);
  filter: drop-shadow(0 0 10px rgba(255,107,203,0.9))
          drop-shadow(0 0 18px rgba(54,209,220,0.9));
}

/* Nav links */
.nav-links {
  display: flex;
  align-items: center;
  gap: 22px;
  margin-left: auto;
}

.nav-link {
  position: relative;
  font-size: 14px;
  font-weight: 500;
  color: rgba(226,232,240,0.9);
  text-decoration: none;
  cursor: pointer;
  transition: color 0.2s ease, text-shadow 0.2s ease, transform 0.2s ease;
}

.nav-link::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: -4px;
  width: 0;
  height: 2px;
  border-radius: 999px;
  background-image: var(--primary-gradient);
  transition: width 0.25s ease;
}

.nav-link:hover,
.nav-link:active {
  color: #e5e7eb;
  text-shadow: 0 0 10px rgba(255,107,203,0.9), 0 0 18px rgba(54,209,220,0.9);
  transform: translateY(-1px);
}

.nav-link:hover::after,
.nav-link:active::after {
  width: 100%;
}

/* CTA button in header */
.book-btn {
  background-image: var(--primary-gradient);
  padding: 10px 22px;
  border-radius: 999px;
  font-size: 15px;
  cursor: pointer;
  transition: 0.25s ease;
  border: none;
  outline: none;
  box-shadow: 0 8px 24px rgba(0,0,0,0.45);
  white-space: nowrap;
  color: #f9fafb;
}

/* Mobile: make CTA appear black (as requested) */
@media (max-width: 640px) {
  .nav-links {
    display: none;
  }

  .book-btn {
    background: #020617;
    border: 1px solid rgba(148,163,184,0.85);
    box-shadow: 0 6px 16px rgba(15,23,42,0.9);
  }
}

.book-btn:hover,
.book-btn:active {
  opacity: 0.9;
  box-shadow: 0 12px 32px rgba(0,0,0,0.6);
  transform: translateY(-1px);
}

/* ===================================
   HERO SECTION + BACKGROUND OVERLAY
=================================== */

.hero-section {
  position: relative;
  padding-top: 140px; /* clears fixed header */
  padding-bottom: 80px;
  overflow: hidden;
  background-color: #020617;
  background-image: url("https://res.cloudinary.com/dpapyknn4/image/upload/v1765120532/kid-coding-infographic-icon-neon-boy-programming-on-laptop-in-computer-language-children-learning-kids-coding-school-teach-to-create-computer-and-mobile-phone-apps-vector_kswxdi.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

/* Dark + neon gradient overlay to keep content readable
   while underlying hero image stays slightly more visible */
.hero-section::before {
  content: "";
  position: absolute;
  inset: 0;
  background:
    radial-gradient(circle at top left, rgba(132,89,255,0.16), transparent 55%),
    radial-gradient(circle at bottom right, rgba(54,209,220,0.16), transparent 55%),
    linear-gradient(135deg, rgba(2,6,23,0.78), rgba(8,1,22,0.82));
  z-index: 0;
}

.hero {
  position: relative;
  z-index: 1;
  display: flex;
  justify-content: space-between;
  gap: 40px;
  flex-wrap: wrap;
}

/* LEFT SIDE */

.hero-left {
  width: 48%;
  min-width: 320px;
}

.hero-left h1 {
  font-size: 44px;
  font-weight: 800;
  line-height: 1.2;
  margin-bottom: 12px;
  cursor: default;
  transition: text-shadow 0.25s ease, transform 0.25s ease;
}

.hero-left h1 span {
  background-image: var(--primary-gradient);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

/* Glow on hover / click for main heading */
.hero-left h1:hover,
.hero-left h1:active {
  text-shadow: 0 0 18px rgba(255,107,203,0.9), 0 0 32px rgba(54,209,220,0.9);
  transform: translateY(-1px);
}

.hero-left p {
  font-size: 18px;
  color: var(--muted);
  margin-bottom: 20px;
}

/* Badges */
.badge-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
  max-width: 420px;
  margin-top: 16px;
}

.badge {
  background: rgba(15,23,42,0.9);
  padding: 10px 14px;
  border-radius: 999px;
  font-size: 14px;
  border: 1px solid rgba(148,163,184,0.45);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  white-space: nowrap;
}

/* ===================================
   FORM CARD
=================================== */

.form-card {
  width: 420px;
  max-width: 100%;
  background: var(--card-bg);
  padding: 26px 24px 24px;
  border-radius: 20px;
  box-shadow: 0px 0px 40px rgba(0,0,0,0.55);
  position: relative;
  overflow: hidden;
}

.form-card::before {
  content: "";
  position: absolute;
  inset: -1px;
  border-radius: inherit;
  padding: 1px;
  background-image: var(--primary-gradient-soft);
  -webkit-mask:
    linear-gradient(#000 0 0) content-box,
    linear-gradient(#000 0 0);
  -webkit-mask-composite: xor;
          mask-composite: exclude;
}

/* Keep inner content above gradient border mask */
.form-inner {
  position: relative;
  z-index: 1;
}

/* Form header + subtle glow on hover */
.form-title {
  margin: 0 0 8px;
  font-size: 20px;
  font-weight: 700;
  cursor: default;
  background-image: var(--primary-gradient);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  transition: text-shadow 0.25s ease, transform 0.25s ease;
}

.form-title:hover,
.form-title:active {
  text-shadow: 0 0 12px rgba(255,107,203,0.9), 0 0 26px rgba(54,209,220,0.85);
  transform: translateY(-0.5px);
}

.form-subtitle {
  margin: 0 0 14px;
  font-size: 13px;
  color: var(--muted);
}

/* Two-step indicator line */
.step-indicator {
  display: flex;
  gap: 6px;
  align-items: center;
  margin-bottom: 18px;
}

.step-bar {
  flex: 1;
  height: 4px;
  border-radius: 999px;
  background: rgba(30,64,175,0.5);
}

.step-bar.active {
  background-image: var(--primary-gradient);
}

/* Labels + inputs */

label {
  font-size: 14px;
  color: rgba(226,232,240,0.95);
  display: block;
}

.field-wrapper {
  margin-bottom: 14px;
}

/* Extra sub-label row for phone field (Country code / Mobile number) */
.phone-field .phone-sub-label-row {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: rgba(148,163,184,0.9);
  margin-top: 4px;
}

.phone-field input#parentPhone {
  margin-top: 4px;
}

/* Telephone input plugin wraps input in .iti */
.iti {
  width: 100%;
}

/* Underlying input styling */
input,
select {
  width: 100%;
  margin-top: 6px;
  padding: 12px 12px;
  border-radius: 10px;
  border: 1px solid rgba(30,64,175,0.3);
  outline: none;
  background: var(--input-bg);
  color: #f9fafb;
  font-size: 15px;
  transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}

input:focus,
select:focus {
  border-color: rgba(129,140,248,0.9);
  box-shadow: 0 0 0 1px rgba(129,140,248,0.6);
  background: #020617;
}

/* Style intl-tel-input dropdown + search for dark theme */
.iti__country-list {
  background: #020617;
  border-radius: 12px;
  border: 1px solid #374151;
  box-shadow: 0 18px 40px rgba(15,23,42,0.9);
}

.iti__country {
  background: #020617;
  color: #e5e7eb;
}

.iti__country.iti__highlight {
  background: #111827;
}

.iti__search-input {
  background: #020617;
  color: #e5e7eb;
  border-radius: 8px;
  border: 1px solid #374151;
}

.iti__search-input::placeholder {
  color: #6b7280;
}

/* Laptop / Desktop question */
.radio-group {
  margin: 4px 0 10px;
}

.radio-label {
  font-size: 14px;
  margin: 0 0 6px;
  color: rgba(226,232,240,0.95);
}

.radio-options {
  display: flex;
  align-items: center;
  gap: 18px;
}

.radio-option {
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
}

.radio-option input[type="radio"] {
  accent-color: #ff6bcb;
}

/* CTA button inside card */

.submit-btn {
  width: 100%;
  padding: 15px 0;
  margin-top: 14px;
  background-image: var(--primary-gradient);
  border-radius: 999px; /* fully round */
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
  border: none;
  outline: none;
  transition: 0.25s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  box-shadow: 0 12px 30px rgba(15,23,42,0.9);
  color: #020617; /* black text on gradient */
}

.submit-btn span.icon {
  font-size: 18px;
}

.submit-btn:hover,
.submit-btn:active {
  opacity: 0.95;
  transform: translateY(-1px);
  box-shadow: 0 16px 40px rgba(15,23,42,1);
}

/* Form message */
.form-message {
  margin-top: 8px;
  font-size: 13px;
}

.form-message.error {
  color: #fca5a5;
}

.form-message.success {
  color: #bbf7d0;
}


/* STEP 2: DATE & TIME SLOT LIST (Option B style) */

.step2-intro {
  margin: 4px 0 14px;
  font-size: 13px;
  color: var(--muted);
}

.slot-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 240px;
  overflow-y: auto;
  padding-right: 4px;
}

.slot-list-empty {
  font-size: 13px;
  color: var(--muted);
  margin: 4px 0;
}

.slot-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 10px;
  background: rgba(15,23,42,0.9);
  border: 1px solid rgba(55,65,81,0.8);
  font-size: 14px;
  cursor: pointer;
  transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, transform 0.15s ease;
}

.slot-main {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.slot-time {
  font-weight: 600;
  color: #e5e7eb;
}

.slot-meta {
  font-size: 12px;
  color: var(--muted);
}

.slot-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.slot-tag {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.6);
  color: rgba(209,213,219,0.95);
}

.slot-tag.star {
  border-color: transparent;
  background-image: var(--primary-gradient);
  color: #020617;
  box-shadow: 0 0 12px rgba(255,107,203,0.4);
}

.slot-row.full {
  opacity: 0.45;
  cursor: not-allowed;
}

.slot-row.full .slot-time,
.slot-row.full .slot-meta {
  text-decoration: line-through;
}

.slot-row.selected {
  border-color: rgba(129,140,248,0.95);
  box-shadow: 0 0 0 1px rgba(129,140,248,0.8), 0 16px 30px rgba(15,23,42,0.9);
  transform: translateY(-1px);
}

.slot-row:hover:not(.full):not(.selected) {
  border-color: rgba(129,140,248,0.8);
  background: #020617;
}

.step2-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin-top: 16px;
}

/* Secondary button for "Back" */
.secondary-btn {
  flex: 0 0 auto;
  padding: 11px 18px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.7);
  background: #020617;
  color: #e5e7eb;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease, transform 0.15s ease;
}

.secondary-btn:hover,
.secondary-btn:active {
  border-color: rgba(209,213,219,0.9);
  background: #020617;
  box-shadow: 0 10px 26px rgba(15,23,42,0.9);
  transform: translateY(-1px);
}

/* On very small screens, keep list compact */
@media (max-width: 640px) {
  .slot-row {
    padding: 9px 10px;
  }
  .slot-meta {
    font-size: 11px;
  }
}

/* Floating CTA for mobile */
.floating-cta {
  position: fixed;
  left: 50%;
  bottom: 16px;
  transform: translateX(-50%);
  padding: 14px 22px;
  border-radius: 999px;
  border: none;
  outline: none;
  background-image: var(--primary-gradient);
  box-shadow: 0 18px 40px rgba(15,23,42,1);
  color: #020617;
  font-size: 15px;
  font-weight: 600;
  display: none;
  align-items: center;
  justify-content: center;
  gap: 8px;
  z-index: 998;
  white-space: nowrap; /* keep one line */
}


/* Mobile-only tweaks for phone country dropdown and Child Grade height */
@media (max-width: 640px) {
  /* Keep intl-tel-input country dropdown as a smaller scrollable sheet instead of full-screen */
  .iti-mobile .iti--container {
    top: 150px !important;          /* roughly under hero/form area */
    bottom: auto !important;
    left: 50% !important;
    transform: translateX(-50%);
    width: 92% !important;
    max-height: 320px;
  }

  .iti-mobile .iti__country-list {
    max-height: 260px !important;
    overflow-y: auto !important;
  }

  /* Make Child Grade select the same visual height as other inputs on mobile */
  #childGrade {
    height: 48px;
    padding-top: 12px;
    padding-bottom: 12px;
  }
}
/* Only show floating CTA on small screens */
@media (max-width: 640px) {
  .floating-cta {
    display: inline-flex;
  }

  /* mobile tweak for Laptop / Desktop radios: keep Yes / No on one line with better spacing */
  .radio-options {
    justify-content: flex-start;
    gap: 72px;
  }
}

/* Responsive */
@media (max-width: 900px) {
  .hero {
    flex-direction: column;
  }
  .hero-left,
  .form-card {
    width: 100%;
  }
}

@media (max-width: 640px) {
  .hero-left h1 {
    font-size: 34px;
  }
  .badge-grid {
    grid-template-columns: minmax(0, 1fr);
  }
}
</style>
</head>

<body>

<header>
  <div class="container navbar">
    <div class="logo" onclick="window.scrollTo({top:0, behavior:'smooth'})" aria-label="Unischooly logo"></div>

    <nav class="nav-links">
      <a href="#programs" class="nav-link">Programs</a>
      <a href="#experts" class="nav-link">Meet our Experts</a>
      <a href="#curriculum" class="nav-link">Curriculum</a>
      <a href="#faqs" class="nav-link">FAQs</a>
    </nav>

    <button class="book-btn" type="button" onclick="scrollToForm()">Book Trial Class</button>
  </div>
</header>

<section class="hero-section">
  <div class="container hero">

    <!-- LEFT TEXT -->
    <div class="hero-left">
      <h1>Book a <span>Free Live Coding Class</span><br>for your child.</h1>
      <p>A personalised 60-minute class to introduce your child to coding, logic skills &amp; futuristic learning.</p>

      <div class="badge-grid">
        <div class="badge">‚è± <span>60-min Live Class</span></div>
        <div class="badge">üë©‚Äçüè´ <span>Top 1% Certified Teachers</span></div>
        <div class="badge">üåé <span>Kids in 30+ Countries</span></div>
        <div class="badge">üöÄ <span>Hands-On Projects</span></div>
      </div>
    </div>

    <!-- RIGHT FORM -->
    <div class="form-card" id="formCard">
      <div class="form-inner">
        <h2 class="form-title">Book Now &amp; Get Certified</h2>
        <p class="form-subtitle">Step 1 of 2 ¬∑ Share your child &amp; parent details to unlock a personalised trial class.</p>

        <!-- Gradient 2-step indicator line -->
        <div class="step-indicator">
          <div class="step-bar active"></div>
          <div class="step-bar"></div>
        </div>

        <div id="step1Fields">
        <!-- PHONE (country code + number in one field) -->
        <div class="field-wrapper phone-field">
          <label for="parentPhone">Parent WhatsApp Number</label>
          <div class="phone-sub-label-row">
            <span>Country code</span>
            <span>Mobile number</span>
          </div>
          <input type="tel" id="parentPhone" name="parentPhone" placeholder="Enter mobile number" />
        </div>

        <div class="field-wrapper">
          <label for="childName">Child Name</label>
          <input type="text" id="childName" name="childName" placeholder="Enter child's name" />
        </div>

        <div class="field-wrapper">
          <label for="childGrade">Child Grade</label>
          <select id="childGrade" name="childGrade">
            <option value="">Select Grade</option>
            <option>Grade 1</option><option>Grade 2</option><option>Grade 3</option><option>Grade 4</option>
            <option>Grade 5</option><option>Grade 6</option><option>Grade 7</option><option>Grade 8</option>
            <option>Grade 9</option><option>Grade 10</option><option>Grade 11</option><option>Grade 12</option>
          </select>
        </div>

        <div class="field-wrapper">
          <label for="parentName">Parent Name</label>
          <input type="text" id="parentName" name="parentName" placeholder="Enter parent name" />
        </div>

        <div class="field-wrapper">
          <label for="parentEmail">Parent Email</label>
          <input type="email" id="parentEmail" name="parentEmail" placeholder="Enter email" />
        </div>

        <!-- Laptop / Desktop question -->
        <div class="radio-group">
          <p class="radio-label">Do you have a Laptop or Desktop?</p>
          <div class="radio-options">
            <label class="radio-option">
              <input type="radio" name="hasComputer" value="yes" checked />
              <span>Yes</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="hasComputer" value="no" />
              <span>No</span>
            </label>
          </div>
        </div>

        <button class="submit-btn" type="button" id="submitLead">
          <span>Book a Free Trial Class</span>
          <span class="icon">‚ú®</span>
        </button>

        </div>

        <div id="step2Fields" style="display:none;">
          <p class="step2-intro">Great! Now pick a convenient date & time for your child's live class.</p>

          <div class="field-wrapper">
            <label for="preferredDateSelect">Preferred Date</label>
            <select id="preferredDateSelect" name="preferredDateSelect">
              <option value="">Loading available dates...</option>
            </select>
          </div>

          <div class="field-wrapper">
            <label>Available Time Slots</label>
            <div id="slotList" class="slot-list">
              <p class="slot-list-empty">Select a date to see available slots.</p>
            </div>
          </div>

          <div class="step2-actions">
            <button type="button" class="secondary-btn" id="backToStep1">‚Üê Back</button>
            <button type="button" class="submit-btn" id="confirmSlotBtn" disabled>
              <span>Confirm &amp; Continue</span>
              <span class="icon">‚û°Ô∏è</span>
            </button>
          </div>
        </div>

        <div id="formMessage" class="form-message"></div>
      </div>
    </div>

  </div>
</section>

<!-- Floating CTA (mobile) -->
<button class="floating-cta" type="button" onclick="scrollToForm()">
  <span>Book a Free Trial Class</span>
  <span>‚ú®</span>
</button>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@17.0.19/build/js/intlTelInput.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
function scrollToForm() {
  const form = document.getElementById("formCard");
  if (form) {
    form.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}

document.addEventListener("DOMContentLoaded", function () {
  /* PHONE INPUT INITIALISATION */
  const phoneInput = document.querySelector("#parentPhone");
  let iti;

  if (phoneInput && window.intlTelInput) {
    iti = window.intlTelInput(phoneInput, {
      initialCountry: "us", // Default to USA
      separateDialCode: true,
      autoPlaceholder: "polite",
      preferredCountries: [
        "us","ca","gb","ae","sa","kw","qa","bh","om",
        "id","ph","th",
        "sg","vn","au","nz",
        "in","bd","jp","my",
        "za","ng"
      ],
      utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@17.0.19/build/js/utils.js"
    });
  }

  /* URL PARAMS (for future course_id filter etc.) */
  const urlParams = new URLSearchParams(window.location.search);
  const courseIdParam = urlParams.get("courseId");
  const courseIdFilter = courseIdParam && !isNaN(parseInt(courseIdParam, 10))
    ? parseInt(courseIdParam, 10)
    : null;

  /* SUPABASE SETUP */
  const supabaseUrl = "https://binklfyiypbhuzsvnlzg.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";
  const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

  /* MULTI-STEP STATE */
  let currentLeadId = null;
  let currentRegionRule = null;
  let slotsByDate = {};
  let selectedSlot = null; // full slot object

  const submitBtn = document.getElementById("submitLead");
  const messageEl = document.getElementById("formMessage");
  const preferredDateSelect = document.getElementById("preferredDateSelect");
  const slotListEl = document.getElementById("slotList");
  const backToStep1Btn = document.getElementById("backToStep1");
  const confirmSlotBtn = document.getElementById("confirmSlotBtn");

  const step1Fields = document.getElementById("step1Fields");
  const step2Fields = document.getElementById("step2Fields");
  const stepBars = document.querySelectorAll(".step-bar");
  const subtitleEl = document.querySelector(".form-subtitle");

  function setStep(step) {
    if (!step1Fields || !step2Fields) return;

    if (step === 1) {
      step1Fields.style.display = "block";
      step2Fields.style.display = "none";

      if (stepBars[0]) stepBars[0].classList.add("active");
      if (stepBars[1]) stepBars[1].classList.remove("active");

      if (subtitleEl) {
        subtitleEl.textContent =
          "Step 1 of 2 ¬∑ Share your child & parent details to unlock a personalised trial class.";
      }
    } else {
      step1Fields.style.display = "none";
      step2Fields.style.display = "block";

      if (stepBars[0]) stepBars[0].classList.add("active");
      if (stepBars[1]) stepBars[1].classList.add("active");

      if (subtitleEl) {
        subtitleEl.textContent =
          "Step 2 of 2 ¬∑ Choose a convenient date & time for your child‚Äôs trial class.";
      }
    }
  }

  function formatDateLabel(dateObj) {
    const weekdays = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const dayName = weekdays[dateObj.getDay()];
    const monthName = months[dateObj.getMonth()];
    const day = String(dateObj.getDate()).padStart(2, "0");
    return `${dayName}, ${day} ${monthName}`;
  }

  function formatTimeLabel(dateObj) {
    let hours = dateObj.getHours();
    const minutes = String(dateObj.getMinutes()).padStart(2, "0");
    const ampm = hours >= 12 ? "PM" : "AM";
    hours = hours % 12;
    if (hours === 0) hours = 12;
    return `${hours}:${minutes} ${ampm}`;
  }

  function addMinutes(dateObj, minutes) {
    return new Date(dateObj.getTime() + minutes * 60000);
  }

  async function fetchRegionRuleForCountry(countryIso2) {
    if (!countryIso2) return null;
    const upperIso = countryIso2.toUpperCase();

    try {
      const { data, error } = await supabaseClient
        .from("region_time_rules")
        .select("*")
        .eq("is_active", true)
        .ilike("countries", `%${upperIso}%`);

      if (error) {
        console.error("Error fetching region_time_rules:", error);
        return null;
      }
      if (!data || !data.length) {
        console.warn("No region_time_rules match for country:", upperIso);
        return null;
      }
      return data[0];
    } catch (err) {
      console.error("Unexpected error while fetching region rule:", err);
      return null;
    }
  }

  async function loadSlotsForRegion(regionRule) {
    slotsByDate = {};
    selectedSlot = null;

    if (slotListEl) {
      slotListEl.innerHTML = '<p class="slot-list-empty">Loading slots...</p>';
    }
    if (confirmSlotBtn) {
      confirmSlotBtn.disabled = true;
    }

    const now = new Date();
    const maxDaysAhead = regionRule && typeof regionRule.max_days_ahead === "number"
      ? regionRule.max_days_ahead
      : 6;

    const future = new Date(now.getTime() + maxDaysAhead * 24 * 60 * 60 * 1000);

    let query = supabaseClient
      .from("demo_slots")
      .select("*")
      .eq("is_active", true)
      .gt("slot_start_ist", now.toISOString())
      .lt("slot_start_ist", future.toISOString())
      .order("slot_start_ist", { ascending: true });

    if (regionRule && regionRule.region_key) {
      query = query.eq("region_key", regionRule.region_key);
    }

    if (courseIdFilter !== null) {
      query = query.eq("course_id", courseIdFilter);
    }

    let slotsData;
    try {
      const { data, error } = await query;
      if (error) {
        console.error("Error fetching demo_slots:", error);
        if (slotListEl) {
          slotListEl.innerHTML = '<p class="slot-list-empty">Unable to load slots. Please try again.</p>';
        }
        return;
      }
      slotsData = data || [];
    } catch (err) {
      console.error("Unexpected error while fetching slots:", err);
      if (slotListEl) {
        slotListEl.innerHTML = '<p class="slot-list-empty">Unable to load slots. Please try again.</p>';
      }
      return;
    }

    if (!slotsData.length) {
      if (slotListEl) {
        slotListEl.innerHTML = '<p class="slot-list-empty">No slots available right now. Our team will contact you on WhatsApp.</p>';
      }
      if (preferredDateSelect) {
        preferredDateSelect.innerHTML = '<option value="">No dates available</option>';
      }
      return;
    }

    const offsetMinutes = regionRule && typeof regionRule.timezone_offset_min === "number"
      ? regionRule.timezone_offset_min
      : 0;

    const allSlotsById = {};

    slotsData.forEach((slot) => {
      const istStart = new Date(slot.slot_start_ist);
      const localStart = addMinutes(istStart, offsetMinutes);

      const y = localStart.getFullYear();
      const m = String(localStart.getMonth() + 1).padStart(2, "0");
      const d = String(localStart.getDate()).padStart(2, "0");
      const dateKey = `${y}-${m}-${d}`;

      if (!slotsByDate[dateKey]) {
        slotsByDate[dateKey] = {
          dateObj: new Date(localStart.getTime()),
          slots: []
        };
      }
      slotsByDate[dateKey].slots.push(slot);
      allSlotsById[slot.id] = { slot, localStart };
    });

    window.__unischoolySlotsById = allSlotsById;

    if (preferredDateSelect) {
      preferredDateSelect.innerHTML = '<option value="">Select a date</option>';

      const sortedDateKeys = Object.keys(slotsByDate).sort();
      sortedDateKeys.forEach((dateKey) => {
        const info = slotsByDate[dateKey];
        const option = document.createElement("option");
        option.value = dateKey;
        option.textContent = formatDateLabel(info.dateObj);
        preferredDateSelect.appendChild(option);
      });
    }

    if (slotListEl) {
      slotListEl.innerHTML = '<p class="slot-list-empty">Select a date to see available slots.</p>';
    }
  }

  function renderSlotsForDate(dateKey) {
    if (!slotListEl) return;

    const info = slotsByDate[dateKey];
    if (!info || !info.slots || !info.slots.length) {
      slotListEl.innerHTML = '<p class="slot-list-empty">No slots available for this date.</p>';
      selectedSlot = null;
      if (confirmSlotBtn) confirmSlotBtn.disabled = true;
      return;
    }

    slotListEl.innerHTML = "";

    const offsetMinutes = currentRegionRule && typeof currentRegionRule.timezone_offset_min === "number"
      ? currentRegionRule.timezone_offset_min
      : 0;

    info.slots.forEach((slot) => {
      const istStart = new Date(slot.slot_start_ist);
      const localStart = addMinutes(istStart, offsetMinutes);

      const remaining = (slot.capacity_total || 0) - (slot.capacity_booked || 0);
      const isFull = remaining <= 0;

      const row = document.createElement("div");
      row.className = "slot-row";
      if (isFull) row.classList.add("full");
      if (selectedSlot && selectedSlot.id === slot.id) {
        row.classList.add("selected");
      }

      const main = document.createElement("div");
      main.className = "slot-main";

      const timeEl = document.createElement("div");
      timeEl.className = "slot-time";
      timeEl.textContent = formatTimeLabel(localStart);

      const metaEl = document.createElement("div");
      metaEl.className = "slot-meta";
      if (isFull) {
        metaEl.textContent = "Fully booked";
      } else {
        metaEl.textContent = remaining === 1 ? "1 seat left" : `${remaining} seats left`;
      }

      main.appendChild(timeEl);
      main.appendChild(metaEl);

      const tagsEl = document.createElement("div");
      tagsEl.className = "slot-tags";

      if (slot.is_star_teacher) {
        const starTag = document.createElement("span");
        starTag.className = "slot-tag star";
        starTag.textContent = "‚≠ê Star teacher slot";
        tagsEl.appendChild(starTag);
      }

      if (!isFull) {
        const avTag = document.createElement("span");
        avTag.className = "slot-tag";
        avTag.textContent = "Available";
        tagsEl.appendChild(avTag);
      } else {
        const fullTag = document.createElement("span");
        fullTag.className = "slot-tag";
        fullTag.textContent = "Full";
        tagsEl.appendChild(fullTag);
      }

      row.appendChild(main);
      row.appendChild(tagsEl);

      if (!isFull) {
        row.addEventListener("click", () => {
          const allRows = slotListEl.querySelectorAll(".slot-row");
          allRows.forEach((r) => r.classList.remove("selected"));
          row.classList.add("selected");

          selectedSlot = {
            id: slot.id,
            dateKey,
            localStart: new Date(localStart.getTime()),
            remaining,
            capacity_total: slot.capacity_total,
            capacity_booked: slot.capacity_booked || 0,
            is_star_teacher: !!slot.is_star_teacher
          };

          if (confirmSlotBtn) confirmSlotBtn.disabled = false;
        });
      }

      slotListEl.appendChild(row);
    });

    if (!selectedSlot && confirmSlotBtn) {
      confirmSlotBtn.disabled = true;
    }
  }

  async function handleSubmitStep1() {
    if (!submitBtn) return;

    const childName   = document.getElementById("childName").value.trim();
    const childGrade  = document.getElementById("childGrade").value;
    const parentName  = document.getElementById("parentName").value.trim();
    const parentEmail = document.getElementById("parentEmail").value.trim();
    const hasComputer = (document.querySelector('input[name="hasComputer"]:checked') || {}).value || null;
    const localNumber = phoneInput ? phoneInput.value.trim() : "";

    if (messageEl) {
      messageEl.textContent = "";
      messageEl.classList.remove("error", "success");
    }

    if (!childName || !childGrade || !parentName || !parentEmail || !localNumber) {
      if (messageEl) {
        messageEl.textContent = "Please fill all required fields, including grade.";
        messageEl.classList.add("error");
      }
      return;
    }

    let fullNumber = localNumber;
    let phoneCountryCode = "";
    let countryIso2 = "";

    if (iti) {
      const data = iti.getSelectedCountryData();
      fullNumber = iti.getNumber() || localNumber;
      phoneCountryCode = data && data.dialCode ? "+" + data.dialCode : "";
      countryIso2 = data && data.iso2 ? data.iso2 : "";
    }

    submitBtn.disabled = true;

    try {
      const { data, error } = await supabaseClient
        .from("demo_leads")
        .insert([
          {
            child_name:   childName,
            child_grade:  childGrade,
            parent_name:  parentName,
            parent_email: parentEmail,
            phone_country_code: phoneCountryCode,
            phone_number: fullNumber,
            is_whatsapp: true,
            has_laptop: hasComputer === "yes" ? "yes" : "no"
          }
        ])
        .select("id")
        .limit(1);

      if (error) {
        console.error("Supabase insert error:", error);
        if (messageEl) {
          messageEl.textContent = "Something went wrong while saving your details. Please try again.";
          messageEl.classList.add("error");
        }
      } else if (data && data.length) {
        currentLeadId = data[0].id;
        setStep(2);

        const formCard = document.getElementById("formCard");
        if (formCard) {
          formCard.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        const regionRule = await fetchRegionRuleForCountry(countryIso2);
        currentRegionRule = regionRule;
        await loadSlotsForRegion(regionRule || null);

        if (messageEl) {
          messageEl.textContent = "";
          messageEl.className = "form-message";
        }
      }
    } catch (err) {
      console.error("Unexpected error:", err);
      if (messageEl) {
        messageEl.textContent = "Unexpected error. Please try again.";
        messageEl.classList.add("error");
      }
    } finally {
      submitBtn.disabled = false;
    }
  }

  async function handleConfirmSlot() {
    if (!currentLeadId || !selectedSlot) {
      if (messageEl) {
        messageEl.textContent = "Please select a slot before continuing.";
        messageEl.classList.add("error");
      }
      return;
    }

    if (confirmSlotBtn) confirmSlotBtn.disabled = true;
    if (messageEl) {
      messageEl.textContent = "";
      messageEl.classList.remove("error", "success");
    }

    try {
      const { data: slotUpdateData, error: slotUpdateError } = await supabaseClient
        .from("demo_slots")
        .update({
          capacity_booked: selectedSlot.capacity_booked + 1
        })
        .eq("id", selectedSlot.id)
        .lt("capacity_booked", selectedSlot.capacity_total)
        .select("id, capacity_booked, capacity_total")
        .maybeSingle();

      if (slotUpdateError) {
        console.error("Error updating demo_slots capacity:", slotUpdateError);
        if (messageEl) {
          messageEl.textContent = "That slot just got full. Please pick another slot.";
          messageEl.classList.add("error");
        }
        await loadSlotsForRegion(currentRegionRule || null);
        return;
      }

      if (!slotUpdateData) {
        if (messageEl) {
          messageEl.textContent = "That slot just got full. Please pick another slot.";
          messageEl.classList.add("error");
        }
        await loadSlotsForRegion(currentRegionRule || null);
        return;
      }

      const localIso = selectedSlot.localStart.toISOString();
      const dateOnly = selectedSlot.dateKey;
      const regionKey = currentRegionRule && currentRegionRule.region_key ? currentRegionRule.region_key : null;

      const slotUpdatePayload = {
        preferred_slot_id: selectedSlot.id,
        preferred_slot_local_iso: localIso,
        preferred_slot_date: dateOnly,
        preferred_region_key: regionKey
      };

      const { error: leadUpdateError } = await supabaseClient
        .from("demo_leads")
        .update(slotUpdatePayload)
        .eq("id", currentLeadId);

      if (leadUpdateError) {
        console.error("Error updating demo_leads with slot info:", leadUpdateError);
      }

      if (messageEl) {
        messageEl.textContent = "Your slot is selected! Our team will confirm the booking on WhatsApp shortly.";
        messageEl.classList.add("success");
      }
    } catch (err) {
      console.error("Unexpected error while confirming slot:", err);
      if (messageEl) {
        messageEl.textContent = "Something went wrong while confirming your slot. Please try again.";
        messageEl.classList.add("error");
      }
    } finally {
      if (confirmSlotBtn) confirmSlotBtn.disabled = false;
    }
  }

  if (submitBtn) {
    submitBtn.addEventListener("click", handleSubmitStep1);
  }

  if (preferredDateSelect) {
    preferredDateSelect.addEventListener("change", function () {
      const dateKey = this.value;
      if (dateKey) {
        renderSlotsForDate(dateKey);
      } else if (slotListEl) {
        slotListEl.innerHTML = '<p class="slot-list-empty">Select a date to see available slots.</p>';
        selectedSlot = null;
        if (confirmSlotBtn) confirmSlotBtn.disabled = true;
      }
    });
  }

  if (backToStep1Btn) {
    backToStep1Btn.addEventListener("click", function () {
      setStep(1);
      if (messageEl) {
        messageEl.textContent = "";
        messageEl.className = "form-message";
      }
    });
  }

  if (confirmSlotBtn) {
    confirmSlotBtn.addEventListener("click", handleConfirmSlot);
  }

  setStep(1);
});
</script>

</body>
</html>
