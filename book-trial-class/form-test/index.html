<!-- form-test_full.txt
     Save this file as form-test/index.html in your unischooly-landing repo.
     Single-file functional 3-step booking test (vanilla HTML + JS + Supabase).
-->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Unischooly ‚Äî Booking form test</title>
<style>
  /* Minimal, readable styling */
  body{font-family:Inter,system-ui,-apple-system; background:#041028;color:#dbeafe;padding:20px}
  .card{max-width:900px;margin:0 auto;background:#06102a;padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
  h1{font-size:20px;margin-bottom:6px}
  .muted{color:#93c5fd;font-size:13px;margin-bottom:12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .field{margin-bottom:12px}
  label{display:block;font-size:13px;margin-bottom:6px}
  input,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid #1e293b;background:#021025;color:#dbeafe}
  button{cursor:pointer}
  .radio-chip{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;border:1px solid #13324a;background:#021b33;margin-right:8px;cursor:pointer}
  .radio-chip.selected{background:linear-gradient(90deg,#7c3aed,#06b6d4);color:#021025}
  .slot-dates-row{display:flex;gap:8px;overflow:auto;padding:8px 0;margin-bottom:12px}
  .slot-date-pill{min-width:130px;border-radius:10px;padding:10px;border:1px solid #16324a;background:#021b33;color:#dbeafe;cursor:pointer}
  .slot-date-pill.active{background:linear-gradient(90deg,#7c3aed,#06b6d4);color:#021025}
  .slot-grid{display:flex;flex-wrap:wrap;gap:8px}
  .slot-pill{padding:8px 12px;border-radius:8px;border:1px solid #123047;background:#012033;cursor:pointer}
  .slot-pill.star{box-shadow:0 0 0 2px rgba(250,204,21,0.12),0 6px 18px rgba(2,6,23,0.6)}
  .slot-pill.full{opacity:0.45;cursor:not-allowed}
  .error{color:#fecaca}
  .success{color:#bbf7d0}
  .loader-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:1000}
  .loader-box{background:#021025;padding:22px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);text-align:center}
  .small{font-size:12px;color:#93c5fd}
  .hint{font-size:12px;color:#93c5fd;margin-top:6px}
  .back-link{cursor:pointer;color:#a5b4fc;margin-bottom:10px;display:inline-block}
</style>
</head>
<body>
  <div class="card">
    <h1>Unischooly ‚Äî Booking test (3 steps)</h1>
    <div class="muted">This page tests the backend flow for demo_leads & demo_slots_live. Fill step 1 ‚Üí select slot ‚Üí submit step 3.</div>

    <div id="global-error" class="error" style="margin-bottom:8px"></div>
    <div id="global-success" class="success" style="margin-bottom:8px"></div>

    <!-- STEP 1 -->
    <div id="step-1">
      <h2>Step 1 ‚Äî Contact & child details</h2>

      <div class="field">
        <label>Country</label>
        <div style="display:flex;gap:10px;align-items:center">
          <select id="country-select"></select>
          <div id="country-flag">üè≥Ô∏è</div>
          <div id="country-dial" class="small">+--</div>
        </div>
      </div>

      <div class="field">
        <label>WhatsApp mobile number</label>
        <input id="phone-number" placeholder="Digits only" />
        <div id="phone-error" class="error" style="display:none"></div>
      </div>

      <div class="grid">
        <div class="field">
          <label>Child's name</label>
          <input id="child-name" />
        </div>
        <div class="field">
          <label>Child's grade</label>
          <select id="child-grade">
            <option value="">Select</option>
            <script>for(let i=1;i<=12;i++){document.write(`<option value="Grade ${i}">Grade ${i}</option>`)};</script>
          </select>
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <label>Parent / Guardian name</label>
          <input id="parent-name" />
        </div>
        <div class="field">
          <label>Parent email</label>
          <input id="parent-email" />
          <div id="email-error" class="error" style="display:none"></div>
        </div>
      </div>

      <div class="field">
        <label>Do you have a Laptop or Desktop?</label>
        <div id="has-laptop-group">
          <label class="radio-chip selected" data-value="Yes"><input type="radio" name="has-laptop" checked/> Yes</label>
          <label class="radio-chip" data-value="No"><input type="radio" name="has-laptop"/> No</label>
        </div>
      </div>

      <div style="display:flex;gap:8px">
        <button id="step-1-next">Save & Continue</button>
      </div>
      <div class="hint">We will capture device & browser automatically. You can change country if your child's country differs from your IP.</div>
    </div>

    <!-- STEP 2 -->
    <div id="step-2" style="display:none;margin-top:14px">
      <div class="back-link" id="back-to-step-1">&larr; Back to details</div>
      <h2>Step 2 ‚Äî Date & Time</h2>
      <div class="field">
        <label>Language</label>
        <div id="lang-pills" style="display:flex;gap:8px">
          <div class="radio-chip selected lang-pill" data-lang="English">English</div>
          <div class="radio-chip lang-pill" data-lang="Arabic">Arabic</div>
          <div class="radio-chip lang-pill" data-lang="Bahasa">Bahasa</div>
          <div class="radio-chip lang-pill" data-lang="Vietnamese">Vietnamese</div>
          <div class="radio-chip lang-pill" data-lang="Filipino">Filipino</div>
          <div class="radio-chip lang-pill" data-lang="Thai">Thai</div>
        </div>
      </div>

      <div class="field">
        <label>Select Date</label>
        <div id="slot-dates-row" class="slot-dates-row"></div>
      </div>
      <div class="field">
        <label>Select Start Time (local)</label>
        <div id="slot-times-grid" class="slot-grid"></div>
        <div id="slot-times-empty" style="display:none" class="small">No slots available for this date.</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="step-2-next">Confirm slot & Continue</button>
      </div>
    </div>

    <!-- STEP 3 -->
    <div id="step-3" style="display:none;margin-top:14px">
      <div class="back-link" id="back-to-step-2">&larr; Back to date & time</div>
      <h2>Step 3 ‚Äî Personalise</h2>

      <div class="field">
        <label>Who are you?</label>
        <div id="who-group">
          <label class="radio-chip selected" data-value="Parent">Parent</label>
          <label class="radio-chip" data-value="Student">Student</label>
          <label class="radio-chip" data-value="Guardian">Guardian</label>
        </div>
      </div>

      <div class="field">
        <label>Why are you booking this demo?</label>
        <div id="reason-group">
          <label class="radio-chip selected" data-value="Want to buy course">Want to buy course</label>
          <label class="radio-chip" data-value="To Compare Platform">To Compare Platform</label>
          <label class="radio-chip" data-value="To strengthen Concept">To strengthen Concept</label>
          <label class="radio-chip" data-value="Just for free demo">Just for free demo</label>
        </div>
      </div>

      <div class="field">
        <label>When will you purchase?</label>
        <div id="timeline-group">
          <label class="radio-chip selected" data-value="After the Demo">After the Demo</label>
          <label class="radio-chip" data-value="This Week">This Week</label>
          <label class="radio-chip" data-value="This Month">This Month</label>
          <label class="radio-chip" data-value="Just Exploring">Just Exploring</label>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="step-3-submit">Finish booking</button>
      </div>
    </div>

  </div>

  <div class="loader-modal" id="loader-modal">
    <div class="loader-box">
      <div style="font-weight:700;margin-bottom:8px">Booking your class‚Ä¶</div>
      <div class="small">Please wait ‚Äî we‚Äôre finalising your booking.</div>
    </div>
  </div>

<script type="module">
/* =========================
   Config (use your Supabase)
   ========================= */
const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";

/* Supabase client via ESM (cdn) */
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Table names */
const DEMO_LEADS_TABLE = "demo_leads";
const DEMO_SLOTS_LIVE = "demo_slots_live";

/* =========================
   App state
   ========================= */
const state = {
  leadId: null,
  courseId: null,
  utm: {},
  ipInfo: null,
  selectedCountry: null,
  selectedRegionKey: null,
  selectedTimeZone: null,
  selectedLang: "English",
  selectedDate: null,
  selectedSlotId: null,
  selectedSlotDisplayTime: null,
  selectedSlotIsStar: false,
  slotDataByDate: {},
  localDayKeys: [],
  todayLocalKey: null,
  internetSpeedMbps: 0,
  fmt: null
};

/* =========================
   Static country list
   (Simplified; extend as needed)
   Each entry: id, countryName, dialCode, flag, timeZone, regionKey
   IMPORTANT: keep regionKey values one of: ANZ, EUROPE, ASIA, MEA, SEA, USA, ROW
   ========================= */
const COUNTRY_OPTIONS = [
  { id: "IN", countryName: "India", dialCode: "+91", flag: "üáÆüá≥", timeZone: "Asia/Kolkata", regionKey: "ASIA" },
  { id: "AE", countryName: "United Arab Emirates", dialCode: "+971", flag: "üá¶üá™", timeZone: "Asia/Dubai", regionKey: "MEA" },
  { id: "SA", countryName: "Saudi Arabia", dialCode: "+966", flag: "üá∏üá¶", timeZone: "Asia/Riyadh", regionKey: "MEA" },
  { id: "US", countryName: "United States", dialCode: "+1", flag: "üá∫üá∏", timeZone: "America/New_York", regionKey: "USA" },
  { id: "CA", countryName: "Canada", dialCode: "+1", flag: "üá®üá¶", timeZone: "America/Toronto", regionKey: "USA" },
  { id: "GB", countryName: "United Kingdom", dialCode: "+44", flag: "üá¨üáß", timeZone: "Europe/London", regionKey: "EUROPE" },
  { id: "AU", countryName: "Australia", dialCode: "+61", flag: "üá¶üá∫", timeZone: "Australia/Sydney", regionKey: "ANZ" },
  { id: "NZ", countryName: "New Zealand", dialCode: "+64", flag: "üá≥üáø", timeZone: "Pacific/Auckland", regionKey: "ANZ" },
  { id: "SG", countryName: "Singapore", dialCode: "+65", flag: "üá∏üá¨", timeZone: "Asia/Singapore", regionKey: "SEA" },
  { id: "ID", countryName: "Indonesia", dialCode: "+62", flag: "üáÆüá©", timeZone: "Asia/Jakarta", regionKey: "SEA" },
  { id: "PH", countryName: "Philippines", dialCode: "+63", flag: "üáµüá≠", timeZone: "Asia/Manila", regionKey: "SEA" },
  { id: "VN", countryName: "Vietnam", dialCode: "+84", flag: "üáªüá≥", timeZone: "Asia/Ho_Chi_Minh", regionKey: "SEA" },
  { id: "MY", countryName: "Malaysia", dialCode: "+60", flag: "üá≤üáæ", timeZone: "Asia/Kuala_Lumpur", regionKey: "SEA" },
  { id: "TH", countryName: "Thailand", dialCode: "+66", flag: "üáπüá≠", timeZone: "Asia/Bangkok", regionKey: "SEA" },
  { id: "JP", countryName: "Japan", dialCode: "+81", flag: "üáØüáµ", timeZone: "Asia/Tokyo", regionKey: "ASIA" },
  { id: "CN", countryName: "China", dialCode: "+86", flag: "üá®üá≥", timeZone: "Asia/Shanghai", regionKey: "ASIA" },
  // ... add remaining countries as required
];

/* ---------- Helpers: DOM ---------- */
function $(id){return document.getElementById(id)}
function showGlobalError(msg){$('global-error').textContent=msg; setTimeout(()=>{$('global-error').textContent=''},7000)}
function showGlobalSuccess(msg){$('global-success').textContent=msg; setTimeout(()=>{$('global-success').textContent=''},7000)}
function showLoader(show){$('loader-modal').style.display = show ? 'flex' : 'none'}

/* =========================
   Init: populate countries, parse URL params, detect IP
   ========================= */
function populateCountrySelect(){
  const sel = $('country-select');
  sel.innerHTML = '';
  COUNTRY_OPTIONS.forEach(opt=>{
    const o = document.createElement('option');
    o.value = opt.id;
    o.textContent = `${opt.flag} ${opt.countryName} (${opt.dialCode})`;
    sel.appendChild(o);
  });
  sel.addEventListener('change', handleCountryChange);
  // default to India index 0 if nothing
  sel.value = COUNTRY_OPTIONS[0].id;
  handleCountryChange();
}

function handleCountryChange(){
  const sel = $('country-select');
  const id = sel.value;
  const opt = COUNTRY_OPTIONS.find(o=>o.id===id);
  if(!opt) return;
  state.selectedCountry = opt;
  state.selectedTimeZone = opt.timeZone;
  state.selectedRegionKey = opt.regionKey;
  $('country-flag').textContent = opt.flag;
  $('country-dial').textContent = opt.dialCode;
}

/* Parse URL: courseId, utm, fmt */
function parseUrlParams(){
  const params = new URLSearchParams(window.location.search);
  const c = params.get('courseId');
  state.courseId = c ? parseInt(c,10) : null;
  state.utm.utm_source = params.get('utm_source') || null;
  state.utm.utm_medium = params.get('utm_medium') || null;
  state.utm.utm_campaign = params.get('utm_campaign') || null;
  state.utm.utm_term = params.get('utm_term') || null;
  state.utm.utm_content = params.get('utm_content') || null;
  state.fmt = params.get('fmt') || null;
}

/* IP detect and set selected country/timezone (as default, user can change) */
async function detectIpAndSetCountry(){
  try{
    const r = await fetch('https://ipapi.co/json/');
    const json = await r.json();
    state.ipInfo = json;
    const name = json.country_name;
    if(!name) return;
    const match = COUNTRY_OPTIONS.find(o=>o.countryName===name || o.id===json.country_code);
    if(match){
      $('country-select').value = match.id;
      handleCountryChange();
    }
  }catch(e){
    console.warn('IP detection failed',e);
  }
}

/* Device/browser helpers */
function getDeviceType(){
  const w = window.innerWidth || document.documentElement.clientWidth;
  if(w<=640) return 'mobile';
  if(w<=1024) return 'tablet';
  return 'desktop';
}
function getBrowserInfo(){ return navigator.userAgent || '' }
function detectInternetSpeed(){
  try{
    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    if(conn && typeof conn.downlink === 'number') state.internetSpeedMbps = conn.downlink;
    else state.internetSpeedMbps = 0;
  }catch(e){ state.internetSpeedMbps = 0 }
}

/* =========================
   Validation
   ========================= */
function validatePhone(phone){
  const cleaned = (phone||'').replace(/\D/g,'');
  return cleaned.length>=7 && cleaned.length<=15;
}
function validateEmail(email){
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

/* =========================
   Step 1: Save lead (upsert)
   ========================= */
async function handleStep1Next(){
  $('global-error').textContent='';
  const phoneRaw = $('phone-number').value.trim();
  const phoneDial = state.selectedCountry ? state.selectedCountry.dialCode : '+91';
  const phoneClean = phoneRaw.replace(/\D/g,'');
  const childName = $('child-name').value.trim();
  const childGrade = $('child-grade').value;
  const parentName = $('parent-name').value.trim();
  const parentEmail = $('parent-email').value.trim();
  const hasLaptopEl = document.querySelector('#has-laptop-group .radio-chip.selected');
  const hasLaptop = hasLaptopEl ? hasLaptopEl.getAttribute('data-value') : 'Yes';

  if(!phoneClean || !childName || !childGrade || !parentName || !parentEmail){
    showGlobalError('Please fill all required fields.');
    return;
  }
  if(!validatePhone(phoneClean)){ $('phone-error').style.display='block'; $('phone-error').textContent='Invalid phone number (7-15 digits)'; return } else $('phone-error').style.display='none';
  if(!validateEmail(parentEmail)){ $('email-error').style.display='block'; $('email-error').textContent='Invalid email'; return } else $('email-error').style.display='none';

  const deviceType = getDeviceType();
  const browserInfo = getBrowserInfo();

  const payload = {
    child_name: childName,
    child_grade: childGrade,
    parent_name: parentName,
    parent_email: parentEmail,
    phone_country_code: phoneDial,
    phone_number: phoneClean,
    is_whatsapp: true,
    has_laptop: hasLaptop,
    course_id: state.courseId,
    lang: state.selectedLang ? state.selectedLang.toLowerCase() : 'english',
    utm_source: state.utm.utm_source,
    utm_medium: state.utm.utm_medium,
    utm_campaign: state.utm.utm_campaign,
    utm_term: state.utm.utm_term,
    utm_content: state.utm.utm_content,
    landing_page_path: window.location.pathname,
    full_url: window.location.href,
    ip_address: state.ipInfo?.ip || null,
    city: state.ipInfo?.city || null,
    country: state.selectedCountry?.countryName || state.ipInfo?.country_name || null,
    region_key: state.selectedRegionKey || null,
    device_type: deviceType,
    browser: browserInfo,
    timezone: state.selectedTimeZone || Intl.DateTimeFormat().resolvedOptions().timeZone,
    internet_speed_mbps: state.internetSpeedMbps || 0,
    page_completed: 1,
    fmt: state.fmt
  };

  const btn = $('step-1-next');
  btn.disabled = true;
  try {
    const { data, error } = await supabaseClient
      .from(DEMO_LEADS_TABLE)
      .upsert(payload, { onConflict: "phone_country_code,phone_number" })
      .select()
      .single();

    if(error){
      console.error('Step1 upsert', error);
      showGlobalError('Could not save details. Try again.');
      return;
    }
    state.leadId = data.id;
    // move to step 2
    $('step-1').style.display='none';
    $('step-2').style.display='block';
    await fetchSlotsForNextSevenDays();
  }catch(e){
    console.error(e); showGlobalError('Unexpected error saving lead.');
  }finally{ btn.disabled=false }
}

/* =========================
   Slot helpers: IST ‚Üí Local conversion rules
   ========================= */

/* toIstDateString: returns YYYY-MM-DD for IST today + offset */
function toIstDateString(offsetDays){
  const now = new Date();
  const istString = now.toLocaleString('en-US', { timeZone: 'Asia/Kolkata' });
  const istDate = new Date(istString);
  istDate.setDate(istDate.getDate() + offsetDays);
  const y = istDate.getFullYear();
  const m = String(istDate.getMonth()+1).padStart(2,'0');
  const d = String(istDate.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

/* computeLocalDayKeys: returns 7 days (today + 6) in user's timezone */
function computeLocalDayKeys(timeZone){
  const now = new Date();
  const localStr = now.toLocaleString('en-US',{ timeZone });
  const localDate = new Date(localStr);
  const keys = [];
  for(let i=0;i<7;i++){
    const d = new Date(localDate.getTime());
    d.setDate(d.getDate() + i);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    keys.push(`${y}-${m}-${dd}`);
  }
  return { todayKey: keys[0], keys };
}

/* convertSlotToLocalStruct:
   - converts slot_row.slot_datetime_ist (IST timestamp) to local time using timezone
   - applies rule: shift to next day IF local_time < 03:00 (for all regions OR optionally only some)
   - applies SEA hide rule: if regionKey==='SEA' and local hour < 07:00 -> hide (return null)
   - hides past slots for today (local) using nowLocalDateObj and also enforces +1 hour rule for today
*/
function convertSlotToLocalStruct(slotRow, timeZone, todayLocalKey, nowLocalDateObj, localDayKeysSet, regionKey) {
  // parse IST datetime (assuming stored as ISO / timestamp with timezone in DB)
  const istBase = new Date(slotRow.slot_datetime_ist);
  // We'll convert IST -> local by using toLocaleString with the desired timeZone
  // 1) convert istBase to local representation
  let localStr = istBase.toLocaleString('en-US', { timeZone });
  let local = new Date(localStr);

  // AFTER converting to local time, check early-morning shift rule:
  // If local hour < 3, then the intended class should be on the NEXT DAY (shift assignKey)
  if(local.getHours() < 3){
    // shift local to next day (keeping same clock time)
    const shifted = new Date(local.getTime());
    shifted.setDate(shifted.getDate() + 1);
    local = shifted;
    // recalc localStr for formatting if needed
    localStr = local.toLocaleString('en-US', { timeZone });
  }

  // SEA rule: hide slots before 07:00 local
  if(regionKey === 'SEA'){
    if(local.getHours() < 7){
      return null; // hide
    }
  }

  // assignKey using local date
  const y = local.getFullYear();
  const m = String(local.getMonth() + 1).padStart(2, '0');
  const d = String(local.getDate()).padStart(2, '0');
  const assignKey = `${y}-${m}-${d}`;

  // Only keep if within 7-day local window
  if(!localDayKeysSet.has(assignKey)) return null;

  // Hide past slots for today (local) and also enforce "1 hour ahead" rule for today's slots
  if(assignKey === todayLocalKey && nowLocalDateObj){
    // require local >= nowLocal + 1 hour
    const nowPlus1 = new Date(nowLocalDateObj.getTime() + (60*60*1000));
    if(local < nowPlus1) return null;
  }

  // Format display time (start time only) as 06:00 PM
  const displayTime = new Intl.DateTimeFormat('en-US', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true,
    timeZone
  }).format(local);

  // Determine if full (capacity_remaining <= 0)
  const isFull = Number(slotRow.capacity_remaining) <= 0;

  return {
    id: slotRow.id,
    raw: slotRow,
    displayTime,
    isStar: !!slotRow.is_star_teacher,
    isFull,
    sortDate: local,
    assignKey
  };
}

/* Fetch slots (today ‚Üí +6 days) from demo_slots_live and convert to local
   Note: demo_slots_live should already contain entries for today + 6 or +5 depending on backend.
*/
async function fetchSlotsForNextSevenDays(){
  if(!state.selectedRegionKey || !state.courseId){
    showGlobalError("Region or course not detected.");
    return;
  }
  const tz = state.selectedTimeZone || Intl.DateTimeFormat().resolvedOptions().timeZone;
  const { todayKey, keys } = computeLocalDayKeys(tz);
  state.todayLocalKey = todayKey;
  state.localDayKeys = keys;
  const localDayKeysSet = new Set(keys);

  // IST date window: today .. today+6 (we ask backend to have at least +6 days)
  const todayIst = toIstDateString(0);
  const plus6Ist = toIstDateString(6);

  const now = new Date();
  const nowLocalStr = now.toLocaleString('en-US', { timeZone: tz });
  const nowLocalDateObj = new Date(nowLocalStr);

  const { data, error } = await supabaseClient
    .from(DEMO_SLOTS_LIVE)
    .select("id, region_key, course_id, slot_date, slot_time_ist, slot_datetime_ist, is_star_teacher, capacity_remaining, is_active")
    .eq("region_key", state.selectedRegionKey)
    .eq("course_id", state.courseId)
    .gte("slot_date", todayIst)
    .lte("slot_date", plus6Ist)
    .eq("is_active", true)
    .order("slot_datetime_ist", { ascending: true });

  if(error){
    console.error('Slots fetch error', error);
    showGlobalError('Could not load slots.');
    return;
  }

  const byDate = {};
  (data||[]).forEach(row=>{
    const converted = convertSlotToLocalStruct(row, tz, todayKey, nowLocalDateObj, localDayKeysSet, state.selectedRegionKey);
    if(!converted) return;
    if(!byDate[converted.assignKey]) byDate[converted.assignKey]=[];
    byDate[converted.assignKey].push(converted);
  });

  Object.keys(byDate).forEach(k => byDate[k].sort((a,b)=>a.sortDate - b.sortDate));

  state.slotDataByDate = byDate;
  renderSlotDates();
}

/* Render date pills and times */
function renderSlotDates(){
  const container = $('slot-dates-row');
  container.innerHTML = '';
  const keys = state.localDayKeys;
  if(!state.selectedDate || !keys.includes(state.selectedDate)) state.selectedDate = keys[0];
  keys.forEach(k=>{
    const btn = document.createElement('button');
    btn.className = 'slot-date-pill';
    if(k === state.selectedDate) btn.classList.add('active');
    // format pill
    const [y,m,d] = k.split('-').map(x=>parseInt(x,10));
    const dt = new Date(Date.UTC(y,m-1,d));
    const weekday = dt.toLocaleDateString('en-US',{weekday:'short'});
    const month = dt.toLocaleDateString('en-US',{month:'short'});
    btn.innerHTML = `<div style="font-weight:700">${weekday} ‚Ä¢ ${String(d).padStart(2,'0')} ${month}</div><div class="small">${k}</div>`;
    btn.addEventListener('click', ()=>{
      state.selectedDate = k;
      renderSlotDates();
      renderSlotTimes();
    });
    container.appendChild(btn);
  });
  renderSlotTimes();
}

function renderSlotTimes(){
  const grid = $('slot-times-grid');
  const empty = $('slot-times-empty');
  grid.innerHTML = '';
  const dateKey = state.selectedDate;
  const list = state.slotDataByDate[dateKey] || [];
  if(!list.length){
    empty.style.display = 'block';
    return;
  } else empty.style.display = 'none';

  list.forEach(slot=>{
    const p = document.createElement('button');
    p.type='button';
    p.className = 'slot-pill';
    if(slot.isStar) p.classList.add('star');
    if(slot.isFull) p.classList.add('full');
    p.innerHTML = `<div style="font-weight:700">${slot.displayTime}</div><div class="small">${slot.isStar ? '‚òÖ Star Teacher' : ''}</div>`;
    if(!slot.isFull){
      p.addEventListener('click', ()=>{
        // select
        state.selectedSlotId = slot.id;
        state.selectedSlotDisplayTime = slot.displayTime;
        state.selectedSlotIsStar = slot.isStar;
        // update visual selection
        Array.from(document.querySelectorAll('.slot-pill')).forEach(el=>el.style.outline='');
        p.style.outline = '3px solid rgba(99,102,241,0.5)';
      });
    }
    grid.appendChild(p);
  });
}

/* =========================
   Step 2: Save slot to demo_leads
   ========================= */
async function handleStep2Next(){
  $('global-error').textContent='';
  if(!state.selectedDate || !state.selectedSlotId || !state.selectedSlotDisplayTime){
    showGlobalError('Please select date & time.');
    return;
  }
  if(!state.leadId){ showGlobalError('Lead not found. Please complete step 1.'); return; }

  const payload = {
    preferred_date: state.selectedDate,
    preferred_time_slot: state.selectedSlotDisplayTime,
    slot_id: state.selectedSlotId,
    lang: state.selectedLang ? state.selectedLang.toLowerCase() : 'english',
    star_teacher_selected: state.selectedSlotIsStar,
    page_completed: 2
  };

  const btn = $('step-2-next');
  btn.disabled = true;
  try{
    const { error } = await supabaseClient.from(DEMO_LEADS_TABLE).update(payload).eq('id', state.leadId);
    if(error){ console.error('Step2 update', error); showGlobalError('Could not save slot.'); return; }
    $('step-2').style.display='none';
    $('step-3').style.display='block';
  }catch(e){ console.error(e); showGlobalError('Error saving slot.'); }finally{ btn.disabled=false }
}

/* =========================
   Step 3: Save motivations and finalise
   ========================= */
async function handleStep3Submit(){
  $('global-error').textContent='';
  if(!state.leadId){ showGlobalError('Lead missing. Start again.'); return; }

  const who = document.querySelector('#who-group .radio-chip.selected')?.getAttribute('data-value');
  const reason = document.querySelector('#reason-group .radio-chip.selected')?.getAttribute('data-value');
  const timeline = document.querySelector('#timeline-group .radio-chip.selected')?.getAttribute('data-value');
  if(!who || !reason || !timeline){ showGlobalError('Please complete all questions.'); return; }

  const payload = {
    who_are_you: who,
    booking_reason: reason,
    purchase_timeline: timeline,
    page_completed: 3
  };

  const btn = $('step-3-submit');
  btn.disabled = true;
  showLoader(true);
  try{
    const { error } = await supabaseClient.from(DEMO_LEADS_TABLE).update(payload).eq('id', state.leadId);
    if(error){ console.error('Step3 update', error); showGlobalError('Could not save preferences.'); return; }
    showLoader(false);
    // Redirect to portal (as before) ‚Äî or show success
    const bookingUUID = state.leadId;
    const courseIdParam = state.courseId || '';
    const redirectUrl = "https://portal.unischooly.com/demo-dashboard/?bookingUUID=" + encodeURIComponent(bookingUUID) + "&medium=dashboard&courseId=" + encodeURIComponent(courseIdParam) + "&post_booking=true";
    // show success then redirect
    showGlobalSuccess('Booking finalised. Redirecting‚Ä¶');
    setTimeout(()=>{ window.location.href = redirectUrl; }, 1200);
  }catch(e){ console.error(e); showGlobalError('Error finalising booking.'); showLoader(false); }finally{ btn.disabled=false }
}

/* =========================
   UI helpers: set up chip groups
   ========================= */
function setupRadioChipGroup(containerId){
  const c = document.getElementById(containerId);
  if(!c) return;
  c.addEventListener('click', (e)=>{
    const chip = e.target.closest('.radio-chip');
    if(!chip) return;
    Array.from(c.querySelectorAll('.radio-chip')).forEach(cc=>cc.classList.remove('selected'));
    chip.classList.add('selected');
  });
}
function setupLangPills(){
  const c = document.getElementById('lang-pills');
  Array.from(c.querySelectorAll('.lang-pill')).forEach(btn=>{
    btn.addEventListener('click', ()=>{
      Array.from(c.querySelectorAll('.lang-pill')).forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      state.selectedLang = btn.getAttribute('data-lang');
    });
  });
}

/* =========================
   Bind events
   ========================= */
document.addEventListener('DOMContentLoaded', async ()=>{
  parseUrlParams();
  populateCountrySelect();
  detectIpAndSetCountry();
  detectInternetSpeed();
  setupRadioChipGroup('has-laptop-group');
  setupRadioChipGroup('who-group');
  setupRadioChipGroup('reason-group');
  setupRadioChipGroup('timeline-group');
  setupLangPills();

  $('step-1-next').addEventListener('click', handleStep1Next);
  $('step-2-next').addEventListener('click', handleStep2Next);
  $('step-3-submit').addEventListener('click', handleStep3Submit);
  $('back-to-step-1').addEventListener('click', ()=>{
    $('step-2').style.display='none'; $('step-1').style.display='block';
  });
  $('back-to-step-2').addEventListener('click', ()=>{
    $('step-3').style.display='none'; $('step-2').style.display='block';
  });
});

/* Expose for debugging if needed */
window._unischoolyState = state;

</script>
</body>
</html>
