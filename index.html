<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const supabaseUrl = "https://binklfyiypbhuzsvnlzg.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";

  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  console.log("Supabase Loaded:", supabase);  // â† CHECK IN BROWSER CONSOLE

  const step1El = document.getElementById("step1");
  const step2El = document.getElementById("step2");
  const tab1El = document.getElementById("tab-step1");
  const tab2El = document.getElementById("tab-step2");
  const btnStep1 = document.getElementById("btnStep1");
  const btnStep2 = document.getElementById("btnStep2");
  const msgStep1 = document.getElementById("msgStep1");
  let currentLeadId = null;

  function showStep(step) {
    if (step === 1) {
      step1El.classList.remove("hidden");
      step2El.classList.add("hidden");
      tab1El.classList.add("active");
      tab2El.classList.remove("active");
    } else {
      step1El.classList.add("hidden");
      step2El.classList.remove("hidden");
      tab1El.classList.remove("active");
      tab2El.classList.add("active");
    }
  }

  function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      utm_source: params.get("utm_source"),
      utm_medium: params.get("utm_medium"),
      utm_campaign: params.get("utm_campaign"),
      utm_term: params.get("utm_term"),
      utm_content: params.get("utm_content"),
      course_id: params.get("courseId"),
      fmt: params.get("ffmt"),
      lang: params.get("lang")
    };
  }

  btnStep1.addEventListener("click", async () => {
    console.log("Step 1 clicked");

    const phoneCode = document.getElementById("phoneCode").value;
    const phoneNumber = document.getElementById("phoneNumber").value.trim();
    const childName = document.getElementById("childName").value.trim();
    const childGrade = document.getElementById("childGrade").value;
    const parentName = document.getElementById("parentName").value.trim();
    const parentEmail = document.getElementById("parentEmail").value.trim();
    const hasLaptop = document.querySelector("input[name='hasLaptop']:checked")?.value || null;

    if (!phoneNumber || !childName || !childGrade || !parentName || !parentEmail) {
      msgStep1.textContent = "Please fill all required fields";
      msgStep1.classList.remove("hidden");
      return;
    }

    const urlInfo = getUrlParams();

    const { data, error } = await supabase
      .from("demo_leads")
      .insert([{
        child_name: childName,
        child_grade: childGrade,
        parent_name: parentName,
        parent_email: parentEmail,
        phone_country_code: phoneCode,
        phone_number: phoneNumber,
        has_laptop: hasLaptop,
        landing_page_path: window.location.pathname,
        full_url: window.location.href,
        ...urlInfo
      }])
      .select("id")
      .single();

    if (error) {
      console.error(error);
      msgStep1.textContent = "Error saving lead!";
      msgStep1.classList.remove("hidden");
      return;
    }

    console.log("Row inserted:", data);

    currentLeadId = data.id;
    showStep(2);
  });
</script>
