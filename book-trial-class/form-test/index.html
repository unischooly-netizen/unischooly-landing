<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unischooly ‚Äì Booking Form (Backend Test)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-main: #050818;
      --bg-card: #0b1020;
      --bg-card-soft: #12172b;
      --accent-1: #ff6ad5;
      --accent-2: #4be1ff;
      --accent-3: #8b5cff;
      --accent-4: #ffac35;
      --text-main: #e5f0ff;
      --text-soft: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --danger: #f97373;
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text-main);
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 32px 16px;
    }

    .shell {
      width: 100%;
      max-width: 1120px;
      background: radial-gradient(circle at top left, #1f2937 0, #020617 55%);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.8),
        0 0 0 1px rgba(56, 189, 248, 0.08);
      padding: 28px 32px 32px;
    }

    .shell-header {
      margin-bottom: 12px;
    }

    .shell-title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.01em;
      margin: 0 0 4px;
      background: linear-gradient(90deg, #e5e7eb, #a5b4fc, #22d3ee);
      -webkit-background-clip: text;
      color: transparent;
    }

    .shell-subtitle {
      margin: 0;
      font-size: 13px;
      color: var(--text-soft);
    }

    .step-indicator {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 18px 0 20px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .step-indicator span strong {
      color: #e5e7eb;
    }

    .step-bars {
      display: flex;
      gap: 8px;
      width: 160px;
    }

    .step-bar {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
    }

    .step-bar.active {
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
    }

    .step-bar.completed {
      background: linear-gradient(90deg, #22c55e, #a7f3d0);
    }

    .step-bar-inner {
      width: 100%;
      height: 100%;
      border-radius: inherit;
    }

    .banner {
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 12px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .banner.show {
      display: flex;
    }

    .banner-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.7);
      color: #fecaca;
    }

    .banner-success {
      background: rgba(22, 163, 74, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.8);
      color: #bbf7d0;
    }

    .banner-icon {
      font-size: 16px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 16px;
    }

    .field-group {
      margin-bottom: 16px;
    }

    .field-label-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
    }

    .field-label {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .field-hint {
      font-size: 11px;
      color: var(--text-soft);
    }

    .input,
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background-color 0.15s;
    }

    .input::placeholder {
      color: #4b5563;
    }

    .input:focus,
    select:focus {
      border-color: var(--accent-2);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.4),
        0 0 30px rgba(56, 189, 248, 0.3);
    }

    .pill-toggle {
      display: inline-flex;
      padding: 4px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      border: 1px solid rgba(148, 163, 184, 0.4);
      gap: 4px;
    }

    .pill-toggle button {
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-soft);
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .pill-toggle button span {
      font-size: 13px;
    }

    .pill-toggle button.active {
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: #f9fafb;
      box-shadow:
        0 0 0 1px rgba(96, 165, 250, 0.6),
        0 8px 25px rgba(15, 23, 42, 0.9);
    }

    .pill-toggle button.inactive {
      color: #9ca3af;
    }

    .btn-main {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 14px 18px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      color: #0b1020;
      background-image: linear-gradient(90deg, #ff6ad5, #8b5cff, #4be1ff);
      background-size: 200% 100%;
      box-shadow:
        0 10px 40px rgba(59, 130, 246, 0.5),
        0 0 0 1px rgba(191, 219, 254, 0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.1s ease, box-shadow 0.15s ease, background-position 0.2s;
    }

    .btn-main:hover {
      background-position: 100% 0;
      transform: translateY(-1px);
      box-shadow:
        0 14px 45px rgba(59, 130, 246, 0.65),
        0 0 0 1px rgba(191, 219, 254, 0.35);
    }

    .btn-main:active {
      transform: translateY(0);
      box-shadow:
        0 8px 30px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(148, 163, 184, 0.75);
    }

    .btn-main:disabled {
      opacity: 0.65;
      cursor: wait;
      box-shadow: none;
    }

    .btn-secondary {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-soft);
      background: transparent;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }

    .btn-secondary span {
      font-size: 14px;
    }

    .btn-secondary:hover {
      color: #e5e7eb;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .section-subtitle {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 12px;
    }

    .date-row,
    .time-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .date-pill {
      min-width: 100px;
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      cursor: pointer;
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      transition: all 0.15s ease;
    }

    .date-pill strong {
      font-size: 13px;
      color: #e5e7eb;
    }

    .date-pill.selected {
      border-color: var(--accent-2);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.4),
        0 10px 40px rgba(15, 23, 42, 0.95);
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
    }

    .time-pill {
      flex: 1 0 150px;
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      cursor: pointer;
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: all 0.15s ease;
    }

    .time-pill-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .time-pill-main {
      font-size: 13px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .time-pill-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .star-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(250, 204, 21, 0.12);
      color: #facc15;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      border: 1px solid rgba(250, 204, 21, 0.8);
    }

    .star-badge span {
      font-size: 11px;
    }

    .time-pill.selected {
      border-color: var(--accent-2);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.4),
        0 10px 40px rgba(15, 23, 42, 0.95);
    }

    .pill-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .pill-option {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-subtle);
      font-size: 12px;
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      color: var(--text-soft);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .pill-option.selected {
      border-color: var(--accent-2);
      color: #f9fafb;
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.4),
        0 8px 28px rgba(15, 23, 42, 0.95);
    }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-soft);
      text-align: center;
    }

    @media (max-width: 768px) {
      body {
        padding: 16px 8px;
      }

      .shell {
        padding: 20px 16px 20px;
        border-radius: 20px;
      }

      .grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="shell-header">
      <h1 class="shell-title">Unischooly ‚Äì Booking Form (Backend Test)</h1>
      <p class="shell-subtitle">
        Simple 3-step form to test Supabase integration. No fancy design ‚Äì only logic.
      </p>
    </header>

    <div class="step-indicator">
      <span>Step <strong id="step-label">1</strong> of 3 ‚Äì <span id="step-title">Details</span></span>
      <div class="step-bars">
        <div class="step-bar completed"><div class="step-bar-inner"></div></div>
        <div class="step-bar" id="step-bar-2"><div class="step-bar-inner"></div></div>
        <div class="step-bar" id="step-bar-3"><div class="step-bar-inner"></div></div>
      </div>
    </div>

    <div id="error-banner" class="banner banner-error">
      <div class="banner-icon">‚ö†Ô∏è</div>
      <div id="error-text">Something went wrong.</div>
    </div>

    <div id="success-banner" class="banner banner-success">
      <div class="banner-icon">‚úÖ</div>
      <div id="success-text">Saved successfully.</div>
    </div>

    <!-- STEP 1 -->
    <section id="step-1">
      <div class="field-group">
        <div class="section-title">Step 1 ‚Äì Basic details</div>
        <div class="section-subtitle">
          Backend test: region fixed to <strong>MEA</strong>, language fixed to <strong>English</strong>.
          We also capture IP, city, country, device type & browser.
        </div>
      </div>

      <div class="grid">
        <div class="field-group" style="grid-column: span 4;">
          <div class="field-label-row">
            <label class="field-label">Phone Country Code</label>
          </div>
          <input id="phone-country-code" class="input" type="text" placeholder="+971" value="+971" />
        </div>

        <div class="field-group" style="grid-column: span 8;">
          <div class="field-label-row">
            <label class="field-label">WhatsApp Number</label>
            <span class="field-hint">We'll send class link &amp; updates here</span>
          </div>
          <input
            id="phone-number"
            class="input"
            type="tel"
            placeholder="10‚Äì12 digit number"
          />
          <div class="field-hint" style="margin-top: 4px;">
            Please share the number that you use for WhatsApp.
          </div>
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Child's Name</label>
          </div>
          <input id="child-name" class="input" type="text" placeholder="E.g. Aarav, Emma" />
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Select Child's Grade</label>
          </div>
          <select id="child-grade">
            <option value="">Select grade</option>
            <option>Grade 1</option>
            <option>Grade 2</option>
            <option>Grade 3</option>
            <option>Grade 4</option>
            <option>Grade 5</option>
            <option>Grade 6</option>
            <option>Grade 7</option>
            <option>Grade 8</option>
            <option>Grade 9</option>
            <option>Grade 10</option>
            <option>Grade 11</option>
            <option>Grade 12</option>
          </select>
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Parent / Guardian Name</label>
          </div>
          <input id="parent-name" class="input" type="text" placeholder="Full name" />
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Parent's Email</label>
          </div>
          <input id="parent-email" class="input" type="email" placeholder="We'll send confirmation here" />
        </div>

        <div class="field-group" style="grid-column: span 12;">
          <div class="field-label-row">
            <label class="field-label">Do you have a Laptop / Desktop?</label>
          </div>
          <div class="pill-toggle">
            <button type="button" id="laptop-yes" class="active">
              <span>üíª</span> Yes
            </button>
            <button type="button" id="laptop-no" class="inactive">
              <span>üì±</span> No (Tablet / Mobile only)
            </button>
          </div>
        </div>
      </div>

      <button id="btn-step-1" class="btn-main" style="margin-top: 8px;">
        <span>üöÄ</span>
        <span>Save &amp; Continue to Date &amp; Time</span>
      </button>

      <div class="footer-note">
        Note: We will share the class link & certificate on Email & WhatsApp.
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step-2" style="display:none;">
      <button class="btn-secondary" id="btn-back-to-1">
        <span>‚Üê</span>
        <span>Back to details</span>
      </button>

      <div class="field-group">
        <div class="section-title">Select Date &amp; Time</div>
        <div class="section-subtitle">
          Choose a slot that works in your local time. Your class will be for 1 hour. Showing today + next 5 days.
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Select Date</label>
          <span class="field-hint" id="date-range-label"></span>
        </div>
        <div class="date-row" id="date-row"></div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Select Start Time</label>
          <span class="field-hint">
            Class slots are limited. Times are shown in your local time.
          </span>
        </div>
        <div class="time-row" id="time-row"></div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Select Language</label>
        </div>
        <select id="language-select">
          <option value="english">English</option>
          <option value="arabic">Arabic</option>
          <option value="bahasa">Bahasa</option>
          <option value="vietnamese">Vietnamese</option>
          <option value="filipino">Filipino</option>
          <option value="thai">Thai</option>
        </select>
      </div>

      <button id="btn-step-2" class="btn-main" style="margin-top: 8px;">
        <span>‚ú®</span>
        <span>Confirm Class Time</span>
      </button>

      <div class="footer-note">
        Note: Free class will be conducted by reputed teachers. By continuing you agree to be contacted by Unischooly via WhatsApp / Phone / Email.
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="step-3" style="display:none;">
      <button class="btn-secondary" id="btn-back-to-2">
        <span>‚Üê</span>
        <span>Back to date &amp; time</span>
      </button>

      <div class="field-group">
        <div class="section-title">Help us personalise your experience</div>
        <div class="section-subtitle">
          A few quick questions so we can plan the trial class for your child.
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Who are you?</label>
        </div>
        <div class="pill-options" id="who-options">
          <button type="button" class="pill-option" data-value="Parent">Parent</button>
          <button type="button" class="pill-option" data-value="Student">Student</button>
          <button type="button" class="pill-option" data-value="Guardian">Guardian</button>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Why are you booking this trial class?</label>
        </div>
        <div class="pill-options" id="why-options">
          <button type="button" class="pill-option" data-value="Want to buy course">Want to buy course</button>
          <button type="button" class="pill-option" data-value="To Compare Platform">To Compare Platform</button>
          <button type="button" class="pill-option" data-value="To strengthen Concept">To strengthen Concept</button>
          <button type="button" class="pill-option" data-value="Just for free demo">Just for free demo</button>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">When are you planning to purchase?</label>
        </div>
        <div class="pill-options" id="when-options">
          <button type="button" class="pill-option" data-value="After the Demo">After the Demo</button>
          <button type="button" class="pill-option" data-value="This Week">This Week</button>
          <button type="button" class="pill-option" data-value="This Month">This Month</button>
          <button type="button" class="pill-option" data-value="Just Exploring">Just Exploring</button>
        </div>
      </div>

      <button id="btn-step-3" class="btn-main" style="margin-top: 8px;">
        <span>‚úÖ</span>
        <span>Submit</span>
      </button>

      <div class="footer-note" id="final-message" style="display:none; margin-top: 12px;">
        Your trial class is booked. You can now close this test page.
      </div>
    </section>
  </div>

  <script type="module">
  // ---------- CONFIG ----------
  const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";

  // ‚ö†Ô∏è This is only for BACKEND TEST.
  // In your real form we will read region_key + timezone from demo_leads.
  const TEST_REGION = {
    regionKey: "MEA",          // same region you used for UAE
    courseId: 1,               // Coding course
    timeZone: "Asia/Dubai"     // UAE timezone
  };

  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ---------- HELPERS ----------

  function getInternetSpeedMbps() {
    const nav = navigator;
    const conn =
      nav.connection || nav.mozConnection || nav.webkitConnection || null;
    if (!conn || typeof conn.downlink !== "number") return null;
    // Round to 1 decimal place
    return Math.round(conn.downlink * 10) / 10;
  }

  function formatDateRangeLabel(minDate, maxDate, timeZone) {
    const opt = { day: "2-digit", month: "short", year: "numeric", timeZone };
    const minStr = minDate.toLocaleDateString("en-GB", opt);
    const maxStr = maxDate.toLocaleDateString("en-GB", opt);
    return `${minStr} ‚Äì ${maxStr}`;
  }

  function makeDateKey(date, timeZone) {
    // Returns YYYY-MM-DD in the given timeZone
    return date.toLocaleDateString("en-CA", { timeZone }); // en-CA => 2025-12-10
  }

  function formatDayLabels(date, todayKey, tomorrowKey, timeZone) {
    const dateKey = makeDateKey(date, timeZone);
    const bottomLabel = date.toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "short",
      timeZone,
    }); // 10 Dec

    let topLabel;
    if (dateKey === todayKey) topLabel = "Today";
    else if (dateKey === tomorrowKey) topLabel = "Tomorrow";
    else {
      topLabel = date.toLocaleDateString("en-GB", {
        weekday: "short",
        timeZone,
      }); // Mon, Tue...
    }
    return { topLabel, bottomLabel, dateKey };
  }

  function formatTimeLabel(date, timeZone) {
    return date
      .toLocaleTimeString("en-US", {
        timeZone,
        hour: "numeric",
        minute: "2-digit",
        hour12: true,
      })
      .toLowerCase(); // e.g. "6:00 pm"
  }

  function getNowInZone(timeZone) {
    // Build a Date that represents "now" in given zone
    const now = new Date();
    const parts = new Intl.DateTimeFormat("en-CA", {
      timeZone,
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      hour12: false,
    })
      .formatToParts(now)
      .reduce((acc, p) => {
        acc[p.type] = p.value;
        return acc;
      }, {});

    const isoLike = `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:00`;
    return new Date(isoLike);
  }

  // ---------- STATE ----------
  let currentStep = 1;
  let currentLead = null; // { id, region_key, timezone, lang, ... }
  let groupedSlots = {};  // dateKey -> { date, slots[] }
  let selectedDateKey = null;
  let selectedSlot = null;
  let selectedLanguage = "english";

  // DOM elements (ids/classes are from the existing test layout)
  const step1Card = document.querySelector("[data-step='1']");
  const step2Card = document.querySelector("[data-step='2']");
  const step3Card = document.querySelector("[data-step='3']");

  const pageProgressBars = document.querySelectorAll(".step-progress-bar");

  const dateContainer = document.getElementById("slot-dates");
  const timeContainer = document.getElementById("slot-times");
  const dateRangeLabelEl = document.getElementById("date-range-label");
  const languageSelect = document.getElementById("language-select");
  const selectedTimeSummaryEl = document.getElementById("selected-time-summary");

  const btnStep1Next = document.getElementById("btn-step1-next");
  const btnStep2Back = document.getElementById("btn-step2-back");
  const btnStep2Next = document.getElementById("btn-step2-next");
  const btnStep3Submit = document.getElementById("btn-step3-submit");

  const leadForm = document.getElementById("lead-form");
  const motivationsForm = document.getElementById("motivations-form");

  // ---------- UI STEP CONTROL ----------

  function updateStepUI() {
    step1Card.style.display = currentStep === 1 ? "block" : "none";
    step2Card.style.display = currentStep === 2 ? "block" : "none";
    step3Card.style.display = currentStep === 3 ? "block" : "none";

    pageProgressBars.forEach((bar, index) => {
      if (index < currentStep) bar.classList.add("is-active");
      else bar.classList.remove("is-active");
    });
  }

  function goToStep(step) {
    currentStep = step;
    updateStepUI();
  }

  // ---------- STEP 1 ‚Äì LEAD CREATION + INTERNET SPEED ----------

  async function handleStep1Submit(event) {
    event.preventDefault();
    btnStep1Next.disabled = true;
    btnStep1Next.textContent = "Saving...";

    // Minimal fields for backend test ‚Äì adjust to your actual form ids
    const phoneCode = document.getElementById("phone-country-code").value.trim();
    const phoneNumber = document.getElementById("phone-number").value.trim();
    const childName = document.getElementById("child-name").value.trim();
    const childGrade = document.getElementById("child-grade").value.trim();
    const parentName = document.getElementById("parent-name").value.trim();
    const parentEmail = document.getElementById("parent-email").value.trim();
    const hasLaptop = document.querySelector(
      'input[name="has-laptop"]:checked'
    )?.value;

    if (
      !phoneCode ||
      !phoneNumber ||
      !childName ||
      !childGrade ||
      !parentName ||
      !parentEmail
    ) {
      alert("Please fill all required fields.");
      btnStep1Next.disabled = false;
      btnStep1Next.textContent = "Book a Free Trial Class";
      return;
    }

    const browserTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const internetSpeed = getInternetSpeedMbps();

    const payload = {
      child_name: childName,
      child_grade: childGrade,
      parent_name: parentName,
      parent_email: parentEmail,
      phone_country_code: phoneCode,
      phone_number: phoneNumber,
      has_laptop: hasLaptop,
      // NEW: save internet speed
      internet_speed_mbps: internetSpeed,
      // For this backend test, we fix region+timezone.
      region_key: TEST_REGION.regionKey,
      timezone: TEST_REGION.timeZone,
      course_id: TEST_REGION.courseId,
      lang: "english",
      page_completed: 1,
      full_url: window.location.href,
      landing_page_path: window.location.pathname,
    };

    const { data, error } = await supabase
      .from("demo_leads")
      .upsert(payload, {
        onConflict: "phone_country_code,phone_number",
        ignoreDuplicates: false,
      })
      .select("*")
      .single();

    btnStep1Next.disabled = false;
    btnStep1Next.textContent = "Book a Free Trial Class";

    if (error) {
      console.error(error);
      alert("Unable to save your details. Please try again.");
      return;
    }

    currentLead = data;
    await loadSlotsForLead(); // prepare Step 2
    goToStep(2);
  }

  // ---------- STEP 2 ‚Äì LOAD & DISPLAY SLOTS CORRECTLY ----------

  async function loadSlotsForLead() {
    if (!currentLead) return;

    const regionKey = currentLead.region_key || TEST_REGION.regionKey;
    const courseId = currentLead.course_id || TEST_REGION.courseId;
    const timeZone = currentLead.timezone || TEST_REGION.timeZone;

    // today + next 5 days based on REGION timezone
    const nowInZone = getNowInZone(timeZone);
    const todayKey = makeDateKey(nowInZone, timeZone);

    const tomorrow = new Date(nowInZone.getTime() + 24 * 60 * 60 * 1000);
    const tomorrowKey = makeDateKey(tomorrow, timeZone);

    const lastDay = new Date(nowInZone.getTime() + 5 * 24 * 60 * 60 * 1000);
    const minDateIso = todayKey; // YYYY-MM-DD
    const maxDateIso = makeDateKey(lastDay, timeZone);

    const { data, error } = await supabase
      .from("demo_slots_live")
      .select(
        "slot_id, slot_date, slot_datetime_local, is_star_teacher, region_key, course_id"
      )
      .eq("region_key", regionKey)
      .eq("course_id", courseId)
      .gte("slot_date", minDateIso)
      .lte("slot_date", maxDateIso)
      .order("slot_datetime_local", { ascending: true });

    if (error) {
      console.error(error);
      alert("Could not load slots.");
      return;
    }

    if (!data || data.length === 0) {
      dateContainer.innerHTML = "<p>No slots found.</p>";
      timeContainer.innerHTML = "";
      return;
    }

    // Build groupedSlots: dateKey -> { date, slots: [] }
    groupedSlots = {};
    let minSlotDate = null;
    let maxSlotDate = null;

    for (const row of data) {
      const utcDate = new Date(row.slot_datetime_local);
      const dateKey = makeDateKey(utcDate, timeZone);

      const localDateForLabels = new Date(
        utcDate.toLocaleString("en-CA", { timeZone })
      ); // still a Date object

      if (!groupedSlots[dateKey]) {
        groupedSlots[dateKey] = {
          date: localDateForLabels,
          slots: [],
        };
      }

      // Filter: if it's "today" in region timezone, skip slots that are < now + 1 hour
      const slotLocalDate = new Date(
        utcDate.toLocaleString("en-CA", { timeZone })
      );
      const oneHourLater = new Date(nowInZone.getTime() + 60 * 60 * 1000);
      const isToday = dateKey === todayKey;
      if (isToday && slotLocalDate < oneHourLater) {
        continue; // too close, skip
      }

      groupedSlots[dateKey].slots.push({
        id: row.slot_id,
        dateKey,
        localDate: slotLocalDate, // real Date in region timezone
        timeLabel: formatTimeLabel(utcDate, timeZone),
        isStar: !!row.is_star_teacher,
      });

      // Track min/max for "Showing 10 Dec ‚Äì 15 Dec"
      if (!minSlotDate || slotLocalDate < minSlotDate) minSlotDate = slotLocalDate;
      if (!maxSlotDate || slotLocalDate > maxSlotDate) maxSlotDate = slotLocalDate;
    }

    // Sort slots within each day by real datetime
    Object.values(groupedSlots).forEach((group) => {
      group.slots.sort((a, b) => a.localDate - b.localDate);
    });

    // Render UI
    renderDateButtons(timeZone, todayKey, tomorrowKey);
    renderTimeButtons();

    if (minSlotDate && maxSlotDate && dateRangeLabelEl) {
      dateRangeLabelEl.textContent = formatDateRangeLabel(
        minSlotDate,
        maxSlotDate,
        timeZone
      );
    }
  }

  function renderDateButtons(timeZone, todayKey, tomorrowKey) {
    dateContainer.innerHTML = "";
    selectedSlot = null;
    selectedTimeSummaryEl.textContent = "Please select a time slot.";

    const dateKeys = Object.keys(groupedSlots).sort(); // chronological

    dateKeys.forEach((dateKey) => {
      const group = groupedSlots[dateKey];
      const labels = formatDayLabels(group.date, todayKey, tomorrowKey, timeZone);

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "date-pill";
      btn.innerHTML = `
        <span class="date-pill-top">${labels.topLabel}</span>
        <span class="date-pill-bottom">${labels.bottomLabel}</span>
      `;

      if (!selectedDateKey) selectedDateKey = dateKey;
      if (selectedDateKey === dateKey) btn.classList.add("is-selected");

      btn.addEventListener("click", () => {
        selectedDateKey = dateKey;
        renderDateButtons(timeZone, todayKey, tomorrowKey); // re-render to update selection
        renderTimeButtons();
      });

      dateContainer.appendChild(btn);
    });
  }

  function renderTimeButtons() {
    timeContainer.innerHTML = "";
    selectedSlot = null;
    selectedTimeSummaryEl.textContent = "Please select a time slot.";

    const group = groupedSlots[selectedDateKey];
    if (!group || !group.slots.length) {
      timeContainer.innerHTML = "<p>No available slots for this day.</p>";
      return;
    }

    group.slots.forEach((slot) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "time-pill";
      btn.innerHTML = `
        <div class="time-pill-main">${slot.timeLabel}</div>
        <div class="time-pill-sub">1:1 live class ¬∑ 60 mins</div>
        ${
          slot.isStar
            ? '<div class="time-pill-star">‚≠ê Star teacher</div>'
            : ""
        }
      `;

      if (selectedSlot && selectedSlot.id === slot.id) {
        btn.classList.add("is-selected");
      }

      btn.addEventListener("click", () => {
        selectedSlot = slot;
        // re-render to reflect selection
        renderTimeButtons();
        selectedTimeSummaryEl.textContent = `${slot.timeLabel} on ${selectedDateKey}`;
      });

      timeContainer.appendChild(btn);
    });
  }

  async function handleStep2Confirm() {
    if (!currentLead || !selectedSlot) {
      alert("Please select a date and time.");
      return;
    }

    btnStep2Next.disabled = true;
    btnStep2Next.textContent = "Saving...";

    const { error } = await supabase
      .from("demo_leads")
      .update({
        preferred_date: selectedSlot.localDate.toISOString().slice(0, 10),
        preferred_time_slot: selectedSlot.timeLabel,
        slot_id: selectedSlot.id,
        star_teacher_selected: selectedSlot.isStar,
        lang: selectedLanguage,
        page_completed: 2,
      })
      .eq("id", currentLead.id);

    btnStep2Next.disabled = false;
    btnStep2Next.textContent = "Confirm Class Time";

    if (error) {
      console.error(error);
      alert("Could not save your selected slot.");
      return;
    }

    goToStep(3);
  }

  // ---------- STEP 3 ‚Äì MOTIVATIONS (unchanged from your logic) ----------

  async function handleStep3Submit(event) {
    event.preventDefault();
    if (!currentLead) return;

    btnStep3Submit.disabled = true;
    btnStep3Submit.textContent = "Saving...";

    const who = document.querySelector(
      'input[name="who_are_you"]:checked'
    )?.value;
    const reason = document.querySelector(
      'input[name="booking_reason"]:checked'
    )?.value;
    const when = document.querySelector(
      'input[name="purchase_timeline"]:checked'
    )?.value;

    const { error } = await supabase
      .from("demo_leads")
      .update({
        who_are_you: who,
        booking_reason: reason,
        purchase_timeline: when,
        page_completed: 3,
      })
      .eq("id", currentLead.id);

    btnStep3Submit.disabled = false;
    btnStep3Submit.textContent = "Submit";

    if (error) {
      console.error(error);
      alert("Could not save your answers.");
      return;
    }

    alert("Your trial class is booked! (Backend test).");
  }

  // ---------- EVENT WIRING ----------

  document.addEventListener("DOMContentLoaded", () => {
    updateStepUI();

    if (leadForm) leadForm.addEventListener("submit", handleStep1Submit);
    if (btnStep2Back)
      btnStep2Back.addEventListener("click", () => goToStep(1));
    if (btnStep2Next)
      btnStep2Next.addEventListener("click", handleStep2Confirm);
    if (motivationsForm)
      motivationsForm.addEventListener("submit", handleStep3Submit);

    if (languageSelect) {
      languageSelect.addEventListener("change", (e) => {
        selectedLanguage = e.target.value.toLowerCase();
      });
    }
  });
</script>
</body>
</html>
