<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unischooly ‚Äì Booking Form (Backend Test)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-main: #050818;
      --bg-card: #0b1020;
      --bg-card-soft: #12172b;
      --accent-1: #ff6ad5;
      --accent-2: #4be1ff;
      --accent-3: #8b5cff;
      --accent-4: #ffac35;
      --text-main: #e5f0ff;
      --text-soft: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --danger: #f97373;
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text-main);
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 32px 16px;
    }

    .shell {
      width: 100%;
      max-width: 1120px;
      background: radial-gradient(circle at top left, #1f2937 0, #020617 55%);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.8),
        0 0 0 1px rgba(56, 189, 248, 0.08);
      padding: 28px 32px 32px;
    }

    .shell-header {
      margin-bottom: 12px;
    }

    .shell-title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.01em;
      margin: 0 0 4px;
      background: linear-gradient(90deg, #e5e7eb, #a5b4fc, #22d3ee);
      -webkit-background-clip: text;
      color: transparent;
    }

    .shell-subtitle {
      margin: 0;
      font-size: 13px;
      color: var(--text-soft);
    }

    .step-indicator {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 18px 0 20px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .step-indicator span strong {
      color: #e5e7eb;
    }

    .step-bars {
      display: flex;
      gap: 8px;
      width: 160px;
    }

    .step-bar {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
    }

    .step-bar.active {
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
    }

    .step-bar.completed {
      background: linear-gradient(90deg, #22c55e, #a7f3d0);
    }

    .step-bar-inner {
      width: 100%;
      height: 100%;
      border-radius: inherit;
    }

    .banner {
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 12px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .banner.show {
      display: flex;
    }

    .banner-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.7);
      color: #fecaca;
    }

    .banner-success {
      background: rgba(22, 163, 74, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.8);
      color: #bbf7d0;
    }

    .banner-icon {
      font-size: 16px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 16px;
    }

    .field-group {
      margin-bottom: 16px;
    }

    .field-label-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
    }

    .field-label {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .field-hint {
      font-size: 11px;
      color: var(--text-soft);
    }

    .input,
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background-color 0.15s;
    }

    .input::placeholder {
      color: #4b5563;
    }

    .input:focus,
    select:focus {
      border-color: var(--accent-2);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.4),
        0 0 30px rgba(56, 189, 248, 0.3);
    }

    .pill-toggle {
      display: inline-flex;
      padding: 4px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      border: 1px solid rgba(148, 163, 184, 0.4);
      gap: 4px;
    }

    .pill-toggle button {
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-soft);
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .pill-toggle button span {
      font-size: 13px;
    }

    .pill-toggle button.active {
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: #f9fafb;
      box-shadow:
        0 0 0 1px rgba(96, 165, 250, 0.6),
        0 8px 25px rgba(15, 23, 42, 0.9);
    }

    .pill-toggle button.inactive {
      color: #9ca3af;
    }

    .btn-main {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 14px 18px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      color: #0b1020;
      background-image: linear-gradient(90deg, #ff6ad5, #8b5cff, #4be1ff);
      background-size: 200% 100%;
      box-shadow:
        0 10px 40px rgba(59, 130, 246, 0.5),
        0 0 0 1px rgba(191, 219, 254, 0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.1s ease, box-shadow 0.15s ease, background-position 0.2s;
    }

    .btn-main:hover {
      background-position: 100% 0;
      transform: translateY(-1px);
      box-shadow:
        0 14px 45px rgba(59, 130, 246, 0.65),
        0 0 0 1px rgba(191, 219, 254, 0.35);
    }

    .btn-main:active {
      transform: translateY(0);
      box-shadow:
        0 8px 30px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(148, 163, 184, 0.75);
    }

    .btn-main:disabled {
      opacity: 0.65;
      cursor: wait;
      box-shadow: none;
    }

    .btn-secondary {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-soft);
      background: transparent;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }

    .btn-secondary span {
      font-size: 14px;
    }

    .btn-secondary:hover {
      color: #e5e7eb;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .section-subtitle {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 12px;
    }

    .date-row,
    .time-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .date-pill {
      min-width: 100px;
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      cursor: pointer;
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      transition: all 0.15s ease;
    }

    .date-pill strong {
      font-size: 13px;
      color: #e5e7eb;
    }

    .date-pill.selected {
      border-color: var(--accent-2);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.4),
        0 10px 40px rgba(15, 23, 42, 0.95);
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
    }

    .time-pill {
      flex: 1 0 150px;
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      cursor: pointer;
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: all 0.15s ease;
    }

    .time-pill-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .time-pill-main {
      font-size: 13px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .time-pill-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .star-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(250, 204, 21, 0.12);
      color: #facc15;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      border: 1px solid rgba(250, 204, 21, 0.8);
    }

    .star-badge span {
      font-size: 11px;
    }

    .time-pill.selected {
      border-color: var(--accent-2);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.4),
        0 10px 40px rgba(15, 23, 42, 0.95);
    }

    .pill-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .pill-option {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-subtle);
      font-size: 12px;
      background: radial-gradient(circle at top, #020617 0, #020617 55%);
      color: var(--text-soft);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .pill-option.selected {
      border-color: var(--accent-2);
      color: #f9fafb;
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.4),
        0 8px 28px rgba(15, 23, 42, 0.95);
    }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-soft);
      text-align: center;
    }

    @media (max-width: 768px) {
      body {
        padding: 16px 8px;
      }

      .shell {
        padding: 20px 16px 20px;
        border-radius: 20px;
      }

      .grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="shell-header">
      <h1 class="shell-title">Unischooly ‚Äì Booking Form (Backend Test)</h1>
      <p class="shell-subtitle">
        Simple 3-step form to test Supabase integration. No fancy design ‚Äì only logic.
      </p>
    </header>

    <div class="step-indicator">
      <span>Step <strong id="step-label">1</strong> of 3 ‚Äì <span id="step-title">Details</span></span>
      <div class="step-bars">
        <div class="step-bar completed"><div class="step-bar-inner"></div></div>
        <div class="step-bar" id="step-bar-2"><div class="step-bar-inner"></div></div>
        <div class="step-bar" id="step-bar-3"><div class="step-bar-inner"></div></div>
      </div>
    </div>

    <div id="error-banner" class="banner banner-error">
      <div class="banner-icon">‚ö†Ô∏è</div>
      <div id="error-text">Something went wrong.</div>
    </div>

    <div id="success-banner" class="banner banner-success">
      <div class="banner-icon">‚úÖ</div>
      <div id="success-text">Saved successfully.</div>
    </div>

    <!-- STEP 1 -->
    <section id="step-1">
      <div class="field-group">
        <div class="section-title">Step 1 ‚Äì Basic details</div>
        <div class="section-subtitle">
          Backend test: region fixed to <strong>MEA</strong>, language fixed to <strong>English</strong>.
          We also capture IP, city, country, device type & browser.
        </div>
      </div>

      <div class="grid">
        <div class="field-group" style="grid-column: span 4;">
          <div class="field-label-row">
            <label class="field-label">Phone Country Code</label>
          </div>
          <input id="phone-country-code" class="input" type="text" placeholder="+971" value="+971" />
        </div>

        <div class="field-group" style="grid-column: span 8;">
          <div class="field-label-row">
            <label class="field-label">WhatsApp Number</label>
            <span class="field-hint">We'll send class link &amp; updates here</span>
          </div>
          <input
            id="phone-number"
            class="input"
            type="tel"
            placeholder="10‚Äì12 digit number"
          />
          <div class="field-hint" style="margin-top: 4px;">
            Please share the number that you use for WhatsApp.
          </div>
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Child's Name</label>
          </div>
          <input id="child-name" class="input" type="text" placeholder="E.g. Aarav, Emma" />
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Select Child's Grade</label>
          </div>
          <select id="child-grade">
            <option value="">Select grade</option>
            <option>Grade 1</option>
            <option>Grade 2</option>
            <option>Grade 3</option>
            <option>Grade 4</option>
            <option>Grade 5</option>
            <option>Grade 6</option>
            <option>Grade 7</option>
            <option>Grade 8</option>
            <option>Grade 9</option>
            <option>Grade 10</option>
            <option>Grade 11</option>
            <option>Grade 12</option>
          </select>
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Parent / Guardian Name</label>
          </div>
          <input id="parent-name" class="input" type="text" placeholder="Full name" />
        </div>

        <div class="field-group" style="grid-column: span 6;">
          <div class="field-label-row">
            <label class="field-label">Parent's Email</label>
          </div>
          <input id="parent-email" class="input" type="email" placeholder="We'll send confirmation here" />
        </div>

        <div class="field-group" style="grid-column: span 12;">
          <div class="field-label-row">
            <label class="field-label">Do you have a Laptop / Desktop?</label>
          </div>
          <div class="pill-toggle">
            <button type="button" id="laptop-yes" class="active">
              <span>üíª</span> Yes
            </button>
            <button type="button" id="laptop-no" class="inactive">
              <span>üì±</span> No (Tablet / Mobile only)
            </button>
          </div>
        </div>
      </div>

      <button id="btn-step-1" class="btn-main" style="margin-top: 8px;">
        <span>üöÄ</span>
        <span>Save &amp; Continue to Date &amp; Time</span>
      </button>

      <div class="footer-note">
        Note: We will share the class link & certificate on Email & WhatsApp.
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step-2" style="display:none;">
      <button class="btn-secondary" id="btn-back-to-1">
        <span>‚Üê</span>
        <span>Back to details</span>
      </button>

      <div class="field-group">
        <div class="section-title">Select Date &amp; Time</div>
        <div class="section-subtitle">
          Choose a slot that works in your local time. Your class will be for 1 hour. Showing today + next 5 days.
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Select Date</label>
          <span class="field-hint" id="date-range-label"></span>
        </div>
        <div class="date-row" id="date-row"></div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Select Start Time</label>
          <span class="field-hint">
            Class slots are limited. Times are shown in your local time.
          </span>
        </div>
        <div class="time-row" id="time-row"></div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Select Language</label>
        </div>
        <select id="language-select">
          <option value="english">English</option>
          <option value="arabic">Arabic</option>
          <option value="bahasa">Bahasa</option>
          <option value="vietnamese">Vietnamese</option>
          <option value="filipino">Filipino</option>
          <option value="thai">Thai</option>
        </select>
      </div>

      <button id="btn-step-2" class="btn-main" style="margin-top: 8px;">
        <span>‚ú®</span>
        <span>Confirm Class Time</span>
      </button>

      <div class="footer-note">
        Note: Free class will be conducted by reputed teachers. By continuing you agree to be contacted by Unischooly via WhatsApp / Phone / Email.
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="step-3" style="display:none;">
      <button class="btn-secondary" id="btn-back-to-2">
        <span>‚Üê</span>
        <span>Back to date &amp; time</span>
      </button>

      <div class="field-group">
        <div class="section-title">Help us personalise your experience</div>
        <div class="section-subtitle">
          A few quick questions so we can plan the trial class for your child.
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Who are you?</label>
        </div>
        <div class="pill-options" id="who-options">
          <button type="button" class="pill-option" data-value="Parent">Parent</button>
          <button type="button" class="pill-option" data-value="Student">Student</button>
          <button type="button" class="pill-option" data-value="Guardian">Guardian</button>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">Why are you booking this trial class?</label>
        </div>
        <div class="pill-options" id="why-options">
          <button type="button" class="pill-option" data-value="Want to buy course">Want to buy course</button>
          <button type="button" class="pill-option" data-value="To Compare Platform">To Compare Platform</button>
          <button type="button" class="pill-option" data-value="To strengthen Concept">To strengthen Concept</button>
          <button type="button" class="pill-option" data-value="Just for free demo">Just for free demo</button>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label-row">
          <label class="field-label">When are you planning to purchase?</label>
        </div>
        <div class="pill-options" id="when-options">
          <button type="button" class="pill-option" data-value="After the Demo">After the Demo</button>
          <button type="button" class="pill-option" data-value="This Week">This Week</button>
          <button type="button" class="pill-option" data-value="This Month">This Month</button>
          <button type="button" class="pill-option" data-value="Just Exploring">Just Exploring</button>
        </div>
      </div>

      <button id="btn-step-3" class="btn-main" style="margin-top: 8px;">
        <span>‚úÖ</span>
        <span>Submit</span>
      </button>

      <div class="footer-note" id="final-message" style="display:none; margin-top: 12px;">
        Your trial class is booked. You can now close this test page.
      </div>
    </section>
  </div>

  <script>
    // ===== CONFIG =====
    const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";

    const { createClient } = supabase;
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const courseIdParam = urlParams.get("courseId") || urlParams.get("course") || "1";
    const courseId = parseInt(courseIdParam, 10) || 1;
    const langParam = (urlParams.get("lang") || "english").toLowerCase();

    // For this backend test we fix region to MEA (you can change to USA, ASIA, etc. if needed)
    const REGION_KEY = "MEA";
    const COUNTRY_NAME = "Backend Test Country";

    // ===== STATE =====
    let leadRow = null;
    let leadId = null;

    let hasLaptop = "yes";
    let selectedDateKey = null;
    let selectedSlot = null;
    let language = "english";

    let whoValue = null;
    let whyValue = null;
    let whenValue = null;

    // ===== HELPERS =====
    function showError(msg) {
      const banner = document.getElementById("error-banner");
      const text = document.getElementById("error-text");
      text.textContent = msg;
      banner.classList.add("show");
      setTimeout(() => banner.classList.remove("show"), 6000);
    }

    function showSuccess(msg) {
      const banner = document.getElementById("success-banner");
      const text = document.getElementById("success-text");
      text.textContent = msg;
      banner.classList.add("show");
      setTimeout(() => banner.classList.remove("show"), 5000);
    }

    function setStep(step) {
      document.getElementById("step-label").textContent = step;
      const titles = {
        1: "Details",
        2: "Date & Time",
        3: "Motivation",
      };
      document.getElementById("step-title").textContent = titles[step];

      document.getElementById("step-1").style.display = step === 1 ? "block" : "none";
      document.getElementById("step-2").style.display = step === 2 ? "block" : "none";
      document.getElementById("step-3").style.display = step === 3 ? "block" : "none";

      const bar2 = document.getElementById("step-bar-2");
      const bar3 = document.getElementById("step-bar-3");

      bar2.className = "step-bar";
      bar3.className = "step-bar";

      if (step >= 2) bar2.classList.add("completed");
      if (step === 2) bar2.classList.add("active");
      if (step === 3) {
        bar2.classList.add("completed");
        bar3.classList.add("completed");
        bar3.classList.add("active");
      }
    }

    function getTimezone() {
      try {
        return Intl.DateTimeFormat().resolvedOptions().timeZone || null;
      } catch {
        return null;
      }
    }

    function formatDateLabel(date) {
      const today = new Date();
      const diffDays = Math.floor((date - startOfDay(today)) / (1000 * 60 * 60 * 24));
      if (diffDays === 0) return "Today";
      if (diffDays === 1) return "Tomorrow";
      return date.toLocaleDateString(undefined, { weekday: "short" });
    }

    function startOfDay(date) {
      return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    }

    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function formatDayMonth(date) {
      return date.toLocaleDateString(undefined, { day: "2-digit", month: "short" });
    }

    function formatTimeLocal(date) {
      return date.toLocaleTimeString(undefined, {
        hour: "2-digit",
        minute: "2-digit",
        hour12: true,
      });
    }

    
    // ===== CLIENT INFO HELPERS (IP, CITY, DEVICE, BROWSER) =====
    let cachedClientInfo = null;

    async function fetchClientInfo() {
      if (cachedClientInfo) return cachedClientInfo;
      try {
        const resp = await fetch("https://ipapi.co/json/");
        if (!resp.ok) return null;
        const data = await resp.json();
        cachedClientInfo = data;
        return data;
      } catch (err) {
        console.error("Error fetching client info", err);
        return null;
      }
    }

    function detectDeviceInfo() {
      const ua = navigator.userAgent || "";
      let device_type = "desktop";
      if (/Mobi|Android|iPhone|iPod/i.test(ua)) device_type = "mobile";
      if (/iPad|Tablet/i.test(ua)) device_type = "tablet";

      let browser = "Unknown";
      if (ua.includes("Edg/")) browser = "Edge";
      else if (ua.includes("OPR/") || ua.includes("Opera")) browser = "Opera";
      else if (ua.includes("Chrome/") && !ua.includes("Chromium") && !ua.includes("Edg/"))
        browser = "Chrome";
      else if (ua.includes("Safari/") && !ua.includes("Chrome/")) browser = "Safari";
      else if (ua.includes("Firefox/")) browser = "Firefox";

      return { device_type, browser };
    }

// ===== STEP 1 LOGIC =====
    const laptopYesBtn = document.getElementById("laptop-yes");
    const laptopNoBtn = document.getElementById("laptop-no");

    laptopYesBtn.addEventListener("click", () => {
      hasLaptop = "yes";
      laptopYesBtn.classList.add("active");
      laptopYesBtn.classList.remove("inactive");
      laptopNoBtn.classList.remove("active");
      laptopNoBtn.classList.add("inactive");
    });

    laptopNoBtn.addEventListener("click", () => {
      hasLaptop = "no";
      laptopNoBtn.classList.add("active");
      laptopNoBtn.classList.remove("inactive");
      laptopYesBtn.classList.remove("active");
      laptopYesBtn.classList.add("inactive");
    });

    document.getElementById("btn-step-1").addEventListener("click", async () => {
      const phoneCountryCode = document.getElementById("phone-country-code").value.trim();
      const phoneNumber = document.getElementById("phone-number").value.trim();
      const childName = document.getElementById("child-name").value.trim();
      const childGrade = document.getElementById("child-grade").value;
      const parentName = document.getElementById("parent-name").value.trim();
      const parentEmail = document.getElementById("parent-email").value.trim();

      if (!phoneCountryCode || !phoneNumber || !childName || !childGrade || !parentName || !parentEmail) {
        showError("Please fill all required fields before continuing.");
        return;
      }

      const btn = document.getElementById("btn-step-1");
      btn.disabled = true;

      const tz = getTimezone();
      const fullUrl = window.location.href;
      const path = window.location.pathname + window.location.search;

      let ip_address = null;
      let city = null;
      let countryFromIP = null;
      let device_type = null;
      let browser = null;

      try {
        const info = await fetchClientInfo();
        if (info) {
          ip_address = info.ip || null;
          city = info.city || null;
          countryFromIP = info.country_name || null;
        }
      } catch (e) {
        console.error("Client info fetch error", e);
      }

      const deviceInfo = detectDeviceInfo();
      device_type = deviceInfo.device_type;
      browser = deviceInfo.browser;

      const resolvedCountry = countryFromIP || COUNTRY_NAME;

      const payload = {
        child_name: childName,
        child_grade: childGrade,
        parent_name: parentName,
        parent_email: parentEmail,
        phone_country_code: phoneCountryCode,
        phone_number: phoneNumber,
        has_laptop: hasLaptop,
        region_key: REGION_KEY,
        country: resolvedCountry,
        timezone: tz,
        lang: langParam,
        course_id: courseId,
        full_url: fullUrl,
        landing_page_path: path,
        ip_address: ip_address,
        city: city,
        device_type: device_type,
        browser: browser,
        internet_speed_mbps: null,
        page_completed: 1,
      };

      try {
        const { data, error } = await supa
          .from("demo_leads")
          .upsert(payload, {
            onConflict: "phone_country_code,phone_number",
          })
          .select("*")
          .single();

        if (error) {
          console.error(error);
          showError(error.message || "Unable to save details. Please try again.");
          btn.disabled = false;
          return;
        }

        leadRow = data;
        leadId = data.id;
        showSuccess("Details saved. Now pick a date & time.");
        await loadSlots();
        setStep(2);
      } catch (err) {
        console.error(err);
        showError("Unexpected error while saving details.");
      } finally {
        btn.disabled = false;
      }
    });

    // ===== STEP 2 ‚Äì LOAD SLOTS =====
    async function loadSlots() {
      const dateRow = document.getElementById("date-row");
      const timeRow = document.getElementById("time-row");
      dateRow.innerHTML = "Loading slots...";
      timeRow.innerHTML = "";

      const today = startOfDay(new Date());
      const end = new Date(today.getTime() + 5 * 24 * 60 * 60 * 1000);

      const todayKey = formatDateKey(today);
      const endKey = formatDateKey(end);

      document.getElementById(
        "date-range-label"
      ).textContent = `Showing ${todayKey} ‚Äì ${endKey}`;

      try {
        const { data, error } = await supa
          .from("demo_slots_live")
          .select(
            "id, slot_date, slot_time_ist, slot_datetime_ist, is_star_teacher, region_key, course_id"
          )
          .eq("region_key", REGION_KEY)
          .eq("course_id", courseId)
          .gte("slot_date", todayKey)
          .lte("slot_date", endKey)
          .order("slot_datetime_ist", { ascending: true });

        if (error) {
          console.error(error);
          dateRow.innerHTML = "";
          showError(error.message || "Could not load slots.");
          return;
        }

        if (!data || data.length === 0) {
          dateRow.innerHTML = "No slots found for this period.";
          return;
        }

        // Build grouped slots by local date
        const grouped = {};
        const now = new Date();
        const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);

        data.forEach((row) => {
          if (!row.slot_datetime_ist) return;
          const local = new Date(row.slot_datetime_ist);

          // Enforce +1 hour rule for "today"
          const isToday =
            formatDateKey(local) === formatDateKey(now);
          if (isToday && local < oneHourLater) {
            return; // skip
          }

          const dateKey = formatDateKey(local);
          if (!grouped[dateKey]) grouped[dateKey] = [];
          grouped[dateKey].push({
            id: row.id,
            dateKey,
            localDate: startOfDay(local),
            localDateTime: local,
            timeLabel: formatTimeLocal(local),
            isStar: !!row.is_star_teacher,
          });
        });

        const dateKeys = Object.keys(grouped).sort();
        if (dateKeys.length === 0) {
          dateRow.innerHTML = "No upcoming slots (respecting 1-hour rule).";
          return;
        }

        // Render date pills
        dateRow.innerHTML = "";
        dateKeys.forEach((dk, idx) => {
          const sample = grouped[dk][0];
          const dateObj = sample.localDate;
          const pill = document.createElement("button");
          pill.type = "button";
          pill.className = "date-pill";
          pill.dataset.dateKey = dk;
          pill.innerHTML = `
            <div>${formatDateLabel(dateObj)}</div>
            <strong>${formatDayMonth(dateObj)}</strong>
          `;
          if (idx === 0) {
            pill.classList.add("selected");
            selectedDateKey = dk;
          }
          pill.addEventListener("click", () => {
            selectedDateKey = dk;
            document.querySelectorAll(".date-pill").forEach((p) => p.classList.remove("selected"));
            pill.classList.add("selected");
            renderTimePills(grouped);
          });
          dateRow.appendChild(pill);
        });

        renderTimePills(grouped);
      } catch (err) {
        console.error(err);
        dateRow.innerHTML = "";
        showError("Unexpected error while loading slots.");
      }
    }

    function renderTimePills(grouped) {
      const timeRow = document.getElementById("time-row");
      timeRow.innerHTML = "";

      const list = grouped[selectedDateKey] || [];
      if (!list.length) {
        timeRow.textContent = "No slots for this date.";
        return;
      }

      list.forEach((slot) => {
        const pill = document.createElement("button");
        pill.type = "button";
        pill.className = "time-pill";
        pill.dataset.slotId = slot.id;
        pill.innerHTML = `
          <div class="time-pill-header">
            <div class="time-pill-main">${slot.timeLabel}</div>
            ${
              slot.isStar
                ? '<div class="star-badge"><span>‚≠ê</span><span>Star teacher</span></div>'
                : ""
            }
          </div>
          <div class="time-pill-sub">1:1 live class ¬∑ 60 mins</div>
        `;

        pill.addEventListener("click", () => {
          selectedSlot = slot;
          document.querySelectorAll(".time-pill").forEach((p) => p.classList.remove("selected"));
          pill.classList.add("selected");
        });

        if (!selectedSlot) {
          selectedSlot = slot;
          pill.classList.add("selected");
        } else if (selectedSlot && selectedSlot.id === slot.id) {
          pill.classList.add("selected");
        }

        timeRow.appendChild(pill);
      });
    }

    document.getElementById("language-select").addEventListener("change", (e) => {
      language = e.target.value || "english";
    });

    document.getElementById("btn-back-to-1").addEventListener("click", () => {
      setStep(1);
    });

    document.getElementById("btn-step-2").addEventListener("click", async () => {
      if (!leadId || !selectedSlot) {
        showError("Please select a time slot before continuing.");
        return;
      }

      const btn = document.getElementById("btn-step-2");
      btn.disabled = true;

      try {
        const updatePayload = {
          preferred_date: selectedSlot.dateKey,
          preferred_time_slot: selectedSlot.timeLabel,
          slot_id: selectedSlot.id,
          star_teacher_selected: selectedSlot.isStar,
          lang: language,
          page_completed: 2,
        };

        const { error } = await supa
          .from("demo_leads")
          .update(updatePayload)
          .eq("id", leadId);

        if (error) {
          console.error(error);
          showError(error.message || "Could not save selected slot.");
          btn.disabled = false;
          return;
        }

        showSuccess("Class time confirmed. Final step ‚Äì quick questions.");
        setStep(3);
      } catch (err) {
        console.error(err);
        showError("Unexpected error while saving slot.");
      } finally {
        btn.disabled = false;
      }
    });

    // ===== STEP 3 ‚Äì MOTIVATIONS =====
    function setupPillGroup(containerId, setter) {
      const container = document.getElementById(containerId);
      container.querySelectorAll(".pill-option").forEach((btn) => {
        btn.addEventListener("click", () => {
          const value = btn.getAttribute("data-value");
          setter(value);
          container.querySelectorAll(".pill-option").forEach((b) => b.classList.remove("selected"));
          btn.classList.add("selected");
        });
      });
    }

    setupPillGroup("who-options", (v) => (whoValue = v));
    setupPillGroup("why-options", (v) => (whyValue = v));
    setupPillGroup("when-options", (v) => (whenValue = v));

    document.getElementById("btn-back-to-2").addEventListener("click", () => {
      setStep(2);
    });

    document.getElementById("btn-step-3").addEventListener("click", async () => {
      if (!leadId) {
        showError("Lead not found. Please start again.");
        return;
      }

      const btn = document.getElementById("btn-step-3");
      btn.disabled = true;

      try {
        const payload = {
          who_are_you: whoValue,
          booking_reason: whyValue,
          purchase_timeline: whenValue,
          page_completed: 3,
        };

        const { error } = await supa
          .from("demo_leads")
          .update(payload)
          .eq("id", leadId);

        if (error) {
          console.error(error);
          showError(error.message || "Could not save final answers.");
          btn.disabled = false;
          return;
        }

        showSuccess("All steps saved successfully.");
        const finalMsg = document.getElementById("final-message");
        finalMsg.style.display = "block";
      } catch (err) {
        console.error(err);
        showError("Unexpected error while saving.");
      } finally {
        btn.disabled = false;
      }
    });

    // Initialise
    setStep(1);
    document.getElementById("language-select").value = "english";
  </script>
</body>
</html>
