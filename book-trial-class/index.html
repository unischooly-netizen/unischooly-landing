<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unischooly | Book Your Free Trial Class</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Simple reset + layout -->
  <style>
    :root {
      --uni-bg: #050816;
      --uni-card: #0f172a;
      --uni-accent-start: #ff6b6b;
      --uni-accent-end: #fbbf24;
      --uni-border: #1f2937;
      --uni-text-main: #f9fafb;
      --uni-text-muted: #9ca3af;
      --uni-danger: #f97373;
      --uni-success: #4ade80;
      --uni-warning: #facc15;
    }
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: var(--uni-text-main);
    }
    a {
      color: inherit;
      text-decoration: none;
    }
    .page-shell {
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px 16px 40px;
    }

    /* HEADER */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0 16px;
    }
    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-circle {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: radial-gradient(circle at 20% 0, #fbbf24, #ec4899 40%, #6366f1 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: #020617;
    }
    .logo-text-main {
      font-weight: 700;
      letter-spacing: .04em;
      font-size: 18px;
    }
    .logo-text-tag {
      font-size: 11px;
      color: var(--uni-text-muted);
    }
    nav {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 14px;
    }
    nav a {
      color: var(--uni-text-muted);
      position: relative;
      padding-bottom: 2px;
    }
    nav a:hover {
      color: var(--uni-text-main);
    }
    nav a::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -3px;
      width: 0;
      height: 2px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--uni-accent-start), var(--uni-accent-end));
      transition: width .18s ease-out;
    }
    nav a:hover::after {
      width: 100%;
    }
    .nav-cta {
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      background: linear-gradient(120deg, var(--uni-accent-start), var(--uni-accent-end));
      color: #111827;
      box-shadow: 0 10px 28px rgba(0,0,0,.45);
    }
    .nav-cta:hover {
      opacity: .94;
      transform: translateY(-1px);
    }

    /* HERO */
    .hero {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 32px;
      align-items: center;
      margin-top: 12px;
    }
    .hero-copy {
      padding-right: 12px;
    }
    .hero-kicker {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15,23,42,.8);
      border: 1px solid rgba(55,65,81,.8);
      color: var(--uni-text-muted);
      margin-bottom: 10px;
    }
    .hero-title {
      font-size: clamp(26px, 4vw, 34px);
      line-height: 1.2;
      font-weight: 800;
      margin-bottom: 10px;
    }
    .hero-title span {
      background: linear-gradient(120deg, var(--uni-accent-start), var(--uni-accent-end));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .hero-sub {
      font-size: 14px;
      color: var(--uni-text-muted);
      max-width: 440px;
      margin-bottom: 16px;
    }
    .hero-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 18px;
    }
    .hero-badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,.9);
      background: rgba(15,23,42,.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--uni-text-muted);
    }
    .hero-badge strong {
      color: var(--uni-text-main);
    }
    .hero-stats {
      display: flex;
      gap: 20px;
      font-size: 12px;
      margin-top: 6px;
      color: var(--uni-text-muted);
    }
    .hero-stats span {
      display: block;
      font-size: 16px;
      font-weight: 700;
      color: var(--uni-text-main);
    }
    .hero-art {
      position: relative;
      min-height: 280px;
      border-radius: 24px;
      overflow: hidden;
      background-image: url("https://res.cloudinary.com/dpapyknn4/image/upload/v1765120532/kid-coding-infographic-icon-neon-boy-programming-on-laptop-in-computer-language-children-learning-kids-coding-school-teach-to-create-computer-and-mobile-phone-apps-vector_kswxdi.jpg");
      background-position: center;
      background-size: cover;
    }
    .hero-art::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,.1), rgba(15,23,42,.9));
    }
    .hero-art-inner {
      position: relative;
      z-index: 1;
      height: 100%;
      padding: 18px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .hero-art-pill {
      align-self: flex-start;
      padding: 5px 11px;
      border-radius: 999px;
      background: rgba(15,23,42,.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148,163,184,.9);
      font-size: 11px;
      color: var(--uni-text-muted);
    }
    .hero-art-pill strong {
      color: var(--uni-text-main);
      font-weight: 600;
    }
    .hero-art-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .hero-art-tag {
      font-size: 12px;
      color: var(--uni-text-muted);
    }
    .hero-art-tag span {
      color: var(--uni-text-main);
      font-weight: 600;
    }
    .hero-art-chip {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15,23,42,.9);
      border: 1px solid rgba(55,65,81,.9);
      font-size: 11px;
      color: var(--uni-text-muted);
    }

    /* CARD SHELL (Form Pages) */
    .card-shell {
      margin-top: 26px;
      border-radius: 22px;
      background: radial-gradient(circle at top, rgba(30,64,175,.7), rgba(15,23,42,1) 55%);
      padding: 1px;
    }
    .card-inner {
      border-radius: 21px;
      background: radial-gradient(circle at top, rgba(15,23,42,1), rgba(2,6,23,1));
      padding: 18px 18px 20px;
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 0.9fr);
      gap: 18px;
    }
    .card-left-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .card-left-sub {
      font-size: 13px;
      color: var(--uni-text-muted);
      margin-bottom: 10px;
    }
    .card-tagline {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: var(--uni-text-muted);
      margin-bottom: 6px;
    }
    .card-perks {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      margin-top: 10px;
    }
    .card-perk-row {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--uni-text-muted);
    }
    .card-perk-dot {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: radial-gradient(circle at 20% 0, var(--uni-accent-start), var(--uni-accent-end));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #020617;
    }

    /* FORM PANELS */
    .step-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      margin-bottom: 10px;
    }
    .step-pill {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,1);
      background: rgba(15,23,42,1);
      color: var(--uni-text-muted);
    }
    .step-pill strong {
      color: var(--uni-text-main);
    }
    .step-divider {
      flex: 1;
      height: 1px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(55,65,81,1), rgba(15,23,42,0));
    }
    .form-panel {
      border-radius: 14px;
      background: rgba(15,23,42,.9);
      border: 1px solid var(--uni-border);
      padding: 14px 14px 16px;
      box-shadow: 0 18px 40px rgba(15,23,42,.9);
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .field {
      margin-bottom: 10px;
    }
    .field label {
      display: block;
      font-size: 11px;
      margin-bottom: 4px;
      color: var(--uni-text-muted);
    }
    .field input,
    .field select {
      width: 100%;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid rgba(55,65,81,1);
      background: rgba(15,23,42,1);
      color: var(--uni-text-main);
      font-size: 13px;
      outline: none;
    }
    .field input:focus,
    .field select:focus {
      border-color: rgba(129,140,248,1);
      box-shadow: 0 0 0 1px rgba(129,140,248,.5);
    }
    .field-hint {
      font-size: 10px;
      color: var(--uni-text-muted);
      margin-top: 2px;
    }
    .yesno-wrap {
      display: inline-flex;
      border-radius: 999px;
      padding: 2px;
      background: rgba(17,24,39,1);
      border: 1px solid rgba(55,65,81,1);
      gap: 4px;
    }
    .yesno-btn {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--uni-text-muted);
      cursor: pointer;
    }
    .yesno-btn.active {
      background: linear-gradient(120deg, var(--uni-accent-start), var(--uni-accent-end));
      color: #020617;
      font-weight: 600;
    }

    .form-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
      gap: 10px;
      font-size: 11px;
      color: var(--uni-text-muted);
    }
    .btn-primary {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(120deg, var(--uni-accent-start), var(--uni-accent-end));
      color: #111827;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary:disabled {
      opacity: .6;
      cursor: default;
    }
    .btn-secondary {
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,1);
      background: rgba(15,23,42,1);
      color: var(--uni-text-muted);
      padding: 8px 14px;
      font-size: 12px;
      cursor: pointer;
    }

    .status-line {
      font-size: 11px;
      margin-top: 8px;
      min-height: 16px;
    }
    .status-line.ok {
      color: var(--uni-success);
    }
    .status-line.error {
      color: var(--uni-danger);
    }

    /* PAGE 2 SLOTS */
    .hidden {
      display: none !important;
    }
    .slots-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .slots-title {
      font-size: 16px;
      font-weight: 600;
    }
    .slots-meta {
      font-size: 11px;
      color: var(--uni-text-muted);
      text-align: right;
    }
    .slots-meta span {
      display: block;
    }
    .slot-groups {
      max-height: 320px;
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: thin;
    }
    .slot-day-group {
      margin-bottom: 10px;
    }
    .slot-day-header {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--uni-text-muted);
    }
    .slot-chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .slot-chip {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(55,65,81,1);
      background: rgba(17,24,39,1);
      color: var(--uni-text-main);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .slot-chip.star {
      border-color: var(--uni-warning);
      box-shadow: 0 0 0 1px rgba(250,204,21,.4);
    }
    .slot-chip.full {
      border-style: dashed;
      border-color: rgba(75,85,99,1);
      color: rgba(148,163,184,1);
      background: rgba(15,23,42,.6);
      cursor: not-allowed;
      opacity: .6;
    }
    .slot-chip.selected {
      background: linear-gradient(120deg, var(--uni-accent-start), var(--uni-accent-end));
      color: #020617;
      border-color: transparent;
    }
    .slot-chip-time {
      font-weight: 600;
    }
    .slot-chip-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15,23,42,.9);
      border: 1px solid rgba(55,65,81,1);
    }
    .slot-chip-tag.star-tag {
      border-color: var(--uni-warning);
      color: var(--uni-warning);
    }
    .slot-chip-tag.full-tag {
      border-color: rgba(148,163,184,1);
      color: rgba(148,163,184,1);
    }
    .slot-empty {
      font-size: 12px;
      color: var(--uni-text-muted);
      padding: 8px 0;
    }

    @media (max-width: 900px) {
      .hero {
        grid-template-columns: minmax(0, 1fr);
      }
      .card-inner {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      nav {
        width: 100%;
        justify-content: space-between;
      }
      .hero-art {
        min-height: 220px;
      }
      .card-inner {
        padding: 14px 12px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <!-- HEADER -->
    <header>
      <div class="logo-wrap">
        <div class="logo-circle">U</div>
        <div>
          <div class="logo-text-main">Unischooly</div>
          <div class="logo-text-tag">Future-ready skills for kids</div>
        </div>
      </div>
      <nav>
        <a href="#programs">Programs</a>
        <a href="#how-it-works">How it works</a>
        <a href="#reviews">Reviews</a>
        <button class="nav-cta" type="button">Book Free Trial</button>
      </nav>
    </header>

    <!-- HERO -->
    <section class="hero">
      <div class="hero-copy">
        <div class="hero-kicker">
          <span>‚ö° LIVE 1:1 Online Class</span>
        </div>
        <h1 class="hero-title">
          Free Coding Class for Kids ‚Äî <span>Book Your Perfect Time Slot</span>
        </h1>
        <p class="hero-sub">
          Personalised trial session in your child's local time. Certified teachers, project-based learning, and a detailed class report for parents.
        </p>
        <div class="hero-badges">
          <div class="hero-badge"><strong>üåé 30+ Countries</strong><span>global learners</span></div>
          <div class="hero-badge"><strong>‚≠ê 4.8/5</strong><span>average parent rating</span></div>
          <div class="hero-badge"><strong>üéì 1:1 or Small Groups</strong></div>
          <div class="hero-badge"><strong>üìú Certificate</strong><span>after class</span></div>
        </div>
        <div class="hero-stats">
          <div>
            <span>25,000+</span>
            kids taught
          </div>
          <div>
            <span>45 mins</span>
            live class
          </div>
          <div>
            <span>Zero</span>
            payment required
          </div>
        </div>
      </div>
      <div class="hero-art">
        <div class="hero-art-inner">
          <div class="hero-art-pill">
            Free Live Coding Class ‚Ä¢ <strong>Limited Daily Slots</strong>
          </div>
          <div class="hero-art-footer">
            <div class="hero-art-tag">
              <span>Kids book in 2 minutes</span>
              <br />
              No credit card, personalised report after demo.
            </div>
            <div class="hero-art-chip">
              üéüÔ∏è Today + Next 5 Days ¬∑ IST to Local Time
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CARD SHELL: PAGE 1 + PAGE 2 -->
    <section class="card-shell" id="booking-card">
      <div class="card-inner">
        <!-- LEFT: Pitch -->
        <div>
          <div class="card-tagline">BOOK NOW &amp; GET CERTIFIED</div>
          <div class="card-left-title">Free Live Coding Class for Your Child</div>
          <div class="card-left-sub">
            Fill quick details, pick a time slot that works in your child's local time, and we'll match you with a top teacher.
          </div>

          <div class="card-perks">
            <div class="card-perk-row">
              <div class="card-perk-dot">‚úì</div>
              <div>Personalised 45-minute 1:1 session aligned to your child's grade</div>
            </div>
            <div class="card-perk-row">
              <div class="card-perk-dot">‚úì</div>
              <div>Live project inside the class ‚Äî no boring slides</div>
            </div>
            <div class="card-perk-row">
              <div class="card-perk-dot">‚úì</div>
              <div>Detailed class summary &amp; certificate emailed to parents</div>
            </div>
          </div>
        </div>

        <!-- RIGHT: MULTI-STEP FORM -->
        <div>
          <div class="step-indicator">
            <div class="step-pill" id="step-pill-page1"><strong>Step 1</strong> ¬∑ Child &amp; Parent Details</div>
            <div class="step-pill hidden" id="step-pill-page2"><strong>Step 2</strong> ¬∑ Pick Date &amp; Time</div>
            <div class="step-divider"></div>
          </div>

          <!-- PAGE 1: Lead Details -->
          <div class="form-panel" id="page1-panel">
            <form id="page1-form">
              <div class="field">
                <label for="child_name">Child's Name</label>
                <input id="child_name" name="child_name" required placeholder="E.g. Aarav, Emma" />
              </div>

              <div class="form-row">
                <div class="field">
                  <label for="child_grade">Child's Grade</label>
                  <select id="child_grade" name="child_grade" required>
                    <option value="">Select grade</option>
                    <option value="1">Grade 1</option>
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                    <option value="6">Grade 6</option>
                    <option value="7">Grade 7</option>
                    <option value="8">Grade 8</option>
                    <option value="9">Grade 9</option>
                    <option value="10">Grade 10</option>
                  </select>
                </div>
                <div class="field">
                  <label for="child_country">Child's Country</label>
                  <select id="child_country" name="child_country" required>
                    <option value="">Select country</option>
                    <option value="IN">India</option>
                    <option value="AE">United Arab Emirates</option>
                    <option value="SA">Saudi Arabia</option>
                    <option value="US">United States</option>
                    <option value="GB">United Kingdom</option>
                    <option value="OM">Oman</option>
                    <option value="QA">Qatar</option>
                    <option value="KW">Kuwait</option>
                    <option value="BH">Bahrain</option>
                    <!-- Extend with full country list as per country_region_mapping -->
                  </select>
                  <div class="field-hint">We will auto-convert slots from IST to this country‚Äôs time.</div>
                </div>
              </div>

              <div class="field">
                <label for="parent_name">Parent's Name</label>
                <input id="parent_name" name="parent_name" required placeholder="Parent / Guardian full name" />
              </div>

              <div class="field">
                <label for="parent_email">Parent's Email</label>
                <input id="parent_email" name="parent_email" type="email" required placeholder="We will send confirmation here" />
              </div>

              <div class="form-row">
                <div class="field">
                  <label for="phone_country_code">Country Code</label>
                  <select id="phone_country_code" name="phone_country_code" required>
                    <option value="+91">üáÆüá≥ +91</option>
                    <option value="+971">üá¶üá™ +971</option>
                    <option value="+966">üá∏üá¶ +966</option>
                    <option value="+1">üá∫üá∏ +1</option>
                    <option value="+44">üá¨üáß +44</option>
                    <option value="+968">üá¥üá≤ +968</option>
                    <option value="+974">üá∂üá¶ +974</option>
                    <option value="+965">üá∞üáº +965</option>
                    <option value="+973">üáßüá≠ +973</option>
                  </select>
                </div>
                <div class="field">
                  <label for="parent_phone">Parent WhatsApp Number</label>
                  <input id="parent_phone" name="parent_phone" required placeholder="10‚Äì12 digit number" />
                </div>
              </div>

              <div class="field">
                <label>Does your child have a Laptop / Desktop for the class?</label>
                <div class="yesno-wrap" id="has_laptop_group">
                  <button type="button" class="yesno-btn active" data-value="true">Yes</button>
                  <button type="button" class="yesno-btn" data-value="false">No</button>
                </div>
                <div class="field-hint">We strongly recommend a laptop / desktop. Tablet can work for some programs.</div>
              </div>

              <div class="form-footer">
                <div>Step 1 of 2 ¬∑ Details</div>
                <button class="btn-primary" type="submit" id="page1-submit">
                  Continue to Time Slots
                </button>
              </div>
              <div id="page1-status" class="status-line"></div>
            </form>
          </div>

          <!-- PAGE 2: Date & Time Slots -->
          <div class="form-panel hidden" id="page2-panel">
            <div class="slots-header">
              <div>
                <div class="slots-title">Pick Your Class Start Time</div>
                <div class="card-left-sub" style="margin: 4px 0 0; font-size:12px;">
                  All slots are shown in your child's <span id="local-timezone-label">local time</span>.
                </div>
              </div>
              <div class="slots-meta">
                <span id="slot-region-label"></span>
                <span id="slot-course-label"></span>
              </div>
            </div>

            <div id="slots-loading" class="slot-empty">Loading available slots‚Ä¶</div>
            <div id="slots-container" class="slot-groups hidden"></div>

            <div class="form-footer">
              <button type="button" class="btn-secondary" id="back-to-page1">‚Üê Back</button>
              <button type="button" class="btn-primary" id="confirm-slot-btn" disabled>
                Confirm &amp; Book Slot
              </button>
            </div>
            <div id="page2-status" class="status-line"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- JS: Supabase + Booking Logic -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // TODO: REPLACE with your values from Supabase project settings
    const SUPABASE_URL = "https://binklfyiypbhuzsvnlzg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbmtsZnlpeXBiaHV6c3ZubHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzA5NjgsImV4cCI6MjA4MDYwNjk2OH0.PYCRN7ubQA2XnVy8BYd6746iAGATjBuBAlvsCdLdbqw";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ------------------------
    // Helpers
    // ------------------------
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function formatLocalTime(date) {
      const options = { hour: "numeric", minute: "2-digit", hour12: true };
      return date.toLocaleTimeString(undefined, options);
    }

    function formatDayLabel(localDate) {
      const today = new Date();
      const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const startOfThat = new Date(localDate.getFullYear(), localDate.getMonth(), localDate.getDate());
      const diffDays = Math.round((startOfThat - startOfToday) / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return "Today";
      if (diffDays === 1) return "Tomorrow";

      const opts = { weekday: "short", month: "short", day: "numeric" };
      return localDate.toLocaleDateString(undefined, opts);
    }

    // Convert IST datetime (string) to child's local time using offset minutes
    function convertIstToLocal(istDateString, offsetMinutes) {
      if (!istDateString) return null;
      const istDate = new Date(istDateString);
      if (Number.isNaN(istDate.getTime())) return null;
      const localMs = istDate.getTime() + offsetMinutes * 60 * 1000;
      return new Date(localMs);
    }

    // ------------------------
    // Global state
    // ------------------------
    let globalLeadId = null;
    let globalRegionKey = null;
    let globalCourseId = null;
    let globalTimezoneOffsetMin = 0;
    let globalCountryCode = null;
    let globalSelectedSlot = null;
    let cachedRegionRules = null;

    const page1Panel = document.getElementById("page1-panel");
    const page2Panel = document.getElementById("page2-panel");
    const stepPill1 = document.getElementById("step-pill-page1");
    const stepPill2 = document.getElementById("step-pill-page2");
    const page1Status = document.getElementById("page1-status");
    const page2Status = document.getElementById("page2-status");
    const slotsContainer = document.getElementById("slots-container");
    const slotsLoading = document.getElementById("slots-loading");
    const confirmSlotBtn = document.getElementById("confirm-slot-btn");
    const backToPage1Btn = document.getElementById("back-to-page1");
    const localTimezoneLabel = document.getElementById("local-timezone-label");
    const slotRegionLabel = document.getElementById("slot-region-label");
    const slotCourseLabel = document.getElementById("slot-course-label");

    // ------------------------
    // Load region rules once
    // ------------------------
    async function loadRegionRules() {
      if (cachedRegionRules) return cachedRegionRules;
      const { data, error } = await supabase
        .from("region_time_rules")
        .select("region_key, timezone_offset_min, region_display_name, countries, is_active")
        .eq("is_active", true);

      if (error) {
        console.error("Error loading region_time_rules:", error);
        throw error;
      }
      cachedRegionRules = data || [];
      return cachedRegionRules;
    }

    async function getRegionInfoForCountry(countryIso2) {
      const rules = await loadRegionRules();
      const code = (countryIso2 || "").toUpperCase();

      for (const row of rules) {
        if (!row.countries) continue;
        const list = row.countries.split(",").map(c => c.trim().toUpperCase());
        if (list.includes(code)) {
          return {
            region_key: row.region_key,
            timezone_offset_min: row.timezone_offset_min,
            region_display_name: row.region_display_name || row.region_key
          };
        }
      }
      // fallback ‚Äì ROW region if present
      const rowRegion = rules.find(r => r.region_key === "ROW");
      if (rowRegion) {
        return {
          region_key: rowRegion.region_key,
          timezone_offset_min: rowRegion.timezone_offset_min,
          region_display_name: rowRegion.region_display_name || "Rest of World"
        };
      }
      return null;
    }

    // ------------------------
    // PAGE 1 logic
    // ------------------------
    const hasLaptopGroup = document.getElementById("has_laptop_group");
    let hasLaptopValue = true;
    hasLaptopGroup.querySelectorAll(".yesno-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        hasLaptopGroup.querySelectorAll(".yesno-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        hasLaptopValue = btn.dataset.value === "true";
      });
    });

    const page1Form = document.getElementById("page1-form");

    page1Form.addEventListener("submit", async (event) => {
      event.preventDefault();
      page1Status.textContent = "";
      page1Status.className = "status-line";

      const childName = document.getElementById("child_name").value.trim();
      const childGrade = document.getElementById("child_grade").value;
      const childCountry = document.getElementById("child_country").value;
      const parentName = document.getElementById("parent_name").value.trim();
      const parentEmail = document.getElementById("parent_email").value.trim();
      const phoneCountryCode = document.getElementById("phone_country_code").value;
      const parentPhone = document.getElementById("parent_phone").value.trim();

      if (!childName || !childGrade || !childCountry || !parentName || !parentEmail || !parentPhone) {
        page1Status.textContent = "Please fill all required fields.";
        page1Status.classList.add("error");
        return;
      }

      const courseIdParam = getQueryParam("courseId");
      globalCourseId = courseIdParam ? parseInt(courseIdParam, 10) : 1;
      const lang = getQueryParam("lang") || "english";

      try {
        page1Status.textContent = "Saving details‚Ä¶";
        const regionInfo = await getRegionInfoForCountry(childCountry);
        if (!regionInfo) {
          page1Status.textContent = "Could not map this country to a region. Please try a different country or contact support.";
          page1Status.classList.add("error");
          return;
        }

        globalRegionKey = regionInfo.region_key;
        globalTimezoneOffsetMin = regionInfo.timezone_offset_min || 0;
        globalCountryCode = childCountry;

        const { data, error } = await supabase
          .from("demo_leads")
          .insert({
            child_name: childName,
            child_grade: childGrade,
            child_country_iso2: childCountry,
            parent_name: parentName,
            parent_email: parentEmail,
            phone_country_code: phoneCountryCode,
            parent_phone: parentPhone,
            has_laptop: hasLaptopValue,
            region_key: globalRegionKey,
            course_id: globalCourseId,
            lang: lang,
            source_url: window.location.href
          })
          .select("id")
          .single();

        if (error) {
          console.error("Error inserting demo_lead:", error);
          page1Status.textContent = "Something went wrong while saving. Please try again.";
          page1Status.classList.add("error");
          return;
        }

        globalLeadId = data.id;
        page1Status.textContent = "Details saved. Loading available slots‚Ä¶";
        page1Status.classList.add("ok");

        // Switch to Page 2
        page1Panel.classList.add("hidden");
        page2Panel.classList.remove("hidden");
        stepPill1.classList.add("hidden");
        stepPill2.classList.remove("hidden");

        // Update labels
        slotRegionLabel.textContent = regionInfo.region_display_name || globalRegionKey;
        slotCourseLabel.textContent = "Course ID: " + globalCourseId;
        localTimezoneLabel.textContent = "local time (" + childCountry + ")";

        // Load slots
        await loadSlotsForCurrentLead();
      } catch (e) {
        console.error(e);
        page1Status.textContent = "Unexpected error. Please try again.";
        page1Status.classList.add("error");
      }
    });

    backToPage1Btn.addEventListener("click", () => {
      page2Panel.classList.add("hidden");
      stepPill2.classList.add("hidden");
      page1Panel.classList.remove("hidden");
      stepPill1.classList.remove("hidden");
      confirmSlotBtn.disabled = true;
      globalSelectedSlot = null;
    });

    // ------------------------
    // PAGE 2 slot loading
    // ------------------------
    async function loadSlotsForCurrentLead() {
      slotsLoading.classList.remove("hidden");
      slotsContainer.classList.add("hidden");
      slotsContainer.innerHTML = "";
      page2Status.textContent = "";
      page2Status.className = "status-line";

      if (!globalRegionKey || !globalCourseId) {
        page2Status.textContent = "Missing region or course information.";
        page2Status.classList.add("error");
        return;
      }

      const { data: slots, error } = await supabase
        .from("demo_slots_live")
        .select("*")
        .eq("region_key", globalRegionKey)
        .eq("course_id", globalCourseId)
        .eq("is_active", true)
        .order("slot_date", { ascending: true })
        .order("slot_time_ist", { ascending: true });

      if (error) {
        console.error("Error loading demo_slots_live:", error);
        page2Status.textContent = "Could not load available slots. Please refresh.";
        page2Status.classList.add("error");
        slotsLoading.textContent = "Failed to load slots.";
        return;
      }

      const now = new Date();
      const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);

      // Transform and group
      const grouped = new Map(); // key: dateKey, value: { label, slots: [] }

      for (const slot of slots) {
        const localDate = convertIstToLocal(slot.slot_datetime_ist, globalTimezoneOffsetMin);
        if (!localDate) continue;

        // Filter: at least 1 hour from now
        if (localDate < oneHourLater) {
          continue;
        }

        const dayLabel = formatDayLabel(localDate);
        const dateKey = localDate.toISOString().slice(0, 10);

        const isFull = (slot.capacity_remaining ?? 0) <= 0 || slot.is_active === false;

        const slotObj = {
          id: slot.id,
          slot_date: slot.slot_date,
          slot_time_ist: slot.slot_time_ist,
          slot_datetime_ist: slot.slot_datetime_ist,
          is_star_teacher: slot.is_star_teacher,
          capacity_total: slot.capacity_total,
          capacity_remaining: slot.capacity_remaining,
          localDate,
          localTimeLabel: formatLocalTime(localDate),
          isFull
        };

        if (!grouped.has(dateKey)) {
          grouped.set(dateKey, { label: dayLabel, slots: [] });
        }
        grouped.get(dateKey).slots.push(slotObj);
      }

      slotsLoading.classList.add("hidden");

      if (grouped.size === 0) {
        slotsContainer.innerHTML = '<div class="slot-empty">No slots available in the next 5 days. Please try again later.</div>';
        slotsContainer.classList.remove("hidden");
        return;
      }

      // Render grouped slots
      slotsContainer.innerHTML = "";
      for (const [dateKey, group] of grouped.entries()) {
        const wrapper = document.createElement("div");
        wrapper.className = "slot-day-group";

        const header = document.createElement("div");
        header.className = "slot-day-header";
        header.textContent = group.label;
        wrapper.appendChild(header);

        const row = document.createElement("div");
        row.className = "slot-chips-row";

        group.slots.forEach(slotObj => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "slot-chip";

          if (slotObj.is_star_teacher) {
            btn.classList.add("star");
          }
          if (slotObj.isFull) {
            btn.classList.add("full");
          }

          const timeSpan = document.createElement("span");
          timeSpan.className = "slot-chip-time";
          timeSpan.textContent = slotObj.localTimeLabel;
          btn.appendChild(timeSpan);

          if (slotObj.is_star_teacher) {
            const tag = document.createElement("span");
            tag.className = "slot-chip-tag star-tag";
            tag.textContent = "Star Teacher";
            btn.appendChild(tag);
          }

          if (slotObj.isFull) {
            const tag = document.createElement("span");
            tag.className = "slot-chip-tag full-tag";
            tag.textContent = "Full";
            btn.appendChild(tag);
            btn.disabled = true;
          } else {
            const capTag = document.createElement("span");
            capTag.className = "slot-chip-tag";
            capTag.textContent = (slotObj.capacity_remaining ?? 0) + " seats left";
            btn.appendChild(capTag);
          }

          if (!slotObj.isFull) {
            btn.addEventListener("click", () => {
              // deselect others
              slotsContainer.querySelectorAll(".slot-chip").forEach(el => el.classList.remove("selected"));
              btn.classList.add("selected");
              globalSelectedSlot = slotObj;
              confirmSlotBtn.disabled = false;
              page2Status.textContent = "Selected: " + group.label + ", " + slotObj.localTimeLabel;
              page2Status.className = "status-line ok";
            });
          }

          row.appendChild(btn);
        });

        wrapper.appendChild(row);
        slotsContainer.appendChild(wrapper);
      }

      slotsContainer.classList.remove("hidden");
    }

    // ------------------------
    // Confirm slot booking
    // ------------------------
    confirmSlotBtn.addEventListener("click", async () => {
      page2Status.textContent = "";
      page2Status.className = "status-line";

      if (!globalLeadId || !globalSelectedSlot) {
        page2Status.textContent = "Please select a slot first.";
        page2Status.classList.add("error");
        return;
      }

      confirmSlotBtn.disabled = true;
      confirmSlotBtn.textContent = "Booking slot‚Ä¶";

      try {
        // Simple approach: update lead with chosen slot
        const { error: updateError } = await supabase
          .from("demo_leads")
          .update({
            booked_region_key: globalRegionKey,
            booked_course_id: globalCourseId,
            booked_slot_date: globalSelectedSlot.slot_date,
            booked_slot_time_ist: globalSelectedSlot.slot_time_ist,
            booked_slot_local: globalSelectedSlot.localTimeLabel,
            booked_timezone_offset_min: globalTimezoneOffsetMin,
            status: "BOOKED"
          })
          .eq("id", globalLeadId);

        if (updateError) {
          console.error("Error updating demo_lead with chosen slot:", updateError);
          page2Status.textContent = "Could not confirm slot. Please try again.";
          page2Status.classList.add("error");
          confirmSlotBtn.disabled = false;
          confirmSlotBtn.textContent = "Confirm & Book Slot";
          return;
        }

        page2Status.textContent = "Slot booked successfully! We have emailed your confirmation.";
        page2Status.classList.add("ok");
        confirmSlotBtn.textContent = "Slot Confirmed ‚úî";
      } catch (err) {
        console.error(err);
        page2Status.textContent = "Unexpected error while booking slot.";
        page2Status.classList.add("error");
        confirmSlotBtn.disabled = false;
        confirmSlotBtn.textContent = "Confirm & Book Slot";
      }
    });
  </script>
</body>
</html>
